# WFO 稳定性评分公式缺陷修复（2025-11-04）

- 症状：1024 参数网格中所有组合的稳定性评分均为 0；多组参数的 IC/胜率出现高度一致。
- 根因：稳定性评分使用硬阈值项 `(1 - min(ic_std/|ic_mean|, 1.0))`，当 `ic_std >= |ic_mean|` 时整体评分被强制归零。真实数据中常见 `std ≫ mean`，导致系统性归零。
- 修复：改为平滑衰减 `stability = ic_win_rate × ic_mean × 1/(1+ic_std)`（两处修改）。避免突变，保证在 IC>0 时评分>0，并对波动做连续惩罚。
- 佐证：16 组合调试网格验证，稳定性评分范围 [0.0103, 0.0130]，全部>0；IC 加权优于等权（+10.8%），严格阈值优于宽松（+14.5%）。
- 受影响文件：`etf_rotation_optimized/core/wfo_parameter_grid_search.py`（稳定性评分公式×2），`etf_rotation_optimized/test_wfo_parameter_grid.py`（新增 debug 模式、参数名修复）。
- 文档：完整技术报告 `/tmp/wfo_bug_analysis.md`；项目文档 `etf_rotation_optimized/docs/WFO_STABILITY_SCORE_BUG_FIX.md`。
- 教训：
  1) 金融评分公式避免硬阈值，优先平滑惩罚（1/(1+x)、exp(-x) 等）。
  2) 设计需做极限分析（x→0/∞，std≈mean 等典型值）。
  3) 测试除“非零性”外应验证“差异性”。
  4) 日志需输出范围与异常（全0/全一样）。
- 后续：
  - 运行 1024 组合大网格（单进程），产出 Top-20 与完整 CSV；
  - 增加稳定性评分单元测试：非零性、单调性（std 上升评分不增）、参数差异性；
  - 视需要评估替代衰减（exp(-k·std)、sigmoid）并做稳健性对比。