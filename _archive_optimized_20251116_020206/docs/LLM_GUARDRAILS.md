<!-- ALLOW-MD -->
# LLM 编辑与运维护栏

本文件定义了大模型（或自动化代理）在本仓库中的“安全编辑规则”。任何脚本/工具应首先读取本文件，严格遵守以下约束，避免误操作。

## 强约束（不得违反）

1. 目录与文件所有权
   - `real_backtest/` 为“脚本入口的权威位置”。与根目录同名的脚本若同时存在，以 `real_backtest/` 为准。
   - `run_combo_wfo.py` 仅在根目录维护一个副本（主入口）。不得复制到其他目录。
   - `core/`、`real_backtest/core/` 下为算法与管线实现，未经确认不得移动/重命名模块文件。

2. 结果契约（Output Schema 不变更）
   - `results/run_*/` 与 `results_combo_wfo/` 的文件名、字段名、数值含义视为“公共契约”。
   - 在未同步更新 `docs/OUTPUT_SCHEMA.md`、相关读取脚本与下游流程前，不得更改。

3. 无未来函数原则（回测）
   - 严禁在任何回测/分析环节使用“包含当天或未来”的信息计算权重或信号。
   - 任何滚动/窗口型计算，均应严格截断至“调仓日前一日”。

4. 禁止的高危操作
5. 新增 Markdown 的严格限制（本仓库已启用）
   - 默认禁止在非 `docs/` 目录新增任何 `.md` 文件；
   - 在 `docs/` 目录新增 `.md` 文件，需在文档前 10 行内加入 `<!-- ALLOW-MD -->` 标记，且提交前通过 pre-commit 钩子校验；
   - 已存在的 `.md` 文档可自由修改（不受新增限制影响）。

   - 不得批量删除或移动顶层目录中的文件（尤其是 `core/`、`real_backtest/`、`results/`）。
   - 不得在未经确认的情况下覆盖 `results/run_*` 历史结果。
   - 不得将同名可执行脚本复制到多个目录；如确有需要，应建立最薄包装并备注来源。

## 建议流程（修改/新增前置步骤）

1. 变更评估
   - 判断是否影响公共接口（函数返回结构、输出文件 schema、配置键名）。
   - 若影响，先修改/补充文档（`docs/OUTPUT_SCHEMA.md`、`docs/MODULE_MAP.md`），再改代码。

2. 小步提交
   - 将大改拆分为多 PR：先文档与契约、再实现、最后验证与清理。

3. 验证与回归
   - 运行 `run_combo_wfo.py` 生成一轮结果，与基线 run 对比关键统计（组合数、显著组合数、均值 IC、Top 组合）。
   - 运行 `real_backtest/test_freq_no_lookahead.py`，核对回测摘要统计是否在预期范围。

## 兼容性与包装策略

- 若必须在根目录保留与 `real_backtest/` 同名的脚本，应：
  1) 在根脚本顶部加入醒目注释（只做包装，不做业务逻辑），并直接导入/调用 `real_backtest` 下实现；
  2) 在 `README.md` 与本文件中声明“权威位置”为 `real_backtest/`。

## 受保护的关键清单

- 只读/不可删除：
  - `run_combo_wfo.py`
  - `core/` 下所有 `.py`
  - `real_backtest/core/` 下所有 `.py`
  - `results/run_*/` 历史结果目录

- 慎改（需评估影响）：
  - `configs/*.yaml`
  - `docs/OUTPUT_SCHEMA.md`
  - `real_backtest/test_freq_no_lookahead.py`

## 常见误区

- 复制粘贴脚本到多个位置，导致后续修改不一致 → 应用“权威位置 + 包装”策略。
- 修改输出文件字段名，未同步修改读取脚本 → 先更新文档与读取逻辑，再变更产出。
- 回测便利起见把当天数据纳入权重估计 → 坚决禁止，严格使用历史窗口。
