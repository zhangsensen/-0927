<!-- ALLOW-MD --># 8天 WFO 全量扩容 + 频率泛化验证 - 操作手册

> 更新（2025-11-08）：回测引擎采用“稳定排名(平均 ties) + 日级IC预计算(memmap共享) + Numba预热 + 全局缓存”，默认固定 8 天频率以保证复现性。性能优化阶段已冻结，详见根目录 `README.md` 的推荐环境变量模板与冻结原则。

## 🎯 目标
1. **8天 WFO 全量运行**：固定 8天频率，对全部 12,597 候选组合跑 WFO，筛选所有通过 IC/稳定性门槛的合格组合
2. **全频真实回测**：用 8天 WFO 筛出的白名单，跑 30 个频率的真实回测（含交易成本）
3. **频率泛化评估**：验证"8天模型是否过拟合 8天？还是具备频率泛化能力？"

---

## 📊 当前状态

### 运行时间戳
```
20251108_022132
```

### 流水线阶段
| 阶段 | 任务 | 状态 | 预计耗时 |
|------|------|------|----------|
| 1 | 8天 WFO 全量运行 | ✅ **运行中** (PID: 67730) | ~1 小时 |
| 2 | 白名单生成 | ⏳ 待完成 | 自动触发 |
| 3 | 全频真实回测 | ⏳ 待完成 | ~1-2 小时 |
| 4 | 频率泛化分析 | ⏳ 待完成 | 5 分钟 |

### 自动化机制
- **监控脚本**已启动（后台运行）
- WFO 完成后会**自动触发**全频回测和分析
- 无需人工干预

---

## 🔧 手动操作命令

### 1. 查看当前状态
```bash
python scripts/check_8d_wfo_status.py
```

### 2. 查看 WFO 实时日志
```bash
tail -f results/logs/wfo_8d_full_20251108_022132.log
```

### 3. 查看监控脚本日志
```bash
tail -f results/logs/monitor_8d_wfo_20251108_022132.log
```

### 4. 检查 WFO 进程是否运行
```bash
ps -p 67730
```

### 5. 手动触发全频回测（如果自动化失败）
```bash
python scripts/auto_8d_wfo_pipeline.py
```

---

## 📈 预期输出文件

### 阶段 1: WFO 结果
```
results/run_20251108_022132/
├── wfo_learned_ranking_20251108_022132.csv  # 全量 WFO 结果（12,597 组合）
├── whitelist_8d_wfo_qualified_20251108_022132.txt  # 合格组合白名单
└── ...
```

### 阶段 3: 全频回测
```
results_combo_wfo/20251108_022132/
└── all_freq_scan_8d_wfo_qualified_20251108_022132.csv  # 白名单组合在 30 频率的表现
```

### 阶段 4: 分析报告
```
results_combo_wfo/20251108_022132/
└── freq_generalization_report_20251108_022132.json  # 频率泛化分析 JSON
```

**报告内容：**
- 各频率的 Sharpe 分布（中位/P20/P80/IQR/>1.0 占比）
- 每个组合的"最佳频率"分布（8天占比多少？）
- 8天 vs 其他频率的秩相关（Spearman）→ **泛化能力指标**
- 泛化质量判断：优秀(>0.7) / 良好(>0.5) / 一般(>0.3) / 差(<0.3)

---

## 🎯 关键验证点

### 乐观情景（8天模型泛化良好）
```
✅ 合格组合数 ≥ 3000
✅ 8天白名单在 16天的中位 Sharpe ≈ 0.60（略低于 8天的 0.64，但仍优秀）
✅ 8天 vs 16天 Spearman ≈ 0.85+（高度一致）
✅ 最佳频率分布：8天占 45%，16天占 30%
→ 结论：8天模型具备频率泛化能力，可作为"统一排序基准"
```

### 悲观情景（8天模型过拟合）
```
❌ 合格组合数 < 1500
❌ 8天白名单在 16天的中位 Sharpe ≈ 0.35（暴跌）
❌ 8天 vs 21天 Spearman ≈ 0.2（接近随机）
❌ 最佳频率分布：24天突然占 40%（异常）
→ 结论：8天模型只适用高频，需改用"多频率集成模型"
```

---

## 📞 故障排查

### WFO 进程意外退出
```bash
# 1. 检查日志最后几行
tail -n 50 results/logs/wfo_8d_full_20251108_022132.log

# 2. 重启 WFO（会跳过已完成的组合）
bash scripts/run_8d_wfo_full.sh
```

### 监控脚本失败
```bash
# 手动触发全频回测
python scripts/auto_8d_wfo_pipeline.py
```

### 全频回测卡住
```bash
# 查看回测日志
tail -f results/logs/all_freq_scan_8d_wfo_20251108_022132.log

# 如果卡死，检查是否内存不足
top -pid $(pgrep -f run_production_backtest)
```

---

## 📊 预计完成时间

| 阶段 | 耗时 | 累计 |
|------|------|------|
| 8天 WFO | ~1 小时 | 1 小时 |
| 白名单生成 | 1 分钟 | 1 小时 |
| 全频回测 | ~1-2 小时 | 2-3 小时 |
| 分析报告 | 5 分钟 | 2-3 小时 |

**总耗时：约 2-3 小时**（全自动，无需人工干预）

---

## ✅ 下一步行动

### WFO 完成后（自动触发）
1. 查看分析报告：`cat results_combo_wfo/20251108_022132/freq_generalization_report_20251108_022132.json`
2. 判断泛化质量（Spearman 中位数）
3. 决策：
   - **泛化良好（>0.7）**：采用 8天模型 + λ=0.15 惩罚，扩容到 Top3000/5000
   - **泛化一般（0.5-0.7）**：仅限 8天频率使用，不跨频率推广
   - **泛化差（<0.5）**：回退多频率集成模型，分别建模

### 人工确认点
- WFO 完成后，检查合格组合数是否合理（预期 3000-5000）
- 全频回测完成后，检查各频率 Sharpe 分布是否符合预期
- 分析报告生成后，阅读泛化质量判断并决定下一步

---

## 📝 备注

- 候选池：12,597 组合（18 因子，combo_sizes=[2,3,4,5]）
- WFO 筛选标准：IC > 0.03, 稳定性 > 0.5
- 全频测试：30 个换仓频率（3/5/6/7/8/9/10/11/12/13/15/16/18/20/21/24/25/30 天等）
- 真实成本：佣金 0.005%（双向），印花税无，滑点 0.05 HKD
- 并行度：8 核（环境变量 n_jobs=-1）

---

## 🔥 关键产物

### 新排序公式（如果泛化通过）
```python
# 生产版（8天 Ridge + 换手惩罚）
score = pred_8d_sharpe_ridge - 0.15 * turnover_proxy_21d
```

### 白名单生成
```python
# 从 8天 Ridge 排序取 TopK
top_combos = ridge_rank.sort_values('score', ascending=False).head(K)['combo']
```

### 固定频率回测
```python
# 固定 8天，TopK=500/1000
RB_TEST_FREQ=8 RB_TOPK=1000 python -m real_backtest.run_production_backtest
```
