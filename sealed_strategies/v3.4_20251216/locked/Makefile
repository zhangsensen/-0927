# é‡åŒ–äº¤æ˜“å¼€å‘ç¯å¢ƒ Makefile
# 
# ğŸ”’ å¼ºåˆ¶ä½¿ç”¨ UV åŒ…ç®¡ç†å™¨ï¼ˆ2025-12-15 æ›´æ–°ï¼‰
# âŒ ç¦æ­¢: pip install, python -m venv, source .venv/bin/activate
# âœ… å¿…é¡»: uv run python <script>, uv sync, uv add/remove
# ğŸ“– è¯¦è§: AGENTS.md é¡¶éƒ¨è¯´æ˜

.PHONY: help install format lint test clean run wfo vec bt verify all

# ============ å¸®åŠ© ============
help:  ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "ETF è½®åŠ¨ç­–ç•¥ç ”ç©¶å¹³å° - å‘½ä»¤åˆ—è¡¨"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# ============ ç¯å¢ƒå®‰è£… ============
install:  ## å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬å¼€å‘ä¾èµ–ï¼‰
	uv sync --dev
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

install-prod:  ## ä»…å®‰è£…ç”Ÿäº§ä¾èµ–
	uv sync
	@echo "âœ… ç”Ÿäº§ä¾èµ–å®‰è£…å®Œæˆ"

# ============ æ ¸å¿ƒå·¥ä½œæµ ============
wfo:  ## è¿è¡Œ WFO ç­›é€‰ï¼ˆ12,597 ç»„åˆï¼‰
	uv run python etf_rotation_optimized/run_combo_wfo.py

vec:  ## è¿è¡Œ VEC æ‰¹é‡å›æµ‹
	uv run python scripts/batch_vec_backtest.py

bt:  ## è¿è¡Œ BT æ‰¹é‡å®¡è®¡
	uv run python scripts/batch_bt_backtest.py

verify:  ## éªŒè¯ VEC/BT å¯¹é½ï¼ˆ< 0.01ppï¼‰
	uv run python scripts/full_vec_bt_comparison.py

all: wfo vec bt verify  ## è¿è¡Œå®Œæ•´å·¥ä½œæµï¼šWFO â†’ VEC â†’ BT â†’ éªŒè¯

# ============ ä»£ç è´¨é‡ ============
format:  ## æ ¼å¼åŒ–ä»£ç ï¼ˆblack + isortï¼‰
	uv run black .
	uv run isort .

lint:  ## è¿è¡Œä»£ç æ£€æŸ¥ï¼ˆflake8 + mypyï¼‰
	uv run flake8 factor_system/ --max-line-length=88 --extend-ignore=E203,W503
	uv run mypy factor_system/ --ignore-missing-imports --no-strict-optional || true

check:  ## è¿è¡Œæ‰€æœ‰è´¨é‡æ£€æŸ¥ï¼ˆpre-commitï¼‰
	uv run pre-commit run --all-files

# ============ æµ‹è¯• ============
test:  ## è¿è¡Œæµ‹è¯•
	uv run pytest -v

test-cov:  ## è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
	uv run pytest --cov=factor_system --cov-report=html --cov-report=term-missing

# ============ æ¸…ç† ============
clean:  ## æ¸…ç†ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	rm -rf .pytest_cache .coverage htmlcov .mypy_cache
	@echo "âœ… ç¼“å­˜æ¸…ç†å®Œæˆ"

clean-all: clean  ## æ·±åº¦æ¸…ç†ï¼ˆåŒ…æ‹¬å› å­ç¼“å­˜ï¼‰
	uv run python scripts/cache_cleaner.py --all
	@echo "âœ… æ·±åº¦æ¸…ç†å®Œæˆ"

# ============ ä¾èµ–ç®¡ç† ============
update-deps:  ## æ›´æ–°æ‰€æœ‰ä¾èµ–
	uv sync --upgrade
	uv lock --upgrade
	@echo "âœ… ä¾èµ–æ›´æ–°å®Œæˆ"

export-requirements:  ## å¯¼å‡º requirements.txtï¼ˆå…¼å®¹æ¨¡å¼ï¼‰
	uv pip compile pyproject.toml -o requirements.txt
	@echo "âœ… requirements.txt å·²å¯¼å‡º"

# ============ å®¡è®¡ä¸ç›‘æ§ ============
audit:  ## å®¡è®¡å€™é€‰æ± ï¼ˆéœ€è¦ RUN_DIR å‚æ•°ï¼‰
	@if [ -z "$(RUN_DIR)" ]; then echo "Usage: make audit RUN_DIR=results/run_YYYYMMDD_HHMMSS"; exit 2; fi
	uv run python scripts/audit_candidate_pool.py --run-dir $(RUN_DIR)

monitor:  ## ç›‘æ§ WFO æ’åè´¨é‡ï¼ˆéœ€è¦ RUN_DIR å‚æ•°ï¼‰
	@if [ -z "$(RUN_DIR)" ]; then echo "Usage: make monitor RUN_DIR=results/run_YYYYMMDD_HHMMSS"; exit 2; fi
	uv run python scripts/monitor_wfo_rank_quality.py --run-dir $(RUN_DIR) --thresholds config/monitor_thresholds.yaml

# ============ å¼€å‘è¾…åŠ© ============
setup-dev: install  ## åˆå§‹åŒ–å¼€å‘ç¯å¢ƒ
	uv run pre-commit install
	@echo "âœ… å¼€å‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"