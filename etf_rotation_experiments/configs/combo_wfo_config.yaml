# =============================================================================
# 排序模式配置 (生产推荐: ML 排序)
# =============================================================================
# 控制 WFO 后如何选择最终的 TopN 组合
#
# method: "ml" (推荐) 或 "wfo" (备用)
#   - "ml":  ✅ 推荐 - 使用已训练的 ML 排序模型
#            A/B 测试验证: Top-200 平均 Sharpe +69%, 年化收益 +7.87%
#            适用于生产环境, 具备良好的泛化能力和风险控制
#
#   - "wfo": ⚠️ 备用 - 使用原始 WFO 指标排序 (mean_oos_ic, oos_sharpe_proxy 等)
#            用于对照基准或 ML 模型不可用时的回退选项
#
# top_n: 最终选出的组合数量 (用于后续回测)
# ml_model_path: ML 模型路径 (无扩展名, 仅当 method="ml" 时使用)
#
# 注意:
#   - ML 模式依赖 ml_ranker/models/ltr_ranker 模型文件
#   - 若 ML 模型缺失或加载失败, 系统会自动回退到 WFO 排序
#   - 如需使用原始 WFO 排序, 只需将 method 改为 "wfo"
#   - 定期 (每季度) 重训模型以适应市场变化: python applications/run_ranking_pipeline.py
# =============================================================================
ranking:
  method: "ml"  # 生产默认: "ml" (ML模型排序) | 备用: "wfo" (原始WFO排序)
  top_n: 2000   # 最终选择的组合数量
  ml_model_path: "strategies/ml_ranker/models/ltr_ranker"  # ML模型路径 (无扩展名)

compatibility:
  legacy_optimized_mode: false
  strict_validation: true
  optimized_config_path: "../../etf_rotation_optimized/configs/combo_wfo_config.yaml"
  notes: "迁移后保持与生产配置一致，必要时可切换 legacy 模式"

backtest:
  commission_rate: 0.00005  # 万0.5（真实ETF场内交易费率，来源于生产配置）
  initial_capital: 1000000
  lookback_window: 252
  rebalance_frequency: 21d
  max_workers: 8
  
  # 网格搜索配置
  # 固化调仓频率：已验证 8 天最优，关闭全频率扫描避免无意义耗时
  test_all_frequencies: false
  test_all_position_sizes: false  # 已验证最优值为4，无需再扫描
  position_size_range: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]

# =============================================================================
# 风控配置 (V10 止损机制)
# =============================================================================
# 设计原则：
#   - 高胜率策略不需要过紧的止损（会产生过多误杀）
#   - 止损的目的是防止单一持仓的灾难性下跌拖累组合
#   - 已通过 WFO 滚动窗口验证，-5% 是收益/回撤的最优平衡点
#
# 参数说明：
#   - etf_stop_loss: 单一ETF止损阈值（从入场价计算）
#   - enabled: 是否启用止损机制
#   - cooldown_days: 止损后冷却期（避免频繁进出）
#
# 注意事项：
#   - 止损触发后，该ETF被移出组合（权重置0），不影响其他持仓
#   - 下一个调仓日重新评估是否买入
#   - 设置过紧（<3%）会导致大量误杀，严重损害胜率
# =============================================================================
risk_control:
  enabled: true
  etf_stop_loss: 0.05  # 5% 止损阈值（WFO验证最优值）
  cooldown_days: 0      # 止损后冷却期（0=下一调仓日可重新买入）

# =============================================================================
# 择时配置 (Light Timing)
# =============================================================================
# 设计原则（来自 1126.md 验证）：
#   - 仅做"防御性减仓"，不做"进攻性加仓"
#   - 复合信号 = 0.4*MA + 0.4*Mom + 0.2*Gold
#   - 阈值 -0.4 触发防御模式，仓位降至 30%
#
# 信号组成：
#   - MA Signal: 沪深300 价格 > MA200 ? 1 : -1
#   - Mom Signal: 沪深300 20日动量 > 0 ? 1 : -1
#   - Gold Signal: 黄金ETF 价格 > MA200 ? 1 : -1
# =============================================================================
timing:
  enabled: true
  type: "light_timing"
  extreme_threshold: -0.4  # 极端市场阈值（触发防御模式）
  extreme_position: 0.3    # 防御模式下的目标仓位

combo_wfo:
  combo_sizes:
  - 2
  - 3
  - 4
  - 5
  enable_fdr: true
  fdr_alpha: 0.05
  fdr_method: fdr_bh
  is_period: 252
  n_jobs: -1
  oos_period: 60
  rebalance_frequencies:
  - 8
  save_all_results: true
  scoring:
    complexity_penalty_lambda: 0.15
    use_robust_scoring: true
  scoring_strategy: ic
  step_size: 60
  top_n: 5000
  verbose: true
cross_section:
  bounded_factors:
  - PRICE_POSITION_20D
  - PRICE_POSITION_120D
  - PV_CORR_20D
  - RSI_14
  winsorize_lower: 0.025
  winsorize_upper: 0.975
data:
  cache_dir: .cache  # 默认指向 etf_rotation_experiments/.cache，支持环境变量 ETF_CACHE_DIR 覆盖
  data_dir: ../raw/ETF/daily  # 相对路径，支持环境变量 ETF_DATA_DIR 覆盖
  end_date: '2025-10-14'
  start_date: '2020-01-01'
  symbols:
  - '159801'
  - '159819'
  - '159859'
  - '159883'
  - '159915'
  - '159920'
  - '159928'
  - '159949'
  - '159992'
  - '159995'
  - '159998'
  - '510050'
  - '510300'
  - '510500'
  - '511010'
  - '511260'
  - '511380'
  - '512010'
  - '512100'
  - '512400'
  - '512480'
  - '512660'
  - '512690'
  - '512720'
  - '512800'
  - '512880'
  - '512980'
  - '513050'
  - '513100'
  - '513130'
  - '513500'
  - '515030'
  - '515180'
  - '515210'
  - '515650'
  - '515790'
  - '516090'
  - '516160'
  - '516520'
  - '518850'
  - '518880'
  - '588000'
  - '588200'
output_root: results_combo_wfo
run_id: COMBO_WFO_DEEP_MINING
