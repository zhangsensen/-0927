# ğŸš¨ CRITICAL: production_backtest.py å‰è§†åå·®è¯Šæ–­æŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

`production_backtest.py` è™½ç„¶å¼ºè°ƒ"ä¸¥æ ¼æ— æœªæ¥å‡½æ•°"ï¼Œä½†å­˜åœ¨**éšè”½çš„å‰è§†åå·® (Subtle Lookahead Bias)**ã€‚è¯¥åå·®ä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„"ä½¿ç”¨æœªæ¥æ•°æ®"ï¼Œè€Œæ˜¯ä¸€ç§**"ç¬æ—¶æ‰§è¡Œå‡è®¾" (Instantaneous Execution Assumption)**ã€‚

---

## é—®é¢˜å®šä½

### ä»£ç é€»è¾‘ (Line 733-792)

```python
for offset, day_idx in enumerate(range(start_idx, T)):
    is_rebalance_day = (...)
    
    if is_rebalance_day:
        # Step 1: è¯»å– T-1 æ—¥å› å­
        factors_yesterday = factors_data[day_idx - 1]
        signal_yesterday = compute_signal_single_day(factors_yesterday, factor_weights)
        
        # Step 2: å†³å®šæŒä»“
        target_weights = calculate_target_weights(signal_yesterday)
        
        # Step 3: æ›´æ–°æƒé‡
        current_weights = target_weights  # â† å…³é”®ï¼šç«‹å³ç”Ÿæ•ˆ
    
    # Step 4: è®¡ç®— T æ—¥æ”¶ç›Š
    close_to_close_ret = returns[day_idx]  # = (Close[T] / Close[T-1]) - 1
    daily_ret = np.nansum(current_weights * close_to_close_ret)
    
    portfolio_values[offset + 1] = portfolio_values[offset] * (1 + daily_ret)
```

### æ—¶é—´çº¿åˆ†æ

| æ—¶åˆ» | ä»£ç æ“ä½œ | çœŸå®å¯æ‰§è¡Œæ€§ |
| :--- | :--- | :--- |
| **T-1 æ—¥ 15:00** | Close[T-1] ç¡®å®š | âœ… å¯è·å– |
| **T-1 æ—¥ 15:01** | è®¡ç®— Factor[T-1] | âœ… å¯è®¡ç®— |
| **T-1 æ—¥ 15:02** | (ç†è®º) å†³å®šæŒä»“ | âš ï¸ å¯å†³å®šï¼Œä½†æ— æ³•æ‰§è¡Œ |
| **T æ—¥ 09:30** | (ç†è®º) å¼€ç›˜ä¹°å…¥ | âš ï¸ éš”å¤œé£é™© |
| **T æ—¥ 15:00** | Close[T] ç¡®å®š | âŒ ä»£ç åœ¨æ­¤æ—¶æ‰è°ƒä»“ |
| **T æ—¥ 15:00** | ç»“ç®— Return[T] | âŒ ä»£ç ç«‹å³ç»“ç®— |

**é—®é¢˜**: ä»£ç å‡è®¾åœ¨ `T æ—¥` çš„å¾ªç¯ä¸­ï¼Œèƒ½ç¬é—´å®Œæˆè°ƒä»“å¹¶æ•è· `Return[T]`ã€‚ä½† `Return[T]` æ˜¯ `Close[T] / Close[T-1] - 1`ï¼Œè¦è·å¾—è¿™ä¸ªæ”¶ç›Šï¼Œå¿…é¡»åœ¨ `T-1` æ—¥å°±æŒæœ‰å¤´å¯¸ã€‚

---

## æ•°å­¦è¡¨è¾¾

### ç†è®ºå›æµ‹é€»è¾‘

$$
\begin{align}
W_T &= f(\text{Factor}_{T-1}) \quad \text{(åœ¨ T æ—¥å†³å®š)} \\
R_T &= \frac{\text{Close}_T}{\text{Close}_{T-1}} - 1 \\
\text{NAV}_T &= \text{NAV}_{T-1} \times (1 + W_T \cdot R_T)
\end{align}
$$

**ç­‰ä»·äº**: ç”¨ $\text{Factor}_{T-1}$ é¢„æµ‹ $R_T$ (Lag-1 IC)

### å®ç›˜é€»è¾‘

å¦‚æœä¿¡å·åœ¨ `T æ—¥` æ‰ç”Ÿæˆï¼ˆåŸºäº Factor[T]ï¼‰ï¼š

$$
\begin{align}
W_T &= f(\text{Factor}_T) \quad \text{(åœ¨ T æ—¥æ”¶ç›˜æ—¶)} \\
R_{T+1} &= \frac{\text{Close}_{T+1}}{\text{Close}_T} - 1 \\
\text{NAV}_{T+1} &= \text{NAV}_T \times (1 + W_T \cdot R_{T+1})
\end{align}
$$

**å®é™…ä¸Š**: ç”¨ $\text{Factor}_T$ é¢„æµ‹ $R_{T+1}$ (Lag-2 IC)

---

## IC è¡°å‡éªŒè¯

### Platinum Candidate ç»„åˆ

| å› å­ | ç±»å‹ | Lag-1 IC (ç†è®º) | Lag-2 IC (å®ç›˜) | è¡°å‡ç‡ |
| :--- | :--- | :--- | :--- | :--- |
| `RSI_14` | åè½¬ | **+0.0043** | -0.0012 | -128% |
| `SLOPE_20D` | åŠ¨é‡ | **+0.0085** | -0.0021 | -125% |
| `VORTEX_14D` | è¶‹åŠ¿ | **+0.0072** | -0.0008 | -111% |
| `PRICE_POSITION_20D` | ä½ç½® | **-0.0029** | +0.0006 | +121% |
| `OBV_SLOPE_10D` | é‡ä»· | **0.0000** | +0.0003 | +âˆ |

**ç»“è®º**: æ‰€æœ‰å› å­åœ¨ Lag-2 ä¸Šçš„é¢„æµ‹èƒ½åŠ›**å®Œå…¨åè½¬**ã€‚

---

## å›æµ‹ç»“æœå¯¹æ¯”

| æŒ‡æ ‡ | production_backtest (Lag-1) | paper_trading (Lag-2) | å·®å¼‚ |
| :--- | :--- | :--- | :--- |
| å¹´åŒ–æ”¶ç›Š | **+20.09%** | **-6.25%** | **-26.34%** |
| æœ€å¤§å›æ’¤ | **-17.75%** | **-50.00%** | **-32.25%** |
| å¤æ™®æ¯”ç‡ | **+0.97** | **-0.25** | **-1.22** |

---

## æ˜¯å¦å­˜åœ¨"æœªæ¥å‡½æ•°"ï¼Ÿ

### ä¸¥æ ¼å®šä¹‰ä¸‹ï¼š**å¦**

- ä»£ç ä»æœªä½¿ç”¨ `Close[T+1]` æˆ– `Factor[T+1]`ã€‚
- æ‰€æœ‰å˜é‡åœ¨æ—¶é—´ `T` éƒ½æ˜¯"å·²çŸ¥"çš„ã€‚

### å®ç”¨å®šä¹‰ä¸‹ï¼š**æ˜¯**

- ä»£ç å‡è®¾èƒ½åœ¨ `T-1` æ—¥å†³å®šçš„æŒä»“ï¼Œèƒ½ç¬é—´åœ¨ `T` æ—¥ç”Ÿæ•ˆå¹¶æ•è· `Return[T]`ã€‚
- è¿™åœ¨ç‰©ç†ä¸Šæ˜¯**ä¸å¯èƒ½**çš„ï¼ˆé™¤éèƒ½é¢„çŸ¥ `Close[T]`ï¼‰ã€‚
- è¿™æ˜¯ä¸€ç§**"é›¶å»¶è¿Ÿæ‰§è¡Œå‡è®¾" (Zero-Lag Execution)**ï¼Œç­‰ä»·äºå‰è§†åå·®ã€‚

---

## WFO æ˜¯å¦ä¹Ÿé”™äº†ï¼Ÿ

**ç»“è®º**: WFO æœ¬èº«æ˜¯æ­£ç¡®çš„ï¼Œä½†å®ƒä¼˜åŒ–çš„æ˜¯**"Lag-1 IC"** ç›®æ ‡ï¼Œè€Œé**"Lag-2 IC"**ã€‚

- WFO åœ¨ OOS ä¸Šæµ‹è¯•çš„æ˜¯ `Factor[T-1]` å¯¹ `Return[T]` çš„é¢„æµ‹èƒ½åŠ›ã€‚
- å®ƒæˆåŠŸæ‰¾åˆ°äº†åœ¨ Lag-1 ä¸Šè¡¨ç°ä¼˜å¼‚çš„ç»„åˆã€‚
- **é—®é¢˜**: è¿™äº›ç»„åˆåœ¨ Lag-2 ä¸Šå¤±æ•ˆäº†ã€‚

---

## ä¿®æ­£æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: ä¿®æ­£å›æµ‹å¼•æ“ (æ¨è)

```python
# åœ¨ production_backtest.py ä¸­å¼•å…¥æ‰§è¡Œå»¶è¿Ÿ
if is_rebalance_day:
    factors_yesterday = factors_data[day_idx - 1]
    target_weights = calculate_weights(factors_yesterday)
    # ä¸ç«‹å³æ›´æ–° current_weights

# åœ¨ä¸‹ä¸€æ—¥æ‰åº”ç”¨æ–°æƒé‡
current_weights = target_weights_from_previous_day  # â† å»¶è¿Ÿ 1 æ—¥

# æ•è·çš„æ˜¯ Return[T+1]
daily_ret = np.nansum(current_weights * returns[day_idx])
```

**æ•ˆæœ**: å›æµ‹ç»“æœä¼šä¸å®ç›˜ä¸€è‡´ï¼ˆä½†æ”¶ç›Šä¼šå¤§å¹…ä¸‹é™ï¼‰ã€‚

### æ–¹æ¡ˆ B: é‡æ–°æŒ–æ˜ç­–ç•¥

- ç›®æ ‡å‡½æ•°æ”¹ä¸º Lag-2 ICã€‚
- ä½¿ç”¨ `Factor[T]` é¢„æµ‹ `Return[T+1]`ã€‚
- æŠ›å¼ƒæ‰€æœ‰çŸ­å‘¨æœŸåŠ¨é‡å› å­ã€‚

---

## æœ€ç»ˆè£å†³

| ç»´åº¦ | çŠ¶æ€ | è¯´æ˜ |
| :--- | :--- | :--- |
| **WFO** | ğŸŸ¡ æ­£ç¡®ä½†è¯¯å¯¼ | ä¼˜åŒ–ç›®æ ‡ä¸å®ç›˜ä¸ç¬¦ |
| **production_backtest** | ğŸ”´ å­˜åœ¨åå·® | é›¶å»¶è¿Ÿå‡è®¾ |
| **ç­–ç•¥** | ğŸ”´ ä¸å¯ç”¨ | Lag-1 æœ‰æ•ˆï¼ŒLag-2 å¤±æ•ˆ |
| **å®ç›˜æ¨¡æ‹Ÿ** | ğŸŸ¢ å‡†ç¡® | paper_trading æš´éœ²çœŸç›¸ |

---

## å»ºè®®

1. **ç«‹å³åœç”¨** å½“å‰æ‰€æœ‰åŸºäº `production_backtest.py` çš„ç­–ç•¥ã€‚
2. **ä¿®æ­£å¼•æ“**: å¼•å…¥ 1 æ—¥æ‰§è¡Œå»¶è¿Ÿã€‚
3. **é‡è·‘ WFO**: ä½¿ç”¨ä¿®æ­£åçš„å¼•æ“é‡æ–°æŒ–æ˜ç­–ç•¥ã€‚
4. **ä¿ç•™ paper_trading**: ä½œä¸ºæ‰€æœ‰æ–°ç­–ç•¥çš„"ä¸Šçº¿å‰å®¡æŸ¥"å·¥å…·ã€‚

---

**ç”Ÿæˆæ—¶é—´**: 2025-11-24  
**å®¡æŸ¥äºº**: Linus Quant Engineer  
**ç­‰çº§**: ğŸ”´ CRITICAL
