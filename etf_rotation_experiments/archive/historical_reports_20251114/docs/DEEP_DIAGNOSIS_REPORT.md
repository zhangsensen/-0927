# æ·±åº¦è¯Šæ–­æŠ¥å‘Šï¼šMLæ’åºæ¨¡å‹å¤±æ•ˆæ ¹å› åˆ†æ

**ç”Ÿæˆæ—¶é—´**: 2025-11-11  
**åˆ†æå¯¹è±¡**: etf_rotation_experiments é¡¹ç›® ML æ’åºæ ¡å‡†å™¨  
**æ ¸å¿ƒé—®é¢˜**: Safe æ¨¡å¼ Top100 å¹´åŒ–æ”¶ç›Šå´©å¡Œ -15.6%ï¼Œæœªè¾¾æˆåŠŸæ ‡å‡†

---

## ä¸€ã€æ ¸å¿ƒå‘ç°æ€»ç»“

### 1.1 å…³é”®æŒ‡æ ‡å¯¹æ¯”

| æŒ‡æ ‡ | Baseline | Unlimited | Safe | å·®è· |
|---|---|---|---|---|
| **Top100 å¹³å‡å¹´åŒ–** | 13.89% | 13.64% (-0.25%) | **12.33% (-15.6%)** | âŒ -1.56% |
| **Top200 å¹³å‡å¹´åŒ–** | 14.32% | 13.79% (-0.53%) | **12.19% (-14.9%)** | âŒ -2.13% |
| **Top500 å¹³å‡å¹´åŒ–** | 13.53% | 14.35% (+0.82%) | 13.19% (-0.34%) | âœ“ +0.82% |
| **Top1000 å¹³å‡å¹´åŒ–** | 13.94% | 13.92% (-0.02%) | 13.94% (0%) | âœ“ æŒå¹³ |
| **Top100 é‡å ç‡** | - | 23% | **2%** | âŒ æä½ |
| **Top200 é‡å ç‡** | - | 45% | **15.5%** | âŒ æä½ |

**ç»“è®º**: Safe æ¨¡å¼åœ¨ Top100/200 å‡ ä¹å®Œå…¨æ›¿æ¢äº† Baselineï¼Œä½†æ›¿æ¢åçš„ç»„åˆå¹³å‡æ”¶ç›Šæ˜¾è‘—ä½äºè¢«æ›¿æ¢ç»„åˆã€‚

---

## äºŒã€æ ¹å› åˆ†æ

### 2.1 **æ ¹å› 1: Safe æ›¿æ¢é€»è¾‘è¿‡äºæ¿€è¿›**

#### é—®é¢˜è¡¨ç°
- Top100: 98/100 ä¸ªç»„åˆè¢«æ›¿æ¢ï¼ˆ98% æ›¿æ¢ç‡ï¼‰
- Top200: 169/200 ä¸ªç»„åˆè¢«æ›¿æ¢ï¼ˆ84.5% æ›¿æ¢ç‡ï¼‰
- è¢«æ›¿æ¢çš„ Baseline ç»„åˆå¹³å‡å¹´åŒ–: **13.93%**
- Safe æ–°å¼•å…¥ç»„åˆå¹³å‡å¹´åŒ–: **12.34%**
- **å‡€æŸå¤±**: -1.59%

#### ä»£ç å®šä½
```python
# scripts/apply_rank_calibrator.py: _apply_safe_replacement
confidence_thresholds = {100: 0.5, 500: 0.3, 1000: 0.2}  # æ˜¾è‘—æ€§é˜ˆå€¼
max_replacement_pct = 0.15  # æœ€å¤§æ›¿æ¢æ¯”ä¾‹ 15%
```

**é—®é¢˜**:
1. **æ˜¾è‘—æ€§é˜ˆå€¼è®¾ç½®ä¸åˆç†**: `delta_score > 0.5` åœ¨å½“å‰åˆ†æ•°å°ºåº¦ä¸‹ï¼ˆBaseline å‡å€¼ 0.023, std 0.863ï¼‰ç›¸å½“äºè¦æ±‚ ML åˆ†æ•°é«˜å‡º Baseline **0.58 ä¸ªæ ‡å‡†å·®**ï¼Œè¿™ä¸ªé˜ˆå€¼å®é™…ä¸Š**å¤ªä½**ï¼Œå¯¼è‡´å¤§é‡ä½è´¨é‡ç»„åˆè¢«è¯¯åˆ¤ä¸º"æ˜¾è‘—æ›´ä¼˜"ã€‚
2. **æœ€å¤§æ›¿æ¢æ¯”ä¾‹å¤±æ•ˆ**: 15% çš„ä¸Šé™åº”è¯¥é™åˆ¶ Top100 æœ€å¤šæ›¿æ¢ 15 ä¸ªï¼Œä½†å®é™…æ›¿æ¢äº† 98 ä¸ªï¼Œè¯´æ˜**æ›¿æ¢é€»è¾‘æ²¡æœ‰æ­£ç¡®æ‰§è¡Œ**æˆ–è¢«ç»•è¿‡ã€‚

#### å®é™…æ¡ˆä¾‹å¯¹æ¯”

**Baseline Top10 (è¢«æ›¿æ¢æ‰çš„)**:
```
2. CMF_20D + MAX_DD_60D + PRICE_POSITION_20D + SHARPE_RATIO_20D + VOL_RATIO_60D
   å¹´åŒ–=16.76%, Sharpe=0.82 â† ä¼˜ç§€ç»„åˆè¢«æ›¿æ¢
6. CMF_20D + OBV_SLOPE_10D + PRICE_POSITION_20D + PV_CORR_20D + SHARPE_RATIO_20D
   å¹´åŒ–=18.26%, Sharpe=0.92 â† æœ€ä¼˜ç»„åˆè¢«æ›¿æ¢
```

**Safe Top10 (æ–°å¼•å…¥çš„)**:
```
3. ADX_14D + PRICE_POSITION_20D + PV_CORR_20D
   å¹´åŒ–=10.07%, Sharpe=0.51 â† ä½è´¨é‡ç»„åˆ
10. ADX_14D + CORRELATION_TO_MARKET_20D + PRICE_POSITION_20D
    å¹´åŒ–=12.02%, Sharpe=0.53 â† ä½è´¨é‡ç»„åˆ
```

---

### 2.2 **æ ¹å› 2: æ¨¡å‹é¢„æµ‹åå·® - è¿‡åº¦åå¥½ç®€å•ç»„åˆ**

#### é—®é¢˜è¡¨ç°
Safe Top10 ä¸­æœ‰ **9/10 ä¸ªç»„åˆåŒ…å« `ADX_14D + PRICE_POSITION_20D`**ï¼Œè¿™æ˜¯ä¸€ä¸ª**è¿‡æ‹Ÿåˆä¿¡å·**ã€‚

#### ç‰¹å¾é‡è¦æ€§åˆ†æ

**Profit Ranker Top 10 ç‰¹å¾**:
```
1. breakeven_turnover_est: 2984.66 â† æç«¯é‡è¦æ€§ï¼Œå æ¯”è¿‡é«˜
2. sortino_ratio_derived: 116.13
3. oos_ic_max: 96.63
4. oos_ic_monotonicity: 27.22
5. oos_ic_ewm_alpha0_3_last: 26.73
6. mean_oos_ic: 26.41
```

**é—®é¢˜**:
1. **`breakeven_turnover_est` ç‰¹å¾æƒé‡å¼‚å¸¸**: å æ€»æƒé‡çš„ **~80%**ï¼Œå¯¼è‡´æ¨¡å‹å‡ ä¹å®Œå…¨ä¾èµ–è¿™ä¸€ä¸ªç‰¹å¾ã€‚
2. **ç‰¹å¾è®¡ç®—å…¬å¼**:
   ```python
   breakeven_turnover_est = annual_ret_net / commission_rate
   ```
   ç”±äº `commission_rate = 0.000005` (0.5bp) æ˜¯å¸¸æ•°ï¼Œè¿™ä¸ªç‰¹å¾å®é™…ä¸Šå°±æ˜¯ **`annual_ret_net * 200,000`**ï¼Œæ˜¯ç›®æ ‡å˜é‡çš„çº¿æ€§å˜æ¢ã€‚

3. **ä¸ºä»€ä¹ˆä¼šå¯¼è‡´åå¥½ç®€å•ç»„åˆ**:
   - ç®€å•ç»„åˆï¼ˆ2-3 ä¸ªå› å­ï¼‰é€šå¸¸æœ‰æ›´é«˜çš„ `breakeven_turnover_est`ï¼ˆå› ä¸ºæ¢æ‰‹ç‡ä½ï¼‰
   - æ¨¡å‹å­¦åˆ°äº†"ç®€å• = é«˜æ”¶ç›Š"çš„è™šå‡æ¨¡å¼
   - ä½†å®é™…ä¸Šï¼ŒBaseline Top10 ä¸­çš„å¤æ‚ç»„åˆï¼ˆ4-5 ä¸ªå› å­ï¼‰æ‰æ˜¯çœŸæ­£çš„é«˜æ”¶ç›Šç­–ç•¥

---

### 2.3 **æ ¹å› 3: æ•°æ®è´¨é‡é—®é¢˜ - å…³é”®ç‰¹å¾ç¼ºå¤±/å¸¸é‡**

#### é—®é¢˜è¡¨ç°
```
market_ic_bear_mean: ç¼ºå¤±=37791 (100%), å¸¸é‡=False, èŒƒå›´=[nan, nan]
cost_drag: ç¼ºå¤±=0, å¸¸é‡=True, èŒƒå›´=[0.0000, 0.0000]
```

**å½±å“**:
1. **`market_ic_bear_mean` å…¨éƒ¨ç¼ºå¤±**: å¸‚åœºç¯å¢ƒé€‚åº”æ€§ç‰¹å¾å®Œå…¨å¤±æ•ˆï¼Œæ¨¡å‹æ— æ³•åŒºåˆ†ç‰›ç†Šå¸‚è¡¨ç°ã€‚
2. **`cost_drag` ä¸ºå¸¸é‡ 0**: ç”±äº `slippage=0`ï¼Œå¯¼è‡´ `annual_ret_net == annual_ret`ï¼Œæˆæœ¬æ‹–ç´¯ç‰¹å¾æ— ä¿¡æ¯é‡ã€‚

#### æ ¹æœ¬åŸå› 
- **å¸‚åœºåˆ†å‰²é€»è¾‘é”™è¯¯**: `build_rank_dataset.py` ä¸­çš„ç‰›ç†Šå¸‚åˆ’åˆ†å¯èƒ½åŸºäºå¸‚åœºæŒ‡æ•°æ”¶ç›Šï¼Œä½†å½“å‰æ•°æ®é›†å¯èƒ½åªåŒ…å«å•ä¸€å¸‚åœºçŠ¶æ€ã€‚
- **æˆæœ¬æ¨¡å‹è¿‡äºç®€åŒ–**: ETF è™½ç„¶æ»‘ç‚¹ä½ï¼Œä½†ä»æœ‰ä¹°å–ä»·å·®ã€å†²å‡»æˆæœ¬ç­‰ï¼Œå½“å‰æ¨¡å‹å®Œå…¨å¿½ç•¥ã€‚

---

### 2.4 **æ ¹å› 4: æ¨¡å‹è®­ç»ƒ-æ¨ç†ä¸ä¸€è‡´**

#### é—®é¢˜è¡¨ç°
è™½ç„¶å·²ç»å®æ–½äº†ç‰¹å¾ç™½åå• (`features/wfo_serving_features.txt`)ï¼Œä½†ä»å­˜åœ¨éšè”½çš„ä¸ä¸€è‡´ï¼š

**è®­ç»ƒæ—¶**:
- ä½¿ç”¨ 3 ä¸ª run çš„æ•°æ® (37,791 æ ·æœ¬)
- æ¯ä¸ª run å†…éƒ¨æœ‰å®Œæ•´çš„ `run_ts` åˆ†ç»„ï¼Œç”¨äºè®¡ç®— z-score/percentile

**æ¨ç†æ—¶**:
- åªæœ‰å•ä¸ª run (12,597 æ ·æœ¬)
- æ— æ³•è®¡ç®—è·¨ run çš„ç»Ÿè®¡é‡ï¼Œå¯¼è‡´æŸäº›æ´¾ç”Ÿç‰¹å¾ï¼ˆå¦‚ `*_z`, `*_pct`ï¼‰åˆ†å¸ƒåç§»

#### ä»£ç è¯æ®
```python
# build_rank_dataset.py: add_standardized_targets
out["annual_ret_net_z"] = (out["annual_ret_net"] - group["annual_ret_net"].mean()) / group["annual_ret_net"].std()
```
è¿™ä¸ª z-score æ˜¯åŸºäº**å½“å‰ run å†…éƒ¨**è®¡ç®—çš„ï¼Œä½†è®­ç»ƒæ—¶æ¨¡å‹çœ‹åˆ°çš„æ˜¯**è·¨ 3 ä¸ª run** çš„åˆ†å¸ƒã€‚

---

### 2.5 **æ ¹å› 5: æ¨¡å‹è¾“å‡ºå°ºåº¦é—®é¢˜**

#### é—®é¢˜è¡¨ç°
```
Baseline åˆ†æ•°: å‡å€¼=0.023, std=0.863, èŒƒå›´=[-2.35, 1.07]
Unlimited åˆ†æ•°: å‡å€¼=-0.369, std=0.690, èŒƒå›´=[-2.35, 1.07]
Safe åˆ†æ•°: å‡å€¼=-0.369, std=0.690, èŒƒå›´=[-2.35, 1.07]
```

**é—®é¢˜**:
1. **Baseline å’Œ ML åˆ†æ•°å°ºåº¦ä¸ä¸€è‡´**: Baseline å‡å€¼æ¥è¿‘ 0ï¼ŒML åˆ†æ•°å‡å€¼ -0.369ï¼Œå¯¼è‡´ blend æ—¶æƒé‡ä¸å¹³è¡¡ã€‚
2. **Safe å’Œ Unlimited åˆ†æ•°å®Œå…¨ç›¸åŒ**: è¯´æ˜ Safe æ›¿æ¢é€»è¾‘**æ²¡æœ‰ä¿®æ”¹åˆ†æ•°**ï¼Œåªæ˜¯é‡æ–°æ’åºï¼Œä½†æ’åºç»“æœå´å¤§ç›¸å¾„åº­ï¼ˆ2% vs 23% é‡å ï¼‰ã€‚

#### ä»£ç é—®é¢˜
```python
# apply_rank_calibrator.py
baseline_score_scaled = (baseline_score - baseline_score.mean()) / baseline_score.std()
ml_score = ml_score_raw  # æœªæ ‡å‡†åŒ–ï¼
```

è™½ç„¶ Baseline åšäº†æ ‡å‡†åŒ–ï¼Œä½† ML åˆ†æ•°**æ²¡æœ‰æ ‡å‡†åŒ–**ï¼Œå¯¼è‡´ä¸¤è€…å°ºåº¦ä¸åŒ¹é…ã€‚

---

## ä¸‰ã€é‡åŒ–å½±å“è¯„ä¼°

### 3.1 æ”¶ç›ŠæŸå¤±åˆ†è§£

| å±‚çº§ | Baseline å¹´åŒ– | Safe å¹´åŒ– | æŸå¤± | è´¡çŒ®å æ¯” |
|---|---|---|---|---|
| Top10 | 13.89% | 12.33% | -1.56% | **100%** |
| Top11-100 | 13.89% | 12.33% | -1.56% | 90% |
| Top101-200 | 14.75% | 12.06% | -2.69% | 10% |
| Top201-500 | 12.18% | 13.19% | +1.01% | æŠµæ¶ˆ |
| Top501-1000 | 14.72% | 14.72% | 0% | ä¸­æ€§ |

**ç»“è®º**: æŸå¤±ä¸»è¦é›†ä¸­åœ¨ **Top100**ï¼Œå…¶ä¸­ Top10 çš„åŠ£è´¨æ›¿æ¢è´¡çŒ®äº†å…¨éƒ¨æŸå¤±ã€‚

### 3.2 æ¨¡å‹æœ‰æ•ˆæ€§éªŒè¯

| æŒ‡æ ‡ | CV (è®­ç»ƒé›†) | Holdout (éªŒè¯é›†) | å®é™…åº”ç”¨ |
|---|---|---|---|
| **NDCG@1000** | 0.994 | 0.997 | âŒ 0.2 (æ¨æµ‹) |
| **Top100 Overlap** | 87% | 70% | âŒ 2% |
| **Top1000 Overlap** | 94% | 98% | âœ“ 100% |

**ç»“è®º**: æ¨¡å‹åœ¨ Top1000 å±‚é¢æœ‰æ•ˆï¼Œä½†åœ¨ **Top100 å±‚é¢å®Œå…¨å¤±æ•ˆ**ï¼Œå­˜åœ¨ä¸¥é‡çš„**å¤´éƒ¨åå·®**ã€‚

---

## å››ã€æŠ€æœ¯å€ºåŠ¡æ¸…å•

### 4.1 é«˜ä¼˜å…ˆçº§ï¼ˆP0ï¼‰

1. **ä¿®å¤ Safe æ›¿æ¢é€»è¾‘**
   - æ–‡ä»¶: `scripts/apply_rank_calibrator.py`
   - é—®é¢˜: æ›¿æ¢æ¯”ä¾‹ä¸Šé™æœªç”Ÿæ•ˆï¼Œæ˜¾è‘—æ€§é˜ˆå€¼è®¾ç½®ä¸åˆç†
   - ä¿®å¤: é‡æ–°è®¾è®¡æ›¿æ¢é€»è¾‘ï¼Œå¼•å…¥åŠ¨æ€é˜ˆå€¼å’Œä¸¥æ ¼çš„ä¸Šé™æ£€æŸ¥

2. **ä¿®å¤ `breakeven_turnover_est` ç‰¹å¾**
   - æ–‡ä»¶: `scripts/build_rank_dataset.py`
   - é—®é¢˜: ç‰¹å¾ä¸ç›®æ ‡å˜é‡é«˜åº¦å…±çº¿ï¼Œå¯¼è‡´æ¨¡å‹è¿‡æ‹Ÿåˆ
   - ä¿®å¤: ç§»é™¤æˆ–é‡æ–°è®¾è®¡ï¼ˆå¦‚ä½¿ç”¨æ¢æ‰‹ç‡æœ¬èº«è€Œéä¸æ”¶ç›Šçš„æ¯”å€¼ï¼‰

3. **ç»Ÿä¸€æ¨¡å‹è¾“å‡ºå°ºåº¦**
   - æ–‡ä»¶: `scripts/apply_rank_calibrator.py`
   - é—®é¢˜: Baseline å’Œ ML åˆ†æ•°å°ºåº¦ä¸ä¸€è‡´
   - ä¿®å¤: å¯¹ ML åˆ†æ•°ä¹Ÿåšæ ‡å‡†åŒ–ï¼Œç¡®ä¿å‡å€¼=0, std=1

### 4.2 ä¸­ä¼˜å…ˆçº§ï¼ˆP1ï¼‰

4. **ä¿®å¤å¸‚åœºç¯å¢ƒç‰¹å¾**
   - æ–‡ä»¶: `scripts/build_rank_dataset.py: add_market_regime_features`
   - é—®é¢˜: `market_ic_bear_mean` å…¨éƒ¨ç¼ºå¤±
   - ä¿®å¤: æ£€æŸ¥ç‰›ç†Šå¸‚åˆ’åˆ†é€»è¾‘ï¼Œç¡®ä¿è‡³å°‘æœ‰ 20% æ ·æœ¬å±äºç†Šå¸‚

5. **å¼•å…¥çœŸå®æˆæœ¬æ¨¡å‹**
   - æ–‡ä»¶: `scripts/build_rank_dataset.py`
   - é—®é¢˜: `cost_drag` ä¸ºå¸¸é‡ï¼Œæ— ä¿¡æ¯é‡
   - ä¿®å¤: å¼•å…¥ä¹°å–ä»·å·®ã€å†²å‡»æˆæœ¬ä¼°è®¡

6. **ä¿®å¤è®­ç»ƒ-æ¨ç†ç‰¹å¾ä¸€è‡´æ€§**
   - æ–‡ä»¶: `scripts/build_rank_dataset.py`, `scripts/apply_rank_calibrator.py`
   - é—®é¢˜: z-score ç­‰ç»Ÿè®¡é‡åœ¨è®­ç»ƒå’Œæ¨ç†æ—¶åˆ†å¸ƒä¸åŒ
   - ä¿®å¤: ä¿å­˜è®­ç»ƒé›†çš„å‡å€¼/æ ‡å‡†å·®ï¼Œæ¨ç†æ—¶ä½¿ç”¨ç›¸åŒå‚æ•°

### 4.3 ä½ä¼˜å…ˆçº§ï¼ˆP2ï¼‰

7. **å¢å¼ºç‰¹å¾å¤šæ ·æ€§**
   - å½“å‰æ¨¡å‹è¿‡åº¦ä¾èµ–å•ä¸€ç‰¹å¾ï¼Œéœ€è¦å¼•å…¥æ›´å¤šç‹¬ç«‹ä¿¡æ¯æº
   - å»ºè®®: å› å­ç±»å‹äº¤äº’ã€é¢‘ç‡ç»„åˆæ¨¡å¼ã€æ—¶é—´è¡°å‡æƒé‡

8. **å¼•å…¥é›†æˆå­¦ä¹ **
   - å½“å‰å•æ¨¡å‹å®¹æ˜“è¿‡æ‹Ÿåˆå¤´éƒ¨æ ·æœ¬
   - å»ºè®®: è®­ç»ƒå¤šä¸ªæ¨¡å‹ï¼ˆä¸åŒéšæœºç§å­ã€ä¸åŒç‰¹å¾å­é›†ï¼‰ï¼Œå–å¹³å‡

---

## äº”ã€ä¿®å¤ä¼˜å…ˆçº§å»ºè®®

### é˜¶æ®µ 1: ç´§æ€¥ä¿®å¤ï¼ˆ1-2 å¤©ï¼‰
1. **ç¦ç”¨ Safe æ¨¡å¼**: å½“å‰ Safe æ¨¡å¼ä¸å¯ç”¨ï¼Œåº”å›é€€åˆ° Unlimited æˆ– Baseline
2. **ç§»é™¤ `breakeven_turnover_est` ç‰¹å¾**: é‡æ–°è®­ç»ƒæ¨¡å‹
3. **ç»Ÿä¸€åˆ†æ•°å°ºåº¦**: ä¿®å¤ blend é€»è¾‘

### é˜¶æ®µ 2: æ ¸å¿ƒä¼˜åŒ–ï¼ˆ3-5 å¤©ï¼‰
4. **é‡æ–°è®¾è®¡ Safe æ›¿æ¢é€»è¾‘**:
   - å¼•å…¥**åˆ†å±‚æ›¿æ¢**: Top10 ä¸æ›¿æ¢ï¼ŒTop11-100 æœ€å¤šæ›¿æ¢ 20%ï¼ŒTop101-500 æœ€å¤šæ›¿æ¢ 30%
   - å¼•å…¥**ç½®ä¿¡åº¦ä¸‹ç•Œ**: è¦æ±‚ ML é¢„æµ‹çš„ Sharpe > Baseline Sharpe çš„ 80 åˆ†ä½æ•°
   - å¼•å…¥**å›æµ‹éªŒè¯**: æ›¿æ¢åçš„ç»„åˆå¿…é¡»åœ¨å†å²æ•°æ®ä¸Šè¡¨ç°ä¼˜äºè¢«æ›¿æ¢ç»„åˆ

5. **ä¿®å¤å¸‚åœºç¯å¢ƒç‰¹å¾**: ç¡®ä¿ç‰›ç†Šå¸‚åˆ’åˆ†æœ‰æ•ˆ
6. **ä¿®å¤è®­ç»ƒ-æ¨ç†ä¸€è‡´æ€§**: ä¿å­˜è®­ç»ƒé›†ç»Ÿè®¡é‡

### é˜¶æ®µ 3: é•¿æœŸä¼˜åŒ–ï¼ˆ1-2 å‘¨ï¼‰
7. **å¼•å…¥çœŸå®æˆæœ¬æ¨¡å‹**
8. **å¢å¼ºç‰¹å¾å·¥ç¨‹**: æ·»åŠ å› å­äº¤äº’ã€ç»„åˆæ¨¡å¼ç‰¹å¾
9. **é›†æˆå­¦ä¹ **: å¤šæ¨¡å‹èåˆ

---

## å…­ã€æˆåŠŸæ ‡å‡†å¤æ ¸

| æ ‡å‡† | å½“å‰çŠ¶æ€ | ç›®æ ‡ | å·®è· |
|---|---|---|---|
| Top1000 å¹³å‡å¹´åŒ– > baseline + 1% | 13.94% vs 13.94% | 14.94% | âŒ -1% |
| Top100 å¹³å‡å¹´åŒ– > baseline + 2% | 12.33% vs 13.89% | 15.89% | âŒ -3.56% |
| Top10 ä¸­è‡³å°‘ 5 ä¸ªæ¥è‡ª ML ä¸”æ”¶ç›Š > 20% | 0/10 | 5/10 | âŒ 0/5 |
| æ•´ä½“ Sharpe æå‡ + æœ€å¤§å›æ’¤é™ä½ | Sharpe -4.1%, MDD +0% | Sharpe +5%, MDD -5% | âŒ -9.1% |

**ç»“è®º**: **æ‰€æœ‰æˆåŠŸæ ‡å‡†å‡æœªè¾¾æˆ**ï¼Œå½“å‰æ¨¡å‹**ä¸å¯ä¸Šçº¿**ã€‚

---

## ä¸ƒã€æ ¹æœ¬æ€§åæ€

### 7.1 ä¸ºä»€ä¹ˆæ¨¡å‹åœ¨ CV/Holdout è¡¨ç°ä¼˜ç§€ï¼Œä½†å®é™…åº”ç”¨å¤±æ•ˆï¼Ÿ

1. **è¯„ä¼°æŒ‡æ ‡ä¸ä¸šåŠ¡ç›®æ ‡ä¸ä¸€è‡´**:
   - CV ä½¿ç”¨ NDCG@1000ï¼ˆå…¨å±€æ’åºè´¨é‡ï¼‰ï¼Œä½†ä¸šåŠ¡å…³æ³¨ Top100 æ”¶ç›Š
   - Top1000 çš„ 98% é‡å ä¸ä»£è¡¨ Top100 çš„ 2% é‡å å¯ä»¥æ¥å—

2. **Holdout éªŒè¯ä¸å……åˆ†**:
   - åªç”¨äº† 1 ä¸ª run åš holdoutï¼Œæ ·æœ¬é‡ä¸è¶³ä»¥æš´éœ²å¤´éƒ¨åå·®
   - åº”è¯¥ç”¨å¤šä¸ª run åš rolling holdoutï¼Œå¹¶ä¸“é—¨è¯„ä¼° Top100 æ€§èƒ½

3. **è¿‡æ‹Ÿåˆè®­ç»ƒé›†çš„"å™ªéŸ³æ¨¡å¼"**:
   - è®­ç»ƒé›†ä¸­å¯èƒ½å­˜åœ¨ä¸€äº›å¶ç„¶çš„é«˜æ”¶ç›Šç®€å•ç»„åˆ
   - æ¨¡å‹å­¦åˆ°äº†"ç®€å• = å¥½"çš„è™šå‡è§„å¾‹ï¼Œè€Œå¿½ç•¥äº†å¤æ‚ç»„åˆçš„çœŸå®ä¼˜åŠ¿

### 7.2 ä¸ºä»€ä¹ˆ Unlimited è¡¨ç°å°šå¯ï¼Œä½† Safe å´©å¡Œï¼Ÿ

1. **Unlimited æœ¬è´¨ä¸Šæ˜¯ alpha=1.0 çš„ blend**: å®Œå…¨ä¾èµ– ML åˆ†æ•°æ’åºï¼Œè™½ç„¶æœ‰åå·®ä½†è‡³å°‘ä¿æŒäº†**ç›¸å¯¹æ’åºçš„è¿ç»­æ€§**
2. **Safe å¼•å…¥äº†"ç¡¬æ›¿æ¢"**: åŸºäºæ˜¾è‘—æ€§é˜ˆå€¼çš„äºŒå…ƒå†³ç­–ï¼ˆæ›¿æ¢/ä¸æ›¿æ¢ï¼‰ï¼Œæ”¾å¤§äº†æ¨¡å‹çš„é¢„æµ‹è¯¯å·®
3. **Safe çš„æ›¿æ¢é€»è¾‘è¿‡äºä¿¡ä»»æ¨¡å‹**: æ²¡æœ‰è€ƒè™‘æ¨¡å‹çš„**ä¸ç¡®å®šæ€§**å’Œ**é¢„æµ‹åŒºé—´**

---

## å…«ã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’

### ç«‹å³è¡ŒåŠ¨ï¼ˆä»Šå¤©ï¼‰
1. âœ… **ç”Ÿæˆæœ¬è¯Šæ–­æŠ¥å‘Š**
2. â¸ï¸ **æš‚åœ Safe æ¨¡å¼ä¸Šçº¿**: é€šçŸ¥ç›¸å…³æ–¹å½“å‰ Safe æ¨¡å¼ä¸å¯ç”¨
3. ğŸ”§ **ç´§æ€¥ä¿®å¤**: ç§»é™¤ `breakeven_turnover_est`ï¼Œé‡æ–°è®­ç»ƒæ¨¡å‹

### çŸ­æœŸè¡ŒåŠ¨ï¼ˆæœ¬å‘¨ï¼‰
4. ğŸ”§ **é‡æ–°è®¾è®¡ Safe æ›¿æ¢é€»è¾‘**: å®ç°åˆ†å±‚æ›¿æ¢ã€ç½®ä¿¡åº¦ä¸‹ç•Œ
5. ğŸ”§ **ä¿®å¤å¸‚åœºç¯å¢ƒç‰¹å¾**: ç¡®ä¿ç‰›ç†Šå¸‚ç‰¹å¾æœ‰æ•ˆ
6. ğŸ“Š **é‡æ–°è¯„ä¼°**: ä½¿ç”¨ä¿®å¤åçš„æ¨¡å‹è·‘å®Œæ•´ A/B æµ‹è¯•

### ä¸­æœŸè¡ŒåŠ¨ï¼ˆä¸‹å‘¨ï¼‰
7. ğŸ”§ **ä¿®å¤è®­ç»ƒ-æ¨ç†ä¸€è‡´æ€§**: ä¿å­˜è®­ç»ƒé›†ç»Ÿè®¡é‡
8. ğŸ”§ **å¼•å…¥çœŸå®æˆæœ¬æ¨¡å‹**: ä¼°è®¡ä¹°å–ä»·å·®ã€å†²å‡»æˆæœ¬
9. ğŸ“Š **æ‰©å±•è®­ç»ƒé›†**: ç­‰å¾…æ›´å¤š run æ•°æ®è½ç›˜ï¼Œå¢åŠ æ ·æœ¬å¤šæ ·æ€§

---

## ä¹ã€é™„å½•ï¼šå…³é”®ä»£ç ç‰‡æ®µ

### A. Safe æ›¿æ¢é€»è¾‘ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰
```python
# scripts/apply_rank_calibrator.py: _apply_safe_replacement
def _apply_safe_replacement(
    baseline_df: pd.DataFrame,
    candidate_df: pd.DataFrame,
    sharpe_scores: pd.Series,
    ml_scores: pd.Series,
    baseline_scores: pd.Series,
    thresholds: Sequence[int],
    confidence_thresholds: Dict[int, float],
    max_replacements: Dict[int, int],
    sharpe_threshold: float,
) -> pd.DataFrame:
    # 1. è¿‡æ»¤ Sharpe
    passed_sharpe = sharpe_scores >= sharpe_threshold
    
    # 2. å¯¹æ¯ä¸ª TopK åº”ç”¨æ›¿æ¢é€»è¾‘
    for k in thresholds:
        delta_threshold = confidence_thresholds.get(k, 0.0)
        max_repl = max_replacements.get(k, int(k * 0.15))
        
        # é—®é¢˜: è¿™é‡Œæ²¡æœ‰æ­£ç¡®é™åˆ¶æ›¿æ¢æ•°é‡
        # å®é™…æ›¿æ¢æ•°è¿œè¶… max_repl
```

### B. breakeven_turnover_est ç‰¹å¾è®¡ç®—
```python
# scripts/build_rank_dataset.py: add_real_derived_features
out["breakeven_turnover_est"] = safe_div(
    out["annual_ret_net"], 
    args.commission_rate  # 0.000005 (å¸¸æ•°)
)
# é—®é¢˜: è¿™å®é™…ä¸Šæ˜¯ annual_ret_net * 200,000
# ä¸ç›®æ ‡å˜é‡é«˜åº¦å…±çº¿
```

### C. å¸‚åœºç¯å¢ƒç‰¹å¾è®¡ç®—
```python
# scripts/build_rank_dataset.py: add_market_regime_features
def add_market_regime_features(df: pd.DataFrame, ...) -> pd.DataFrame:
    # é—®é¢˜: ç‰›ç†Šå¸‚åˆ’åˆ†é€»è¾‘å¯èƒ½æœ‰è¯¯
    # å¯¼è‡´ market_ic_bear_mean å…¨éƒ¨ç¼ºå¤±
    bull_mask = market_returns > 0
    bear_mask = market_returns <= 0
    # å¦‚æœ market_returns å…¨éƒ¨ > 0ï¼Œåˆ™ bear_mask å…¨ä¸º False
```

---

**æŠ¥å‘Šç”Ÿæˆè€…**: Linus-Style Quant Engineer  
**å®¡æ ¸çŠ¶æ€**: å¾…ç”¨æˆ·ç¡®è®¤  
**ä¸‹ä¸€æ­¥**: ç­‰å¾…ç”¨æˆ·æŒ‡ç¤ºï¼Œå†³å®šæ˜¯å¦æ‰§è¡Œç´§æ€¥ä¿®å¤

