# ETF轮动策略优化完整指南

> **文档版本**: v1.0  
> **更新日期**: 2025-11-26  
> **状态**: ✅ 已验证生产就绪

---

## 📋 目录

1. [核心优化目标](#1-核心优化目标)
2. [今日探索历程](#2-今日探索历程)
3. [关键发现与修正](#3-关键发现与修正)
4. [最优配置方案](#4-最优配置方案)
5. [代码架构说明](#5-代码架构说明)
6. [实验记录与对比](#6-实验记录与对比)
7. [重要教训](#7-重要教训)
8. [后续行动计划](#8-后续行动计划)

---

## 1. 核心优化目标

### 1.1 战略方向

我们的核心目标是在 **保持高胜率** 的前提下 **优化回撤控制**，实现：

```text
┌─────────────────────────────────────────────────────────────────┐
│                    策略优化三角平衡                              │
│                                                                 │
│                         收益                                     │
│                          ▲                                       │
│                         /│\                                      │
│                        / │ \                                     │
│                       /  │  \                                    │
│                      /   │   \                                   │
│                     /    │    \                                  │
│                    /     │     \                                 │
│                   ◄──────┴──────►                                │
│                 回撤          胜率                                │
│                                                                 │
│  目标：在胜率~54%的基础上，将回撤从-20%降至-15%，同时保持19%+收益  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 量化目标

| 指标 | 基准值 (无风控) | 目标值 | 最终达成 |
|:-----|:---:|:---:|:---:|
| 年化收益 | 18.5% | ≥18% | ✅ **19.9%** |
| 最大回撤 | -20.3% | ≤-16% | ✅ **-15.3%** |
| Sharpe | 0.91 | ≥1.0 | ✅ **1.03** |
| 胜率 | 53.9% | ≥53% | ✅ **53.9%** |

### 1.3 核心约束

1. **不能过度牺牲收益**：回撤优化不能让年化收益低于15%
2. **不能频繁交易**：换手率需要控制在合理范围
3. **逻辑必须可解释**：风控机制需要有清晰的经济学含义

---

## 2. 今日探索历程

### 2.1 探索路径图

```text
V1-V6: 选股逻辑优化
    │
    ├── 测试多种因子组合
    ├── 确立黄金组合: MOM_20D + RET_VOL_20D + RSI_14
    └── 胜率稳定在 ~54-58%
    │
    ▼
V7-V8: 重度择时测试
    │
    ├── 问题: 严重损害胜率 (58% → 50%)
    └── 结论: 重度择时不可行
    │
    ▼
V9: 轻度择时 (Light Timing) 💡
    │
    ├── 创新: 只在极端市场降仓
    ├── 效率前沿分析: 找到最优参数
    └── 成果: 回撤从-20.3%降至-15.3%，收益反升至19.9%
    │
    ▼
V10: 止损机制探索
    │
    ├── V10.1: 使用简化引擎 ❌ (结果不可靠)
    ├── V10.2: 使用生产引擎 ✅ (结果可靠)
    └── 结论: 止损边际价值很小
    │
    ▼
最终方案: Light Timing (t=-0.4, p=0.3) ✅
```

### 2.2 关键时间线

| 时间 | 动作 | 产出 |
|:-----|:-----|:-----|
| 下午 | V9 效率前沿分析 | 锁定最优 Light Timing 配置 |
| 下午 | V10.1 止损实验 | 发现引擎不一致问题 |
| 下午 | 问题诊断 | 找到简化引擎 vs 生产引擎差异 |
| 下午 | V10.2 修复版 | 确认止损边际价值很小 |
| 下午 | 文档整理 | 完成优化总结 |

---

## 3. 关键发现与修正

### 3.1 重大发现：回测引擎不一致

今天发现了一个 **关键问题**：V10.1 实验使用的简化版回测引擎与 V9 的生产版引擎结果差异巨大！

```text
┌─────────────────────────────────────────────────────────────────┐
│                    两个引擎对比结果                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  简化版引擎 (backtest_with_stoploss_v2)                         │
│  ├── 年化收益: 11.6%                                            │
│  ├── 最大回撤: -31.9%                                           │
│  └── Sharpe:   0.54                                             │
│                                                                 │
│  生产版引擎 (backtest_no_lookahead)                             │
│  ├── 年化收益: 18.5%  ← 差距 7%!                                │
│  ├── 最大回撤: -20.3% ← 差距 11%!                               │
│  └── Sharpe:   0.91   ← 差距 0.37!                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 差异原因分析

| 差异点 | 简化版 | 生产版 |
|:-------|:-------|:-------|
| IC计算 | 每日重算 | 优化缓存 |
| 起始索引 | lookback | lookback+1 |
| 信号计算 | 简化版 | 完整版 |
| 数据对齐 | 可能不一致 | 严格对齐 |

### 3.3 V10.1 错误结论 vs V10.2 正确结论

**V10.1 错误结论（已废弃）**：
> -5% 止损是最优配置，可以在几乎不损失收益的情况下改善回撤

**V10.2 正确结论（已验证）**：
> 止损的边际价值很小！Light Timing 已经非常有效，再叠加止损反而可能损害收益

---

## 4. 最优配置方案

### 4.1 最终推荐配置

```yaml
# ═══════════════════════════════════════════════════════════════
#                    ETF轮动策略 - 最优配置
# ═══════════════════════════════════════════════════════════════

# 选股参数
factors:
  - MOM_20D        # 20日动量
  - RET_VOL_20D    # 20日收益波动率（低波因子）
  - RSI_14         # 14日RSI

rebalance_freq: 8    # 每8个交易日调仓
position_size: 3     # 持仓3只ETF
lookback_window: 252 # 因子计算回看窗口

# 宏观风控 - Light Timing (唯一需要的风控)
timing:
  enabled: true
  type: "light_timing"
  extreme_threshold: -0.4    # 综合评分低于此值时降仓
  extreme_position: 0.3      # 降仓后仓位比例

# 微观风控 - 止损 (不推荐)
stop_loss:
  enabled: false             # 边际价值很小，不启用
  # threshold: -0.10         # 如果要用，建议-10%
```

### 4.2 Light Timing 工作原理

```python
class LightTimingModule:
    """
    轻度择时模块
    
    核心思想：只在市场极度悲观时降仓，其他时间保持满仓
    
    信号计算：
    composite = 0.4 * MA信号 + 0.4 * 动量信号 + 0.2 * 黄金信号
    
    仓位决策：
    if composite < -0.4:
        position = 0.3  # 降至30%仓位
    else:
        position = 1.0  # 保持满仓
    """
    
    def compute_position_ratios(self, close_df):
        ma_signal = self.compute_ma_signal(close_df)      # 均线信号
        mom_signal = self.compute_momentum_signal(close_df)  # 动量信号
        gold_signal = self.compute_gold_signal(close_df)  # 黄金信号
        
        composite = (
            0.4 * ma_signal +
            0.4 * mom_signal +
            0.2 * gold_signal
        )
        
        position_ratios = pd.Series(1.0, index=close_df.index)
        position_ratios[composite < -0.4] = 0.3
        return position_ratios
```

### 4.3 预期表现

| 指标 | 数值 | 说明 |
|:-----|:---:|:-----|
| **年化收益** | 19.9% | 超越基准 18.5% |
| **最大回撤** | -15.3% | 从 -20.3% 改善 5% |
| **Sharpe** | 1.03 | 从 0.91 提升至 >1 |
| **胜率** | 53.9% | 保持不变 |
| **调仓频率** | 8天 | 约46次/年 |

---

## 5. 代码架构说明

### 5.1 核心文件

```text
etf_rotation_experiments/
├── drawdown_optimization_v9.py      # 效率前沿分析 (推荐阅读)
├── drawdown_optimization_v10_v2.py  # 止损验证 (修复版)
└── drawdown_optimization_v10_fixed.py  # 止损验证 (有问题，已废弃)

etf_rotation_optimized/
├── core/
│   ├── data_loader.py               # 数据加载
│   ├── market_timing.py             # 择时模块基类
│   ├── precise_factor_library_v2.py # 因子库
│   └── cross_section_processor.py   # 横截面处理
└── real_backtest/
    └── run_production_backtest.py   # 生产级回测引擎 ⭐
```

### 5.2 关键类和函数

#### `backtest_no_lookahead` (生产引擎)

```python
# 位置: etf_rotation_optimized/real_backtest/run_production_backtest.py
# 用途: 无前视偏差的生产级回测

def backtest_no_lookahead(
    factors_data,          # (T, N, F) 因子数据
    returns,               # (T, N) 收益矩阵
    etf_names,             # ETF名称列表
    rebalance_freq=8,      # 调仓频率
    lookback_window=252,   # 回看窗口
    position_size=3,       # 持仓数量
    commission_rate=0.00005,  # 手续费
    initial_capital=1_000_000.0,
    timing_arr=None,       # 择时仓位数组
    ...
) -> dict:
    """
    特性:
    - IC缓存优化，避免重复计算
    - 严格T+1执行，无前视偏差
    - 支持择时仓位输入
    """
```

#### `LightTimingModule` (轻度择时)

```python
# 位置: 可在 V9/V10 实验文件中找到

class LightTimingModule(MarketTimingModule):
    """
    轻度择时模块
    
    参数:
    - extreme_threshold: 触发降仓的阈值 (默认 -0.4)
    - extreme_position: 降仓后的仓位 (默认 0.3)
    """
```

### 5.3 数据流

```text
┌─────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  ETF数据    │───>│  因子计算        │───>│  横截面标准化   │
│  (36只ETF)  │    │  (MOM/VOL/RSI)   │    │  (z-score)      │
└─────────────┘    └──────────────────┘    └────────┬────────┘
                                                    │
                                                    ▼
┌─────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  NAV曲线    │<───│  回测引擎        │<───│  信号生成       │
│  (业绩曲线) │    │  (含择时)        │    │  (IC加权)       │
└─────────────┘    └──────────────────┘    └─────────────────┘
```

---

## 6. 实验记录与对比

### 6.1 风控方案对比

| 方案 | 年化收益 | 最大回撤 | Sharpe | 评价 |
|:-----|:---:|:---:|:---:|:-----|
| 无风控 | 18.5% | -20.3% | 0.91 | 基准 |
| 重度择时 | 15.2% | -12.1% | 0.82 | 收益损失太大 ❌ |
| 波动率目标 | 16.8% | -14.5% | 0.89 | 中规中矩 |
| **Light Timing** | **19.9%** | **-15.3%** | **1.03** | **最优** ✅ |
| Light+止损(-5%) | 17.4% | -18.3% | 0.92 | 止损反而损害收益 ❌ |

### 6.2 Light Timing 参数敏感性

| threshold | position | 年化收益 | 最大回撤 | Sharpe |
|:---:|:---:|:---:|:---:|:---:|
| -0.3 | 0.3 | 19.1% | -14.8% | 1.00 |
| **-0.4** | **0.3** | **19.9%** | **-15.3%** | **1.03** |
| -0.5 | 0.3 | 18.7% | -17.2% | 0.95 |
| -0.4 | 0.5 | 19.2% | -16.8% | 0.98 |

### 6.3 止损实验结果 (V10.2 正确结果)

| 止损阈值 | 年化收益 | 最大回撤 | Sharpe | 止损次数 |
|:---:|:---:|:---:|:---:|:---:|
| 无 | 19.9% | -15.3% | 1.03 | 0 |
| -3% | 11.0% | -26.4% | 0.61 | 20 |
| -5% | 17.4% | -18.3% | 0.92 | 6 |
| -7% | 19.3% | -15.2% | 1.01 | 3 |
| -10% | 20.2% | -15.2% | 1.04 | 0 |

**结论**: -10% 止损与无止损效果几乎相同（因为很少触发），-5% 止损反而损害收益 2.5%。

---

## 7. 重要教训

### 7.1 回测引擎一致性

```text
╔══════════════════════════════════════════════════════════════════╗
║  🚨 重要教训: 永远使用同一个回测引擎做对比实验！                    ║
╠══════════════════════════════════════════════════════════════════╣
║                                                                  ║
║  今天犯的错误:                                                    ║
║  - V10.1 使用简化版引擎，得到 12.6% 收益基准                       ║
║  - V9 使用生产版引擎，得到 19.9% 收益基准                          ║
║  - 两者差距 7%，导致结论完全错误                                   ║
║                                                                  ║
║  正确做法:                                                        ║
║  - 所有实验统一使用 backtest_no_lookahead 生产引擎                 ║
║  - 修改/新增功能时，在生产引擎基础上扩展                           ║
║  - 不要为了"简化"而重写回测逻辑                                    ║
║                                                                  ║
╚══════════════════════════════════════════════════════════════════╝
```

### 7.2 验证流程

1. **先复现基准**: 任何新实验，先用同样的代码复现已知基准
2. **检查数值一致性**: 基准收益、回撤、Sharpe 都要一致
3. **逐步添加功能**: 在确认基准一致后，再添加新功能
4. **对比差异**: 新功能的影响 = 新结果 - 基准

### 7.3 常见陷阱

| 陷阱 | 表现 | 解决方案 |
|:-----|:-----|:-----|
| 引擎不一致 | 基准收益差距大 | 统一使用生产引擎 |
| 前视偏差 | 回测收益过高 | 使用 `backtest_no_lookahead` |
| 数据泄露 | 样本外表现差 | 严格分离训练/测试 |
| 过拟合 | 参数敏感性高 | 参数网格要粗，不要太细 |

---

## 8. 后续行动计划

### 8.1 短期 (本周)

- [x] 确认 Light Timing 配置 (t=-0.4, p=0.3)
- [x] 修正 V10 实验结论
- [x] 完成优化文档
- [ ] 集成到生产代码

### 8.2 中期 (本月)

- [ ] 实盘小资金测试
- [ ] 监控换手率和滑点
- [ ] 建立业绩追踪机制

### 8.3 长期 (季度)

- [ ] 每季度复盘策略表现
- [ ] 根据市场变化微调参数
- [ ] 探索新因子

---

## 附录 A: 快速命令参考

```bash
# 运行 V9 效率前沿实验
cd /Users/zhangshenshen/深度量化0927/etf_rotation_experiments
python3 drawdown_optimization_v9.py

# 运行 V10.2 止损验证
python3 drawdown_optimization_v10_v2.py

# 查看生产回测引擎
cat ../etf_rotation_optimized/real_backtest/run_production_backtest.py
```

## 附录 B: 相关文件索引

| 文件 | 用途 | 重要性 |
|:-----|:-----|:---:|
| `drawdown_optimization_v9.py` | 效率前沿分析 | ⭐⭐⭐ |
| `drawdown_optimization_v10_v2.py` | 止损验证 (修复版) | ⭐⭐ |
| `run_production_backtest.py` | 生产回测引擎 | ⭐⭐⭐ |
| `market_timing.py` | 择时模块基类 | ⭐⭐ |
| `DAILY_OPTIMIZATION_SUMMARY_20251126.md` | 今日优化摘要 | ⭐⭐ |

---

**文档维护**: 如有更新，请同步修改本文档和 `DAILY_OPTIMIZATION_SUMMARY_20251126.md`。
