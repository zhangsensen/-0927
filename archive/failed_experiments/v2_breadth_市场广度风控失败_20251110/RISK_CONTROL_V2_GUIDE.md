# ETF Rotation V2 - é£æ§å±‚é›†æˆæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

**etf_rotation_v2_breadth** æ˜¯è€é¡¹ç›®ï¼ˆetf_rotation_optimizedï¼‰çš„å®éªŒåˆ†æ”¯ï¼Œé›†æˆäº†**ç¬¬äºŒä»£é£æ§**ï¼š

- ğŸŸ¢ **å¸‚åœºå¹¿åº¦ç›‘æ§** (æ¨è): æœ‰æ•ˆä¿¡å·å æ¯”<25%è§¦å‘é˜²å®ˆï¼ˆé™è‡³50%ä»“ä½ï¼‰
- ğŸŸ¡ **æ³¢åŠ¨ç‡ç›®æ ‡** (è°¨æ…): 20D/60Dæ³¢åŠ¨>30%é™æ æ†ï¼ˆå¸¦æ»åé£é™©ï¼‰
- ğŸ¤· **ç›¸å…³æ€§ç›‘æ§** (ä½ä¼˜å…ˆçº§): å› å­å¹³å‡ç›¸å…³>0.65å‡æƒ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. éªŒè¯é›†æˆï¼ˆå·²å®Œæˆï¼‰

```bash
python3 test_risk_control.py
```

**é¢„æœŸè¾“å‡º**:
```
âœ… é…ç½®åŠ è½½æˆåŠŸ
   - å¸‚åœºå¹¿åº¦: å·²å¯ç”¨
   - æ³¢åŠ¨ç‡ç›®æ ‡: æœªå¯ç”¨
   - ç›¸å…³æ€§ç›‘æ§: æœªå¯ç”¨
âœ… é£æ§æ—¥å¿—ç”ŸæˆæˆåŠŸ: 1379æ¡è®°å½•
   - è§¦å‘é˜²å®ˆå¤©æ•°: 685
   - å¹³å‡ç¼©ä»“æ¯”ä¾‹: 24.2%
```

### 2. è¿è¡Œå®Œæ•´å›æµ‹

#### 2.1 Baselineï¼ˆæ— é£æ§ï¼‰

```bash
# ä½¿ç”¨åŸé…ç½®è¿è¡Œ
python3 run_combo_wfo.py --config configs/run_combo_wfo.yaml
```

#### 2.2 å¸‚åœºå¹¿åº¦ç‰ˆï¼ˆæ¨èï¼‰

ç¼–è¾‘ `configs/run_combo_wfo.yaml`ï¼Œæ·»åŠ ï¼š

```yaml
risk_control:
  market_breadth:
    enabled: true
    breadth_floor: 0.25        # 25%æœ‰æ•ˆä¿¡å·é˜ˆå€¼
    score_threshold: 0.0       # z-scoreæ­£å€¼ä¸ºæœ‰æ•ˆ
    defensive_scale: 0.5       # é˜²å®ˆæ¨¡å¼é™è‡³50%ä»“ä½
    verbose: true
  
  volatility_target:
    enabled: false             # é»˜è®¤å…³é—­ï¼ˆæ»åé£é™©ï¼‰
  
  correlation_monitor:
    enabled: false             # é»˜è®¤å…³é—­ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
  
  combine_strategy: "min"      # å¤šæ¨¡å—å–æœ€å°å€¼
```

é‡æ–°è¿è¡Œï¼š

```bash
python3 run_combo_wfo.py --config configs/run_combo_wfo.yaml
```

#### 2.3 ç»¼åˆç‰ˆï¼ˆä¸‰æ¨¡å—å…¨å¼€ï¼‰

```yaml
risk_control:
  market_breadth:
    enabled: true
    breadth_floor: 0.25
    defensive_scale: 0.5
  
  volatility_target:
    enabled: true
    target_vol: 0.30           # 30%å¹´åŒ–æ³¢åŠ¨ç›®æ ‡
    min_window: 20
    max_scale: 1.0
    min_scale: 0.3
  
  correlation_monitor:
    enabled: true
    corr_threshold: 0.65       # å¹³å‡ç›¸å…³>0.65è§¦å‘
    window: 20
    min_penalty: 0.5
  
  combine_strategy: "multiply"  # ä¸‰è€…ç›¸ä¹˜ï¼ˆæ›´æ¿€è¿›ï¼‰
```

### 3. ç»“æœå¯¹æ¯”

#### æŸ¥çœ‹é£æ§æ—¥å¿—

```bash
# è§¦å‘æ—¶é—´çº¿
head -100 results/YOUR_RUN/wfo/risk_control_log.csv

# ç»Ÿè®¡è§¦å‘ç‡
python3 -c "
import pandas as pd
df = pd.read_csv('results/YOUR_RUN/wfo/risk_control_log.csv')
triggered = df[df['final_scale'] < 1.0]
print(f'è§¦å‘å¤©æ•°: {len(triggered)} / {len(df)} ({len(triggered)/len(df)*100:.1f}%)')
print(f'å¹³å‡ç¼©ä»“: {(1 - triggered[\"final_scale\"].mean())*100:.1f}%')
print(f'æœ€ä½ä»“ä½: {triggered[\"final_scale\"].min()*100:.0f}%')
"
```

#### å¯¹æ¯”æŒ‡æ ‡

| ç‰ˆæœ¬ | å¹´åŒ–æ”¶ç›Š | Sharpe | æœ€å¤§å›æ’¤ | è§¦å‘ç‡ | å¹³å‡ç¼©ä»“ |
|------|---------|--------|---------|--------|---------|
| Baseline | 12.9% | 0.486 | -25% | N/A | N/A |
| å¸‚åœºå¹¿åº¦ | ? | ? | ? | ?% | ?% |
| ç»¼åˆç‰ˆ | ? | ? | ? | ?% | ?% |

## ğŸ”¬ å®éªŒè®¾è®¡åŸåˆ™

### ä¸ºä»€ä¹ˆè¦å¤åˆ¶é¡¹ç›®ï¼Ÿ

1. **ä¿æŠ¤ç”Ÿäº§åŸºçº¿**: è€é¡¹ç›®ï¼ˆetf_rotation_optimizedï¼‰å·²éªŒè¯å¯è¡Œï¼Œä¸èƒ½ç›´æ¥ä¿®æ”¹
2. **éš”ç¦»å®éªŒ**: ç‹¬ç«‹æµ‹è¯•æ–°é£æ§æœºåˆ¶ï¼Œå¤±è´¥ä¸å½±å“åŸç³»ç»Ÿ
3. **A/Bå¯¹æ¯”**: æ¸…æ™°å¯¹æ¯”æœ‰/æ— é£æ§çš„å·®å¼‚

### ä¸‰ä¸ªé£æ§æ¨¡å—çš„ä¼˜å…ˆçº§

#### ğŸŸ¢ å¸‚åœºå¹¿åº¦ï¼ˆé«˜æ¨èï¼‰

**åŸç†**: æ£€æµ‹æœ‰æ•ˆå› å­ä¿¡å·å æ¯”ï¼Œç›´æ¥åˆ¤æ–­æ¨¡å‹æ˜¯å¦å¤±æ•ˆ

**ä¼˜åŠ¿**:
- O(N)å¤æ‚åº¦ï¼Œæ— é¢å¤–è®¡ç®—æˆæœ¬
- æ¯”æ³¢åŠ¨ç‡æ›´æ—©æ•æ‰ä¿¡å·å´©æºƒï¼ˆ2020-02å¼€å§‹è§¦å‘ vs 3æœˆåå¼¹ï¼‰
- ç›´æ¥æ£€æµ‹æ¨¡å‹å¤±æ•ˆè€Œéå¸‚åœºæ³¢åŠ¨

**é£é™©**:
- å¦‚æœå› å­æœ¬èº«æœ‰é—®é¢˜ï¼Œä¼šé¢‘ç¹è¯¯è§¦å‘
- éœ€é…åˆWFOæ»šåŠ¨éªŒè¯ç¡®ä¿å› å­è´¨é‡

**å‚æ•°è°ƒèŠ‚**:
- `breadth_floor`: 0.25ï¼ˆ25%ï¼‰â†’ 0.30ï¼ˆ30%ï¼‰æ›´æ•æ„Ÿ
- `defensive_scale`: 0.5ï¼ˆ50%ï¼‰â†’ 0.3ï¼ˆ30%ï¼‰æ›´æ¿€è¿›é˜²å®ˆ

#### ğŸŸ¡ æ³¢åŠ¨ç‡ç›®æ ‡ï¼ˆè°¨æ…ï¼‰

**åŸç†**: 20D/60Dæ³¢åŠ¨>30%æ—¶é™æ æ†

**é£é™©**:
- **æ»åæ€§**: 2020å¹´3æœˆæš´è·Œåæ³¢åŠ¨é£™å‡ï¼Œä½†æ­¤æ—¶åå¼¹å·²å¼€å§‹ â†’ å¯èƒ½è¸ç©º
- **å¢åŠ äº¤æ˜“æˆæœ¬**: é¢‘ç¹è°ƒæ•´æ æ†
- **å‡é˜³æ€§**: éœ‡è¡å¸‚æ³¢åŠ¨é«˜ä½†ä¸ä¸€å®šéœ€è¦å‡ä»“

**é€‚ç”¨åœºæ™¯**:
- è¶‹åŠ¿å¹³ç¨³ã€å¸Œæœ›æ§åˆ¶æ³¢åŠ¨
- é…åˆå¸‚åœºå¹¿åº¦ä½¿ç”¨ï¼ˆå¹¿åº¦é˜²å®ˆ + æ³¢åŠ¨é™æ æ†ï¼‰

**å‚æ•°è°ƒèŠ‚**:
- `target_vol`: 0.30ï¼ˆ30%ï¼‰â†’ 0.35ï¼ˆ35%ï¼‰é™ä½æ•æ„Ÿåº¦
- `min_scale`: 0.3 â†’ 0.5ï¼ˆä¸è¦é™å¤ªç‹ ï¼‰

#### ğŸ¤· ç›¸å…³æ€§ç›‘æ§ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

**åŸç†**: å› å­å¹³å‡ç›¸å…³>0.65æ—¶å‡æƒ

**ä¸ºä»€ä¹ˆä½ä¼˜å…ˆçº§?**
- è€é¡¹ç›®å·²æœ‰**é™æ€ç›¸å…³æ€§å»å†—**ï¼ˆ>0.8å‰”é™¤ï¼‰
- åŠ¨æ€ç‰ˆæ”¹å–„æœ‰é™ï¼ˆå› å­é›†å·²ä¼˜åŒ–ï¼‰
- O(FÂ²Ã—T)å¤æ‚åº¦ï¼Œè®¡ç®—æˆæœ¬é«˜

**é€‚ç”¨åœºæ™¯**:
- å› å­é›†æœªåšç›¸å…³æ€§æ¸…æ´—çš„ç³»ç»Ÿ
- ç ”ç©¶ç”¨é€”ï¼ˆè§‚å¯Ÿå› å­çƒ­èšé›†ç°è±¡ï¼‰

## ğŸ“Š å…³é”®æ–‡ä»¶

```
etf_rotation_v2_breadth/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ market_breadth.py        # å¸‚åœºå¹¿åº¦ç›‘æ§å™¨ï¼ˆ148è¡Œï¼‰
â”‚   â”œâ”€â”€ volatility_target.py     # æ³¢åŠ¨ç‡ç›®æ ‡ç®¡ç†å™¨ï¼ˆ171è¡Œï¼‰
â”‚   â”œâ”€â”€ correlation_monitor.py   # ç›¸å…³æ€§ç›‘æ§å™¨ï¼ˆ198è¡Œï¼‰
â”‚   â””â”€â”€ pipeline.py              # ä¸»æµæ°´çº¿ï¼ˆå·²é›†æˆé£æ§å±‚ï¼‰
â”œâ”€â”€ configs/
â”‚   â”œâ”€â”€ risk_control_v2.yaml     # é£æ§é…ç½®æ¨¡æ¿ï¼ˆ93è¡Œï¼‰
â”‚   â””â”€â”€ run_combo_wfo.yaml       # ä¸»é…ç½®ï¼ˆéœ€æ·»åŠ risk_controlæ®µï¼‰
â”œâ”€â”€ test_risk_control.py         # é›†æˆæµ‹è¯•è„šæœ¬
â”œâ”€â”€ RISK_CONTROL_V2_GUIDE.md     # æœ¬æ–‡æ¡£
â””â”€â”€ results/
    â””â”€â”€ YOUR_RUN/
        â””â”€â”€ wfo/
            â”œâ”€â”€ risk_control_log.csv   # æ¯æ—¥é£æ§è§¦å‘è®°å½•
            â”œâ”€â”€ wfo_summary.csv        # WFOçª—å£ç»Ÿè®¡
            â””â”€â”€ window_results.json    # WFOè¯¦ç»†ç»“æœ
```

## ğŸ› ï¸ å·¥ç¨‹åŸåˆ™ï¼ˆLinusæ¨¡å¼ï¼‰

1. **å‘é‡åŒ–ä¼˜å…ˆ**: æ‰€æœ‰è®¡ç®—â‰¥95%å‘é‡åŒ–ï¼Œæ— .apply()
2. **æ˜ç¡®å¤æ‚åº¦**: æ¯ä¸ªæ–¹æ³•æ³¨æ˜O(N)æˆ–O(FÂ²Ã—T)
3. **å‡½æ•°çŸ­å°**: <50è¡Œï¼Œ3å±‚ç¼©è¿›é™åˆ¶
4. **æ¸…æ™°æ³¨é‡Š**: é£é™©è­¦å‘Šã€å‚æ•°è¯´æ˜ã€ä½¿ç”¨åœºæ™¯
5. **å¯æµ‹è¯•**: ç‹¬ç«‹æ¨¡å—ï¼Œæ˜“äºå•å…ƒæµ‹è¯•

## â“ FAQ

### Q1: ä¸ºä»€ä¹ˆ2020å¹´åˆå¸‚åœºå¹¿åº¦å…¨æ˜¯0%ï¼Ÿ

**A**: å› ä¸ºæµ‹è¯•ç”¨çš„æ˜¯2021-01-01èµ·çš„æ•°æ®ï¼Œä½†WFOéœ€è¦126å¤©ISæœŸï¼Œæ‰€ä»¥2020-02å¼€å§‹æ‰æœ‰å› å­å¾—åˆ†ã€‚è¿™æ®µæ—¶é—´å› å­æœªé€‰å®šï¼ˆweightså…¨0ï¼‰ï¼Œå¯¼è‡´å¤åˆå¾—åˆ†ä¸º0ã€‚

**è§£å†³**: ç”Ÿäº§ç¯å¢ƒç”¨2018-01-01èµ·çš„å®Œæ•´æ•°æ®ï¼Œwarmupåè‡ªç„¶æœ‰æ•ˆã€‚

### Q2: å¦‚ä½•åˆ¤æ–­é£æ§æ˜¯å¦æ”¹å–„äº†é•¿å°¾æŸå¤±ï¼Ÿ

**å¯¹æ¯”æŒ‡æ ‡**:
1. **æœ€å¤§å›æ’¤**: æœ‰é£æ§åº”æ›´å°
2. **å›æ’¤æ·±åº¦åˆ†å¸ƒ**: æŸ¥çœ‹>20%çš„æç«¯å›æ’¤æ¬¡æ•°
3. **2020å¹´3æœˆè¡¨ç°**: æ˜¯å¦æå‰é˜²å®ˆvsè¸ç©ºåå¼¹
4. **å¹´åŒ–æ”¶ç›Š**: ä¸åº”ä¸‹é™å¤ªå¤šï¼ˆå®¹å¿-2~3%ï¼‰
5. **Sharpeæ¯”ç‡**: åº”æå‡ï¼ˆæ”¶ç›Š/æ³¢åŠ¨æ”¹å–„ï¼‰

**è„šæœ¬**:
```python
import pandas as pd
import matplotlib.pyplot as plt

# åŠ è½½æ—¥å¿—
df = pd.read_csv('results/YOUR_RUN/wfo/risk_control_log.csv')
df['date'] = pd.to_datetime(df['date'])
df = df.set_index('date')

# å¯¹æ¯”2020å¹´3æœˆè§¦å‘
crisis = df['2020-02':'2020-04']
print(f"å±æœºæœŸé—´è§¦å‘: {(crisis['final_scale'] < 1.0).sum()} / {len(crisis)} å¤©")
print(f"å¹³å‡ä»“ä½: {crisis['final_scale'].mean():.0%}")

# å¯è§†åŒ–
plt.figure(figsize=(14, 6))
plt.plot(df.index, df['final_scale'], label='Position Scale')
plt.axhline(1.0, color='gray', linestyle='--', alpha=0.5)
plt.axhline(0.5, color='red', linestyle='--', alpha=0.5)
plt.fill_between(df.index, df['final_scale'], 1.0, 
                 where=(df['final_scale'] < 1.0), 
                 color='orange', alpha=0.3, label='Defense Mode')
plt.legend()
plt.title('é£æ§è§¦å‘æ—¶é—´çº¿')
plt.tight_layout()
plt.savefig('risk_control_timeline.png', dpi=150)
```

### Q3: å¦‚æœå¸‚åœºå¹¿åº¦é¢‘ç¹è¯¯è§¦å‘æ€ä¹ˆåŠï¼Ÿ

**è¯Šæ–­**:
1. æ£€æŸ¥å› å­ICè´¨é‡ï¼š`wfo_summary.csv`ä¸­`oos_ic`æ˜¯å¦<0.01
2. æŸ¥çœ‹`window_results.json`ä¸­`selected_factors`æ˜¯å¦ç¨³å®š
3. å¯¹æ¯”ä¸åŒ`breadth_floor`ï¼ˆ0.20/0.25/0.30ï¼‰çš„è§¦å‘ç‡

**è°ƒèŠ‚**:
- é™ä½æ•æ„Ÿåº¦ï¼š`breadth_floor: 0.20`ï¼ˆ20%é˜ˆå€¼ï¼‰
- æé«˜å¾—åˆ†é—¨æ§›ï¼š`score_threshold: 0.1`ï¼ˆæ›´é«˜çš„z-scoreï¼‰
- è°ƒæ•´é˜²å®ˆåŠ›åº¦ï¼š`defensive_scale: 0.7`ï¼ˆé™è‡³70%è€Œé50%ï¼‰

### Q4: ä¸‹ä¸€æ­¥è®¡åˆ’ï¼Ÿ

1. **å®Œæ•´å›æµ‹å¯¹æ¯”**ï¼ˆbaseline vs å¸‚åœºå¹¿åº¦ vs ç»¼åˆï¼‰
2. **å‚æ•°ç½‘æ ¼æœç´¢**ï¼ˆbreadth_floor: 0.15-0.35, defensive_scale: 0.3-0.7ï¼‰
3. **é•¿å°¾æŸå¤±åˆ†æ**ï¼ˆ>20%å›æ’¤çš„æ¬¡æ•°å’Œæ·±åº¦ï¼‰
4. **2020å±æœºæœŸéªŒè¯**ï¼ˆé˜²å®ˆvsè¸ç©ºçš„trade-offï¼‰
5. **å¦‚æœéªŒè¯æˆåŠŸ**ï¼šåˆå¹¶åˆ°ä¸»é¡¹ç›®ï¼ˆæˆ–å»ºè®®åªå¯ç”¨å¸‚åœºå¹¿åº¦ï¼‰

## ğŸ“š å‚è€ƒ

- **è€é¡¹ç›®å®¡æ ¸**: å‘ç°éšæ€§å‰ç½®é£æ§æœºåˆ¶ï¼ˆWinsorize + ç›¸å…³å»å†— + ICåŠ æƒï¼‰
- **è‡ªé€‚åº”é¡¹ç›®æ•™è®­**: æ˜¾å¼æ­¢æŸæ­¢ç›ˆç ´ååŠ¨é‡ï¼ˆå¹´åŒ–4.34% vs 12.9%ï¼‰
- **Linuså·¥ç¨‹åŸåˆ™**: "Talk is cheap, show me the code" - ç”¨å›æµ‹éªŒè¯è€Œéç†è®ºæ¨å¯¼

---

**ä½œè€…**: GitHub Copilot  
**ç‰ˆæœ¬**: V2.0  
**æœ€åæ›´æ–°**: 2025-11-10
