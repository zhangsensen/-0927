#!/usr/bin/env python3
"""
Ê∏ÖÁêÜFactorEngine‰∏≠‰∏çÁ¨¶Âêà‰∏ÄËá¥ÊÄßË¶ÅÊ±ÇÁöÑÂõ†Â≠ê
"""

import os
import shutil


def get_valid_factor_files():
    """Ëé∑ÂèñÁ¨¶Âêà‰∏ÄËá¥ÊÄßË¶ÅÊ±ÇÁöÑÂõ†Â≠êÊñá‰ª∂Ê∏ÖÂçï"""

    # Âü∫‰∫éfactor_generation‰∏≠ÂÆûÈôÖÂ≠òÂú®ÁöÑÂõ†Â≠ê
    # Ëøô‰∫õÂõ†Â≠êÂØπÂ∫îÁöÑFactorEngineÊñá‰ª∂Â∫îËØ•‰øùÁïô
    valid_factor_files = {
        # technicalÁõÆÂΩï - Ê†∏ÂøÉÊäÄÊúØÊåáÊ†á
        "rsi.py",
        "macd.py",
        "stoch.py",
        "willr.py",
        "atr.py",
        "cci.py",
        "mfi.py",
        "adx.py",
        "obv.py",
        "mom.py",
        "roc.py",
        "trix.py",
        "ultosc.py",
        "stochf.py",
        "stochrsi.py",
        "trange.py",
        "adxr.py",
        "apo.py",
        "aroon.py",
        "aroonosc.py",
        "bop.py",
        "cmo.py",
        "dx.py",
        "minus_di.py",
        "minus_dm.py",
        "natr.py",
        "plus_di.py",
        "plus_dm.py",
        "ppo.py",
        "rocp.py",
        "rocr.py",
        "rocr100.py",
        # overlapÁõÆÂΩï - ÁßªÂä®Âπ≥ÂùáÁ±ªÊåáÊ†á
        "sma.py",
        "ema.py",
        "bbands.py",
        "dema.py",
        "tema.py",
        "trima.py",
        "wma.py",
        "kama.py",
        "mama.py",
        "t3.py",
        "midpoint.py",
        "midprice.py",
        "sar.py",
        "sarext.py",
    }

    return valid_factor_files


def cleanup_factor_engine():
    """Ê∏ÖÁêÜFactorEngine‰∏≠‰∏çÁ¨¶ÂêàË¶ÅÊ±ÇÁöÑÂõ†Â≠ê"""

    base_path = "/Users/zhangshenshen/Ê∑±Â∫¶ÈáèÂåñ0927/factor_system/factor_engine/factors"
    valid_files = get_valid_factor_files()

    removed_files = []
    kept_files = []

    # Ê∏ÖÁêÜtechnicalÁõÆÂΩï
    tech_path = os.path.join(base_path, "technical")
    if os.path.exists(tech_path):
        for file in os.listdir(tech_path):
            if file.endswith(".py") and file != "__init__.py":
                if file not in valid_files:
                    file_path = os.path.join(tech_path, file)
                    removed_files.append(file_path)
                    print(f"üóëÔ∏è  Âà†Èô§technical: {file}")
                else:
                    kept_files.append(f"technical/{file}")

    # Ê∏ÖÁêÜoverlapÁõÆÂΩï
    overlap_path = os.path.join(base_path, "overlap")
    if os.path.exists(overlap_path):
        for file in os.listdir(overlap_path):
            if file.endswith(".py") and file != "__init__.py":
                if file not in valid_files:
                    file_path = os.path.join(overlap_path, file)
                    removed_files.append(file_path)
                    print(f"üóëÔ∏è  Âà†Èô§overlap: {file}")
                else:
                    kept_files.append(f"overlap/{file}")

    return removed_files, kept_files


def update_init_files():
    """Êõ¥Êñ∞__init__.pyÊñá‰ª∂ÔºåÂè™ÂåÖÂê´ÊúâÊïàÁöÑÂõ†Â≠ê"""

    # Êõ¥Êñ∞technical/__init__.py
    tech_init_path = "/Users/zhangshenshen/Ê∑±Â∫¶ÈáèÂåñ0927/factor_system/factor_engine/factors/technical/__init__.py"
    valid_tech_imports = [
        "from factor_system.factor_engine.factors.technical.ad import AD",
        "from factor_system.factor_engine.factors.technical.adosc import ADOSC",
        "from factor_system.factor_engine.factors.technical.adx import ADX",
        "from factor_system.factor_engine.factors.technical.adxr import ADXR",
        "from factor_system.factor_engine.factors.technical.apo import APO",
        "from factor_system.factor_engine.factors.technical.aroon import AROON",
        "from factor_system.factor_engine.factors.technical.aroonosc import AROONOSC",
        "from factor_system.factor_engine.factors.technical.atr import ATR",
        "from factor_system.factor_engine.factors.technical.bop import BOP",
        "from factor_system.factor_engine.factors.technical.cci import CCI",
        "from factor_system.factor_engine.factors.technical.cmo import CMO",
        "from factor_system.factor_engine.factors.technical.dx import DX",
        "from factor_system.factor_engine.factors.technical.macd import MACD, MACDSignal, MACDHistogram",
        "from factor_system.factor_engine.factors.technical.mfi import MFI",
        "from factor_system.factor_engine.factors.technical.minus_di import MINUS_DI",
        "from factor_system.factor_engine.factors.technical.minus_dm import MINUS_DM",
        "from factor_system.factor_engine.factors.technical.mom import MOM",
        "from factor_system.factor_engine.factors.technical.natr import NATR",
        "from factor_system.factor_engine.factors.technical.obv import OBV",
        "from factor_system.factor_engine.factors.technical.plus_di import PLUS_DI",
        "from factor_system.factor_engine.factors.technical.plus_dm import PLUS_DM",
        "from factor_system.factor_engine.factors.technical.ppo import PPO",
        "from factor_system.factor_engine.factors.technical.roc import ROC",
        "from factor_system.factor_engine.factors.technical.rocp import ROCP",
        "from factor_system.factor_engine.factors.technical.rocr import ROCR",
        "from factor_system.factor_engine.factors.technical.rocr100 import ROCR100",
        "from factor_system.factor_engine.factors.technical.rsi import RSI",
        "from factor_system.factor_engine.factors.technical.stoch import STOCH",
        "from factor_system.factor_engine.factors.technical.stochf import STOCHF",
        "from factor_system.factor_engine.factors.technical.stochrsi import STOCHRSI",
        "from factor_system.factor_engine.factors.technical.trange import TRANGE",
        "from factor_system.factor_engine.factors.technical.trix import TRIX",
        "from factor_system.factor_engine.factors.technical.ultosc import ULTOSC",
        "from factor_system.factor_engine.factors.technical.willr import WILLR",
    ]

    # Êõ¥Êñ∞overlap/__init__.py
    overlap_init_path = "/Users/zhangshenshen/Ê∑±Â∫¶ÈáèÂåñ0927/factor_system/factor_engine/factors/overlap/__init__.py"
    valid_overlap_imports = [
        "from factor_system.factor_engine.factors.overlap.bbands import BBANDS",
        "from factor_system.factor_engine.factors.overlap.dema import DEMA",
        "from factor_system.factor_engine.factors.overlap.ema import EMA",
        "from factor_system.factor_engine.factors.overlap.kama import KAMA",
        "from factor_system.factor_engine.factors.overlap.mama import MAMA",
        "from factor_system.factor_engine.factors.overlap.midpoint import MIDPOINT",
        "from factor_system.factor_engine.factors.overlap.midprice import MIDPRICE",
        "from factor_system.factor_engine.factors.overlap.sar import SAR",
        "from factor_system.factor_engine.factors.overlap.sarext import SAREXT",
        "from factor_system.factor_engine.factors.overlap.sma import SMA",
        "from factor_system.factor_engine.factors.overlap.t3 import T3",
        "from factor_system.factor_engine.factors.overlap.tema import TEMA",
        "from factor_system.factor_engine.factors.overlap.trima import TRIMA",
        "from factor_system.factor_engine.factors.overlap.wma import WMA",
    ]

    return valid_tech_imports, valid_overlap_imports


def write_new_init_files():
    """ÂÜôÂÖ•Êñ∞ÁöÑ__init__.pyÊñá‰ª∂"""

    # ÂÜôÂÖ•technical/__init__.py
    tech_init_content = '''"""ÊäÄÊúØÊåáÊ†áÂõ†Â≠ê"""

from factor_system.factor_engine.factors.technical.ad import AD
from factor_system.factor_engine.factors.technical.adosc import ADOSC
from factor_system.factor_engine.factors.technical.adx import ADX
from factor_system.factor_engine.factors.technical.adxr import ADXR
from factor_system.factor_engine.factors.technical.apo import APO
from factor_system.factor_engine.factors.technical.aroon import AROON
from factor_system.factor_engine.factors.technical.aroonosc import AROONOSC
from factor_system.factor_engine.factors.technical.atr import ATR
from factor_system.factor_engine.factors.technical.bop import BOP
from factor_system.factor_engine.factors.technical.cci import CCI
from factor_system.factor_engine.factors.technical.cmo import CMO
from factor_system.factor_engine.factors.technical.dx import DX
from factor_system.factor_engine.factors.technical.macd import MACD, MACDSignal, MACDHistogram
from factor_system.factor_engine.factors.technical.mfi import MFI
from factor_system.factor_engine.factors.technical.minus_di import MINUS_DI
from factor_system.factor_engine.factors.technical.minus_dm import MINUS_DM
from factor_system.factor_engine.factors.technical.mom import MOM
from factor_system.factor_engine.factors.technical.natr import NATR
from factor_system.factor_engine.factors.technical.obv import OBV
from factor_system.factor_engine.factors.technical.plus_di import PLUS_DI
from factor_system.factor_engine.factors.technical.plus_dm import PLUS_DM
from factor_system.factor_engine.factors.technical.ppo import PPO
from factor_system.factor_engine.factors.technical.roc import ROC
from factor_system.factor_engine.factors.technical.rocp import ROCP
from factor_system.factor_engine.factors.technical.rocr import ROCR
from factor_system.factor_engine.factors.technical.rocr100 import ROCR100
from factor_system.factor_engine.factors.technical.rsi import RSI
from factor_system.factor_engine.factors.technical.stoch import STOCH
from factor_system.factor_engine.factors.technical.stochf import STOCHF
from factor_system.factor_engine.factors.technical.stochrsi import STOCHRSI
from factor_system.factor_engine.factors.technical.trange import TRANGE
from factor_system.factor_engine.factors.technical.trix import TRIX
from factor_system.factor_engine.factors.technical.ultosc import ULTOSC
from factor_system.factor_engine.factors.technical.willr import WILLR

__all__ = ['AD', 'ADOSC', 'ADX', 'ADXR', 'APO', 'AROON', 'AROONOSC', 'ATR', 'BOP', 'CCI', 'CMO', 'DX', 'MACD', 'MACDSignal', 'MACDHistogram', 'MFI', 'MINUS_DI', 'MINUS_DM', 'MOM', 'NATR', 'OBV', 'PLUS_DI', 'PLUS_DM', 'PPO', 'ROC', 'ROCP', 'ROCR', 'ROCR100', 'RSI', 'STOCH', 'STOCHF', 'STOCHRSI', 'TRANGE', 'TRIX', 'ULTOSC', 'WILLR']
'''

    # ÂÜôÂÖ•overlap/__init__.py
    overlap_init_content = '''"""ÁßªÂä®Âπ≥Âùá‰∏éË¶ÜÁõñÊåáÊ†á"""

from factor_system.factor_engine.factors.overlap.bbands import BBANDS
from factor_system.factor_engine.factors.overlap.dema import DEMA
from factor_system.factor_engine.factors.overlap.ema import EMA
from factor_system.factor_engine.factors.overlap.kama import KAMA
from factor_system.factor_engine.factors.overlap.mama import MAMA
from factor_system.factor_engine.factors.overlap.midpoint import MIDPOINT
from factor_system.factor_engine.factors.overlap.midprice import MIDPRICE
from factor_system.factor_engine.factors.overlap.sar import SAR
from factor_system.factor_engine.factors.overlap.sarext import SAREXT
from factor_system.factor_engine.factors.overlap.sma import SMA
from factor_system.factor_engine.factors.overlap.t3 import T3
from factor_system.factor_engine.factors.overlap.tema import TEMA
from factor_system.factor_engine.factors.overlap.trima import TRIMA
from factor_system.factor_engine.factors.overlap.wma import WMA

__all__ = ['BBANDS', 'DEMA', 'EMA', 'KAMA', 'MAMA', 'MIDPOINT', 'MIDPRICE', 'SAR', 'SAREXT', 'SMA', 'T3', 'TEMA', 'TRIMA', 'WMA']
'''

    # ÂÜôÂÖ•Êñá‰ª∂
    with open(
        "/Users/zhangshenshen/Ê∑±Â∫¶ÈáèÂåñ0927/factor_system/factor_engine/factors/technical/__init__.py",
        "w",
        encoding="utf-8",
    ) as f:
        f.write(tech_init_content)

    with open(
        "/Users/zhangshenshen/Ê∑±Â∫¶ÈáèÂåñ0927/factor_system/factor_engine/factors/overlap/__init__.py",
        "w",
        encoding="utf-8",
    ) as f:
        f.write(overlap_init_content)

    print("‚úÖ Â∑≤Êõ¥Êñ∞technical/__init__.pyÂíåoverlap/__init__.py")


def main():
    """‰∏ªÂáΩÊï∞"""
    print("üîß ÂºÄÂßãÊ∏ÖÁêÜFactorEngine‰∏≠‰∏çÁ¨¶Âêà‰∏ÄËá¥ÊÄßË¶ÅÊ±ÇÁöÑÂõ†Â≠ê...")

    # 1. ÂàÜÊûêÈúÄË¶ÅÂà†Èô§ÁöÑÊñá‰ª∂
    print("\nüìã ÂàÜÊûêË¶ÅÂà†Èô§ÁöÑÊñá‰ª∂...")
    removed_files, kept_files = cleanup_factor_engine()

    # 2. ÂÆûÈôÖÂà†Èô§Êñá‰ª∂
    print(f"\nüóëÔ∏è  Âà†Èô§ {len(removed_files)} ‰∏™Êñá‰ª∂...")
    for file_path in removed_files:
        if os.path.exists(file_path):
            os.remove(file_path)
            print(f"  ‚úÖ Â∑≤Âà†Èô§: {os.path.basename(file_path)}")

    # 3. Êõ¥Êñ∞__init__.pyÊñá‰ª∂
    print(f"\nüìù Êõ¥Êñ∞__init__.pyÊñá‰ª∂...")
    write_new_init_files()

    # 4. ÁîüÊàêÊ∏ÖÁêÜÊä•Âëä
    print(f"\nüìä Ê∏ÖÁêÜÊä•Âëä:")
    print(f"  - Âà†Èô§Êñá‰ª∂: {len(removed_files)} ‰∏™")
    print(f"  - ‰øùÁïôÊñá‰ª∂: {len(kept_files)} ‰∏™")
    print(f"  - ‰øùÁïôÁöÑÊñá‰ª∂:")
    for file in sorted(kept_files):
        print(f"    ‚úÖ {file}")

    # 5. ‰øùÂ≠òÊä•Âëä
    with open(
        "/Users/zhangshenshen/Ê∑±Â∫¶ÈáèÂåñ0927/factor_engine_cleanup_report.txt",
        "w",
        encoding="utf-8",
    ) as f:
        f.write("FactorEngine‰∏ÄËá¥ÊÄß‰øÆÂ§çÊä•Âëä\n")
        f.write("=" * 50 + "\n\n")
        f.write(f"Âà†Èô§ÁöÑÊñá‰ª∂ ({len(removed_files)}‰∏™):\n")
        for file in removed_files:
            f.write(f"  - {os.path.basename(file)}\n")
        f.write(f"\n‰øùÁïôÁöÑÊñá‰ª∂ ({len(kept_files)}‰∏™):\n")
        for file in sorted(kept_files):
            f.write(f"  - {file}\n")
        f.write("\n‰øÆÂ§çÂÆåÊàê: FactorEngineÁé∞Âú®Âè™ÂåÖÂê´factor_generation‰∏≠Â≠òÂú®ÁöÑÂõ†Â≠ê\n")

    print(f"\n‚úÖ Ê∏ÖÁêÜÂÆåÊàê! Êä•ÂëäÂ∑≤‰øùÂ≠òËá≥: factor_engine_cleanup_report.txt")

    return removed_files, kept_files


if __name__ == "__main__":
    removed_files, kept_files = main()
