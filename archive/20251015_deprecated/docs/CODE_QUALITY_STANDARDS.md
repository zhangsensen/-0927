# æ·±åº¦é‡åŒ–0927 - ä»£ç è´¨é‡æ ‡å‡†ä¸è§„èŒƒ

## ğŸ“Š è´¨é‡ä¿éšœä½“ç³»æ¦‚è¿°

### æ ¸å¿ƒç†å¿µ
åŸºäºLinus Torvaldså·¥ç¨‹ç†å¿µçš„å®ç”¨ä¸»ä¹‰è´¨é‡æ ‡å‡†ï¼š
- **ç®€æ´æ€§ä¼˜äºå¤æ‚æ€§** - ä»£ç åº”è¯¥ç®€å•æ˜“æ‡‚
- **å®ç”¨æ€§é«˜äºå®Œç¾ä¸»ä¹‰** - è§£å†³å®é™…é—®é¢˜
- **ä¸€è‡´æ€§é‡äºä¸ªäººåå¥½** - å›¢é˜Ÿåä½œä¼˜å…ˆ
- **å®‰å…¨æ€§æ˜¯åº•çº¿** - é‡åŒ–äº¤æ˜“ä¸å®¹å¦¥å

### è´¨é‡å·¥å…·çŸ©é˜µ
| å·¥å…·ç±»å‹ | ä¸»è¦å·¥å…· | æ£€æŸ¥ç›®æ ‡ | ä¸¥é‡ç¨‹åº¦ |
|---------|---------|---------|---------|
| **é™æ€åˆ†æ** | pyscn (CFG+APTED) | å¤æ‚åº¦ã€æ¶æ„åˆè§„æ€§ | ä¸­ç­‰ |
| **æ­»ä»£ç æ£€æµ‹** | Vulture | æœªä½¿ç”¨ä»£ç æ¸…ç† | ä½ç­‰ |
| **å®‰å…¨æ£€æŸ¥** | è‡ªå®šä¹‰è„šæœ¬ | æœªæ¥å‡½æ•°ã€æ—¶é—´å®‰å…¨ | **ä¸¥é‡** |
| **åŸºç¡€è´¨é‡** | Black/isort/è¯­æ³• | ä»£ç æ ¼å¼åŒ– | ä½ç­‰ |
| **ç±»å‹å®‰å…¨** | MyPy (å¯é€‰) | ç±»å‹æ³¨è§£æ£€æŸ¥ | ä¿¡æ¯æ€§ |

## ğŸ›¡ï¸ æ ¸å¿ƒå®‰å…¨çº¢çº¿

### 1. æœªæ¥å‡½æ•°æ£€æµ‹ (ä¸¥é‡)
**è§„åˆ™**: ä¸¥ç¦ä½¿ç”¨æœªæ¥æ•°æ®ï¼Œç¡®ä¿å›æµ‹æœ‰æ•ˆæ€§

**æ£€æµ‹æ¨¡å¼**:
```python
# ç¦æ­¢ä½¿ç”¨ä»¥ä¸‹æ¨¡å¼
data.shift(-1)          # è´Ÿæ•°shift
future_data_column      # åŒ…å«"future_"å‰ç¼€
lead_function()         # å‰ç»æ€§å‡½æ•°
```

**è‡ªåŠ¨ä¿®å¤**: æ— ï¼Œå¿…é¡»æ‰‹åŠ¨é‡æ„é€»è¾‘

### 2. æ—¶é—´å®‰å…¨åˆè§„ (ä¸¥é‡)
**è§„åˆ™**: ä¸¥æ ¼T+1æ‰§è¡Œçº¦æŸï¼Œé˜²æ­¢æ—¶é—´æ³„éœ²

**èµ„é‡‘æµå­—æ®µ**:
```python
# æ‰€æœ‰èµ„é‡‘æµå­—æ®µå¿…é¡»å»¶è¿Ÿä¸€ä¸ªäº¤æ˜“æ—¥
money_flow_columns = [
    "buy_sell_ratio", "large_order_ratio",
    "main_net_inflow_rate", "institutional_absorption"
]
# è‡ªåŠ¨æ‰§è¡Œshift(1)
```

### 3. å› å­æ¸…å•åˆè§„ (ä¸­ç­‰)
**è§„åˆ™**: FactorEngineå¿…é¡»ä¸¥æ ¼éµå¾ªå®˜æ–¹å› å­æ¸…å•

**éªŒè¯ç‚¹**:
- æ–°å¢å› å­å¿…é¡»å·²åœ¨æ¸…å•ä¸­æ³¨å†Œ
- å› å­å‚æ•°ä¸èƒ½éšæ„ä¿®æ”¹
- ä¿æŒä¸factor_generationä¸¥æ ¼ä¸€è‡´

## ğŸ“ ä»£ç è´¨é‡æ ‡å‡†

### å¤æ‚åº¦æ§åˆ¶ (pyscn)
```toml
[complexity.thresholds]
low = 5          # ç†æƒ³å¤æ‚åº¦ â‰¤ 5
medium = 10      # å¯æ¥å—å¤æ‚åº¦ â‰¤ 10
high = 15        # è­¦å‘Šå¤æ‚åº¦ > 10
critical = 20    # é˜»å¡å¤æ‚åº¦ > 20
```

**å½“å‰çŠ¶æ€**:
- å¹³å‡å¤æ‚åº¦: 9.45
- é«˜é£é™©å‡½æ•°: 10ä¸ª
- æœ€é«˜å¤æ‚åº¦: 56 (éœ€é‡æ„)

### ä»£ç é‡å¤æ§åˆ¶
```toml
[duplication.thresholds]
max_ratio = 0.05      # æœ€å¤§é‡å¤ç‡ 5%
min_similarity = 0.90 # ç›¸ä¼¼åº¦é˜ˆå€¼ 90%
```

**å½“å‰çŠ¶æ€**: 6.4%é‡å¤ç‡ (éœ€è¦æ”¹è¿›)

### æ­»ä»£ç æ¸…ç† (Vulture)
```toml
[vulture.settings]
min_confidence = 80   # æœ€ä½ç½®ä¿¡åº¦
ignore_names = ["test_*", "_*", "setUp", "tearDown"]
```

## ğŸ”§ é›†æˆè´¨é‡æ£€æŸ¥æµç¨‹

### Pre-commit é’©å­ (å¿«é€Ÿæ£€æŸ¥)
```bash
# è‡ªåŠ¨è§¦å‘æ—¶æœº
git commit  # æäº¤å‰æ£€æŸ¥

# æ£€æŸ¥å†…å®¹
âœ… Pythonè¯­æ³•æ£€æŸ¥ (é˜»å¡)
âœ… æœªæ¥å‡½æ•°æ£€æµ‹ (é˜»å¡)
âœ… å› å­æ¸…å•éªŒè¯ (é˜»å¡)
âœ… åŸºç¡€è´¨é‡æ£€æŸ¥ (è­¦å‘Š)
âš ï¸ pyscnè´¨é‡åˆ†æ (ä¿¡æ¯)
```

### Pre-push é’©å­ (å…¨é¢æ£€æŸ¥)
```bash
# è‡ªåŠ¨è§¦å‘æ—¶æœº
git push  # æ¨é€å‰æ£€æŸ¥

# æ£€æŸ¥å†…å®¹
âœ… å®Œæ•´pyscnåˆ†æ
âœ… Vultureæ­»ä»£ç æ£€æµ‹
âœ… å®‰å…¨åˆè§„æ€§éªŒè¯
âœ… æ€§èƒ½å½±å“è¯„ä¼°
```

### æ‰‹åŠ¨è´¨é‡æ£€æŸ¥
```bash
# è¿è¡Œå®Œæ•´è´¨é‡æ£€æŸ¥å¥—ä»¶
bash scripts/unified_quality_check.sh

# ç”Ÿæˆè¯¦ç»†HTMLæŠ¥å‘Š
pyscn analyze factor_system/ --output-format html

# å•ç‹¬è¿è¡Œå„å·¥å…·
pyscn check factor_system/ --threshold 10
vulture factor_system/ --min-confidence 80
```

## ğŸ“Š è´¨é‡è¯„åˆ†ä½“ç³»

### ç»¼åˆå¥åº·è¯„åˆ†
```python
def calculate_health_score():
    scores = {
        'complexity': 70,      # å¤æ‚åº¦è¯„åˆ†
        'dead_code': 100,      # æ­»ä»£ç è¯„åˆ†
        'duplication': 70,     # é‡å¤ç‡è¯„åˆ†
        'architecture': 75,    # æ¶æ„åˆè§„è¯„åˆ†
        'security': 100        # å®‰å…¨æ£€æŸ¥è¯„åˆ†
    }
    return sum(scores.values()) / len(scores)  # 85/100 (Açº§)
```

### è¯„åˆ†ç­‰çº§
- **90-100**: Açº§ (ä¼˜ç§€) - ç”Ÿäº§å°±ç»ª
- **80-89**: Bçº§ (è‰¯å¥½) - éœ€è¦æ”¹è¿›
- **70-79**: Cçº§ (ä¸€èˆ¬) - å¿…é¡»æ”¹è¿›
- **<70**: Dçº§ (å·®) - ä¸å»ºè®®åˆå¹¶

### æ”¹è¿›ç›®æ ‡
```yaml
current_metrics:
  health_score: 85/100
  complexity: 70/100  # å¹³å‡9.45ï¼Œç›®æ ‡: â‰¤8
  duplication: 70/100 # 6.4%ï¼Œç›®æ ‡: <2%
  architecture: 75/100 # 73%åˆè§„ï¼Œç›®æ ‡: >90%

target_metrics:
  health_score: 92/100
  complexity: 85/100
  duplication: 90/100
  architecture: 90/100
```

## ğŸ¯ è´¨é‡æ”¹è¿›å®è·µ

### 1. å¤æ‚åº¦é‡æ„ç­–ç•¥
```python
# é‡æ„å‰ (å¤æ‚åº¦56)
def calculate_comprehensive_factors():
    # 200è¡Œå¤æ‚é€»è¾‘...

# é‡æ„å (å¤æ‚åº¦â‰¤10)
def calculate_comprehensive_factors():
    config = _validate_calculation_parameters()     # å¤æ‚åº¦5
    context = _prepare_calculation_context()       # å¤æ‚åº¦8
    results = _execute_factor_calculations(context) # å¤æ‚åº¦15
    return _postprocess_results(results)           # å¤æ‚åº¦12
```

### 2. ä»£ç é‡å¤æ¶ˆé™¤
```python
# æå–é€šç”¨å·¥å…·ç±»
class DataProcessor:
    @staticmethod
    def validate_ohlcv_data(data): pass

    @staticmethod
    def handle_missing_values(data): pass

    @staticmethod
    def apply_time_series_validation(data): pass
```

### 3. æ¶æ„åˆè§„æ”¹è¿›
```python
# é‡æ–°å®šä¹‰å±‚çº§è¾¹ç•Œ
Domain Layer:
  - FactorEngine (æ ¸å¿ƒè®¡ç®—)
  - FactorRegistry (å› å­ç®¡ç†)

Application Layer:
  - ScreeningLogic (ç­›é€‰é€»è¾‘)
  - PipelineOrchestration (æµç¨‹ç¼–æ’)

Infrastructure Layer:
  - DataProviders (æ•°æ®æä¾›)
  - FileSystemUtils (æ–‡ä»¶ç³»ç»Ÿ)
```

## ğŸ“ è´¨é‡æ£€æŸ¥æ¸…å•

### ä»£ç æäº¤å‰æ£€æŸ¥
- [ ] è¿è¡Œ `bash scripts/unified_quality_check.sh`
- [ ] ä¿®å¤æ‰€æœ‰æœªæ¥å‡½æ•°ä½¿ç”¨
- [ ] ç¡®ä¿å› å­æ¸…å•åˆè§„
- [ ] æ£€æŸ¥ä»£ç å¤æ‚åº¦ < 20
- [ ] æ¸…ç†æœªä½¿ç”¨çš„å¯¼å…¥å’Œå˜é‡

### ä»£ç å®¡æŸ¥æ£€æŸ¥
- [ ] æ–°å¢å‡½æ•°æœ‰å®Œæ•´æ–‡æ¡£
- [ ] å¼‚å¸¸å¤„ç†é€‚å½“
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] æ€§èƒ½å½±å“å¯æ¥å—
- [ ] ç¬¦åˆé‡åŒ–äº¤æ˜“å®‰å…¨æ ‡å‡†

### å‘å¸ƒå‰æ£€æŸ¥
- [ ] å®Œæ•´pyscnåˆ†æè¯„åˆ† > 85
- [ ] å®‰å…¨æ‰«ææ— é«˜é£é™©é—®é¢˜
- [ ] é›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•è¾¾æ ‡
- [ ] æ–‡æ¡£æ›´æ–°å®Œæ•´

## ğŸš€ æŒç»­æ”¹è¿›è®¡åˆ’

### çŸ­æœŸç›®æ ‡ (1-2å‘¨)
- é‡æ„é«˜å¤æ‚åº¦å‡½æ•° (>20)
- é™ä½ä»£ç é‡å¤ç‡è‡³ <3%
- å®Œå–„å•å…ƒæµ‹è¯•è¦†ç›–ç‡

### ä¸­æœŸç›®æ ‡ (1-2æœˆ)
- å»ºç«‹è‡ªåŠ¨åŒ–è´¨é‡é—¨ç¦
- é›†æˆCI/CDè´¨é‡æ£€æŸ¥
- ä¼˜åŒ–æ¶æ„åˆè§„æ€§è‡³ >90%

### é•¿æœŸç›®æ ‡ (3-6æœˆ)
- å»ºç«‹è´¨é‡ç›‘æ§ä»ªè¡¨æ¿
- å®æ–½ä»£ç è´¨é‡æŒç»­æ”¹è¿›
- è¾¾åˆ°ç”Ÿäº§çº§è´¨é‡æ ‡å‡†

## ğŸ”— ç›¸å…³èµ„æº

### é…ç½®æ–‡ä»¶
- `.pyscn.toml` - pyscnè´¨é‡æ£€æŸ¥é…ç½®
- `pyproject.toml` - é¡¹ç›®é…ç½®ä¸å·¥å…·è®¾ç½®
- `.pre-commit-config.yaml` - Gité’©å­é…ç½®
- `vulture_whitelist.py` - æ­»ä»£ç æ£€æµ‹ç™½åå•

### æ£€æŸ¥è„šæœ¬
- `scripts/unified_quality_check.sh` - ç»Ÿä¸€è´¨é‡æ£€æŸ¥
- `scripts/code_compliance_check.sh` - åˆè§„æ€§æ£€æŸ¥
- `factor_system/factor_screening/scripts/check_future_functions.py` - æœªæ¥å‡½æ•°æ£€æµ‹

### æŠ¥å‘Šè¾“å‡º
- `.quality_reports/quality_summary.md` - è´¨é‡æ£€æŸ¥æ‘˜è¦
- `.quality_reports/pyscn_quality_report.html` - pyscn HTMLæŠ¥å‘Š
- `.pyscn/reports/analyze_*.html` - pyscnè¯¦ç»†åˆ†ææŠ¥å‘Š

---

**ç‰ˆæœ¬**: v1.0
**æ›´æ–°æ—¶é—´**: 2025-10-14
**ç»´æŠ¤äºº**: é‡åŒ–å¼€å‘å›¢é˜Ÿ

*æœ¬æ–‡æ¡£å°†æ ¹æ®é¡¹ç›®å‘å±•å’Œè´¨é‡æ ‡å‡†æ¼”è¿›æŒç»­æ›´æ–°*