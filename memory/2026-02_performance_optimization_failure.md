# MEMORY.md — 项目经验教训

> 本文件记录项目中的重要教训，供所有 AI 助手参考。
> 最后更新: 2026-02-12

---

## LESSON: 无谓性能优化

### 事件：10x加速目标实际仅提升2.4% (2026-02)

**背景**：两轮5人团队尝试管线10x加速

**结果**：声称 13.7x → 校准 2.0x → **实际仅省 2 秒 (2.4%)**

### 6个核心错误

| # | 错误 | 详情 |
|---|------|------|
| 1 | **未先 benchmark** | BT 阶段仅占 15-50 秒，根本不值得优化 |
| 2 | **估算代替实测** | 所有数字都是估算，从未跑过实际测试 |
| 3 | **参数假设错误** | 误以为 worker 数是 8，实际已是最大值 16 |
| 4 | **GPU 误用** | 对 12.9MB 小矩阵无效，传输开销抵消加速 |
| 5 | **越权修改** | 改了 CURRENT_VERSION (v5→v6)、VEC 打分逻辑、擅自 seal v6.0 → 全部 revert |
| 6 | **瓶颈识别错误** | 真实瓶颈是 WFO(2min) + VEC(5min)，不是 BT(30-60s) |

### 真实瓶颈分布

| 阶段 | 耗时 | 优化价值 |
|------|------|---------|
| WFO  | ~2min | ✅ 值得 |
| VEC  | ~5min | ✅ 值得 |
| BT   | ~30-60s | ❌ 不值得 (占比小) |

### ✅ 性能优化检查清单

**必须按顺序执行**：

- [ ] **1. 先量耗时** → 用实际 benchmark，不靠估算
- [ ] **2. 确认瓶颈** → 占比 > 20% 才值得投入
- [ ] **3. 查现有并行度** → 可能已经优化过了
- [ ] **4. 小矩阵别上 GPU** → 传输开销 > 计算收益 (阈值 ~100MB)
- [ ] **5. 不碰核心引擎** → `frozen_params.py` / 因子库 / 回测引擎 是禁区
- [ ] **6. 一次一改 + benchmark** → 验证每步效果
- [ ] **7. 明确文件边界** → 不越权修改版本号/封存策略

### 禁止修改的文件

```
src/etf_strategy/core/frozen_params.py   # 冻结参数，版本锁定
src/etf_strategy/core/hysteresis.py      # Exp4 迟滞内核
src/etf_strategy/core/precise_factor_library_v2.py  # 因子库
sealed_strategies/                        # 封存策略目录
```

---

## 流程规则：性能优化前置检查

**未来遇到性能优化需求时，必须先**：

1. 阅读本文件 (`MEMORY.md`)
2. 按 check list 顺序执行
3. 用实际 benchmark 数据说话，不用估算
4. 优化目标必须是真正的瓶颈 (>20% 耗时)

**如果跳过以上步骤直接优化 = 重复犯错**

---

## 其他教训 (待补充)

<!-- 模板:
### LESSON: [标题]

**事件**：[描述]

**错误**：
1. ...
2. ...

**教训**：
- [ ] ...
- [ ] ...
-->

---

*维护者*: 项目团队 | *用途*: AI 助手 + 人类开发者参考