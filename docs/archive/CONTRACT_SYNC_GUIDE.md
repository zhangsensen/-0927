============================================================
ETF 回测契约说明 & 调试指引
============================================================
最近更新时间：2025-11-27
适用对象：所有协助本项目的 LLM（Cloud Code、Code X 等）
目标：确保「向量化引擎」与 Backtrader WFO 的行为契约一致，并指导后续排查。

------------------------------------------------------------
1. 契约总览（共识参数）
------------------------------------------------------------
FREQ                = 8                     # 每 8 个 bar 调仓一次
POS_SIZE            = 3                     # 理论持仓数量
INITIAL_CAPITAL     = 1_000_000             # 初始本金（人民币）
COMMISSION_RATE     = 0.0002                # 单边千 0.2 手续费
LOOKBACK            = 252                   # 252 日洗牌窗口
LEVERAGE            = 1.0                   # 禁止杠杆
CHEAT_ON_CLOSE      = True                  # 信号日收盘成交
TARGET_POS_FORMULA  = current_value / POS_SIZE / (1 + commission)
DATA_FILLING RULE   = 所有 OHLCV 先 bfill 再 ffill，禁止 NaN
EXECUTION ORDER     = 先平仓、再按目标顺序调仓；部分买单可能被拒

------------------------------------------------------------
2. 现象回顾（第 10 次调仓示例）
------------------------------------------------------------
- 向量化持仓：['511010','511260']，现金 335,795，target_pos ≈ 338k，买不了 512800
- Backtrader 持仓：['511010','511260','159992']，现金 14,408，target_pos ≈ 508k，可买 512800
- 根因：早在调仓 #3/#4 就因 **现金/仓位不同步** 分岔，之后所有计算全错位。

------------------------------------------------------------
3. 根本原因拆解（按影响度排序）
------------------------------------------------------------
A. Margin/MOC 执行差异（关键）
   - Backtrader cheat-on-close 中，卖出与买入在同一 bar 提交，但订单按 data feed 顺序撮合。
   - 结果：约 68.8% 的调仓至少有 1 个买单被拒（26.7% 的买单因 Margin 失败）。
   - 向量化算法默认「卖出收益立即全部可用」，从不发生买入失败 → 仓位数量与 BT 不一致。

B. 数据填充问题（已修复）
   - 多只 ETF 初期无历史 → close NaN → broker.getvalue() 返回 NaN。
   - 解决：所有 OHLCV 先 bfill 后 ffill，保证任何时刻无 NaN。

C. 仓位调整逻辑差异（已修复）
   - 早期向量化未处理「目标仓位 < 当前仓位」导致的减仓，造成现金/仓位偏差。
   - 已加入减仓分支后，前 60+ 次调仓可与 BT 精确对齐。

------------------------------------------------------------
4. 建议的排查 Workflow（供 LLM 严格执行）
------------------------------------------------------------
Step 1  数据一致性
  - 确认所有数据帧 (OHLCV) 执行 df = df.bfill().ffill()。
  - 取任一日期/标的交叉验证 ndarray 与 DataFrame 是否同值。

Step 2  契约校验脚本
  - 运行当前的对照脚本（vectorized vs Backtrader），仅关注前 10~20 次调仓。
  - 如出现差异，打印：target 列表、pre/post holdings、cash、buy order 状态。

Step 3  Margin 失败定位
  - 在 Backtrader Strategy 中实现 notify_order，记录 Completed / Margin。
  - 当 Margin 失败时，输出：bar、ticker、需要现金、提交时可用现金。
  - 若失败发生在第 N 调仓，回溯前 N-1 调仓的现金与持仓，找出首次偏差点。

Step 4  复刻 BT 行为的 VEC 版本
  - 特殊需求：若必须模拟 BT 结果，使用“BT-style vectorized”逻辑：
    1) target_pos_value 使用调仓前 current_value
    2) 只允许整数股
    3) 买单按目标顺序，现金不足直接跳过（不缩减份额）
    4) 保留旧持仓，直至下一次调仓清理

Step 5  现实贴近度评估
  - 若想贴近真实市场撮合：
    * 执行顺序：先卧单卖出，确认成交后再发买单（或使用 T+1 逻辑）。
    * 预留现金：target_pos_value 可适当乘 0.98，避免手续费侵蚀导致买单失败。
    * 若要完全同步，使用“双阶段调仓”：Day T 收盘只平仓，Day T+1 再建仓。

------------------------------------------------------------
5. 如何让结果更贴近现实
------------------------------------------------------------
1) 「执行日 +1」模式：信号日只挂单，隔日开盘撮合，可避免 cheat-on-close 的同步难题。
2) 现金缓冲：在 target_pos_value 前乘系数 (1 - buffer)，buffer 取 0.5%~1%。
3) 拆分成交：对每个标的先卖后买，等待返回的成交回报，再决定是否下买单。
4) 引入撮合引擎：若追求精准，可写一个模拟撮合层，显式建模订单队列与成交延迟。

------------------------------------------------------------
6. 面向大模型的执行 Checklist
------------------------------------------------------------
[ ] 读取 ./CONTRACT_SYNC_GUIDE.txt，确认契约参数
[ ] 校验数据填充 (bfill+ffill) 是否在最新脚本生效
[ ] 运行对照脚本，比较前 10 次调仓 log
[ ] 出现差异 → 打印买入/卖出订单详情 + cash
[ ] 排查 margin failure → 是否需要现金缓冲 or 两段调仓
[ ] 回答用户前，明确说明「向量化 vs Backtrader」差异来自何处，给出缓解方案

------------------------------------------------------------
7. FAQ
------------------------------------------------------------
Q: 为什么 Backtrader value 偶尔是 NaN？
A: 某些 ETF 在当前 bar 的 close 为 NaN。请确保所有 feed 经过 bfill+ffill。

Q: 为什么我明明卖出后有钱，买入仍然失败？
A: 提交买单时，Backtrader 还没更新 broker 的现金。尤其在多 feed 情况下，执行顺序不等同提交顺序。

Q: 想完全一致该怎么办？
A: 只能让 VEC 模拟 BT 的全部约束（整数股、现金不足跳过、保持上一期残留），或反过来修改 BT 的策略，采用“两阶段调仓 + 足额现金缓冲”。

------------------------------------------------------------
8. 结语
------------------------------------------------------------
- VEC（数学模型）擅长快速筛选，但默认所有买入都能成交。
- Backtrader（执行模拟）严格遵循资金约束，真实但慢且复杂。
- 在任何分析中，必须注明「该数据来自 VEC 结果」还是「来自 Backtrader 结果」。
- 若二者差异 >5pp，请回放调仓日志，确认是否是 margin failure、数据缺失、或未实施减仓逻辑。

以上内容如需更新，请直接修改本文件并告知团队。