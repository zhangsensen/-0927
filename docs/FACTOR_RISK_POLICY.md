# 📋 因子风险政策文档 (Factor Risk Policy)

> **版本**: v1.0  
> **创建日期**: 2025-12-01  
> **最后更新**: 2025-12-01  
> **审计覆盖**: Top1000 + 分层抽样200 = 1,182 个策略

---

## 📊 执行摘要

| 分类 | 因子数 | 说明 |
|------|--------|------|
| 🟢 **安全因子** | 12 | 可用于生产 |
| 🔴 **高风险因子** | 3 | 禁止用于生产 |
| ⛔ **禁止组合** | 1 | 特定因子组合禁用 |
| **安全策略池** | 4,795 | 占比 72.3% |

---

## 🔴 高风险因子 (RISKY_FACTORS)

### 1. OBV_SLOPE_10D
| 属性 | 值 |
|------|-----|
| **状态** | ⛔ 禁止用于生产 |
| **发现日期** | 2025-12-01 |
| **发现来源** | Top1000 BT 审计 |

**发现证据**:
- 平均 VEC/BT 差异: **61.0pp** (极高)
- 含该因子的策略在 Top1000 中 diff >= 10pp 占比显著
- 根因: 成交量计算在 VEC 和 BT 中存在边界条件差异

**当前处理**:
```python
RISKY_FACTORS = ["OBV_SLOPE_10D", ...]
```
- 从生产策略池中过滤
- 仅允许研究用途

**复查计划**:
- [ ] 深入分析 OBV 计算逻辑
- [ ] 检查 VEC/BT 成交量数据对齐
- [ ] 若根因修复，可重新评估

---

### 2. CMF_20D (Chaikin Money Flow)
| 属性 | 值 |
|------|-----|
| **状态** | ⛔ 禁止用于生产 |
| **发现日期** | 2025-12-01 |
| **发现来源** | Top1000 BT 审计 |

**发现证据**:
- 平均 VEC/BT 差异: **35.0pp** (很高)
- 与 OBV_SLOPE_10D 类似，涉及成交量计算
- 在特定市场状态下 VEC/BT 行为不一致

**当前处理**:
```python
RISKY_FACTORS = [..., "CMF_20D", ...]
```
- 从生产策略池中过滤
- 仅允许研究用途

**复查计划**:
- [ ] 检查 CMF 公式中的 close location value 计算
- [ ] 验证高低点价格在 VEC/BT 中的一致性
- [ ] 与 OBV 问题可能同源，一并修复

---

### 3. VOL_RATIO_60D
| 属性 | 值 |
|------|-----|
| **状态** | ⛔ 禁止用于生产 |
| **发现日期** | 2025-12-01 |
| **发现来源** | Top1000 BT 审计深度分析 |

**发现证据**:
- 单独使用: 平均 diff **13.86pp**
- 139 个策略中 57 个 diff >= 10pp (41%)
- 与 VOL_RATIO_20D 组合使用时更严重 (见禁止组合)

**差异分布**:
```
VOL_RATIO_60D only:  n=139, avg_diff=11.18pp, >=10pp: 57 (41.0%)
Without VOL_RATIO:   n=570, avg_diff=1.42pp,  >=10pp: 3 (0.5%)
```

**根因分析**:
- 60 日成交量均值在低流动性 ETF 上计算不稳定
- VEC 使用 numpy 向量化，BT 使用逐日滚动，精度差异累积

**当前处理**:
```python
RISKY_FACTORS = [..., "VOL_RATIO_60D"]
```

**复查计划**:
- [ ] 统一 VEC/BT 的滚动窗口计算方式
- [ ] 考虑使用 EMA 替代 SMA 以减少边界效应
- [ ] 验证修复后重新审计

---

## ⛔ 禁止组合 (BANNED_FACTOR_COMBOS)

### VOL_RATIO_20D + VOL_RATIO_60D
| 属性 | 值 |
|------|-----|
| **状态** | ⛔ 禁止组合 |
| **发现日期** | 2025-12-01 |
| **发现来源** | Top1000 BT 审计因子组合分析 |

**发现证据**:
- 组合平均 diff: **25.85pp** (极高)
- 31 个策略中 26 个 diff >= 10pp (83.9%)
- 是所有因子组合中差异最大的

**差异对比**:
```
VOL_RATIO_20D only:      n=242, avg_diff=4.33pp
VOL_RATIO_60D only:      n=139, avg_diff=11.18pp
Both (20D + 60D):        n=31,  avg_diff=25.85pp  ← 显著恶化
```

**根因分析**:
- 两个因子的计算误差相互放大
- 短期和长期成交量比率的组合引入额外噪声
- 导致 18 个 NaN 策略（BT 返回 nan）全部含此组合

**当前处理**:
```python
BANNED_FACTOR_COMBOS = [
    ("VOL_RATIO_20D", "VOL_RATIO_60D"),
]
```

**复查计划**:
- [ ] 如果 VOL_RATIO_60D 根因修复，重新评估组合
- [ ] 考虑是否应该直接禁用 VOL_RATIO_60D（当前已禁用）

---

## 🟢 安全因子 (SAFE_FACTORS)

以下 12 个因子经过 Top1000 + 分层200 审计验证，可安全用于生产：

| 因子名 | 类别 | 审计结果 | 备注 |
|--------|------|----------|------|
| **ADX_14D** | 趋势 | ✅ avg_diff < 0.1pp | 最佳组合核心因子 |
| **SLOPE_20D** | 趋势 | ✅ avg_diff < 0.1pp | |
| **VORTEX_14D** | 趋势 | ✅ avg_diff < 0.1pp | |
| **MOM_20D** | 动量 | ✅ avg_diff < 0.1pp | |
| **RSI_14** | 动量 | ✅ avg_diff < 0.1pp | |
| **PRICE_POSITION_20D** | 动量 | ✅ avg_diff < 0.1pp | 最佳组合核心因子 |
| **PRICE_POSITION_120D** | 动量 | ✅ avg_diff < 0.1pp | 最佳组合核心因子 |
| **MAX_DD_60D** | 风险 | ✅ avg_diff < 0.02pp | 最佳组合核心因子，精度最高 |
| **RET_VOL_20D** | 风险 | ✅ avg_diff < 0.1pp | |
| **CALMAR_RATIO_60D** | 风险 | ✅ avg_diff < 0.1pp | |
| **SHARPE_RATIO_20D** | 风险 | ✅ avg_diff < 0.1pp | 最佳组合核心因子 |
| **CORRELATION_TO_MARKET_20D** | 相关性 | ✅ avg_diff < 0.1pp | |
| **RELATIVE_STRENGTH_VS_MARKET_20D** | 相关性 | ✅ avg_diff < 0.1pp | |
| **PV_CORR_20D** | 资金流 | ✅ avg_diff < 0.1pp | |
| **VOL_RATIO_20D** | 成交量 | ⚠️ avg_diff < 5pp | 单独使用安全，禁止与 60D 组合 |

---

## 🟡 观察因子 (WATCH_LIST)

### VOL_RATIO_20D
| 属性 | 值 |
|------|-----|
| **状态** | ⚠️ 可用但需注意 |
| **平均 diff** | 4.33pp (单独使用) |

**观察原因**:
- 单独使用时 diff 在可接受范围
- 但与 VOL_RATIO_60D 组合时显著恶化
- 已在 BANNED_FACTOR_COMBOS 中禁止组合

**使用建议**:
- 可用于生产，但应避免与其他成交量因子组合
- 优先选择不含此因子的策略

---

## 📈 审计证据汇总

### Top1000 BT 审计 (2025-12-01)
```
总策略: 1000
有效策略: 982 (98.2%)
NaN 策略: 18 (VOL_RATIO 因子导致)

对齐质量:
  < 0.1pp: 460 (46.8%)
  < 1.0pp: 595 (60.6%)
  >= 10pp: 143 (14.6%)  ← 主要来自 RISKY_FACTORS
  
平均 diff: 4.29pp
```

### 分层抽样 200 审计 (2025-12-01)
```
抽样方法: 收益 5 分层 × IC 3 分层
总策略: 200 (从安全池 4,795 中抽取)

对齐质量:
  < 0.1pp: 200 (100%)  ✅
  < 1.0pp: 200 (100%)  ✅
  >= 10pp: 0 (0%)      ✅
  
平均 diff: 0.04pp
```

### 结论
- 风险因子筛选有效
- 安全池 4,795 个策略可信赖
- 无新型问题因子

---

## 🔄 增量审计流程

当添加新因子或新组合时，执行以下流程：

### 1. 新因子审计
```bash
# Step 1: 生成含新因子的组合
uv run python src/etf_strategy/run_combo_wfo.py --factors "NEW_FACTOR"

# Step 2: VEC 回测
uv run python scripts/run_full_space_vec_backtest.py

# Step 3: 抽样 BT 审计 (至少 50 个)
uv run python scripts/batch_bt_backtest.py --topk 50

# Step 4: 检查对齐
# 要求: avg_diff < 1pp, >=10pp 占比 < 5%
```

### 2. 判定标准
| 指标 | 安全 | 观察 | 高风险 |
|------|------|------|--------|
| avg_diff | < 1pp | 1-10pp | >= 10pp |
| >=10pp 占比 | < 5% | 5-20% | >= 20% |
| NaN 率 | 0% | < 5% | >= 5% |

### 3. 更新本文档
- 在对应分类添加新因子
- 记录发现证据和日期
- 设置复查计划

---

## 📝 变更历史

| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2025-12-01 | v1.0 | 初始版本，基于 Top1000 + 分层200 审计 |

---

## 📚 相关文档

- `docs/BT_AUDIT_TOP1000_REPORT.md` - Top1000 审计详细报告
- `docs/VEC_BT_ALIGNMENT_GUIDE.md` - VEC/BT 对齐指南
- `scripts/select_strategy_v2.py` - 风险因子筛选实现
- `AGENTS.md` - 项目核心配置和最佳策略

---

**维护者**: Quant Team  
**下次复查**: 2026-01-01 或新增因子时
