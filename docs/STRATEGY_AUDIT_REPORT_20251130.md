# 策略深度审核报告

> **审核日期**: 2025-11-30  
> **审核范围**: 43 ETF 统一轮动策略 (v1.0 封板版)  
> **核心策略**: CORRELATION_TO_MARKET_20D + MAX_DD_60D + PRICE_POSITION_120D + PRICE_POSITION_20D

---

## 📊 Executive Summary

| 维度 | 评分 | 说明 |
|------|------|------|
| **代码质量** | ⭐⭐⭐⭐⭐ | VEC/BT 完美对齐，差异 < 0.05pp |
| **回测收益** | ⭐⭐⭐⭐ | 121% 总收益，年化 ~18% |
| **样本外验证** | ⭐⭐⭐⭐ | ✅ WFO 10 窗口滚动验证，p=0.0016 显著 |
| **风险控制** | ⭐⭐ | 仅有择时，无止损 |
| **数据质量** | ⭐⭐⭐ | 7个ETF晚上市，25个有缺失 |

**总体评估**: 策略代码质量高，回测结果可复现，**已通过 WFO 滚动样本外验证**，但存在**风险控制不足**的问题。

---

## 🔍 详细发现

### 1. ✅ 优势

#### 1.1 代码质量优秀
```
VEC/BT 对齐状态:
- 平均差异: 0.0254pp ✅
- 最大差异: 0.0441pp ✅
- 100/100 组合完美对齐 ✅
- Margin 失败: 0 ✅
```

#### 1.2 因子设计合理
- 核心 4 因子覆盖多个维度：相关性、风险、动量
- 因子相关性适中（最高 0.48），避免了高度共线性
- 因子库有 18 个因子，提供了多样化选择

#### 1.3 择时模块有效
```
择时效果分析:
- 防守期沪深300年化: -48.92%
- 全仓期沪深300年化: +34.96%
- 结论: 择时有效，成功规避了下跌期
```

#### 1.4 回测指标良好
```
核心策略表现:
- 总收益: 121.02%
- 胜率: 54.59%
- 盈亏比: 1.414
- 交易次数: 196 (合理)
```

---

### 2. ⚠️ 问题与不足

#### 2.1 ✅ WFO 滚动样本外验证 (已实现)

**实现状态**:
```
WFO 配置:
- 样本内 (IS): 756 天 (~3年)
- 样本外 (OOS): 63 天 (~3个月)
- 滚动步长: 63 天
- 滚动窗口数: 10
```

**核心策略 WFO 验证结果**:
```
mean_oos_ic: 0.1302 (样本外预测能力)
p_value: 0.0016 (< 0.05, 统计显著 ✅)
is_significant: True
positive_rate: 61.25% (8/10 窗口 IC > 0)

窗口详情:
Window 1: +0.1227 ✅   Window 6: +0.1664 ✅
Window 2: +0.0002 ✅   Window 7: +0.1593 ✅
Window 3: +0.0339 ✅   Window 8: +0.1623 ✅
Window 4: +0.1819 ✅   Window 9: +0.1687 ✅
Window 5: -0.0234 ❌   Window 10: +0.3304 ✅
```

**结论**: 
- ✅ 策略已通过 WFO 滚动样本外验证
- ✅ p=0.0016 表明因子预测能力统计显著
- ✅ 80% 的 OOS 窗口显示正向预测能力

---

#### 2.2 🟡 多重测试问题 (中优先级)

**问题描述**:
- 从 12,597 个因子组合中选出最优组合
- 虽然 WFO 提供了样本外验证，但仍存在一定程度的数据挖掘偏差
- 建议关注 Sharpe Ratio 而非单纯收益率排名

**缓解措施 (已实现)**:
- ✅ WFO 的 p_value 检验可部分控制多重测试问题
- ✅ 只有 p < 0.05 的策略才被认为是显著的

**进一步建议**:
1. 考虑使用 **Bonferroni 校正** (alpha = 0.05/12597 = 0.000004)
2. 或使用 **FDR (False Discovery Rate)** 控制
3. 对 Top-N 策略进行蒙特卡洛模拟验证

---

#### 2.3 🟡 风险控制不足 (中优先级)

**问题描述**:
```
当前风控机制:
✅ 择时仓位调整 (30% 防守仓位)
✅ 固定持仓数 (3只)
❌ 无个股止损
❌ 无组合止损
❌ 无最大回撤控制
❌ 无波动率目标
```

**风险数据**:
```
最大回撤: -39.00%
回撤峰值: 2023-02-09
回撤谷底: 2025-04-30
回撤持续: 约 2 年！
```

**建议修复**:
1. 添加**个股止损** (如 -10% 触发卖出)
2. 添加**组合止损** (如回撤 -20% 降低仓位)
3. 实施**波动率目标** (动态调整仓位)

---

#### 2.4 🟡 数据质量问题 (中优先级)

**问题描述**:
```
ETF 数据完整性:
- 无缺失 ETF: 18/43 (42%)
- 有缺失 ETF: 25/43 (58%)
- 最大缺失: 588200 (48.6% 数据缺失)

晚上市 ETF (预热期后才有数据):
- 159859: 2021-07-07
- 159883: 2021-04-30
- 513130: 2021-06-01
- 516090: 2021-03-19
- 516160: 2021-02-04
- 516520: 2021-03-01
- 588200: 2022-10-26
```

**风险**:
- 可能存在**幸存者偏差**
- 晚上市 ETF 参与回测的时间不完整

**建议修复**:
1. 移除数据缺失 > 20% 的 ETF
2. 或者在因子计算中正确处理缺失
3. 验证策略在"干净"数据集上的表现

---

#### 2.5 🟡 参数敏感性未验证 (中优先级)

**问题描述**:
```
固定参数:
- FREQ = 8 (调仓频率)
- POS_SIZE = 3 (持仓数)
- LOOKBACK = 252 (预热期)
- 择时阈值 = -0.4
- 防守仓位 = 30%
```

**风险**:
- 参数可能特定于历史数据
- 未进行参数稳健性测试

**建议修复**:
```python
# 参数敏感性测试
FREQ: [4, 6, 8, 10, 12]
POS_SIZE: [2, 3, 4, 5]
防守仓位: [20%, 30%, 40%, 50%]

# 验证：在合理参数范围内，策略是否稳定盈利
```

---

#### 2.6 🟢 执行层面考虑 (低优先级)

**问题描述**:
```
回测假设:
- 无滑点
- 固定手续费 0.02%
- 收盘价成交 (Cheat-On-Close)
- 无冲击成本
```

**实盘风险**:
- ETF 流动性可能不足以支撑大额交易
- 收盘价成交在实盘中难以实现

**建议修复**:
1. 添加**滑点模型** (如 0.05%)
2. 考虑**冲击成本** (资金量依赖)
3. 改用**次日开盘价**成交

---

## 📈 年度表现分解

| 年份 | 收益率 | 防守天数 | 沪深300 |
|------|--------|----------|---------|
| 2020 | 待计算 | 31 (12.8%) | +27.43% |
| 2021 | 待计算 | 62 (25.5%) | -4.87% |
| 2022 | 待计算 | 166 (68.6%) | -19.84% |
| 2023 | 待计算 | 135 (55.8%) | -10.03% |
| 2024 | 待计算 | 94 (38.8%) | +19.04% |
| 2025 | 待计算 | 3 (1.6%) | +21.48% |

> 注: 策略年度收益需要单独计算验证

---

## 🎯 后续操作建议

### 立即行动 (1-2周)

| 优先级 | 任务 | 预期结果 |
|--------|------|----------|
| 🟡 P1 | 添加止损机制 | 控制最大回撤 |
| 🟡 P1 | 参数敏感性测试 | 验证参数稳健性 |
| 🟡 P2 | 清理数据质量差的 ETF | 减少噪音干扰 |

### 短期改进 (1个月)

| 任务 | 说明 |
|------|------|
| 添加滑点模型 | 更真实的回测 |
| 年度表现分解 | 理解策略在不同市场环境的表现 |
| 蒙特卡洛模拟 | 进一步验证策略显著性 |

### 长期优化 (3个月)

| 任务 | 说明 |
|------|------|
| 多空策略扩展 | 在下跌市场也能盈利 |
| 机器学习增强 | 动态因子权重 |
| 实盘模拟 | Paper Trading 验证 |

---

## 🔧 具体实施方案

### 方案 1: 添加止损机制

```python
# 在 vec_backtest_kernel 中添加

# 个股止损参数
STOP_LOSS_PCT = -0.10  # -10%

# 在每日循环中检查
for n in range(N):
    if holdings[n] > 0:
        current_pnl = (close_prices[t, n] - entry_prices[n]) / entry_prices[n]
        if current_pnl < STOP_LOSS_PCT:
            # 触发止损卖出
            sell(n)
```

### 方案 2: 参数敏感性测试

```python
# 创建 scripts/param_sensitivity.py

import itertools

FREQ_RANGE = [4, 6, 8, 10, 12]
POS_SIZE_RANGE = [2, 3, 4, 5]

results = []
for freq, pos_size in itertools.product(FREQ_RANGE, POS_SIZE_RANGE):
    ret = run_backtest(freq=freq, pos_size=pos_size)
    results.append({'freq': freq, 'pos_size': pos_size, 'return': ret})

# 绘制热力图，观察参数稳健性
```

### 方案 3: 多重测试校正 (可选)

```python
# 如果需要更严格的显著性检验
from statsmodels.stats.multitest import multipletests

# FDR 校正
p_values = [combo['p_value'] for combo in all_combos]
rejected, pvals_corrected, _, _ = multipletests(p_values, method='fdr_bh')

# 只保留校正后仍显著的策略
significant_combos = [c for c, r in zip(all_combos, rejected) if r]
```

---

## 📝 结论

**当前策略状态**: 
- ✅ 代码质量优秀，可复现
- ✅ 回测收益可观 (121%)
- ✅ **已通过 WFO 样本外验证 (p=0.0016)**
- ⚠️ 风险控制不足 (无止损，最大回撤 -39%)
- ⚠️ 数据质量有待改善

**核心结论**:
策略已通过 WFO 滚动样本外验证，p=0.0016 表明因子预测能力统计显著。
主要改进方向是**风险控制**（添加止损）和**参数稳健性验证**。

**下一步行动**:
```bash
# 1. 参数敏感性测试  
uv run python scripts/param_sensitivity.py

# 2. 添加止损后重新回测
uv run python scripts/backtest_with_stoploss.py

# 3. 清理数据质量问题
uv run python scripts/validate_etf_data.py
```

---

**报告生成**: AI Quant Architect  
**最后更新**: 2025-11-30
