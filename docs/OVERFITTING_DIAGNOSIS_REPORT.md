# 🔬 深度过拟合诊断报告

> **⚠️ 历史研究文档**
>
> 此报告基于 **v3.1 (FREQ=3, 无 hysteresis)** 下的分析。v5.0 生产策略 S1 使用 **ADX_14D** 作为核心因子（与本报告"禁止 ADX"建议不同），原因是：
> 1. ADX 的横截面排名高度稳定（rank autocorrelation > 0.8），与 Exp4 hysteresis (delta_rank=0.10, min_hold_days=9) 高度兼容
> 2. 条件因子消融实验（2026-02-11）推翻了"ADX 失效"假设 — 详见 [conditional_factor_negative_results.md](research/conditional_factor_negative_results.md)
> 3. v3.1 时代无 hysteresis、FREQ=3，执行环境与 v5.0 完全不同，因子有效性结论不可直接迁移
>
> **本报告正文保持原始研究完整性，不做修改。**

**日期**: 2025-12-11
**分析范围**: 62,985 个因子组合
**训练期**: 2020-01-01 ~ 2025-04-30
**Holdout期**: 2025-05-01 ~ 2025-12-08

---

## 📊 核心发现

### 1. 训练期排序完全失效 ⚠️

| 指标 | 数值 | 说明 |
|------|------|------|
| **Spearman秩相关** | **-0.26** | 🚨 负相关！训练排序与Holdout表现反向 |
| Pearson相关 | -0.28 | 同样负相关 |
| 训练Top10 Holdout收益 | -1.0% | 训练最优组合在Holdout亏损 |
| 训练Top1000 Holdout收益 | 0.5% | 几乎为0 |
| 全量62,985 Holdout收益 | **6.3%** | 随机选择反而更好！ |

**结论**: 按训练期综合得分(0.4*收益+0.3*Sharpe-0.3*回撤)排序的Top1000，在Holdout期的表现**劣于随机选择**。

---

### 2. 因子失效与新兴因子

#### 训练期"最优"因子在Holdout期崩溃

| 因子 | 训练Top1000占比 | Holdout Top500占比 | 变化 |
|------|----------------|-------------------|------|
| ADX_14D | 75.7% | 6.0% | **-69.7%** 📉 |
| SHARPE_RATIO_20D | 61.9% | 22.4% | -39.5% 📉 |
| MOM_20D | 53.4% | 13.6% | -39.8% 📉 |
| RELATIVE_STRENGTH_VS_MARKET_20D | 50.9% | 15.6% | -35.3% 📉 |
| SLOPE_20D | 49.0% | 15.4% | -33.6% 📉 |

#### Holdout期真正有效的因子

| 因子 | 训练Top1000占比 | Holdout Top500占比 | 变化 |
|------|----------------|-------------------|------|
| **CMF_20D** | 12.8% | 79.8% | **+67.0%** 📈 |
| **MAX_DD_60D** | 47.7% | 88.2% | **+40.5%** 📈 |
| **CORRELATION_TO_MARKET_20D** | 37.5% | 69.0% | +31.5% 📈 |
| RET_VOL_20D | 27.8% | 41.6% | +13.8% 📈 |

**核心问题**: 训练期WFO选出的趋势因子(ADX/MOM/SLOPE)在Holdout期完全失效，而资金流(CMF)、风险(MAX_DD)、相关性因子被严重低估。

---

### 3. 复杂度陷阱：高阶组合过拟合严重

| 组合阶数 | 数量 | 训练收益 | Holdout收益 | 收益衰减 | 衰减比例 |
|---------|------|---------|------------|---------|---------|
| 2因子 | 153 | 8.6% | **10.5%** | -1.8% | -21% ✅ |
| 3因子 | 816 | 9.1% | **9.8%** | -0.7% | -8% ✅ |
| 4因子 | 3,060 | 11.1% | 8.6% | +2.5% | 23% |
| 5因子 | 8,568 | 13.1% | 7.5% | +5.7% | 43% ⚠️ |
| **6因子** | **18,564** | **15.1%** | **6.4%** | **+8.7%** | **57%** 🚨 |
| **7因子** | **31,824** | **16.5%** | **5.6%** | **+10.9%** | **66%** 🚨 |

**关键发现**:
- 训练Top1000中，52.8%是7因子组合，29.9%是6因子组合（合计82.7%）
- 6-7因子组合的收益衰减高达**57-66%**，严重过拟合
- 2-3因子组合反而稳定，甚至在Holdout期表现更好（负衰减）

---

### 4. 市场环境：Holdout期是牛市

| 指标 | 训练期 (5年) | Holdout期 (7个月) |
|------|-------------|-----------------|
| 平均收益率 | 12.6% | **24.9%** ⬆️ |
| 中位收益率 | 8.8% | **19.7%** ⬆️ |
| 平均Sharpe | 0.27 | **1.72** ⬆️ |
| 平均最大回撤 | -48.6% | **-11.6%** ⬆️ (改善) |
| 正收益ETF占比 | 58.1% | **93.0%** ⬆️ |

**惊人发现**: Holdout期(2025-05~12)市场环境**远好于**训练期！
- ETF平均收益翻倍 (12.6% → 24.9%)
- Sharpe从0.27飙升至1.72
- 93%的ETF正收益（接近全面牛市）

**这意味着什么？**
1. 训练Top1000在牛市中仍亏损/微利 → **严重过拟合**
2. 全量62,985随机选择在牛市中赚6.3% → 合理
3. 训练期选出的因子(ADX/MOM)**对牛市无效**，甚至反向

---

### 5. ETF层面的风格轮动

| 训练期Top10 | 训练期收益 | Holdout期收益 | Holdout排名 | 排名变化 |
|------------|-----------|--------------|------------|---------|
| 513100 | +123% | +34% | 12 | **+11** |
| 518880 | +122% | +20% | 22 | **+20** |
| 515180 | +60% | +3.5% | 38 | **+33** ⚠️ |
| 512690 | +34% | **-6.7%** | 43 | **+34** 🚨 |

**Spearman秩相关**: 仅0.10，ETF强弱排序几乎无延续性。

**典型案例**:
- 512690: 训练第9 → Holdout倒数第1（唯一负收益）
- 159949: 训练第13 → Holdout第1（+75.7%）

---

## 🎯 双重挡板筛选结果

**阈值**: 训练期>80分位 ∩ Holdout期>80分位

| 指标 | 数值 |
|------|------|
| 通过数量 | **1,665** (占2.64%) |
| Holdout平均收益 | **42.7%** |
| Holdout平均Sharpe | **2.19** |
| Holdout平均MaxDD | **14.8%** |

### Top5 稳定组合

1. **CMF + CORR_TO_MARKET + MAX_DD_60D + PRICE_POSITION_120D + RET_VOL + VOL_RATIO_60D**
   - Holdout收益: **68.2%**, Sharpe: 3.13, MaxDD: 13.3%
   
2. **CMF + CORR_TO_MARKET + MAX_DD_60D + PRICE_POS_120D + PRICE_POS_20D + RET_VOL + VOL_RATIO_60D**
   - Holdout收益: **67.5%**, Sharpe: 3.12, MaxDD: 13.3%

3. **CMF + CORR_TO_MARKET + MAX_DD_60D + PV_CORR + RET_VOL + VOL_RATIO_60D**
   - Holdout收益: **66.5%**, Sharpe: 3.03, MaxDD: 16.0%

**共同特征**:
- 全部包含 **MAX_DD_60D** (风险控制)
- 全部包含 **CMF_20D** (资金流)
- 82%包含 **CORRELATION_TO_MARKET_20D**
- 阶数多为6-7（但这些是双重验证的，非纯训练期选出）

---

## 💡 根本原因分析

### 为什么训练期排序失效？

#### 1. **评分公式偏向趋势因子**
训练期综合分 = `0.4*收益 + 0.3*Sharpe - 0.3*回撤`

- 训练期(2020-2025-04)涵盖多轮牛熊，趋势因子(ADX/MOM)在训练集内表现优异
- 但这些因子在**单边牛市**(2025-05~12)中失效，因为：
  - ADX衡量趋势强度，牛市中波动下降反而得分低
  - MOM动量在持续上涨中信号钝化
  - SLOPE线性拟合在震荡式上涨中噪音大

#### 2. **资金流因子在训练期被低估**
- CMF (Chaikin Money Flow) 在训练Top1000中仅12.8%
- 但在Holdout Top500中占79.8%
- 原因：CMF在牛市中捕捉增量资金，而训练期熊市占比高，CMF表现被压制

#### 3. **组合复杂度过高**
- 训练Top1000中82.7%是6-7因子组合
- 高维组合在WFO中因自由度高，容易拟合IS噪音
- 但在新市场环境下泛化能力崩溃

#### 4. **市场环境变化**
- 训练期(5年): 熊牛震荡混合，平均Sharpe 0.27
- Holdout期(7月): 单边牛市，平均Sharpe 1.72
- 因子有效性取决于市场regime，WFO假设regime稳定，但实际发生巨变

---

## 🛠️ 建议方案

### 短期方案：双重挡板筛选

```python
# 已生成: results/vec_from_wfo_20251211_205649/stable_combos_dual_gate.csv
# 1,665个通过训练80%+Holdout80%的组合

# 进一步筛选建议:
1. 回撤上限: MaxDD < 15%
2. 阶数限制: 2-5因子 (避免过拟合)
3. 必选因子: MAX_DD_60D (91%的Holdout Top500包含)
4. 优选因子: CMF_20D, CORRELATION_TO_MARKET_20D
5. 禁止因子: ADX_14D (严重失效)
```

### 中期方案：重构筛选逻辑

1. **放弃训练期排序**: 当前的综合得分公式在regime切换下无效
2. **Regime感知筛选**:
   ```python
   # 分牛市/熊市/震荡三种regime分别WFO
   # 按当前regime动态选择因子池
   ```
3. **降阶约束**: 限制组合阶数≤5，强制降低复杂度
4. **因子稳定性测试**: 
   ```python
   # 不只看训练期表现，看IS/OOS表现的"方差"
   # 淘汰方差大的因子（不稳定）
   ```

### 长期方案：引入在线学习

```python
# 不再依赖固定WFO，改用滚动更新
1. 每月重新评估因子权重
2. 根据最近1年表现动态调整因子池
3. 引入regime检测器，自动切换因子集
```

---

## 📋 立即可执行的筛选脚本

已生成 `scripts/dual_gate_filter.py`，可以：

```bash
# 执行双重挡板 + 回撤约束
uv run python scripts/dual_gate_filter.py \
    --train_quantile 0.70 \
    --hold_quantile 0.80 \
    --max_drawdown 0.15 \
    --max_complexity 5 \
    --output results/filtered_for_bt.csv

# 输出Top50供BT小规模审计
```

---

## ✅ 核心结论

1. **训练期Top1000是过拟合陷阱**，在牛市中仍亏损/微利
2. **真正稳定的组合**: 
   - 通过双重挡板 (训练期合格 ∩ Holdout合格)
   - 低阶组合 (2-3因子，最多5因子)
   - 包含MAX_DD_60D + CMF_20D核心因子
3. **禁止使用**: ADX_14D, SHARPE_RATIO_20D, MOM_20D (训练期过拟合)
4. **市场环境**: Holdout期是牛市，策略失效不是市场差，而是因子选择错误

---

**下一步行动**:
1. ✅ 导出 `stable_combos_dual_gate.csv` (1,665个)
2. 🔜 进一步筛选: MaxDD<15%, 阶数≤5, 必含MAX_DD_60D
3. 🔜 BT小规模审计 (Top20)
4. 🔜 重构WFO逻辑（引入regime感知）
