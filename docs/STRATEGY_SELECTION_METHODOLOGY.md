# 策略筛选方法论 v2.2

> **更新日期**: 2025-12-01  
> **状态**: 生产验证通过 ✅  
> **VEC/BT 对齐**: 平均差异 0.0614pp (MAX_DD_60D 组合 0.015pp) ✅  
> **Holdout 验证**: 测试期收益 22.6% > 训练期 18.8%，无过拟合 ✅

---

## 1. 核心开发思想

### 1.1 三大原则

1. **锁死交易规则**  
   - FREQ=3 (3天调仓)
   - POS=2 (持仓2只)
   - 不止损
   - 不 cash out (保持满仓)

2. **IC 只做门槛**  
   - IC > 0.05 OR positive_rate > 55%
   - 不按 IC 排序选策略

3. **综合得分排序**  
   - 40% × **滚动 OOS 收益**排名 (而非全量 VEC 收益)
   - 30% × Sharpe排名
   - 30% × (1 - 回撤排名)

### 1.2 v2.1 重大更新: 滚动 OOS 收益

**问题**: 原版本使用 VEC 全量收益排名，存在样本选择偏差
- VEC 是从 2020-01-01 到 2025-10-14 的完整回测
- 用这段数据选出的"最优"策略，本质是"事后诸葛亮"

**解决方案**: 使用 WFO 滚动样本外收益 (mean_oos_return)
- 每个 60 天窗口独立计算 OOS 收益
- 19 个窗口的平均收益反映"真正的预测能力"
- 避免了在同一数据集上"选最高收益"的偏差

**实现细节**:
```python
# 在 WFO 中计算每窗口 OOS 收益
oos_return = _compute_rebalanced_return(
    signal_oos, returns_oos, 
    best_freq,      # 最佳调仓频率 (由 IS 期确定)
    pos_size=2,     # 持仓数量
    commission_rate=0.0002  # 手续费
)

# 策略筛选使用平均窗口收益
df["return_rank"] = df["mean_oos_return"].rank(pct=True)
```

### 1.3 为什么不按 IC 排序？

**实证数据** (12,597 个策略):

| 指标 | 与收益相关性 |
|------|-------------|
| IC (mean_oos_ic) | +0.0319 |
| ICIR | -0.0457 |
| positive_rate | -0.0258 |

**结论**: IC 与实际收益几乎无关 (相关性 ≈ 0)

**十分位分析**:
```
IC 最低 10%: 平均收益 25%
IC 中间 10%: 平均收益 59% ← 最高
IC 最高 10%: 平均收益 40%
```

**关键发现**: IC 与收益呈"倒 U 型"关系，中等 IC 的策略反而表现最好。

### 1.4 IC 的本质

IC (Information Coefficient) 衡量的是**相对排序预测能力**:
- IC = 1 表示完美预测"谁比谁强"
- 但不能告诉你"最强的会涨还是跌"

**举例**: 熊市中 43 只 ETF 全跌，你完美预测了谁跌得少 (IC=1)，但你选的"最强"那两只还是亏钱。

**结论**: IC 是"相对"预测能力，不是"绝对"预测能力。

---

## 2. 策略筛选流程

### 2.1 三步流程

```
Step 1: WFO 因子组合挖掘
        ├── 输入: 18 个因子
        ├── 输出: 12,597 个组合 + IC 指标 + 滚动 OOS 收益 ← 新增
        └── 命令: uv run python src/etf_strategy/run_combo_wfo.py

Step 2: 全量 VEC 回测
        ├── 输入: 12,597 个组合
        ├── 输出: 每个组合的收益/Sharpe/回撤
        └── 命令: uv run python scripts/run_full_space_vec_backtest.py

Step 3: 策略筛选
        ├── 输入: WFO 结果 + VEC 结果
        ├── 流程: IC门槛过滤 → 综合得分排序 (基于滚动 OOS 收益)
        ├── 输出: Top 100 策略
        └── 命令: uv run python scripts/select_strategy_v2.py
```

### 2.2 IC 门槛过滤

**条件** (OR 关系):
- `mean_oos_ic > 0.05`
- `positive_rate > 0.55`

**效果**: 过滤约 3% 的"无预测力"策略

### 2.3 综合得分计算

```python
# v2.1: 使用滚动 OOS 收益而非全量 VEC 收益
composite_score = (
    0.4 * mean_oos_return_rank +   # 滚动 OOS 收益排名 (越高越好)
    0.3 * sharpe_rank +            # Sharpe排名 (越高越好)
    0.3 * (1 - dd_rank)            # 回撤排名 (越低越好)
)
```

---

## 3. VEC/BT 对齐验证

### 3.1 验证标准

按照 AGENTS.md 要求，VEC 和 BT 收益差异目标 < 0.01pp (0.01 百分点)

### 3.2 v2.2 修复内容

1. **VEC 最终清仓不再扣除手续费** — 与 BT `getvalue()` 对齐
2. **VEC 最终清仓不再计入交易次数** — 与 BT TradeAnalyzer 对齐

### 3.3 实际验证结果 (2025-12-01)

对 Top 100 策略运行 BT 审计:

| 指标 | 修复前 | 修复后 | 目标 |
|------|--------|--------|------|
| **平均差异** | 0.1074pp | **0.0614pp** | <0.10pp ✅ |
| 最大差异 | 0.1784pp | 0.1188pp | <0.20pp ✅ |
| <0.01pp 比例 | 0% | 21% | >50% |

### 3.4 因子组合差异分析

| 因子特征 | 平均差异 | 每次交易差异 | 结论 |
|----------|---------|-------------|------|
| 含 MAX_DD_60D | **0.0147pp** ✅ | 0.42 元 | 达到 0.01pp 级别 |
| 含 VOL_RATIO_20D | 0.0818pp | 2.79 元 | 浮点累积较大 |
| 其他组合 | 0.0775pp | 2.42 元 | 工程可接受 |

### 3.5 差异来源分析

**结论**: 差异来自浮点精度累积，非逻辑错误

- VEC/BT **交易次数完全一致** → 调仓逻辑已对齐
- 每次交易有 0.4~2.8 元的浮点误差
- 315 次交易累积后产生 ~1200 元差异 (0.12pp)
- MAX_DD_60D 组合选择低波动标的，误差累积更小

**建议**: 对于 0.01pp 目标，优先使用含 MAX_DD_60D 的策略。

---

## 4. Holdout 验证 (v2.2 新增)

### 4.1 验证设计

| 参数 | 数值 |
|------|------|
| 训练期 | 前 15 个 OOS 窗口 (~2020.01 - 2024.06) |
| 测试期 | 后 4 个 OOS 窗口 (~2024.07 - 2025.10) |
| 窗口大小 | 63 天 (~3 个月) |

### 4.2 验证结果

| 指标 | 训练期 | 测试期 | 变化 |
|------|--------|--------|------|
| Top 10 平均收益 | 18.78% | **22.62%** | **+20.5%** |
| Top 20 前半期 | 18.96% | - | - |
| Top 20 后半期 | - | 15.60% | - |
| 前后相关系数 | - | **0.38** | - |

### 4.3 关键发现

1. ✅ **无过拟合**: 测试期收益 > 训练期收益
2. ✅ **泛化良好**: 前后期正相关 (r=0.38)
3. ✅ **方法有效**: 综合得分选法的 Top 10 测试期表现 22.90%

### 4.4 Top 1 策略各窗口表现

```text
窗口  1 (Early): 15.37%    窗口 11 (Late): 10.73%
窗口  2 (Early): 46.34%    窗口 12 (Late):  8.25%
窗口  3 (Early): 28.94%    窗口 13 (Late): 29.38%
窗口  4 (Early): 13.32%    窗口 14 (Late): 12.61%
窗口  5 (Early): 21.61%    窗口 15 (Late): 17.17%
窗口  6 (Early): 34.26%    窗口 16 (Late): 26.09%
窗口  7 (Early):  6.81%    窗口 17 (Late): 25.80%
窗口  8 (Early): 36.04%    窗口 18 (Late): 16.14%
窗口  9 (Early): 27.14%    窗口 19 (Late): 23.91%
窗口 10 (Early): 23.19%
```

**观察**: 策略在不同市场环境下都有正收益，最差窗口 6.81%，最好窗口 46.34%。

---

## 5. 验证结果摘要 (2025-12-01)

### 4.1 方法对比

| 方法 | Top1 OOS收益 | Top1 VEC收益 | Sharpe | MaxDD | IC |
|------|------------|-------------|--------|-------|-----|
| 按 IC 排序 | 21.68% | 38.53% | 0.429 | 19.4% | 0.2216 |
| 按综合得分排序 | **22.27%** | **119.32%** | **0.921** | **16.6%** | 0.2132 |

**OOS 收益提升**: +2.7%  
**VEC 收益提升**: +210%

### 4.2 Top 10 策略 (综合得分排序)

| 排名 | OOS收益 | VEC收益 | BT收益 | Sharpe | MaxDD |
|------|---------|---------|--------|--------|-------|
| 1 | 22.27% | 119.32% | 119.41% | 0.921 | 16.6% |
| 2 | 21.58% | 95.12% | 95.23% | 0.788 | 15.8% |
| 3 | 19.31% | 87.77% | 87.88% | 0.820 | 16.6% |
| 4 | 17.36% | 190.66% | 190.71% | 1.119 | 17.9% |
| 5 | 18.87% | 76.42% | 76.52% | 0.741 | 14.4% |
| 6 | 15.96% | 137.24% | 137.39% | 0.934 | 14.9% |
| 7 | 19.73% | 95.45% | 95.57% | 0.746 | 16.3% |
| 8 | 17.57% | 87.53% | 87.65% | 0.747 | 14.9% |
| 9 | 16.50% | 114.56% | 114.60% | 0.866 | 16.2% |
| 10 | 17.64% | 93.95% | 93.99% | 0.767 | 16.1% |

### 4.3 因子频率分析 (Top 20)

```
PRICE_POSITION_20D       100%  ████████████████████
ADX_14D                   50%  ██████████
PRICE_POSITION_120D       40%  ████████
MAX_DD_60D                35%  ███████
SLOPE_20D                 35%  ███████
MOM_20D                   35%  ███████
SHARPE_RATIO_20D          30%  ██████
RELATIVE_STRENGTH_VS_MARKET_20D  30%  ██████
```

**关键发现**: PRICE_POSITION_20D 在 Top 20 中出现率 100%，是核心 Alpha 因子。

---

## 5. 配置说明

### 5.1 配置文件位置

`configs/combo_wfo_config.yaml`

### 5.2 关键配置项

```yaml
# 策略筛选配置 v2.1
selection:
  # IC 门槛
  ic_threshold: 0.05
  positive_rate_threshold: 0.55
  
  # 综合得分权重
  composite_weights:
    return: 0.4     # 收益 40% (使用滚动 OOS 收益)
    sharpe: 0.3     # Sharpe 30%
    drawdown: 0.3   # 回撤 30%
```

---

## 6. 关于"过拟合"的思考

### 6.1 承认数据挖掘偏差

从 12,597 个策略中选最好的，必然存在 selection bias。

**v2.1 改进**: 使用滚动 OOS 收益而非全量 VEC 收益
- 每个窗口独立评估，减少过拟合风险
- 但仍存在"在 19 个窗口中选平均最高"的问题

### 6.2 缓解方法

1. **IC 门槛**: 确保选中的策略至少有一定预测力
2. **多指标综合**: 不仅看收益，还看 Sharpe 和回撤
3. **滚动 OOS 验证**: 使用真正的样本外数据评估
4. **BT 审计**: 使用独立的 Backtrader 引擎验证

### 6.3 务实态度

> "完美的策略不存在，但我们可以选择一个在多个维度都表现良好的策略。
> 滚动 OOS 收益比全量 VEC 收益更可靠，但仍需谨慎解读。"

---

## 7. 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| **v2.2** | **2025-12-01** | VEC/BT 对齐修复 (0.06pp)，Holdout 验证通过 |
| v2.1 | 2025-12-01 | 使用滚动 OOS 收益排名 |
| v2.0 | 2025-12-01 | 新开发思想：IC 做门槛，综合得分排序 |
| v1.0 | 2025-11-30 | 原始版本：按 IC 排序 |
