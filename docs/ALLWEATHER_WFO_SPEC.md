# å…¨å¤©å€™ç­–ç•¥ WFO ä¼˜åŒ–æ–¹æ¡ˆè§„æ ¼ä¹¦

> **ç‰ˆæœ¬**: 1.1  
> **æ—¥æœŸ**: 2025-11-28  
> **çŠ¶æ€**: å®æ–½ä¸­  
> **è´Ÿè´£äºº**: AI Agent (Claude/Gemini)

---

## âš ï¸ é‡è¦å‘ç° (2025-11-28 å®æµ‹)

### WFO ä¼˜åŒ– vs åŸºå‡†å¯¹æ¯”ç»“æœ

| æŒ‡æ ‡ | WFOä¼˜åŒ– | åŸºå‡†(Rank3) | å·®å¼‚ |
|------|---------|-------------|------|
| **æ€»æ”¶ç›Š** | 11.5% | 28.0% | **-16.5pp** âŒ |
| **æœ€å¤§å›æ’¤** | 20.2% | 14.3% | **+5.9pp** âŒ |
| **å¤æ™®æ¯”ç‡** | 0.24 | 0.51 | **-0.27** âŒ |

### å…³é”®ç»“è®º

1. **ICIR é«˜ â‰  æ”¶ç›Šé«˜**: WFO é€‰å‡ºçš„å› å­åœ¨ IC ç»´åº¦è¡¨ç°å¥½ï¼Œä½†åœ¨å®é™…æ”¶ç›Šç»´åº¦ä¸å¦‚ç®€å•å› å­
2. **è¿‡åº¦æ‹Ÿåˆé£é™©**: å¤æ‚å› å­ç»„åˆï¼ˆå¦‚ `PV_CORR_20D`, `VORTEX_14D`ï¼‰åœ¨å†å²çª—å£è¡¨ç°å¥½ï¼Œä½†ç¼ºä¹é•¿æœŸé²æ£’æ€§
3. **ç®€å•å³ç¾**: "Rank 3" (ADX + PRICE_POSITION + SHARPE + SLOPE) æ›´ç¨³å¥
4. **COMMODITY æ± æ— è§£**: åªæœ‰ 2 ä¸ª ETFï¼Œå› å­é€‰è‚¡æ— æ³•æœ‰æ•ˆå·¥ä½œ

### å»ºè®®æ–¹æ¡ˆ

**æ–¹æ¡ˆ A: æ··åˆç­–ç•¥**ï¼ˆæ¨èï¼‰
- æƒç›Šæ± ç”¨ WFO é€‰å‡ºçš„å› å­
- å€ºåˆ¸/å•†å“/QDII æ± ç”¨ç®€å•åŠ¨é‡

**æ–¹æ¡ˆ B: å…¨éƒ¨å›é€€**
- æ‰€æœ‰æ± ç»Ÿä¸€ä½¿ç”¨ "Rank 3" åŸºå‡†å› å­
- æ”¾å¼ƒæ± ç‰¹å¼‚æ€§å› å­ä¼˜åŒ–

---

## ğŸ“‹ ç›®å½•

1. [æ–¹æ¡ˆæ¦‚è¿°](#1-æ–¹æ¡ˆæ¦‚è¿°)
2. [æ ¸å¿ƒç†å¿µ](#2-æ ¸å¿ƒç†å¿µ)
3. [ç³»ç»Ÿæ¶æ„](#3-ç³»ç»Ÿæ¶æ„)
4. [å› å­ä½“ç³»](#4-å› å­ä½“ç³»)
5. [WFO æµç¨‹](#5-wfo-æµç¨‹)
6. [å¼€å‘æŒ‡å—](#6-å¼€å‘æŒ‡å—)
7. [æµ‹è¯•è§„èŒƒ](#7-æµ‹è¯•è§„èŒƒ)
8. [éªŒæ”¶æ ‡å‡†](#8-éªŒæ”¶æ ‡å‡†)
9. [æ–‡ä»¶æ¸…å•](#9-æ–‡ä»¶æ¸…å•)

---

## 1. æ–¹æ¡ˆæ¦‚è¿°

### 1.1 èƒŒæ™¯

ä¹‹å‰çš„å…¨å¤©å€™ç­–ç•¥å®ç°å­˜åœ¨**æ ¹æœ¬æ€§æ¶æ„ç¼ºé™·**ï¼š

| é—®é¢˜ | æè¿° |
|------|------|
| æ‰‹å·¥ç¡¬ç¼–ç è§„åˆ™ | ç‰›å¸‚1.6å€ã€ç†Šå¸‚0.6å€ç­‰å‚æ•°æ˜¯æ‹è„‘è¢‹çš„ |
| è·³è¿‡å› å­ç­›é€‰ | ç›´æ¥å†™æ­»å› å­ç»„åˆï¼Œæ²¡æœ‰æ•°æ®é©±åŠ¨ä¼˜åŒ– |
| ä½“åˆ¶åˆ‡æ¢é€»è¾‘ | ç”¨ if-else è§„åˆ™è€Œéå› å­åŒ–å¤„ç† |

### 1.2 ç›®æ ‡

æ„å»ºä¸€ä¸ª**çº¯å› å­é©±åŠ¨ã€æ•°æ®ä¼˜åŒ–**çš„å…¨å¤©å€™ç­–ç•¥ç³»ç»Ÿï¼š

```
å› å­æ¨ªæˆªé¢æ„å»º â†’ WFO ç½‘æ ¼æœç´¢ â†’ VEC æ‰¹é‡éªŒè¯ â†’ BT å®¡è®¡
```

### 1.3 å…³é”®åŸåˆ™

1. **ä¸€åˆ‡çš†å› å­**: åŒ…æ‹¬æ‹©æ—¶ä¿¡å·ã€ä½“åˆ¶åˆ¤æ–­éƒ½åº”è¯¥å› å­åŒ–
2. **æ•°æ®é©±åŠ¨**: æ‰€æœ‰å‚æ•°é€šè¿‡ WFO ä¼˜åŒ–ï¼Œä¸æ‰‹å·¥è®¾å®š
3. **åˆ†æ± ç‹¬ç«‹**: æ¯ä¸ªèµ„äº§æ± æœ‰ç‹¬ç«‹çš„å› å­ç»„åˆ
4. **VEC/BT å¯¹é½**: å·®å¼‚ < 0.01 ä¸ªç™¾åˆ†ç‚¹

---

## 2. æ ¸å¿ƒç†å¿µ

### 2.1 ä»€ä¹ˆæ˜¯"ä¸€åˆ‡çš†å› å­"ï¼Ÿ

ä¼ ç»Ÿåšæ³•ï¼š
```python
# âŒ é”™è¯¯ï¼šç¡¬ç¼–ç è§„åˆ™
if is_bull_market:
    equity_weight = 0.8
else:
    equity_weight = 0.3
```

æ­£ç¡®åšæ³•ï¼š
```python
# âœ… æ­£ç¡®ï¼šå› å­åŒ–
# æ‹©æ—¶ä¿¡å·å˜æˆå› å­ï¼Œå‚ä¸æ¨ªæˆªé¢æ’åº
factors['REGIME_SCORE'] = compute_regime_factor(close_prices)
# WFO å†³å®šæ˜¯å¦ä½¿ç”¨è¿™ä¸ªå› å­ï¼Œä»¥åŠæƒé‡
```

### 2.2 ä¸ºä»€ä¹ˆè¦åˆ†æ± ç‹¬ç«‹ WFOï¼Ÿ

ä¸åŒèµ„äº§ç±»åˆ«çš„**æœ‰æ•ˆå› å­ä¸åŒ**ï¼š

| èµ„äº§ç±»åˆ« | æœ‰æ•ˆå› å­ç‰¹å¾ |
|---------|-------------|
| æƒç›Š (Equity) | åŠ¨é‡ã€è¶‹åŠ¿å¼ºåº¦ã€æ³¢åŠ¨ç‡ |
| å€ºåˆ¸ (Bond) | æ”¶ç›Šç‡æ–œç‡ã€ä¹…æœŸã€ä¿¡ç”¨åˆ©å·® |
| å•†å“ (Commodity) | ç¾å…ƒåå‘ã€é¿é™©éœ€æ±‚ã€é€šèƒ€é¢„æœŸ |
| QDII | æ±‡ç‡åŠ¨é‡ã€è·¨å¸‚åœºä»·å·® |

**å¿…é¡»è®©æ¯ä¸ªæ± ç‹¬ç«‹ WFO**ï¼Œæ‰¾åˆ°å„è‡ªçš„æœ€ä¼˜å› å­ç»„åˆã€‚

### 2.3 æƒé‡åˆ†é…æœºåˆ¶

**ä¸å†ç¡¬ç¼–ç æƒé‡**ï¼Œè€Œæ˜¯ï¼š

1. æ¯ä¸ªæ± å†…é€‰å‡º Top N ä¸ª ETF
2. æ± å†…ç­‰æƒåˆ†é…
3. æ± é—´æƒé‡ç”±**ç»„åˆå› å­**å†³å®šï¼ˆä¹Ÿæ˜¯ WFO ä¼˜åŒ–çš„ï¼‰

```
æ€»ä»“ä½ = Î£ (æ± æƒé‡ Ã— æ± å†…é€‰è‚¡)
æ± æƒé‡ = f(æ± çº§å› å­å¾—åˆ†)  # ç”± WFO ä¼˜åŒ–
```

---

## 3. ç³»ç»Ÿæ¶æ„

### 3.1 æ•´ä½“æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Phase 1: å› å­æ„å»º                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æƒç›Šå› å­    â”‚ â”‚ å€ºåˆ¸å› å­    â”‚ â”‚ å•†å“å› å­    â”‚ â”‚ QDIIå› å­   â”‚ â”‚
â”‚  â”‚ 18ä¸ªåŸºç¡€    â”‚ â”‚ 5ä¸ªä¸“å±     â”‚ â”‚ 5ä¸ªä¸“å±     â”‚ â”‚ 5ä¸ªä¸“å±    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    æ‹©æ—¶/ä½“åˆ¶å› å­ (å…¨å±€)                      â”‚ â”‚
â”‚  â”‚  MA_REGIME, MOM_REGIME, VOL_REGIME, GOLD_SIGNAL            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Phase 2: WFO ä¼˜åŒ–                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ¯ä¸ªæ± ç‹¬ç«‹ WFO:                                             â”‚ â”‚
â”‚  â”‚  - è¾“å…¥: æ± å†… ETF + å€™é€‰å› å­é›†                               â”‚ â”‚
â”‚  â”‚  - æœç´¢: å› å­ç»„åˆ Ã— å‚æ•°ç½‘æ ¼                                 â”‚ â”‚
â”‚  â”‚  - è¾“å‡º: æœ€ä¼˜å› å­ç»„åˆ + æœ€ä¼˜å‚æ•°                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æ± é—´æƒé‡ WFO:                                               â”‚ â”‚
â”‚  â”‚  - è¾“å…¥: å„æ± çš„å†å²æ”¶ç›Šåºåˆ—                                  â”‚ â”‚
â”‚  â”‚  - æœç´¢: æƒé‡åˆ†é…æ–¹æ¡ˆ                                        â”‚ â”‚
â”‚  â”‚  - è¾“å‡º: æœ€ä¼˜æ± é—´æƒé‡                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Phase 3: VEC æ‰¹é‡å›æµ‹                        â”‚
â”‚  - ä½¿ç”¨ WFO è¾“å‡ºçš„æœ€ä¼˜é…ç½®                                       â”‚
â”‚  - ç”Ÿæˆå®Œæ•´å›æµ‹æŠ¥å‘Š                                              â”‚
â”‚  - è¾“å‡º daily_values.csv                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Phase 4: BT å®¡è®¡                             â”‚
â”‚  - ä½¿ç”¨ Backtrader äº‹ä»¶é©±åŠ¨å¼•æ“å¤ç°                              â”‚
â”‚  - éªŒè¯ VEC â†” BT å·®å¼‚ < 0.01pp                                  â”‚
â”‚  - ç”Ÿæˆå®¡è®¡æŠ¥å‘Š                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ•°æ®æµ

```
raw/ETF/*.csv
    â†“
DataLoader (OHLCV)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          å› å­è®¡ç®—å±‚                   â”‚
â”‚  â”œâ”€â”€ PreciseFactorLibrary (18å› å­)   â”‚
â”‚  â”œâ”€â”€ BondFactors (5å› å­)             â”‚
â”‚  â”œâ”€â”€ CommodityFactors (5å› å­)        â”‚
â”‚  â”œâ”€â”€ QDIIFactors (5å› å­)             â”‚
â”‚  â””â”€â”€ RegimeFactors (4å› å­)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
factors_3d: np.ndarray [T, N, F]
    â†“
WFO Engine â†’ æœ€ä¼˜é…ç½® JSON
    â†“
VEC Backtest Kernel â†’ daily_values
    â†“
BT Audit â†’ éªŒè¯æŠ¥å‘Š
```

### 3.3 ç›®å½•ç»“æ„

```
etf_rotation_optimized/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ precise_factor_library_v2.py  # 18ä¸ªåŸºç¡€å› å­
â”‚   â”œâ”€â”€ category_factors.py           # åˆ†ç±»å› å­ (Bond/Commodity/QDII)
â”‚   â”œâ”€â”€ regime_factors.py             # ã€æ–°å¢ã€‘æ‹©æ—¶/ä½“åˆ¶å› å­
â”‚   â”œâ”€â”€ backtester_vectorized.py      # VEC æ ¸å¿ƒ
â”‚   â”œâ”€â”€ wfo_engine.py                 # WFO å¼•æ“
â”‚   â””â”€â”€ shared_types.py               # å…±äº«å·¥å…·
â”œâ”€â”€ run_unified_wfo.py                # ç°æœ‰ WFO å…¥å£
â””â”€â”€ run_allweather_wfo.py             # ã€æ–°å¢ã€‘å…¨å¤©å€™ WFO å…¥å£

scripts/
â”œâ”€â”€ batch_vec_backtest.py             # VEC æ‰¹é‡å›æµ‹
â”œâ”€â”€ batch_bt_backtest.py              # BT æ‰¹é‡å®¡è®¡
â””â”€â”€ compare_vec_bt_metrics.py         # å¯¹é½éªŒè¯

configs/
â”œâ”€â”€ etf_pools.yaml                    # æ± é…ç½®
â””â”€â”€ allweather_wfo_config.yaml        # ã€æ–°å¢ã€‘å…¨å¤©å€™ WFO é…ç½®
```

---

## 4. å› å­ä½“ç³»

### 4.1 å› å­åˆ†ç±»

#### 4.1.1 åŸºç¡€å› å­ (æ‰€æœ‰èµ„äº§é€šç”¨)

| å› å­å | è®¡ç®—æ–¹å¼ | å«ä¹‰ |
|--------|---------|------|
| MOM_20D | 20æ—¥æ”¶ç›Šç‡ | çŸ­æœŸåŠ¨é‡ |
| MOM_60D | 60æ—¥æ”¶ç›Šç‡ | ä¸­æœŸåŠ¨é‡ |
| VOL_20D | 20æ—¥æ³¢åŠ¨ç‡ | çŸ­æœŸé£é™© |
| SHARPE_20D | 20æ—¥å¤æ™®æ¯”ç‡ | é£é™©è°ƒæ•´æ”¶ç›Š |
| ADX_14D | 14æ—¥ADX | è¶‹åŠ¿å¼ºåº¦ |
| RSI_14D | 14æ—¥RSI | è¶…ä¹°è¶…å– |
| SLOPE_20D | 20æ—¥æ–œç‡ | è¶‹åŠ¿æ–¹å‘ |
| PRICE_POSITION_20D | ä»·æ ¼ä½ç½® | ç›¸å¯¹é«˜ä½ |
| ... | ... | ... |

#### 4.1.2 å€ºåˆ¸ä¸“å±å› å­

| å› å­å | è®¡ç®—æ–¹å¼ | å«ä¹‰ |
|--------|---------|------|
| YIELD_SLOPE | é•¿çŸ­ç«¯æ”¶ç›Šç‡å·® | åˆ©ç‡æ›²çº¿å½¢æ€ |
| DURATION_PROXY | ä»·æ ¼æ³¢åŠ¨/æ”¶ç›Šç‡æ³¢åŠ¨ | ä¹…æœŸä»£ç† |
| CREDIT_SPREAD | ä¿¡ç”¨å€ºvså›½å€ºä»·å·® | ä¿¡ç”¨é£é™© |
| BOND_MOM_SCORE | ç»¼åˆåŠ¨é‡å¾—åˆ† | å€ºåˆ¸è¶‹åŠ¿ |
| RATE_REGIME | åŠ æ¯/é™æ¯å‘¨æœŸ | åˆ©ç‡ç¯å¢ƒ |

#### 4.1.3 å•†å“ä¸“å±å› å­

| å› å­å | è®¡ç®—æ–¹å¼ | å«ä¹‰ |
|--------|---------|------|
| USD_INVERSE_MOM | ç¾å…ƒæŒ‡æ•°åå‘åŠ¨é‡ | ç¾å…ƒèµ°åŠ¿ |
| VIX_PROXY | Aè‚¡æ³¢åŠ¨ç‡ä»£ç† | ææ…ŒæŒ‡æ•° |
| GOLD_TREND | é»„é‡‘è¶‹åŠ¿å¾—åˆ† | é¿é™©éœ€æ±‚ |
| INFLATION_PROXY | é€šèƒ€é¢„æœŸä»£ç† | é€šèƒ€ç¯å¢ƒ |
| COMMODITY_CYCLE | å•†å“å‘¨æœŸä½ç½® | å‘¨æœŸåˆ¤æ–­ |

#### 4.1.4 QDIIä¸“å±å› å­

| å› å­å | è®¡ç®—æ–¹å¼ | å«ä¹‰ |
|--------|---------|------|
| FX_MOM | æ±‡ç‡åŠ¨é‡ | æ±‡ç‡è¶‹åŠ¿ |
| CROSS_MARKET_SPREAD | è·¨å¸‚åœºä»·å·® | AHæº¢ä»·ç­‰ |
| US_MARKET_REGIME | ç¾è‚¡å¸‚åœºç¯å¢ƒ | ç¾è‚¡è¶‹åŠ¿ |
| GLOBAL_RISK_APPETITE | å…¨çƒé£é™©åå¥½ | é¿é™©æƒ…ç»ª |
| QDII_VOL_RATIO | ç›¸å¯¹æ³¢åŠ¨ç‡ | é£é™©æ¯”è¾ƒ |

#### 4.1.5 ä½“åˆ¶/æ‹©æ—¶å› å­ (å…¨å±€)

| å› å­å | è®¡ç®—æ–¹å¼ | å«ä¹‰ |
|--------|---------|------|
| MA_REGIME | ä»·æ ¼ vs MA200 | é•¿æœŸè¶‹åŠ¿ |
| MOM_REGIME | 20æ—¥åŠ¨é‡æ–¹å‘ | çŸ­æœŸè¶‹åŠ¿ |
| VOL_REGIME | æ³¢åŠ¨ç‡ç›¸å¯¹ä½ç½® | é£é™©ç¯å¢ƒ |
| COMPOSITE_REGIME | ç»¼åˆä½“åˆ¶å¾—åˆ† | å¸‚åœºç¯å¢ƒ |

### 4.2 å› å­æ ‡å‡†åŒ–

æ‰€æœ‰å› å­å¿…é¡»ç»è¿‡**æ¨ªæˆªé¢æ ‡å‡†åŒ–**ï¼š

```python
def standardize(factor_df: pd.DataFrame) -> pd.DataFrame:
    """
    æ¨ªæˆªé¢ Z-Score æ ‡å‡†åŒ–
    æ¯ä¸ªæ—¶é—´ç‚¹ï¼Œè·¨æ‰€æœ‰èµ„äº§æ ‡å‡†åŒ–
    """
    return factor_df.sub(factor_df.mean(axis=1), axis=0).div(factor_df.std(axis=1), axis=0)
```

### 4.3 å› å­å­˜å‚¨æ ¼å¼

```python
# 3D æ•°ç»„æ ¼å¼
factors_3d: np.ndarray  # shape = [T, N, F]
# T = æ—¶é—´ç‚¹æ•°é‡
# N = ETF æ•°é‡
# F = å› å­æ•°é‡

# ç´¢å¼•æ˜ å°„
factor_name_to_idx: Dict[str, int]  # {'MOM_20D': 0, 'VOL_20D': 1, ...}
etf_code_to_idx: Dict[str, int]     # {'510300': 0, '510500': 1, ...}
```

---

## 5. WFO æµç¨‹

### 5.1 WFO é…ç½®æ–‡ä»¶

```yaml
# configs/allweather_wfo_config.yaml

# å…¨å±€è®¾ç½®
global:
  start_date: "2018-01-01"
  end_date: "2025-10-14"
  initial_capital: 1000000
  commission_rate: 0.0002
  freq: 8                    # è°ƒä»“é¢‘ç‡ï¼ˆäº¤æ˜“æ—¥ï¼‰
  
# WFO è®¾ç½®
wfo:
  train_window: 252          # è®­ç»ƒçª—å£ï¼ˆäº¤æ˜“æ—¥ï¼‰
  test_window: 63            # æµ‹è¯•çª—å£ï¼ˆäº¤æ˜“æ—¥ï¼‰
  step_size: 21              # æ­¥è¿›å¤§å°ï¼ˆäº¤æ˜“æ—¥ï¼‰
  min_train_samples: 200     # æœ€å°è®­ç»ƒæ ·æœ¬
  
# æ± é…ç½®
pools:
  EQUITY_BROAD:
    symbols: [510300, 510500, 510050, ...]
    target_weight: 0.20
    pos_size: 3
    candidate_factors:
      - [ADX_14D, PRICE_POSITION_20D, SHARPE_RATIO_20D]
      - [MOM_20D, VOL_20D, RSI_14D]
      - [SLOPE_20D, ADX_14D, MOM_60D]
      # ... æ›´å¤šç»„åˆ
      
  EQUITY_GROWTH:
    symbols: [159915, 512480, 512660, ...]
    target_weight: 0.15
    pos_size: 3
    candidate_factors:
      - [MOM_20D, SHARPE_RATIO_20D, ADX_14D]
      # ...
      
  BOND:
    symbols: [511260, 511010, ...]
    target_weight: 0.20
    pos_size: 2
    candidate_factors:
      - [YIELD_SLOPE, DURATION_PROXY, BOND_MOM_SCORE]
      - [CREDIT_SPREAD, RATE_REGIME, MOM_20D]
      # ...
      
  COMMODITY:
    symbols: [518880, 159985, ...]
    target_weight: 0.15
    pos_size: 2
    candidate_factors:
      - [USD_INVERSE_MOM, GOLD_TREND, VIX_PROXY]
      - [INFLATION_PROXY, COMMODITY_CYCLE, MOM_20D]
      # ...
      
  QDII:
    symbols: [513100, 159941, ...]
    target_weight: 0.15
    pos_size: 3
    candidate_factors:
      - [FX_MOM, US_MARKET_REGIME, CROSS_MARKET_SPREAD]
      # ...

# ä½“åˆ¶å› å­é…ç½®
regime:
  enabled: true
  factors:
    - MA_REGIME
    - MOM_REGIME
    - VOL_REGIME
  composite_weights: [0.4, 0.4, 0.2]  # å¯ WFO ä¼˜åŒ–
```

### 5.2 WFO æ‰§è¡Œæµç¨‹

```
Step 1: åŠ è½½æ•°æ®å’Œé…ç½®
    â†“
Step 2: è®¡ç®—æ‰€æœ‰å› å­ (åŸºç¡€ + åˆ†ç±» + ä½“åˆ¶)
    â†“
Step 3: å¯¹æ¯ä¸ªæ± æ‰§è¡Œç‹¬ç«‹ WFO
    â”œâ”€â”€ éå†å€™é€‰å› å­ç»„åˆ
    â”œâ”€â”€ æ»šåŠ¨çª—å£å›æµ‹
    â”œâ”€â”€ è®¡ç®— OOS æŒ‡æ ‡ (Sharpe, Return, MDD)
    â””â”€â”€ é€‰å‡ºæœ€ä¼˜å› å­ç»„åˆ
    â†“
Step 4: æ± é—´æƒé‡ä¼˜åŒ– (å¯é€‰)
    â”œâ”€â”€ å›ºå®šå„æ± å†…é€‰è‚¡é€»è¾‘
    â”œâ”€â”€ ä¼˜åŒ–æ± é—´æƒé‡åˆ†é…
    â””â”€â”€ æˆ–ä½¿ç”¨ä½“åˆ¶å› å­åŠ¨æ€è°ƒæ•´
    â†“
Step 5: è¾“å‡ºæœ€ä¼˜é…ç½®
    â””â”€â”€ results/allweather_wfo_{timestamp}/best_config.json
```

### 5.3 WFO è¾“å‡ºæ ¼å¼

```json
{
  "timestamp": "2025-11-28T20:30:00",
  "global_metrics": {
    "total_return": 0.45,
    "max_drawdown": 0.18,
    "sharpe_ratio": 0.62,
    "calmar_ratio": 2.5
  },
  "pool_configs": {
    "EQUITY_BROAD": {
      "best_factors": ["ADX_14D", "PRICE_POSITION_20D", "SHARPE_RATIO_20D"],
      "pos_size": 3,
      "weight": 0.20,
      "pool_metrics": {
        "oos_return": 0.35,
        "oos_sharpe": 0.55
      }
    },
    "BOND": {
      "best_factors": ["YIELD_SLOPE", "DURATION_PROXY", "BOND_MOM_SCORE"],
      "pos_size": 2,
      "weight": 0.20,
      "pool_metrics": {
        "oos_return": 0.08,
        "oos_sharpe": 0.85
      }
    }
    // ...
  },
  "regime_config": {
    "enabled": true,
    "composite_weights": [0.4, 0.4, 0.2]
  }
}
```

---

## 6. å¼€å‘æŒ‡å—

### 6.1 æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | ç”¨é€” | ä¼˜å…ˆçº§ |
|------|------|--------|
| `etf_rotation_optimized/core/regime_factors.py` | ä½“åˆ¶/æ‹©æ—¶å› å­è®¡ç®— | P0 |
| `configs/allweather_wfo_config.yaml` | WFO é…ç½®æ–‡ä»¶ | P0 |
| `etf_rotation_optimized/run_allweather_wfo.py` | å…¨å¤©å€™ WFO å…¥å£ | P0 |
| `scripts/run_allweather_vec.py` | å…¨å¤©å€™ VEC å›æµ‹ | P1 |
| `scripts/run_allweather_bt.py` | å…¨å¤©å€™ BT å®¡è®¡ | P1 |

### 6.2 å¼€å‘é¡ºåº

```
Day 1: å› å­æ„å»º
â”œâ”€â”€ å®ç° regime_factors.py
â”œâ”€â”€ æ‰©å±• category_factors.py (è¡¥å……ç¼ºå¤±å› å­)
â””â”€â”€ å•å…ƒæµ‹è¯•å› å­è®¡ç®—

Day 2: WFO æµç¨‹
â”œâ”€â”€ åˆ›å»º allweather_wfo_config.yaml
â”œâ”€â”€ å®ç° run_allweather_wfo.py
â””â”€â”€ éªŒè¯ WFO è¾“å‡º

Day 3: VEC/BT éªŒè¯
â”œâ”€â”€ å®ç° run_allweather_vec.py (ä½¿ç”¨ WFO è¾“å‡º)
â”œâ”€â”€ å®ç° run_allweather_bt.py
â””â”€â”€ éªŒè¯å¯¹é½ < 0.01pp
```

### 6.3 ä»£ç è§„èŒƒ

```python
# 1. ä½¿ç”¨ç±»å‹æ³¨è§£
def compute_factor(prices: pd.DataFrame, window: int = 20) -> pd.DataFrame:
    ...

# 2. ä½¿ç”¨ dataclass å®šä¹‰é…ç½®
@dataclass
class PoolConfig:
    name: str
    symbols: List[str]
    target_weight: float
    pos_size: int
    factor_type: str

# 3. ä½¿ç”¨ logging è€Œé print
logger = logging.getLogger(__name__)
logger.info(f"è®¡ç®—å› å­: {factor_name}")

# 4. ä½¿ç”¨ Numba åŠ é€Ÿæ ¸å¿ƒå¾ªç¯
@njit(cache=True)
def backtest_kernel(...) -> Tuple[...]:
    ...
```

### 6.4 å…³é”®å‡½æ•°ç­¾å

```python
# regime_factors.py
class RegimeFactors:
    def compute_ma_regime(self, close_df: pd.DataFrame, window: int = 200) -> pd.Series:
        """è®¡ç®— MA ä½“åˆ¶å› å­ (>MA200 = 1, <MA200 = -1)"""
        ...
    
    def compute_composite_regime(self, close_df: pd.DataFrame) -> pd.Series:
        """è®¡ç®—ç»¼åˆä½“åˆ¶å¾—åˆ†"""
        ...

# run_allweather_wfo.py
class AllWeatherWFO:
    def run_pool_wfo(self, pool_name: str) -> Dict:
        """å¯¹å•ä¸ªæ± æ‰§è¡Œ WFO ä¼˜åŒ–"""
        ...
    
    def run_full_wfo(self) -> Dict:
        """æ‰§è¡Œå®Œæ•´çš„å…¨å¤©å€™ WFO æµç¨‹"""
        ...
    
    def export_best_config(self, output_dir: str) -> str:
        """å¯¼å‡ºæœ€ä¼˜é…ç½®ä¸º JSON"""
        ...
```

---

## 7. æµ‹è¯•è§„èŒƒ

### 7.1 å•å…ƒæµ‹è¯•

```python
# tests/test_regime_factors.py

def test_ma_regime_values():
    """MA ä½“åˆ¶å› å­å€¼åŸŸæ£€æŸ¥"""
    regime = RegimeFactors()
    result = regime.compute_ma_regime(sample_prices)
    assert result.isin([1.0, -1.0]).all(), "MAä½“åˆ¶å› å­åªèƒ½æ˜¯ 1 æˆ– -1"

def test_composite_regime_range():
    """ç»¼åˆä½“åˆ¶å¾—åˆ†èŒƒå›´æ£€æŸ¥"""
    regime = RegimeFactors()
    result = regime.compute_composite_regime(sample_prices)
    assert result.between(-1, 1).all(), "ç»¼åˆä½“åˆ¶å¾—åˆ†åº”åœ¨ [-1, 1] èŒƒå›´å†…"

def test_factor_no_lookahead():
    """å› å­æ— å‰è§†åå·®æ£€æŸ¥"""
    # ç¡®ä¿ t æ—¶åˆ»çš„å› å­å€¼åªä½¿ç”¨ t åŠä¹‹å‰çš„æ•°æ®
    ...
```

### 7.2 é›†æˆæµ‹è¯•

```python
# tests/test_allweather_wfo.py

def test_wfo_output_format():
    """WFO è¾“å‡ºæ ¼å¼æ£€æŸ¥"""
    wfo = AllWeatherWFO(config_path)
    result = wfo.run_full_wfo()
    
    assert 'pool_configs' in result
    assert 'global_metrics' in result
    for pool_name in ['EQUITY_BROAD', 'BOND', 'COMMODITY', 'QDII']:
        assert pool_name in result['pool_configs']
        assert 'best_factors' in result['pool_configs'][pool_name]

def test_vec_bt_alignment():
    """VEC/BT å¯¹é½æ£€æŸ¥"""
    vec_result = run_vec_backtest(config)
    bt_result = run_bt_backtest(config)
    
    diff = abs(vec_result['total_return'] - bt_result['total_return'])
    assert diff < 0.0001, f"VEC/BT å·®å¼‚è¿‡å¤§: {diff:.4%}"
```

### 7.3 å›å½’æµ‹è¯•

```bash
# æ¯æ¬¡ä¿®æ”¹åè¿è¡Œ
make test          # å•å…ƒæµ‹è¯•
make verify        # VEC/BT å¯¹é½éªŒè¯
```

---

## 8. éªŒæ”¶æ ‡å‡†

### 8.1 åŠŸèƒ½éªŒæ”¶

| æ£€æŸ¥é¡¹ | æ ‡å‡† | éªŒè¯æ–¹æ³• |
|--------|------|----------|
| å› å­è®¡ç®— | æ‰€æœ‰å› å­æ—  NaN æ³„æ¼ | `assert not factors_3d.isnan().any()` |
| WFO æ‰§è¡Œ | å®Œæˆæ‰€æœ‰æ± çš„ä¼˜åŒ– | æ£€æŸ¥è¾“å‡º JSON åŒ…å«æ‰€æœ‰æ±  |
| é…ç½®å¯¼å‡º | JSON æ ¼å¼æ­£ç¡® | JSON Schema éªŒè¯ |
| VEC å›æµ‹ | æ­£å¸¸å®Œæˆ | Exit Code = 0 |
| BT å®¡è®¡ | æ­£å¸¸å®Œæˆ | Exit Code = 0 |

### 8.2 æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | æ ‡å‡† | å¤‡æ³¨ |
|------|------|------|
| WFO è€—æ—¶ | < 5 åˆ†é’Ÿ | 12,000+ ç»„åˆ |
| VEC è€—æ—¶ | < 10 ç§’ | å•æ¬¡å›æµ‹ |
| å†…å­˜å ç”¨ | < 4 GB | å…¨æµç¨‹ |

### 8.3 è´¨é‡éªŒæ”¶

| æŒ‡æ ‡ | æ ‡å‡† | è¯´æ˜ |
|------|------|------|
| VEC/BT å·®å¼‚ | < 0.01pp | æ€»æ”¶ç›Šå·®å¼‚ |
| OOS Sharpe | > 0.3 | æ ·æœ¬å¤–å¤æ™® |
| æœ€å¤§å›æ’¤ | < 30% | é£é™©æ§åˆ¶ |
| ä»£ç è¦†ç›–ç‡ | > 80% | æµ‹è¯•è¦†ç›– |

### 8.4 éªŒæ”¶æ£€æŸ¥æ¸…å•

```markdown
## éªŒæ”¶æ£€æŸ¥æ¸…å•

### å› å­å±‚
- [ ] regime_factors.py å®ç°å®Œæˆ
- [ ] æ‰€æœ‰å› å­å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] å› å­æ— å‰è§†åå·®

### WFO å±‚
- [ ] allweather_wfo_config.yaml é…ç½®å®Œæˆ
- [ ] run_allweather_wfo.py å®ç°å®Œæˆ
- [ ] WFO è¾“å‡º JSON æ ¼å¼æ­£ç¡®
- [ ] æ¯ä¸ªæ± éƒ½æœ‰æœ€ä¼˜å› å­ç»„åˆ

### å›æµ‹å±‚
- [ ] VEC å›æµ‹æ­£å¸¸è¿è¡Œ
- [ ] BT å®¡è®¡æ­£å¸¸è¿è¡Œ
- [ ] VEC/BT å·®å¼‚ < 0.01pp

### æ–‡æ¡£å±‚
- [ ] ä»£ç æ³¨é‡Šå®Œæ•´
- [ ] README æ›´æ–°
- [ ] æœ¬æ–‡æ¡£åŒæ­¥æ›´æ–°
```

---

## 9. æ–‡ä»¶æ¸…å•

### 9.1 éœ€è¦æ–°å¢çš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| `etf_rotation_optimized/core/regime_factors.py` | å¾…åˆ›å»º | ä½“åˆ¶å› å­ |
| `configs/allweather_wfo_config.yaml` | å¾…åˆ›å»º | WFO é…ç½® |
| `etf_rotation_optimized/run_allweather_wfo.py` | å¾…åˆ›å»º | WFO å…¥å£ |
| `scripts/run_allweather_vec.py` | å¾…é‡å†™ | VEC å›æµ‹ |
| `scripts/run_allweather_bt.py` | å¾…åˆ›å»º | BT å®¡è®¡ |
| `tests/test_regime_factors.py` | å¾…åˆ›å»º | å› å­æµ‹è¯• |
| `tests/test_allweather_wfo.py` | å¾…åˆ›å»º | WFO æµ‹è¯• |

### 9.2 éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ |
|---------|---------|
| `etf_rotation_optimized/core/category_factors.py` | è¡¥å……ç¼ºå¤±å› å­ |
| `configs/etf_pools.yaml` | ç¡®è®¤æ± é…ç½®æ­£ç¡® |
| `Makefile` | æ·»åŠ å…¨å¤©å€™ç›¸å…³å‘½ä»¤ |

### 9.3 å‚è€ƒæ–‡ä»¶ï¼ˆåªè¯»ï¼‰

| æ–‡ä»¶è·¯å¾„ | ç”¨é€” |
|---------|------|
| `etf_rotation_optimized/run_unified_wfo.py` | å‚è€ƒ WFO å®ç° |
| `etf_rotation_optimized/core/wfo_engine.py` | WFO å¼•æ“ |
| `etf_rotation_optimized/core/backtester_vectorized.py` | VEC æ ¸å¿ƒ |
| `etf_rotation_optimized/core/precise_factor_library_v2.py` | åŸºç¡€å› å­ |

---

## é™„å½• A: å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ç°æœ‰çš„ run_unified_wfo.pyï¼Ÿ

ç°æœ‰ WFO æ˜¯**å•ä¸€å› å­ç»„åˆ**æœç´¢ï¼Œä¸æ”¯æŒï¼š
- åˆ†æ± ç‹¬ç«‹ä¼˜åŒ–
- åˆ†ç±»ä¸“å±å› å­
- ä½“åˆ¶å› å­æ•´åˆ

éœ€è¦æ–°å»ºä¸“é—¨çš„å…¨å¤©å€™ WFO æµç¨‹ã€‚

### Q2: ä½“åˆ¶å› å­å¦‚ä½•å½±å“é€‰è‚¡ï¼Ÿ

ä¸¤ç§æ–¹å¼ï¼š
1. **å› å­åŠ æƒ**: ä½“åˆ¶å› å­ä½œä¸ºå…¶ä»–å› å­çš„æƒé‡è°ƒèŠ‚å™¨
2. **ä»“ä½è°ƒèŠ‚**: ä½“åˆ¶å¾—åˆ†å½±å“æ•´ä½“ä»“ä½ï¼ˆä½†ä¹Ÿæ˜¯å› å­åŒ–çš„ï¼Œä¸æ˜¯ç¡¬ç¼–ç ï¼‰

æ¨èæ–¹å¼ 1ï¼Œæ›´ç¬¦åˆ"ä¸€åˆ‡çš†å› å­"åŸåˆ™ã€‚

### Q3: å¦‚ä½•å¤„ç†å› å­åœ¨ä¸åŒæ± ä¹‹é—´çš„å†²çªï¼Ÿ

æ¯ä¸ªæ± ç‹¬ç«‹ WFOï¼Œå› å­ç»„åˆäº’ä¸å½±å“ã€‚æ± é—´æƒé‡æ˜¯å¦ä¸€å±‚ä¼˜åŒ–ã€‚

---

## é™„å½• B: å‚è€ƒå‘½ä»¤

```bash
# è¿è¡Œå…¨å¤©å€™ WFO
uv run python etf_rotation_optimized/run_allweather_wfo.py

# è¿è¡Œ VEC å›æµ‹ï¼ˆä½¿ç”¨ WFO è¾“å‡ºï¼‰
uv run python scripts/run_allweather_vec.py --config results/allweather_wfo_xxx/best_config.json

# è¿è¡Œ BT å®¡è®¡
uv run python scripts/run_allweather_bt.py --config results/allweather_wfo_xxx/best_config.json

# éªŒè¯ VEC/BT å¯¹é½
uv run python scripts/compare_vec_bt_metrics.py \
    --vec results/allweather_vec_xxx/daily_values.csv \
    --bt results/allweather_bt_xxx/daily_values.csv

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
make test
```

---

**æ–‡æ¡£ç»“æŸ**

> å¦‚æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒ `docs/` ç›®å½•ä¸‹çš„å…¶ä»–æ–‡æ¡£ï¼Œæˆ–ç›´æ¥è¯¢é—®ã€‚
