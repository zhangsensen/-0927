# 已知差异 | Known Differences

本文档记录VEC回测与实盘交易之间的**已知且接受的差异**。

---

## 1. VEC使用浮点股数 vs 实盘使用整数手

### 差异描述

| 维度 | VEC回测 | 实盘交易 | 差异原因 |
|------|---------|---------|---------|
| **股数计算** | `shares = target_value / price` (浮点数) | `shares = (target_value / price) // 100 * 100` (整数手) | 实盘必须按100股整数倍交易 |
| **资金利用率** | 100% | 99.5-99.9% | 取整后有少量闲置资金 |
| **代码位置** | `scripts/batch_vec_backtest.py:628` | `scripts/generate_today_signal.py:161-165` | - |

### 影响量化

**典型场景**（50万资金，2只ETF，每只25万）：

| 股价 | VEC股数 | 实盘股数 | 差异 | 影响 |
|------|---------|---------|------|------|
| 1.00元 | 250,000 | 250,000 | 0 | 0% |
| 2.00元 | 125,000 | 125,000 | 0 | 0% |
| 3.14元 | 79,617.83 | 79,600 | -17.83股 | 0.02% |
| 5.27元 | 47,438.12 | 47,400 | -38.12股 | 0.08% |

**统计分析**：
- ETF价格范围：1-10元（80%集中在1-5元）
- 单只持仓：10-50万
- **预期误差**：< 0.1%/只 → < 0.2%/组合

### 为什么不修改

**❌ 不建议对齐VEC和实盘的取整逻辑**，原因：

1. **破坏历史对齐性**：修改VEC会导致所有历史回测结果变化，无法对比
2. **理论vs实际的固有差异**：这是回测的理想化假设，反映"最优理论收益"
3. **影响极小**：< 0.2%的误差远小于滑点、市场冲击等实际交易成本

### 实盘预期

**实盘收益 ≈ VEC收益 - 0.05% ~ 0.15%**

误差来源拆解：
- 取整损失：0.05-0.15%
- 滑点：0.02-0.05%（ETF流动性好）
- 未建模成本：时间戳微秒级差异、网络延迟等

**示例**：
- VEC回测：136.52%
- 实盘预期：136.2-136.4%（-0.12pp ~ -0.32pp）

### 监控方案

建议每周对比VEC和实盘收益差异：
```python
# 计算累计差异
vec_return = 1.3652  # VEC累计收益率
real_return = 1.3624  # 实盘累计收益率
tracking_error = abs(vec_return - real_return) / vec_return
# 预期: tracking_error < 0.005 (0.5%)
```

---

## 2. VEC涨跌停假设 vs 实盘涨跌停真实约束

### 差异描述（已修复）

| 维度 | 修复前 | 修复后 |
|------|-------|--------|
| **VEC** | 假设所有ETF可买入 | 同修复前（保持历史回测一致性） |
| **实盘** | 可能选中涨停ETF买不进 | ✅ 过滤涨停/停牌ETF后再选股 |

**修复位置**：`scripts/generate_today_signal.py:263-280`

**过滤规则**：
- 涨停：当日涨幅 > 9.5%（ETF涨停约10%，留0.5%容差）
- 停牌：当日成交量 = 0

**历史涨停事件**（43只ETF，2020-2025）：
- 2020-07-06: 证券ETF (512880) +10.03%
- 2024-02-08: 中证A500 (159338) +10.01%
- 频率：~2-3次/年

**影响**：修复后实盘不会再出现"选中买不进"的情况。

---

## 3. VEC缓存失效 vs 实盘数据更新

### 差异描述（已修复）

| 维度 | 修复前 | 修复后 |
|------|-------|--------|
| **缓存键** | 仅包含 `etf_codes + start_date + end_date` | ✅ 包含 `+ mtime`（数据文件修改时间） |
| **风险** | 数据更新后返回旧缓存 | 数据更新后自动失效 |

**修复位置**：
- `src/etf_strategy/core/data_loader.py:55-76` - 缓存键加mtime
- `scripts/update_daily_from_qmt_bridge.py:311-319` - 数据更新后清理缓存（双保险）

**验证**：
```bash
# 更新数据
uv run python scripts/update_daily_from_qmt_bridge.py --all

# 检查缓存是否清理
ls -lah src/etf_strategy/.cache/  # 应为空或不存在

# 重新跑策略，应加载最新数据
uv run python scripts/generate_today_signal.py ...
```

---

## 总结

| 差异类型 | 状态 | 影响 | 处理方案 |
|---------|------|------|---------|
| **浮点vs整数手** | ✅ 接受 | < 0.2% | 文档记录，实盘预期略低于VEC |
| **涨跌停假设** | ✅ 已修复 | 原~2-3次/年，现已消除 | 实盘信号生成时过滤 |
| **缓存失效** | ✅ 已修复 | 原可导致使用旧数据，现已消除 | 缓存键加mtime + 更新后清理 |

**关键结论**：修复后，实盘与VEC回测的差异仅剩取整损失（< 0.2%），这是理论回测的固有特性，**已接受且可监控**。

---

**文档版本**: v1.0
**更新时间**: 2026-02-05
**维护者**: System
