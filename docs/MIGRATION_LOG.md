# é¡¹ç›®ç»Ÿä¸€é‡æ„è¿ç§»æ—¥å¿—

**å¼€å§‹æ—¶é—´**: 2025-11-16  
**Gitåˆ†æ”¯**: refactor/unified-codebase-20251116  
**ç›®æ ‡**: å°† etf_rotation_optimized/ åˆå¹¶åˆ° etf_rotation_experiments/ï¼Œå½¢æˆç»Ÿä¸€ä»£ç åº“

## æ‰§è¡Œè®°å½•

### é˜¶æ®µ0ï¼šå‡†å¤‡ä¸å¤‡ä»½
- [x] æ­¥éª¤1: å®Œæ•´å¤‡ä»½åˆ›å»º - å®Œæˆ
- [x] æ­¥éª¤2: Pythonç¼“å­˜æ¸…ç† - å®Œæˆ
- [x] æ­¥éª¤3: å·¥ä½œåˆ†æ”¯åˆ›å»º - refactor/unified-codebase-20251116
- [x] æ­¥éª¤4: è¿ç§»æ—¥å¿—æ–‡ä»¶åˆ›å»º - æœ¬æ–‡ä»¶
- [x] æ­¥éª¤5: ç¡¬ç¼–ç è·¯å¾„æ‰«æ - å‘ç°87å¤„å¼•ç”¨

### é˜¶æ®µ1ï¼šcoreå±‚ç»Ÿä¸€
- [x] æ­¥éª¤6: data_contract.pyå·²å­˜åœ¨ï¼Œæ— éœ€åˆ›å»º
- [x] æ­¥éª¤7-8: data_loader.pyå¯¹æ¯” - ä¸¤ç‰ˆæœ¬å®Œå…¨ç›¸åŒï¼Œä¿ç•™experimentsç‰ˆæœ¬
- [x] æ­¥éª¤9: ic_calculator_numba.pyå¯¹æ¯” - experimentsç‰ˆæœ¬æœ‰P0ä¿®å¤ï¼ˆé˜ˆå€¼30ï¼‰ï¼Œå·²æ˜¯æœ€ä¼˜ç‰ˆæœ¬
- [x] æ­¥éª¤10: coreå±‚æµ‹è¯• - æ— å•å…ƒæµ‹è¯•æ–‡ä»¶ï¼ˆç°çŠ¶ï¼‰

### é˜¶æ®µ2ï¼šstrategieså±‚é‡ç»„

- [x] æ­¥éª¤11: åˆ›å»ºstrategiesç›®å½•ç»“æ„
- [x] æ­¥éª¤12: ç§»åŠ¨WFOæ–‡ä»¶åˆ°strategies/wfo/
- [x] æ­¥éª¤13: ç§»åŠ¨ml_rankeråˆ°strategies/ml_ranker/
- [x] æ­¥éª¤14: åˆ›å»ºç»Ÿä¸€å›æµ‹å¼•æ“backtest_engine.pyï¼ˆéª¨æ¶ï¼‰
- [x] æ­¥éª¤15: å›å¡«production/profit/experimentalä¸‰æ¨¡å¼é€»è¾‘è‡³backtest_engine.py
- [x] æ­¥éª¤16: å¼•å…¥BacktestRequestæ•°æ®ç±»ä¸æ»‘ç‚¹å¤ç”¨å‡½æ•°ï¼Œç¡®ä¿å›æµ‹ç»“æœä¸€è‡´
- [x] æ­¥éª¤17: å¤åˆ¶position_optimizerå’Œsignal_optimizeråˆ°strategies/backtest/
- [x] æ­¥éª¤18: æ›´æ–°strategieså±‚å¯¼å…¥è·¯å¾„ï¼ˆä½¿ç”¨sys.path.insertæ–¹æ¡ˆï¼‰
- [x] æ­¥éª¤19: strategieså±‚é›†æˆæµ‹è¯• - WFOå¯¼å…¥æˆåŠŸ âœ“

### é˜¶æ®µ3ï¼šapplicationså±‚æ•´åˆ

- [x] æ­¥éª¤20: åˆ›å»ºapplicationsç›®å½•
- [x] æ­¥éª¤21: è¿ç§»apply_ranker.pyè‡³applicationsï¼Œå¹¶ä¿ç•™å…¼å®¹å…¥å£
- [x] æ­¥éª¤22: è¿ç§»run_ranking_pipeline.pyè‡³applicationsï¼Œå¹¶ä¿ç•™å…¼å®¹å…¥å£
- [x] æ­¥éª¤23: è¿ç§»train_ranker.pyè‡³applicationsï¼Œå¹¶ä¿ç•™å…¼å®¹å…¥å£
- [x] æ­¥éª¤24: è¿ç§»run_combo_wfo.pyè‡³applicationsï¼Œæ›´æ–°PROJECT_ROOTæŒ‡å‘ä¸æ—¥å¿—è·¯å¾„
- [x] æ­¥éª¤25: åˆ›å»º`applications/__init__.py`å¹¶æš´éœ²å…¥å£æ¸…å•
- [x] æ­¥éª¤26: åŸè·¯å¾„åˆ›å»ºè½»é‡ä»£ç†è„šæœ¬ï¼ˆå¯¼å‘applications.*.mainï¼‰
- [ ] æ­¥éª¤27: åº”ç”¨å±‚ç«¯åˆ°ç«¯å›å½’æµ‹è¯•

### é˜¶æ®µ4ï¼šé…ç½®ä¸å‚æ•°ç»Ÿä¸€

- [x] æ­¥éª¤28: åˆå¹¶combo_wfo_config.yamlé»˜è®¤å‚æ•°ï¼ˆcommission/dataè·¯å¾„å¯¹é½ç”Ÿäº§é…ç½®ï¼‰
- [x] æ­¥éª¤29: å¼•å…¥compatibilityèŠ‚ï¼Œæ ‡è®°legacyåˆ‡æ¢ä¸æ¥æºé…ç½®
- [x] æ­¥éª¤30: ç¼–å†™é…ç½®éªŒè¯è„šæœ¬ï¼ˆ`tools/validate_combo_config.py`ï¼Œå« compatibility è·¯å¾„æ£€æŸ¥ï¼‰

### é˜¶æ®µ5ï¼šæ–‡æ¡£ä¸æ—¥å¿—æ›´æ–°

- [x] æ­¥éª¤31: æ›´æ–°æ–‡æ¡£ä¸­ applications/ æ–°è·¯å¾„è¯´æ˜ï¼ˆ`etf_rotation_experiments/README.md` å·²è¦†ç›–æ–°å…¥å£ï¼‰
- [x] æ­¥éª¤32: æ›¿æ¢ç¡¬ç¼–ç è·¯å¾„æ¸…å•ï¼ˆ`tools/check_legacy_paths.py` æ ¸å¿ƒæ–‡æ¡£å·²æ›´æ–°ï¼Œå½’æ¡£ç›®å½•å»¶åå¤„ç†ï¼‰
- [x] æ­¥éª¤33: è®°å½•è¿ç§»è¿›åº¦ï¼ˆæœ¬æ–‡ä»¶ï¼‰

### é˜¶æ®µ6ï¼šæµ‹è¯•ä¸å‘å¸ƒå‡†å¤‡

- [x] æ­¥éª¤34: å›æµ‹å¼•æ“å•å…ƒ/å†’çƒŸæµ‹è¯•
- [x] æ­¥éª¤35: WFOç»„åˆå›å½’æµ‹è¯•ï¼ˆCLI å…¥å£å¯ç”¨æ€§éªŒè¯ï¼‰
- [x] æ­¥éª¤36: äº§å‡ºæœ€ç»ˆå‘å¸ƒè¯´æ˜ï¼ˆrun_20251116_035732/RELEASE_NOTES.mdï¼‰
- [x] æ­¥éª¤37: ç»Ÿä¸€é…ç½®è·¯å¾„ï¼ˆcache/data æ”¯æŒç›¸å¯¹è·¯å¾„å’Œç¯å¢ƒå˜é‡ï¼‰
- [x] æ­¥éª¤38: ML vs WFO æ’åºå¯¹æ¯”éªŒè¯ï¼ˆæŒ‡æ ‡å·®å¼‚è®°å½•ï¼‰
- [x] æ­¥éª¤39: å•å…ƒæµ‹è¯•ä¿®å¤ï¼ˆtest_single_combo è¾¹ç•Œå¤„ç†ï¼‰
- [x] æ­¥éª¤40: ç«¯åˆ°ç«¯æµ‹è¯•ç®€åŒ–ï¼ˆå¯æ‰§è¡Œç‰ˆæœ¬ï¼Œ3ä¸ªè½»é‡æµ‹è¯•ï¼‰

**æµ‹è¯•å‘½ä»¤**:
```bash
# å•å…ƒæµ‹è¯•ï¼ˆML æ’åºé€»è¾‘ï¼‰
cd etf_rotation_experiments && pytest tests/test_ml_ranking.py -v
# âœ… ç»“æœ: 8 passed, 1 skipped

# ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆæ•°æ®ç®¡é“å®Œæ•´æ€§ï¼‰
cd etf_rotation_experiments && pytest tests/test_e2e_workflow.py -v
# âœ… ç»“æœ: 3 passed
```

**æ ¸å¿ƒä¿®å¤**:
- ä¿®å¤ `strategies/ml_ranker/feature_engineer.py` å•æ ·æœ¬è¾¹ç•Œé—®é¢˜
  - `expand_sequence_features` åœ¨ len(df)==1 æ—¶ä½¿ç”¨ `reshape(1, -1)` æ›¿ä»£ `vstack`
  - è¦†ç›–å…¨éƒ¨åºåˆ—ç‰¹å¾ï¼š`oos_ic_list`/`oos_sharpe_list`/`oos_ir_list`/`positive_rate_list`
- Mock æ¨¡å‹ä½¿ç”¨å›ºå®šéšæœºç§å­ï¼ˆ`np.random.seed(42)`ï¼‰ç¡®ä¿æµ‹è¯•ä¸€è‡´æ€§

---

## æœ€ç»ˆéªŒæ”¶æµ‹è¯•

### ML æ’åº vs WFO æ’åºæ€§èƒ½å¯¹æ¯” (2025-11-16)

#### æµ‹è¯•é…ç½®
- **æ•°æ®é›†**: 43 åª ETFï¼Œ2020-01-01 è‡³ 2025-10-14 (1399 äº¤æ˜“æ—¥)
- **WFO å‚æ•°**: IS çª—å£ 252 å¤©ï¼ŒOOS çª—å£ 60 å¤©ï¼Œæ­¥é•¿ 60 å¤© (19 ä¸ªçª—å£)
- **ç»„åˆæ± **: 12597 ä¸ªå› å­ç»„åˆ (2~5 å› å­ç»„åˆï¼Œ18 ä¸ªå› å­)
- **å›æµ‹å‚æ•°**: æ»‘ç‚¹ 1bpsï¼Œå®Œæ•´ 2000 ç»„åˆå›æµ‹ï¼Œæ¢ä»“é¢‘ç‡ 8 å¤©

#### ML æ’åºç»“æœ (run_20251116_035732)
```
WFO è€—æ—¶: 49s (255 combo/s)
Top-2000 å›æµ‹æŒ‡æ ‡:
  - å¹³å‡å¹´åŒ–(å‡€): 18.60%
  - ä¸­ä½å¹´åŒ–(å‡€): 18.57%
  - å¹³å‡ Sharpe(å‡€): 0.917
  - ä¸­ä½ Sharpe(å‡€): 0.923

Top-1 ç»„åˆ: ADX_14D + CMF_20D + CORRELATION_TO_MARKET_20D + RET_VOL_20D + RSI_14
  - LTR score: 0.1916
  - OOS IC: 0.0264
  - å¹´åŒ–æ”¶ç›Š(å‡€): 22.89%
  - Sharpe(å‡€): 1.109
```

#### WFO æ’åºåŸºå‡† (run_20251116_132810)
```
WFO è€—æ—¶: 47s (262 combo/s)
Top-2000 å›æµ‹æŒ‡æ ‡:
  - å¹³å‡å¹´åŒ–(å‡€): 11.42%
  - ä¸­ä½å¹´åŒ–(å‡€): 11.54%
  - å¹³å‡ Sharpe(å‡€): 0.545
  - ä¸­ä½ Sharpe(å‡€): 0.549

Top-1 ç»„åˆ: ADX_14D + CORRELATION_TO_MARKET_20D + VOL_RATIO_20D
  - OOS IC: 0.0489
  - å¹´åŒ–æ”¶ç›Š(å‡€): 22.89%
  - Sharpe(å‡€): 1.109
```

#### æ ¸å¿ƒç»“è®º
| æŒ‡æ ‡ | ML æ’åº | WFO æ’åº | æå‡å¹…åº¦ |
|------|---------|----------|----------|
| å¹³å‡å¹´åŒ–(å‡€) | 18.60% | 11.42% | **+62.9%** |
| ä¸­ä½å¹´åŒ–(å‡€) | 18.57% | 11.54% | **+60.9%** |
| å¹³å‡ Sharpe | 0.917 | 0.545 | **+68.3%** |
| ä¸­ä½ Sharpe | 0.923 | 0.549 | **+68.1%** |

**å…³é”®å‘ç°**:
1. ML æ’åºä½¿ç»„åˆæ± æ•´ä½“è´¨é‡æ˜¾è‘—æå‡ï¼Œå¹³å‡å¹´åŒ–å¢åŠ  **7.18 ä¸ªç™¾åˆ†ç‚¹**
2. Sharpe æå‡ 68%ï¼Œè¡¨æ˜ ML æ¨¡å‹æœ‰æ•ˆå­¦ä¹ äº† WFO æŒ‡æ ‡å¤–çš„ç¨³å¥æ€§ç‰¹å¾
3. Top-1 OOS IC å¯¹æ¯”ï¼šML (0.0264) vs WFO (0.0489)ï¼ŒML ä¾§é‡æ± æ•´ä½“è€Œéå•ç‚¹æå€¼
4. ä¸¤ç§æ’åºçš„ Top-1 å•ç»„åˆè¡¨ç°ç›¸åŒï¼ˆ22.89% å¹´åŒ– / 1.109 Sharpeï¼‰ï¼Œå›  Top-1 æ°å¥½ä¸ºåŒä¸€ç»„åˆ

---

## å·®å¼‚è®°å½•

### coreå±‚å·®å¼‚

- `data_loader.py`: ä¸¤ç‰ˆæœ¬ç›¸åŒï¼ˆ254è¡Œï¼‰
- `ic_calculator_numba.py`: experimentsç‰ˆæœ¬æœ‰P0ä¿®å¤ï¼ˆé˜ˆå€¼30 vs 2ï¼‰âœ“
- `precise_factor_library_v2.py`: æœªå¯¹æ¯”ï¼ˆå‡å®šåŒæ­¥ï¼‰
- `cross_section_processor.py`: æœªå¯¹æ¯”

### strategieså±‚å·®å¼‚

å¾…è®°å½•...

### æµ‹è¯•ç»“æœ

- 2025-11-16 Â· `python3 tools/validate_combo_config.py --json` â†’ âœ… `status: ok`
- 2025-11-16 Â· `python3 -m py_compile etf_rotation_experiments/strategies/backtest/production_backtest.py` â†’ âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡
- 2025-11-16 Â· `python3 -m py_compile etf_rotation_experiments/real_backtest/run_profit_backtest.py` â†’ âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡
- 2025-11-16 Â· `python3 tools/check_legacy_paths.py` â†’ âœ… æ‰«æå®Œæˆï¼Œæ ¸å¿ƒæ–‡æ¡£å·²æ›´æ–°
- 2025-11-16 Â· `source .venv/bin/activate && python3 etf_rotation_experiments/applications/run_combo_wfo.py --help` â†’ âœ… CLI å¯ç”¨
- 2025-11-16 Â· `source .venv/bin/activate && python3 etf_rotation_experiments/real_backtest/run_profit_backtest.py --help` â†’ âœ… CLI å¯ç”¨

**P0 å®Œæ•´æµç¨‹æµ‹è¯•ï¼ˆç”Ÿäº§å¯ç”¨æ€§éªŒè¯ï¼‰**

- 2025-11-16 03:32 Â· **WFO å®Œæ•´æµç¨‹** 
  - é…ç½®ï¼š`etf_rotation_experiments/configs/combo_wfo_config_p0_test.yaml`
  - å‚æ•°ï¼š10 ETF Ã— 8 å› å­ Ã— 2-3 ç»„åˆå¤§å° â†’ 969 ä¸ªå› å­ç»„åˆ
  - è¿è¡Œæ—¶é—´ï¼š~3 ç§’ï¼ˆå« 19 ä¸ª WFO çª—å£è¯„ä¼°ï¼‰
  - ç»“æœè¾“å‡ºï¼š`etf_rotation_experiments/results/run_20251116_033209/`
  - âœ… é…ç½®åŠ è½½æˆåŠŸï¼ˆç¬¦åˆ RB_ ç¯å¢ƒå˜é‡è¦†ç›–æœºåˆ¶ï¼‰
  - âœ… æ•°æ®ç¼“å­˜æ­£ç¡®ä½ç½®ï¼š`experiments/.cache/ohlcv_9ac3907560e6ad83e0df7ab9b17bd19f.pkl`
  - âœ… Daily IC memmap ç”Ÿæˆï¼š`experiments/.cache/daily_ic_auto_v1simple_1399_43_18_db4cd001e270_fp64.mmap`

---

## ğŸ“š æ–‡æ¡£ç´¢å¼•

### æ ¸å¿ƒæŠ€æœ¯æ–‡æ¡£
- **[RELEASE_NOTES.md](etf_rotation_experiments/results/run_20251116_035732/RELEASE_NOTES.md)**: æœ€æ–°ç‰ˆæœ¬å‘å¸ƒè¯´æ˜ï¼Œç”¨æˆ·çº§åŠŸèƒ½ä»‹ç»
- **[ML_VS_WFO_COMPARISON.md](etf_rotation_experiments/results/run_20251116_035732/ML_VS_WFO_COMPARISON.md)**: ML/WFO æ€§èƒ½å¯¹æ¯”è¯¦ç»†æŠ¥å‘Š
- **[TEST_SUMMARY.md](etf_rotation_experiments/TEST_SUMMARY.md)**: æµ‹è¯•æ‰§è¡Œæ€»ç»“ä¸å·²çŸ¥é—®é¢˜
- **[PERFORMANCE_BASELINE.md](etf_rotation_experiments/PERFORMANCE_BASELINE.md)**: æ€§èƒ½åŸºçº¿ä¸ç›‘æ§æ–¹æ¡ˆ

### æ¨¡å‹ç»´æŠ¤
- **[RETRAIN_SCHEDULE.md](etf_rotation_experiments/strategies/ml_ranker/RETRAIN_SCHEDULE.md)**: LTR æ¨¡å‹é‡è®­è®¡åˆ’ä¸æµç¨‹

### å¿«é€Ÿå¼€å§‹

**è¿è¡Œ WFO + ML æ’åº**:
```bash
cd etf_rotation_experiments
python applications/run_combo_wfo.py --config configs/combo_wfo_config.yaml
```

**è¿è¡Œå›æµ‹éªŒè¯**:
```bash
cd etf_rotation_experiments/real_backtest
python run_profit_backtest.py --ranking-file ../results/run_LATEST/ranking_ic_top2000.parquet --topk 10 --slippage-bps 10
```

**æµ‹è¯•å¥—ä»¶**:
```bash
# å•å…ƒæµ‹è¯•
pytest tests/test_ml_ranking.py -v

# ç«¯åˆ°ç«¯æµ‹è¯•
pytest tests/test_e2e_workflow.py -v
```

**æ€§èƒ½ç›‘æ§**:
```bash
# æŸ¥çœ‹æ€§èƒ½åŸºçº¿
cat PERFORMANCE_BASELINE.md

# å¯¹æ¯”ä¸¤æ¬¡è¿è¡Œ
python analysis/compare_runs.py --run1 results/run_A --run2 results/run_B
```

---
  - âœ… æ’åºæ–‡ä»¶ç”Ÿæˆï¼š3 ä¸ª ranking parquet æ–‡ä»¶ï¼ˆranking_ic_top100 / top100_by_ic / top_combosï¼‰
  - âœ… å…ƒæ•°æ®å®Œæ•´ï¼šrun_config.json / wfo_summary.json / factor_selection_summary.json
  - âœ… å› å­æ–‡ä»¶ä¿å­˜ï¼š18 ä¸ªå› å­ parquet æ–‡ä»¶ä½äº `factors/` å­ç›®å½•

- 2025-11-16 03:32 Â· **è‡ªåŠ¨å›æµ‹æµç¨‹**ï¼ˆ`--auto-backtest --backtest-topk 5 --backtest-slippage-bps 10`ï¼‰
  - âœ… å›æµ‹å¼•æ“è‡ªåŠ¨å‘ç° WFO ç»“æœç›®å½•ï¼ˆæ— éœ€æ‰‹åŠ¨æŒ‡å®šè·¯å¾„ï¼‰
  - âœ… 3 ä¸ª ranking æ–‡ä»¶è‡ªåŠ¨è§¦å‘ç‹¬ç«‹å›æµ‹ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
  - âœ… ç»“æœè¾“å‡ºè‡³ `results_combo_wfo/20251116_033209_*/`ï¼ˆ3 ä¸ªå­ç›®å½•ï¼‰
  - âœ… å›æµ‹æ±‡æ€»ç”Ÿæˆï¼š`auto_backtest_summary.json`ï¼ˆåŒ…å« Top1 å¹´åŒ– 13.96% / Sharpe 0.775ï¼‰
  - âœ… è¯¦ç»†ç»©æ•ˆæ–‡ä»¶ï¼š`top100_profit_backtest_slip10bps_*.csv`ï¼ˆ100 ä¸ªç»„åˆå®Œæ•´å›æµ‹ç»“æœï¼‰
  - âœ… å¹³å‡å¹´åŒ–æ”¶ç›Šï¼š5.3% | ä¸­ä½æ•°å¹´åŒ–ï¼š5.1% | å¹³å‡ Sharpeï¼š0.25

- 2025-11-16 Â· **è·¯å¾„è§£æéªŒè¯**
  - âœ… ç¼“å­˜ç›®å½•ä¼˜å…ˆçº§æ­£ç¡®ï¼š`RB_DAILY_IC_MEMMAP_DIR` > `config.data.cache_dir` > `experiments/.cache`
  - âœ… é…ç½®æŸ¥æ‰¾ä¼˜å…ˆçº§æ­£ç¡®ï¼š`RB_CONFIG_FILE` > `experiments/configs` > æ—  optimized fallback
  - âœ… ç»“æœç›®å½•ä¼˜å…ˆçº§æ­£ç¡®ï¼š`RB_WFO_ROOT` > `experiments/results` > `experiments/results_combo_wfo`
  - âœ… æ‰€æœ‰è·¯å¾„è§£æå‡é™å®šåœ¨ `experiments/` æ ‘å†…ï¼Œæ—  `etf_rotation_optimized` ç¡¬ç¼–ç å¼•ç”¨

