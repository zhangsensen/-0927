[LightGBM] [Fatal] Number of rows 10077 exceeds upper limit of 10000 for a query

================================================================================
ğŸš€ å¼€å§‹è®­ç»ƒLTRæ’åºæ¨¡å‹
================================================================================

ğŸ” è‡ªåŠ¨æŸ¥æ‰¾æœ€æ–°WFOç»“æœ...
âœ“ è‡ªåŠ¨å‘ç°æœ€æ–°WFOè¿è¡Œ: run_latest
ğŸ” è‡ªåŠ¨æŸ¥æ‰¾æœ€æ–°å›æµ‹ç»“æœ...
âœ“ è‡ªåŠ¨å‘ç°æœ€æ–°å›æµ‹è¿è¡Œ: 20251114_155420_20251114_161032
  WFOç›®å½•: results/run_latest
  å›æµ‹ç›®å½•: results_combo_wfo/20251114_155420_20251114_161032

================================================================================
ğŸ“‚ åŠ è½½è®­ç»ƒæ•°æ®
================================================================================
âœ“ åŠ è½½WFOç‰¹å¾: 12597 ä¸ªç­–ç•¥ç»„åˆ
  ç‰¹å¾ç»´åº¦: (12597, 27)
  å”¯ä¸€combo: 12597
âœ“ åŠ è½½çœŸå®å›æµ‹ç»“æœ: 12597 ä¸ªç­–ç•¥
  æ•°æ®æ–‡ä»¶: top12597_profit_backtest_slip2bps_20251114_155420_20251114_161032.csv
  ç›®æ ‡åˆ—: annual_ret_net (å‡å€¼=0.1210, std=0.0478)

æ„å»ºè®­ç»ƒæ•°æ®é›†:
  WFOç­–ç•¥æ•°: 12597
  çœŸå®å›æµ‹ç­–ç•¥æ•°: 12597
  åŒ¹é…æˆåŠŸ: 12597 (100.0%)
  æ¬¡è¦ç›®æ ‡: sharpe_net (å‡å€¼=0.5645)

ç›®æ ‡å˜é‡ 'annual_ret_net' ç»Ÿè®¡:
  å‡å€¼: 0.120962
  æ ‡å‡†å·®: 0.047821
  æœ€å°å€¼: -0.051912
  æœ€å¤§å€¼: 0.226249
  ç¼ºå¤±å€¼: 0
  æ ·æœ¬æ•°: 12597
  ç›®æ ‡å˜é‡: annual_ret_net
  å‡å€¼: 0.1210, æ ‡å‡†å·®: 0.0478

================================================================================
ğŸ› ï¸ æ„å»ºç‰¹å¾çŸ©é˜µ
================================================================================

æ„å»ºç‰¹å¾çŸ©é˜µ:
  æå–æ ‡é‡ç‰¹å¾: 16 åˆ—
  æå–åºåˆ—ç‰¹å¾: 21 åˆ—
  åˆ›å»ºäº¤å‰ç‰¹å¾: 6 åˆ—

âœ“ ç‰¹å¾çŸ©é˜µæ„å»ºå®Œæˆ:
  æ ·æœ¬æ•°: 12597
  ç‰¹å¾æ•°: 44
  ç‰¹å¾åˆ—è¡¨ (å‰20): ['mean_oos_ic', 'oos_ic_std', 'oos_ic_ir', 'positive_rate', 'best_rebalance_freq', 'stability_score', 'mean_oos_sharpe', 'oos_sharpe_std', 'mean_oos_sample_count', 'oos_compound_sharpe', 'oos_compound_mean', 'oos_compound_std', 'oos_compound_sample_count', 'p_value', 'q_value', 'oos_sharpe_proxy', 'is_significant', 'ic_seq_mean', 'ic_seq_std', 'ic_seq_min']
  ç‰¹å¾æ•°: 44
  ç‰¹å¾ç»´åº¦: (12597, 44)
  æ ·æœ¬ç¤ºä¾‹: ['mean_oos_ic', 'oos_ic_std', 'oos_ic_ir', 'positive_rate', 'best_rebalance_freq']

================================================================================
ğŸ”¥ è®­ç»ƒLTRæ¨¡å‹
================================================================================

================================================================================
å¼€å§‹è®­ç»ƒLTRæ¨¡å‹
================================================================================

--- Fold 1/5 ---
Traceback (most recent call last):
  File "/Users/zhangshenshen/æ·±åº¦é‡åŒ–0927/etf_rotation_experiments/train_ranker.py", line 234, in <module>
    main()
  File "/Users/zhangshenshen/æ·±åº¦é‡åŒ–0927/etf_rotation_experiments/train_ranker.py", line 135, in main
    model.train(
  File "/Users/zhangshenshen/æ·±åº¦é‡åŒ–0927/etf_rotation_experiments/ml_ranker/ltr_model.py", line 140, in train
    model = lgb.train(
            ^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/lightgbm/engine.py", line 297, in train
    booster = Booster(params=params, train_set=train_set)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/lightgbm/basic.py", line 3660, in __init__
    _safe_call(
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/lightgbm/basic.py", line 313, in _safe_call
    raise LightGBMError(_LIB.LGBM_GetLastError().decode("utf-8"))
lightgbm.basic.LightGBMError: Number of rows 10077 exceeds upper limit of 10000 for a query

================================================================================
ğŸš€ å¼€å§‹è®­ç»ƒLTRæ’åºæ¨¡å‹
================================================================================

ğŸ” è‡ªåŠ¨æŸ¥æ‰¾æœ€æ–°WFOç»“æœ...
âœ“ è‡ªåŠ¨å‘ç°æœ€æ–°WFOè¿è¡Œ: run_latest
ğŸ” è‡ªåŠ¨æŸ¥æ‰¾æœ€æ–°å›æµ‹ç»“æœ...
âœ“ è‡ªåŠ¨å‘ç°æœ€æ–°å›æµ‹è¿è¡Œ: 20251114_155420_20251114_161032
  WFOç›®å½•: results/run_latest
  å›æµ‹ç›®å½•: results_combo_wfo/20251114_155420_20251114_161032

================================================================================
ğŸ“‚ åŠ è½½è®­ç»ƒæ•°æ®
================================================================================
âœ“ åŠ è½½WFOç‰¹å¾: 12597 ä¸ªç­–ç•¥ç»„åˆ
  ç‰¹å¾ç»´åº¦: (12597, 27)
  å”¯ä¸€combo: 12597
âœ“ åŠ è½½çœŸå®å›æµ‹ç»“æœ: 12597 ä¸ªç­–ç•¥
  æ•°æ®æ–‡ä»¶: top12597_profit_backtest_slip2bps_20251114_155420_20251114_161032.csv
  ç›®æ ‡åˆ—: annual_ret_net (å‡å€¼=0.1210, std=0.0478)

æ„å»ºè®­ç»ƒæ•°æ®é›†:
  WFOç­–ç•¥æ•°: 12597
  çœŸå®å›æµ‹ç­–ç•¥æ•°: 12597
  åŒ¹é…æˆåŠŸ: 12597 (100.0%)
  æ¬¡è¦ç›®æ ‡: sharpe_net (å‡å€¼=0.5645)

ç›®æ ‡å˜é‡ 'annual_ret_net' ç»Ÿè®¡:
  å‡å€¼: 0.120962
  æ ‡å‡†å·®: 0.047821
  æœ€å°å€¼: -0.051912
  æœ€å¤§å€¼: 0.226249
  ç¼ºå¤±å€¼: 0
  æ ·æœ¬æ•°: 12597
  ç›®æ ‡å˜é‡: annual_ret_net
  å‡å€¼: 0.1210, æ ‡å‡†å·®: 0.0478

================================================================================
ğŸ› ï¸ æ„å»ºç‰¹å¾çŸ©é˜µ
================================================================================

æ„å»ºç‰¹å¾çŸ©é˜µ:
  æå–æ ‡é‡ç‰¹å¾: 16 åˆ—
  æå–åºåˆ—ç‰¹å¾: 21 åˆ—
  åˆ›å»ºäº¤å‰ç‰¹å¾: 6 åˆ—

âœ“ ç‰¹å¾çŸ©é˜µæ„å»ºå®Œæˆ:
  æ ·æœ¬æ•°: 12597
  ç‰¹å¾æ•°: 44
  ç‰¹å¾åˆ—è¡¨ (å‰20): ['mean_oos_ic', 'oos_ic_std', 'oos_ic_ir', 'positive_rate', 'best_rebalance_freq', 'stability_score', 'mean_oos_sharpe', 'oos_sharpe_std', 'mean_oos_sample_count', 'oos_compound_sharpe', 'oos_compound_mean', 'oos_compound_std', 'oos_compound_sample_count', 'p_value', 'q_value', 'oos_sharpe_proxy', 'is_significant', 'ic_seq_mean', 'ic_seq_std', 'ic_seq_min']
  ç‰¹å¾æ•°: 44
  ç‰¹å¾ç»´åº¦: (12597, 44)
  æ ·æœ¬ç¤ºä¾‹: ['mean_oos_ic', 'oos_ic_std', 'oos_ic_ir', 'positive_rate', 'best_rebalance_freq']

================================================================================
ğŸ”¥ è®­ç»ƒLTRæ¨¡å‹
================================================================================

================================================================================
å¼€å§‹è®­ç»ƒLTRæ¨¡å‹
================================================================================

--- Fold 1/5 ---
Training until validation scores don't improve for 50 rounds
[50]	train's rmse: 0.0248825	valid's rmse: 0.0265111
[100]	train's rmse: 0.0219751	valid's rmse: 0.0246548
[150]	train's rmse: 0.0202502	valid's rmse: 0.0236394
[200]	train's rmse: 0.0190641	valid's rmse: 0.0230213
[250]	train's rmse: 0.0179134	valid's rmse: 0.0225349
[300]	train's rmse: 0.0170036	valid's rmse: 0.0221629
[350]	train's rmse: 0.0160642	valid's rmse: 0.0217801
[400]	train's rmse: 0.0152606	valid's rmse: 0.0214834
[450]	train's rmse: 0.0146262	valid's rmse: 0.0212749
[500]	train's rmse: 0.0140666	valid's rmse: 0.0211027
Did not meet early stopping. Best iteration is:
[500]	train's rmse: 0.0140666	valid's rmse: 0.0211027
  Fold 1 Spearmanç›¸å…³æ€§: 0.8944

--- Fold 2/5 ---
Training until validation scores don't improve for 50 rounds
[50]	train's rmse: 0.0250003	valid's rmse: 0.0266755
[100]	train's rmse: 0.0220964	valid's rmse: 0.0246403
[150]	train's rmse: 0.0203114	valid's rmse: 0.023603
[200]	train's rmse: 0.0189712	valid's rmse: 0.0229295
[250]	train's rmse: 0.0178331	valid's rmse: 0.0223087
[300]	train's rmse: 0.0168972	valid's rmse: 0.02186
[350]	train's rmse: 0.0160613	valid's rmse: 0.0215368
[400]	train's rmse: 0.0153905	valid's rmse: 0.0212671
[450]	train's rmse: 0.0147389	valid's rmse: 0.021019
[500]	train's rmse: 0.0141362	valid's rmse: 0.0208443
Did not meet early stopping. Best iteration is:
[500]	train's rmse: 0.0141362	valid's rmse: 0.0208443
  Fold 2 Spearmanç›¸å…³æ€§: 0.9025

--- Fold 3/5 ---
Training until validation scores don't improve for 50 rounds
[50]	train's rmse: 0.0249929	valid's rmse: 0.0268831
[100]	train's rmse: 0.0219357	valid's rmse: 0.024731
[150]	train's rmse: 0.0202571	valid's rmse: 0.0238057
[200]	train's rmse: 0.0189195	valid's rmse: 0.023086
[250]	train's rmse: 0.0178159	valid's rmse: 0.0225424
[300]	train's rmse: 0.0168671	valid's rmse: 0.0221092
[350]	train's rmse: 0.0160493	valid's rmse: 0.0217203
[400]	train's rmse: 0.0153399	valid's rmse: 0.0213621
[450]	train's rmse: 0.0146668	valid's rmse: 0.0211197
[500]	train's rmse: 0.0140689	valid's rmse: 0.0209398
Did not meet early stopping. Best iteration is:
[500]	train's rmse: 0.0140689	valid's rmse: 0.0209398
  Fold 3 Spearmanç›¸å…³æ€§: 0.8991

--- Fold 4/5 ---
Training until validation scores don't improve for 50 rounds
[50]	train's rmse: 0.0251212	valid's rmse: 0.0269854
[100]	train's rmse: 0.0221148	valid's rmse: 0.0250397
[150]	train's rmse: 0.0204099	valid's rmse: 0.0240786
[200]	train's rmse: 0.0190492	valid's rmse: 0.0233195
[250]	train's rmse: 0.017848	valid's rmse: 0.0226771
[300]	train's rmse: 0.0169806	valid's rmse: 0.0222954
[350]	train's rmse: 0.0161368	valid's rmse: 0.0218889
[400]	train's rmse: 0.0154577	valid's rmse: 0.0216092
[450]	train's rmse: 0.0148054	valid's rmse: 0.0213068
[500]	train's rmse: 0.0142021	valid's rmse: 0.0210891
Did not meet early stopping. Best iteration is:
[500]	train's rmse: 0.0142021	valid's rmse: 0.0210891
  Fold 4 Spearmanç›¸å…³æ€§: 0.9003

--- Fold 5/5 ---
Training until validation scores don't improve for 50 rounds
[50]	train's rmse: 0.0250745	valid's rmse: 0.0264784
[100]	train's rmse: 0.0221487	valid's rmse: 0.0243812
[150]	train's rmse: 0.0204978	valid's rmse: 0.0232918
[200]	train's rmse: 0.0190303	valid's rmse: 0.0224782
[250]	train's rmse: 0.0178742	valid's rmse: 0.0218987
[300]	train's rmse: 0.0168801	valid's rmse: 0.0214225
[350]	train's rmse: 0.0161006	valid's rmse: 0.0211642
[400]	train's rmse: 0.0154049	valid's rmse: 0.0209058
[450]	train's rmse: 0.0147247	valid's rmse: 0.0206534
[500]	train's rmse: 0.0141799	valid's rmse: 0.0204768
Did not meet early stopping. Best iteration is:
[500]	train's rmse: 0.0141799	valid's rmse: 0.0204768
  Fold 5 Spearmanç›¸å…³æ€§: 0.9102

================================================================================
è®­ç»ƒå®Œæˆ
================================================================================
CVå¹³å‡Spearmanç›¸å…³æ€§: 0.9013 Â± 0.0052
æœ€ä½³Fold: 5 (Spearman=0.9102)

  âœ“ è®­ç»ƒå®Œæˆ
  CV Spearman: 0.9102

================================================================================
ğŸ¯ é¢„æµ‹æ’åº
================================================================================
  é¢„æµ‹åˆ†æ•°èŒƒå›´: [-0.0319, 0.2000]
  æ’åèŒƒå›´: [1, 12597]

================================================================================
ğŸ“Š ç‰¹å¾é‡è¦æ€§åˆ†æ
================================================================================

  Top-15 é‡è¦ç‰¹å¾:
    sharpe_seq_max                     :         56
    ic_seq_max                         :         19
    oos_compound_std                   :         14
    ic_seq_trend                       :         11
    oos_ic_std                         :          8
    sharpe_seq_min                     :          7
    oos_compound_mean                  :          6
    ir_seq_std                         :          5
    oos_sharpe_std                     :          4
    ic_seq_median                      :          4
    ic_seq_min                         :          3
    ic_seq_std                         :          3
    ic_seq_cv                          :          3
    sharpe_seq_cv                      :          2
    sharpe_seq_median                  :          2

================================================================================
ğŸ“ˆ æ¨¡å‹è¯„ä¼°
================================================================================

================================================================================
ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š
================================================================================
Traceback (most recent call last):
  File "/Users/zhangshenshen/æ·±åº¦é‡åŒ–0927/etf_rotation_experiments/train_ranker.py", line 236, in <module>
    main()
  File "/Users/zhangshenshen/æ·±åº¦é‡åŒ–0927/etf_rotation_experiments/train_ranker.py", line 174, in main
    eval_report = generate_evaluation_report(
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/zhangshenshen/æ·±åº¦é‡åŒ–0927/etf_rotation_experiments/ml_ranker/evaluator.py", line 222, in generate_evaluation_report
    model_metrics = compute_ranking_metrics(y_true, y_pred, metadata)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/zhangshenshen/æ·±åº¦é‡åŒ–0927/etf_rotation_experiments/ml_ranker/evaluator.py", line 129, in compute_ranking_metrics
    metrics[f"ndcg@{k}"] = compute_ndcg(y_true, y_pred, k=k)
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/zhangshenshen/æ·±åº¦é‡åŒ–0927/etf_rotation_experiments/ml_ranker/evaluator.py", line 52, in compute_ndcg
    return ndcg_score(y_true_2d, y_pred_2d, k=k)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sklearn/utils/_param_validation.py", line 218, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sklearn/metrics/_ranking.py", line 1895, in ndcg_score
    raise ValueError("ndcg_score should not be used on negative y_true values.")
ValueError: ndcg_score should not be used on negative y_true values.
