# ==============================================================================
# 性能优化环境变量 - AMD Ryzen 9 9950X + RTX 5070 Ti 配置
# ==============================================================================
# 参考: docs/MACHINE_CONFIGURATION.md
# 最后更新: 2025-11-26

# ------------------------------------------------------------------------------
# CPU 并行优化 (16 物理核心 / 32 逻辑核心)
# ------------------------------------------------------------------------------
# NumPy/SciPy 底层 BLAS 线程数 (建议使用物理核心数，避免 SMT 竞争)
export OPENBLAS_NUM_THREADS=16
export MKL_NUM_THREADS=16
export NUMEXPR_NUM_THREADS=16
export OMP_NUM_THREADS=16

# Polars 并行 (可以用全部逻辑核心，因为 I/O 占比高)
export POLARS_MAX_THREADS=32

# Numba 并行配置
export NUMBA_NUM_THREADS=16
export NUMBA_THREADING_LAYER=tbb  # TBB 通常比 omp 性能更好

# joblib 并行 (默认使用物理核心数，避免内存竞争)
export JOBLIB_N_JOBS=16

# ------------------------------------------------------------------------------
# 回测稳定性标志 (参考 .github/copilot-instructions.md)
# ------------------------------------------------------------------------------
export RB_STABLE_RANK=1
export RB_DAILY_IC_PRECOMP=1

# ------------------------------------------------------------------------------
# GPU 配置 (RTX 5070 Ti - Blackwell 架构)
# ------------------------------------------------------------------------------
export CUDA_VISIBLE_DEVICES=0
export PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True

# LightGBM GPU 模式
export LIGHTGBM_USE_GPU=1

# ------------------------------------------------------------------------------
# 数据路径配置 (可选覆盖)
# ------------------------------------------------------------------------------
# export ETF_DATA_DIR=/home/sensen/dev/projects/-0927/raw/ETF/daily
# export ETF_CACHE_DIR=/home/sensen/dev/projects/-0927/.cache

# ------------------------------------------------------------------------------
# 性能分析标志 (调试时启用)
# ------------------------------------------------------------------------------
# export RB_PROFILE_BACKTEST=1

# ------------------------------------------------------------------------------
# NumPy 高级配置
# ------------------------------------------------------------------------------
export NUMPY_EXPERIMENTAL_ARRAY_FUNCTION=1
