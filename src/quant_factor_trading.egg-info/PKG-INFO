Metadata-Version: 2.4
Name: quant-factor-trading
Version: 0.3.0
Summary: 综合量化因子投资平台 - ETF轮动 + 因子库 + WFO优化
Author-email: Quant Team <quant@example.com>
License: MIT
Project-URL: Homepage, https://github.com/zhangsensen/quant-factor-trading
Project-URL: Repository, https://github.com/zhangsensen/quant-factor-trading.git
Project-URL: Documentation, https://github.com/zhangsensen/quant-factor-trading/blob/main/README.md
Project-URL: Bug Tracker, https://github.com/zhangsensen/quant-factor-trading/issues
Project-URL: Changelog, https://github.com/zhangsensen/quant-factor-trading/releases
Requires-Python: >=3.11
Description-Content-Type: text/markdown
Requires-Dist: numpy>=2.3.3
Requires-Dist: pandas>=2.3.2
Requires-Dist: polars>=1.33.1
Requires-Dist: scipy>=1.16.2
Requires-Dist: scikit-learn>=1.7.2
Requires-Dist: statsmodels>=0.14.0
Requires-Dist: vectorbt>=0.28.1
Requires-Dist: ta-lib>=0.6.7
Requires-Dist: yfinance>=0.2.66
Requires-Dist: pyarrow>=21.0.0
Requires-Dist: fastparquet>=2024.11.0
Requires-Dist: pyyaml>=6.0.0
Requires-Dist: pydantic>=2.0.0
Requires-Dist: python-dotenv>=1.0.0
Requires-Dist: pyscn>=1.1.1
Requires-Dist: requests>=2.32.0
Requires-Dist: httpx[socks]>=0.28.1
Requires-Dist: joblib>=1.5.2
Requires-Dist: numba>=0.62.0
Requires-Dist: matplotlib>=3.10.6
Requires-Dist: seaborn>=0.13.2
Requires-Dist: mplfinance>=0.12.10b0
Requires-Dist: plotly>=5.24.0
Requires-Dist: pandas-vet>=2023.8.2
Requires-Dist: akshare>=1.17.91
Requires-Dist: tushare>=1.4.0
Provides-Extra: web
Requires-Dist: dash>=2.18.0; extra == "web"
Requires-Dist: beautifulsoup4>=4.13.5; extra == "web"
Requires-Dist: flask>=3.0.0; extra == "web"
Provides-Extra: database
Requires-Dist: sqlalchemy>=2.0.0; extra == "database"
Requires-Dist: redis>=5.0.0; extra == "database"
Provides-Extra: scheduling
Requires-Dist: schedule>=1.2.0; extra == "scheduling"
Provides-Extra: dev
Requires-Dist: pytest>=8.4.2; extra == "dev"
Requires-Dist: pytest-cov>=7.0.0; extra == "dev"
Requires-Dist: black>=25.9.0; extra == "dev"
Requires-Dist: isort>=6.0.1; extra == "dev"
Requires-Dist: flake8>=7.3.0; extra == "dev"
Requires-Dist: ruff>=0.13.2; extra == "dev"
Requires-Dist: mypy>=1.18.2; extra == "dev"
Requires-Dist: bandit>=1.8.6; extra == "dev"
Requires-Dist: safety>=3.6.2; extra == "dev"
Requires-Dist: line-profiler>=5.0.0; extra == "dev"
Requires-Dist: memory-profiler>=0.61.0; extra == "dev"
Requires-Dist: vulture>=2.14; extra == "dev"
Requires-Dist: pre-commit>=4.3.0; extra == "dev"
Requires-Dist: ipython>=9.5.0; extra == "dev"
Requires-Dist: jupyterlab>=4.4.9; extra == "dev"
Requires-Dist: notebook>=7.3.0; extra == "dev"
Requires-Dist: pandas-stubs>=2.3.2.250926; extra == "dev"
Requires-Dist: types-psutil>=7.0.0.20251001; extra == "dev"
Requires-Dist: types-pyyaml>=6.0.12.20250915; extra == "dev"
Requires-Dist: types-seaborn>=0.13.2.20250914; extra == "dev"
Provides-Extra: all
Requires-Dist: quant-factor-trading[database,dev,scheduling,web]; extra == "all"

# 深度量化0927 - ETF 轮动策略研究平台

> **最新版本**: v3.0 (高频轮动 Alpha)
> **发布日期**: 2025-12-01
> **核心文档**: [STRATEGY_BLUEPRINT_V3.md](STRATEGY_BLUEPRINT_V3.md) (👈 **必读：新一代策略蓝图**)
> **Python**: 3.11+
> **包管理**: [UV](https://docs.astral.sh/uv/) (v0.9+)

---

## 🚀 v3.0 重大更新 (2025-12-01)

**我们已从 v1.0 的"防御型"策略全面转向 v3.0 "高频进攻型"策略。**

- **收益率**: 121% (v1.0) -> **237% (v3.0)**
- **Calmar**: 0.66 (v1.0) -> **2.15 (v3.0)**
- **核心逻辑**: 3日轮动 + Top 2 集中持仓 + 无止损
- **详情请见**: [STRATEGY_BLUEPRINT_V3.md](STRATEGY_BLUEPRINT_V3.md)

### ⚠️ 关键发现 (v3.1 审计)

**现有 5 只 QDII 是策略的核心 Alpha 来源！**

| QDII ETF | 名称 | 贡献 | 胜率 |
|----------|------|------|------|
| 513500 | 标普500 | +25.37% | 68.9% |
| 513130 | 恒生科技(港元) | +23.69% | 53.3% |
| 513100 | 纳指100 | +22.03% | 61.3% |
| 159920 | 恒生指数 | +17.13% | 70.0% |
| 513050 | 中概互联 | +2.01% | 44.4% |
| **合计** | | **+90.23%** | **~60%** |

- 移除 QDII → 收益从 237% 降至 177%（损失 60pp）
- **详见**: [docs/ETF_POOL_ARCHITECTURE.md](docs/ETF_POOL_ARCHITECTURE.md)

---

## 🏆 v1.0 历史版本 (Legacy - 仅供参考)

> ⚠️ **注意**: 以下为 v1.0 历史配置，**当前生产环境使用 v3.0 参数**

**本项目 v1.0 版本已于 2025-11-28 封板**，核心策略已验证可复现。

<details>
<summary>📜 点击展开 v1.0 历史配置</summary>

### v1.0 核心策略：43 ETF 统一轮动

| 指标 | 数值 | 说明 |
|------|------|------|
| **策略类型** | 统一池轮动 | 43 只 ETF 统一排名选股 |
| **最佳因子组合** | `CORRELATION_TO_MARKET_20D + MAX_DD_60D + PRICE_POSITION_120D + PRICE_POSITION_20D` | 4 因子组合 |
| **回测收益率** | **121.02%** | 2020-01-01 至 2025-10-14 |
| **胜率** | 54.59% | 196 笔交易 |
| **盈亏比** | 1.414 | - |
| **FREQ** | 8 | ⚠️ 旧参数 |
| **POS_SIZE** | 3 | ⚠️ 旧参数 |

</details>

---

## 🎯 项目概述

本项目是专业级 **ETF 轮动策略研究平台**，采用三层引擎架构（WFO → VEC → BT），从因子挖掘到回测审计全流程覆盖。

| 状态 | 说明 |
|------|------|
| 🔒 v1.0 封板 | 核心策略已验证，可复现 |
| ✅ VEC/BT 对齐 | 差异 < 0.01 个百分点 |
| ✅ 无前视偏差 | `shift_timing_signal` 保证 |
| ✅ 生产就绪 | 43 只 ETF, 18 因子, 12,597 组合 |

---

## ⚡ 快速开始

### 1. 环境安装

```bash
# 安装 UV（如未安装）
curl -LsSf https://astral.sh/uv/install.sh | sh

# 克隆项目后
cd /path/to/project
uv sync --dev              # 安装所有依赖
```

### 2. 生产工作流（复现 237% 收益）

```bash
# Step 1: WFO 筛选 - 从 12,597 组合中筛选 (FREQ=3)
uv run python src/etf_strategy/run_combo_wfo.py

# Step 2: VEC 复算 - 全量精确回测
uv run python scripts/batch_vec_backtest.py

# Step 3: BT 审计（可选）- 事件驱动审计验证
uv run python scripts/batch_bt_backtest.py
```

### 3. 验证结果

最佳策略应为（v3.0）：
```
组合: ADX_14D + MAX_DD_60D + PRICE_POSITION_120D + PRICE_POSITION_20D + SHARPE_RATIO_20D
收益率: 237.45%
胜率: 52.9%
盈亏比: 2.16
参数: FREQ=3, POS=2
```

### ⚠️ 运行命令规范

**所有 Python 脚本必须使用 `uv run` 前缀**：

```bash
# ✅ 正确方式
uv run python script.py

# ❌ 错误方式
python script.py
python3 script.py
```

---

## 🏗️ 三层引擎架构

```
┌─────────────────────────────────────────────────────────────┐
│  WFO 筛选层（粗筛器）                                        │
│  ├── 脚本: src/etf_strategy/run_combo_wfo.py                │
│  ├── 功能: IC/ICIR 评估因子质量 (12,597 组合)               │
│  ├── 速度: ~3 秒完成全量筛选                                 │
│  └── 注意: WFO 排名 ≠ VEC 收益排名（这是正常的）            │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  VEC 复算层（精算器）                                        │
│  ├── 脚本: scripts/batch_vec_backtest.py                    │
│  ├── 功能: Numba 向量化高速回测                              │
│  ├── 对齐: 严格对齐 BT（< 0.01pp 差异）                      │
│  └── 输出: 精确收益率、胜率、盈亏比                          │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  BT 审计层（基准真相）                                       │
│  ├── 脚本: scripts/batch_bt_backtest.py                     │
│  ├── 功能: Backtrader 事件驱动 + 资金约束审计               │
│  └── 输出: 最终审计报告                                      │
└─────────────────────────────────────────────────────────────┘
```

---

## 📁 项目结构

```
.
├── README.md                      # 📌 本文件（v1.1 说明）
├── AGENTS.md                      # AI Agent 指导规则（重要！）
├── pyproject.toml                 # 项目配置 + 依赖定义
├── uv.lock                        # 依赖锁文件
│
├── src/                           # ⭐ 源码目录（标准 src 布局）
│   ├── etf_strategy/              # 🎯 主力策略系统
│   │   ├── run_combo_wfo.py       #    WFO 入口脚本
│   │   ├── core/                  #    核心引擎（🔒 禁止修改）
│   │   │   ├── combo_wfo_optimizer.py    # 滚动 WFO 优化器
│   │   │   ├── precise_factor_library_v2.py  # 18 因子库
│   │   │   ├── backtester_vectorized.py  # VEC 回测引擎
│   │   │   └── shared_types.py           # 共享工具函数
│   │   └── auditor/               #    BT 审计模块
│   │       └── core/engine.py     #    Backtrader 策略
│   │
│   └── etf_data/                  # 📊 数据管理模块（独立）
│       ├── core/                  #    下载器核心
│       └── config/                #    配置管理
│
├── scripts/                       # 🔧 操作脚本
│   ├── batch_vec_backtest.py      #    VEC 批量回测
│   ├── batch_bt_backtest.py       #    BT 批量审计
│   └── full_vec_bt_comparison.py  #    VEC/BT 对比验证
│
├── results/                       # 📊 回测结果
│   ├── ARCHIVE_unified_wfo_43etf_best/   # 🏆 最佳 WFO 结果存档
│   └── ARCHIVE_vec_43etf_best/           # 🏆 最佳 VEC 结果存档 (121%)
│
├── docs/                          # 📚 文档
│   ├── BEST_STRATEGY_43ETF_UNIFIED.md    # 🏆 最佳策略详细文档
│   └── INDEX.md                          # 文档索引
│
├── configs/                       # ⚙️ 全局配置
└── raw/                           # 💾 原始数据
```

---

## 📊 核心参数（v3.0 生产配置）

| 参数 | v3.0 值 | v1.0 值 | 说明 |
|------|---------|---------|------|
| `FREQ` | **3** | 8 | 调仓频率（交易日）|
| `POS_SIZE` | **2** | 3 | 持仓数量 |
| `INITIAL_CAPITAL` | 1,000,000 | 同 | 初始资金 |
| `COMMISSION` | 0.0002 | 同 | 手续费率 (2bp) |
| `LOOKBACK` | 252 | 同 | 回看窗口（交易日） |
| **ETF 数量** | **43** | 43 | 38 A股 + 5 QDII ⚠️ |
| **因子数量** | 18 | 18 | PreciseFactorLibrary |
| **最佳因子组合** | ADX + MAX_DD + PP_120D + PP_20D + SHARPE | CORR + MAX_DD + PP_120D + PP_20D | 5因子 vs 4因子 |

> ⚠️ **关键**: 5 只 QDII 贡献 +90% 收益，禁止移除！详见 [docs/ETF_POOL_ARCHITECTURE.md](docs/ETF_POOL_ARCHITECTURE.md)

---

## 🔒 v3.0 封板规则

### ✅ 允许的修改

- Bug 修复（不改变策略逻辑）
- 数据源适配
- 文档完善
- 性能优化（不改变结果）
- 数据更新（新日期数据）

### ❌ 禁止的修改

- 修改核心因子库
- 修改回测引擎逻辑
- **修改参数默认值 (FREQ=3, POS=2)**
- **修改 ETF 池定义（特别是 5 只 QDII）**
- 删除 ARCHIVE 存档

## 🚫 「简化版 / 备份脚本」禁令

- **唯一的 WFO 入口** 是 `src/etf_strategy/run_combo_wfo.py`。任何 `run_unified*`、`direct_factor*`、`*_simple*`、`*_simplified*` 等脚本一律视为违规，不得出现在生产目录。
- `scripts/archive/` 与 `docs/archive/` 保留历史记录，但被视为冷冻区；其中的脚本或文字不得重新引用到生产流程。
- `scripts/ci_checks.py` 已内置「简化版探测」扫描，如发现违规文件会立即失败，严禁通过跳过检查的方式引入非滚动 WFO 实现。
- 若确因研究需要临时恢复旧脚本，必须先将文件移动到 `backup_*/` 类隔离目录，并在任务结束后彻底清除。

---

## 📖 关键文档

| 文档 | 描述 |
|------|------|
| [docs/BEST_STRATEGY_43ETF_UNIFIED.md](docs/BEST_STRATEGY_43ETF_UNIFIED.md) | 🏆 **最佳策略详细文档** |
| [docs/INDEX.md](docs/INDEX.md) | 文档索引 |

---

## ⚠️ 开发注意事项

1. **Set 遍历不确定性**：使用 `sorted()` 确保有序
2. **前视偏差**：使用 `shift_timing_signal` 滞后信号
3. **调仓日程**：使用 `generate_rebalance_schedule` 统一
4. **浮点精度**：比较时使用 0.01% 容差
5. **资金时序**：BT 中使用卖出后现金计算

---

## 📜 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| **v3.1** | 2025-12-01 | 🔬 ETF 池深度审计：确认 5 只 QDII 贡献 90%+ 收益 |
| **v3.0** | 2025-12-01 | 🚀 高频策略升级：FREQ=3, POS=2, 收益 237.45% |
| v1.1 | 2025-11-30 | 架构重构：统一 `src/` 布局 |
| v1.0 | 2025-11-28 | 🔒 统一策略 121.02% 验证通过 |
| v0.9 | 2025-11-16 | VEC/BT 对齐完成 |
| v0.8 | 2025-11-09 | 性能优化冻结 |

---

**维护者**: 深度量化团队 | **License**: MIT | **🔒 v3.1 策略封板 | 237.45% 收益已验证**
