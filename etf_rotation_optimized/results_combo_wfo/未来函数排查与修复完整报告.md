# æœªæ¥å‡½æ•°é—®é¢˜å…¨é¢æ’æŸ¥ä¸ä¿®å¤æŠ¥å‘Š

## ğŸ” é—®é¢˜å‘ç°è¿‡ç¨‹

### ç”¨æˆ·è´¨ç–‘
> "ä½ çš„å›æµ‹è‚¯å®šæœ‰é—®é¢˜å•Šï¼Œæ˜¯ä¸æ˜¯æ²¡æœ‰é™åˆ¶æœªæ¥å‡½æ•°"

**ç”¨æˆ·è´¨ç–‘çš„åŸå› ï¼š**
- 1å¤©æ¢ä»“å¹´åŒ–204%ï¼Œ5.5å¹´479å€æ”¶ç›Š
- å®Œå…¨ä¸ç¬¦åˆå¸¸è¯†å’Œå¸‚åœºè§„å¾‹
- æ€€ç–‘å­˜åœ¨æœªæ¥å‡½æ•°æ³„éœ²

## ğŸ“‹ å…¨é¢ä»£ç å®¡æŸ¥

### âœ… **æ­£ç¡®çš„ä»£ç ï¼šWFOä¼˜åŒ–å™¨**

æ–‡ä»¶ï¼š`core/combo_wfo_optimizer.py`

**æ—¶é—´éš”ç¦»è®¾è®¡ï¼š**
```python
def _generate_windows(self, total_days: int):
    windows = []
    offset = 0
    while True:
        is_start = offset
        is_end = offset + self.config.is_period      # IS: [0, 252)
        oos_start = is_end
        oos_end = oos_start + self.config.oos_period # OOS: [252, 312)
        if oos_end > total_days:
            break
        windows.append(((is_start, is_end), (oos_start, oos_end)))
        offset += self.config.step_size
    return windows
```

**ä¸¥æ ¼æµ‹è¯•æµç¨‹ï¼š**
```python
def _test_combo_single_window(self, ...):
    # 1. ISæœŸè®¡ç®—æƒé‡
    for i, f_idx in enumerate(combo_indices):
        is_ics[i] = compute_spearman_ic_numba(factors_is[:, :, f_idx], returns_is)
    weights = abs_ics / abs_ics.sum()
    
    # 2. OOSæœŸæµ‹è¯•ï¼ˆç”¨ISæœŸæƒé‡ï¼‰
    signal_oos = _compute_combo_signal(factors_oos_combo, weights)
    mean_ic, ir, pos_rate = _compute_rebalanced_ic(signal_oos, returns_oos, freq)
```

**ç»“è®ºï¼š** âœ… WFOä¼˜åŒ–å™¨è®¾è®¡æ­£ç¡®ï¼Œæ— æœªæ¥å‡½æ•°

---

### âŒ **é”™è¯¯çš„ä»£ç ï¼šæ¢ä»“é¢‘ç‡æµ‹è¯•**

æ–‡ä»¶ï¼š`test_all_frequencies.py`

**é—®é¢˜1ï¼šå› å­æƒé‡å›ºå®šä½¿ç”¨å‰252å¤©**
```python
# ç¬¬142-153è¡Œ
is_end = min(252, factors_data.shape[0] // 2)
factors_is = factors_selected[:is_end]
returns_is = returns[:is_end]

# è®¡ç®—å›ºå®šæƒé‡
weights = np.zeros(len(plan_b_factors))
for i in range(len(plan_b_factors)):
    weights[i] = abs(compute_spearman_ic_numba(factors_is[:, :, i], returns_is))

# âŒ ç”¨è¿™ä¸ªå›ºå®šæƒé‡è·‘å…¨éƒ¨1399å¤©ï¼
signal = compute_signal(factors_selected, weights)
```

**é—®é¢˜åˆ†æï¼š**
- åªç”¨å‰252å¤©è®¡ç®—æƒé‡
- ç„¶åç”¨è¿™ä¸ªå›ºå®šæƒé‡é¢„æµ‹æœªæ¥1147å¤©
- ç›¸å½“äºå‡è®¾æœªæ¥å› å­ICæ°¸è¿œä¸å˜

**é—®é¢˜2ï¼šä¿¡å·æå‰æ‰¹é‡è®¡ç®—**
```python
# ç¬¬153è¡Œï¼šä¸€æ¬¡æ€§ç®—å®Œå…¨éƒ¨1399å¤©çš„ä¿¡å·
signal = compute_signal(factors_selected, weights)

# ç¬¬38è¡Œå›æµ‹æ—¶ç›´æ¥å–ç”¨
def backtest_freq(factors_selected, returns, etf_names, rebalance_freq):
    for i in range(0, len(returns), rebalance_freq):
        sig = signal[i]  # âŒ ç›´æ¥å–ç”¨å·²ç»ç®—å¥½çš„æœªæ¥ä¿¡å·ï¼
```

**é—®é¢˜åˆ†æï¼š**
- åœ¨ç¬¬0å¤©å°±è®¡ç®—äº†æœªæ¥1399å¤©çš„æ‰€æœ‰ä¿¡å·
- å›æµ‹æ—¶ç›´æ¥ç´¢å¼•å–ç”¨
- ç›¸å½“äº"ç©¿è¶Šåˆ°æœªæ¥çœ‹å®Œæ‰€æœ‰æ•°æ®å†å›æ¥äº¤æ˜“"

**é—®é¢˜3ï¼šç¼ºå°‘é€æ—¥æ—¶é—´å±•å¼€**
```python
# âŒ æ²¡æœ‰é€æ­¥å±•å¼€çš„æ—¶é—´çª—å£
# âŒ æ²¡æœ‰æ¯æ¬¡è°ƒä»“é‡æ–°è®¡ç®—æƒé‡
# âŒ æ²¡æœ‰ç”¨å†å²æ•°æ®å®æ—¶è®¡ç®—ä¿¡å·
```

**ç»“è®ºï¼š** âŒ å­˜åœ¨ä¸¥é‡çš„æœªæ¥å‡½æ•°æ³„éœ²

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒåŸåˆ™
1. **ä¸¥æ ¼æ—¶é—´éš”ç¦»**ï¼šç¬¬tæ—¥å†³ç­–åªèƒ½ç”¨ç¬¬t-1æ—¥åŠä¹‹å‰çš„æ•°æ®
2. **æ»šåŠ¨çª—å£**ï¼šæ¯ä¸ªè°ƒä»“æ—¥é‡æ–°è®¡ç®—å› å­æƒé‡
3. **å®æ—¶ä¿¡å·**ï¼šç”¨å½“æ—¥å› å­å€¼å®æ—¶è®¡ç®—ä¿¡å·ï¼Œä¸æå‰æ‰¹é‡è®¡ç®—

### ä¿®å¤åçš„ä»£ç ç»“æ„

æ–‡ä»¶ï¼š`test_freq_no_lookahead.py`

```python
def backtest_no_lookahead(factors_data, returns, ...):
    """æ— æœªæ¥å‡½æ•°çš„å›æµ‹"""
    
    # èµ·å§‹ç‚¹ï¼šéœ€è¦è¶³å¤Ÿå†å²æ•°æ®
    start_idx = lookback_window + 1  # 253å¤©å¼€å§‹
    
    for day_idx in range(start_idx, T):
        # æ£€æŸ¥æ˜¯å¦ä¸ºè°ƒä»“æ—¥
        if day_idx in rebalance_days:
            
            # âœ… 1. æå–å†å²æ•°æ®ï¼ˆæˆªè‡³å‰ä¸€æ—¥ï¼‰
            hist_start = max(0, day_idx - lookback_window)
            hist_end = day_idx  # ä¸åŒ…æ‹¬å½“æ—¥
            factors_hist = factors_data[hist_start:hist_end]
            returns_hist = returns[hist_start:hist_end]
            
            # âœ… 2. ç”¨å†å²æ•°æ®è®¡ç®—å› å­æƒé‡
            factor_weights = compute_weights_from_ic(factors_hist, returns_hist)
            
            # âœ… 3. ç”¨å‰ä¸€æ—¥å› å­å€¼è®¡ç®—ä¿¡å·
            factors_yesterday = factors_data[day_idx - 1]
            signal_yesterday = compute_signal_single_day(
                factors_yesterday, factor_weights
            )
            
            # âœ… 4. åŸºäºä¿¡å·é€‰è‚¡
            target_weights = select_top_n(signal_yesterday)
            
            # âœ… 5. è®¡ç®—äº¤æ˜“æˆæœ¬
            turnover = np.sum(np.abs(target_weights - current_weights))
            trading_cost = turnover * transaction_cost
            
            # âœ… 6. æ›´æ–°æŒä»“
            current_weights = target_weights
            portfolio_value[-1] *= (1 - trading_cost)
        
        # âœ… 7. æ¯æ—¥æ”¶ç›Šè®¡ç®—
        ret_today = returns[day_idx]
        daily_ret = np.nansum(current_weights * ret_today)
        portfolio_value.append(portfolio_value[-1] * (1 + daily_ret))
```

### å…³é”®æ”¹è¿›ç‚¹

| ç»´åº¦ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **æƒé‡è®¡ç®—** | å›ºå®šç”¨å‰252å¤© | æ¯æ¬¡è°ƒä»“æ»šåŠ¨è®¡ç®— |
| **ä¿¡å·è®¡ç®—** | æå‰ç®—å®Œ1399å¤© | æ¯æ¬¡è°ƒä»“å®æ—¶è®¡ç®— |
| **æ—¶é—´çª—å£** | æ— æ—¶é—´éš”ç¦» | ä¸¥æ ¼é€æ—¥å±•å¼€ |
| **æ•°æ®ä½¿ç”¨** | å¯ä»¥çœ‹åˆ°æœªæ¥æ•°æ® | åªèƒ½çœ‹åˆ°å†å²æ•°æ® |

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### æ•°æ®å¯¹æ¯”

| æ¢ä»“é¢‘ç‡ | ä¿®å¤å‰å¹´åŒ– | ä¿®å¤åå¹´åŒ– | å·®è· |
|---------|-----------|-----------|------|
| 1å¤©     | 204.0%    | 2.5%      | **81å€** |
| 2å¤©     | 85.6%     | 9.9%      | **8.6å€** |
| 5å¤©     | 31.3%     | 6.5%      | **4.8å€** |
| 6å¤©     | -         | 12.9%     | - |
| 10å¤©    | 20.9%     | 11.0%     | **1.9å€** |

### æ”¶ç›Šæ›²çº¿å¯¹æ¯”

**ä¿®å¤å‰ï¼ˆ1å¤©æ¢ä»“ï¼‰ï¼š**
- 100ä¸‡ â†’ 47,920ä¸‡ï¼ˆ479å€ï¼‰
- å¹´åŒ–204%ï¼ŒSharpe 6.91
- **å®Œå…¨ä¸å¯ä¿¡ï¼**

**ä¿®å¤åï¼ˆ6å¤©æ¢ä»“ï¼‰ï¼š**
- 100ä¸‡ â†’ 173.4ä¸‡ï¼ˆ73%æ”¶ç›Šï¼‰
- å¹´åŒ–12.9%ï¼ŒSharpe 0.486
- **ç¬¦åˆå¸‚åœºè§„å¾‹**

---

## âœ… ä¿®å¤éªŒè¯

### æµ‹è¯•ç»“æœï¼ˆæ— æœªæ¥å‡½æ•°ï¼‰

```
====================================================================================================
æ–¹æ¡ˆBï¼ˆ5å› å­ï¼‰ä¸åŒæ¢ä»“é¢‘ç‡æµ‹è¯• - æ— æœªæ¥å‡½æ•°ç‰ˆæœ¬
====================================================================================================

 1å¤©æ¢ä»“: 100ä¸‡â†’   111.9ä¸‡ | å¹´åŒ–  2.5% | Sharpe 0.090 | å›æ’¤-48.2% | è°ƒä»“1146æ¬¡
 2å¤©æ¢ä»“: 100ä¸‡â†’   153.4ä¸‡ | å¹´åŒ–  9.9% | Sharpe 0.354 | å›æ’¤-35.6% | è°ƒä»“573æ¬¡
 6å¤©æ¢ä»“: 100ä¸‡â†’   173.4ä¸‡ | å¹´åŒ– 12.9% | Sharpe 0.486 | å›æ’¤-33.6% | è°ƒä»“191æ¬¡  â­æœ€ä¼˜
10å¤©æ¢ä»“: 100ä¸‡â†’   160.9ä¸‡ | å¹´åŒ– 11.0% | Sharpe 0.416 | å›æ’¤-36.8% | è°ƒä»“115æ¬¡
30å¤©æ¢ä»“: 100ä¸‡â†’   151.7ä¸‡ | å¹´åŒ–  9.6% | Sharpe 0.374 | å›æ’¤-33.0% | è°ƒä»“39æ¬¡
```

### æœ€ä¼˜ç»“æœ
- **æœ€é«˜Sharpe**ï¼š6å¤©æ¢ä»“ - Sharpe 0.486, å¹´åŒ–12.9%
- **æœ€é«˜å¹´åŒ–**ï¼š6å¤©æ¢ä»“ - å¹´åŒ–12.9%, Sharpe 0.486
- **æœ€å°å›æ’¤**ï¼š30å¤©æ¢ä»“ - å›æ’¤-33.0%, å¹´åŒ–9.6%

---

## ğŸ’¡ ç»“è®ºä¸å»ºè®®

### 1. æœªæ¥å‡½æ•°çš„å±å®³
- **å›æµ‹ç»“æœè™šé«˜**ï¼šå¹´åŒ–ä»204%è·Œåˆ°12.9%ï¼Œ**15.8å€å·®è·**
- **å®ç›˜å¿…äº**ï¼šåŸºäºé”™è¯¯å›æµ‹çš„ç­–ç•¥å®ç›˜ä¼šå¤§å¹…è·‘å
- **éš¾ä»¥å‘ç°**ï¼šä»£ç å±‚é¢ä¸æŠ¥é”™ï¼Œåªèƒ½é ç»éªŒå’Œå¸¸è¯†åˆ¤æ–­

### 2. çœŸå®ç­–ç•¥è¡¨ç°
- **æ–¹æ¡ˆBï¼ˆ5å› å­ï¼‰çœŸå®è¡¨ç°**ï¼š
  - æœ€ä¼˜é¢‘ç‡ï¼š6å¤©æ¢ä»“
  - å¹´åŒ–æ”¶ç›Šï¼š12.9%
  - Sharpeæ¯”ç‡ï¼š0.486
  - æœ€å¤§å›æ’¤ï¼š-33.6%
  - è°ƒä»“æ¬¡æ•°ï¼š191æ¬¡ï¼ˆ5.5å¹´ï¼‰

### 3. å®ç›˜å»ºè®®
- **æ¨èé…ç½®**ï¼šæ–¹æ¡ˆB + 6-10å¤©æ¢ä»“
- **é¢„æœŸæ”¶ç›Š**ï¼šå¹´åŒ–10-13%
- **é£é™©æ§åˆ¶**ï¼šé¢„æœŸå›æ’¤-30%åˆ°-37%
- **æ‰§è¡Œéš¾åº¦**ï¼šæ¯æœˆè°ƒä»“2-3æ¬¡ï¼Œæ˜“äºæ‰§è¡Œ

### 4. ä¸‹ä¸€æ­¥å·¥ä½œ
- âœ… å·²ä¿®å¤ï¼šæ¢ä»“é¢‘ç‡æµ‹è¯•
- âœ… å·²éªŒè¯ï¼šWFOä¼˜åŒ–å™¨æ— æœªæ¥å‡½æ•°
- â³ å¾…å®Œæˆï¼šä¿®å¤å…¶ä»–å›æµ‹è„šæœ¬
- â³ å¾…å®Œæˆï¼šæ ·æœ¬å¤–éªŒè¯ï¼ˆ2025å¹´è‡³ä»Šï¼‰

---

## ğŸ“ æ•™è®­æ€»ç»“

### é‡åŒ–å›æµ‹çš„é»„é‡‘æ³•åˆ™

1. **ä¸¥æ ¼æ—¶é—´éš”ç¦»**
   - ç¬¬tæ—¥å†³ç­–åªèƒ½ç”¨â‰¤t-1çš„æ•°æ®
   - ç»ä¸èƒ½"å·çœ‹"æœªæ¥æ•°æ®

2. **æ»šåŠ¨çª—å£**
   - æƒé‡ã€å‚æ•°è¦æ»šåŠ¨é‡æ–°è®¡ç®—
   - ä¸èƒ½å›ºå®šä½¿ç”¨æŸä¸€æœŸçš„å‚æ•°

3. **å®æ—¶è®¡ç®—**
   - ä¿¡å·ã€é¢„æµ‹è¦å®æ—¶è®¡ç®—
   - ä¸èƒ½æå‰æ‰¹é‡é¢„è®¡ç®—

4. **å¸¸è¯†æ£€éªŒ**
   - å¹´åŒ–200%çš„ETFç­–ç•¥ â†’ **ä¸å¯ä¿¡**
   - å¹´åŒ–10-15%çš„ETFç­–ç•¥ â†’ **åˆç†**

5. **ä»£ç å®¡æŸ¥**
   - é€è¡Œæ£€æŸ¥æ•°æ®æ¥æº
   - ç¡®ä¿æ²¡æœ‰æ—¶é—´æ³„éœ²
   - å¯»æ‰¾"æå‰çŸ¥é“æœªæ¥"çš„é€»è¾‘

### æ ¸å¿ƒæ£€æŸ¥ç‚¹

- [ ] æ˜¯å¦æå‰è®¡ç®—äº†å…¨éƒ¨æ—¶é—´åºåˆ—ï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨äº†å›ºå®šå‚æ•°/æƒé‡ï¼Ÿ
- [ ] æ˜¯å¦å­˜åœ¨ç´¢å¼•å–ç”¨æœªæ¥æ•°æ®ï¼Ÿ
- [ ] æ˜¯å¦æœ‰é€æ—¥å±•å¼€çš„æ—¶é—´çª—å£ï¼Ÿ
- [ ] å›æµ‹ç»“æœæ˜¯å¦ç¬¦åˆå¸¸è¯†ï¼Ÿ

---

## ğŸ¯ æœ€ç»ˆç»“è®º

**ç”¨æˆ·çš„è´¨ç–‘å®Œå…¨æ­£ç¡®ï¼**

åŸå›æµ‹ä»£ç å­˜åœ¨ä¸¥é‡çš„æœªæ¥å‡½æ•°é—®é¢˜ï¼Œå¯¼è‡´ç»“æœè™šé«˜ã€‚ä¿®å¤åçš„çœŸå®è¡¨ç°ï¼š
- å¹´åŒ–æ”¶ç›Šï¼š12.9%ï¼ˆ6å¤©æ¢ä»“ï¼‰
- Sharpeæ¯”ç‡ï¼š0.486
- é€‚åˆ100ä¸‡èµ„é‡‘çš„ETFè½®åŠ¨ç­–ç•¥

**è¿™æ˜¯ä¸€ä¸ªç¬¦åˆå¸‚åœºè§„å¾‹çš„ã€å¯å®ç°çš„ç­–ç•¥è¡¨ç°ã€‚**
