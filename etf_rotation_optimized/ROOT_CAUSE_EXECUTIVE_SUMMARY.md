# 【定位完成】性能坍塌根因 - 执行摘要

## 🎯 核心结论

**根本原因**: 因子池从18个扩张到25个(+38.9%)，导致WFO窗口内平均因子数从3.8增至6.7(+76%)，引发过拟合、换手飙升、夏普崩溃。

---

## 📊 关键数据对比

| 指标 | 历史 (10-27) | 今日 (10-28) | 变化 |
|------|-------------|--------------|------|
| **因子池总数** | 18 | 25 | ⬆️ +38.9% |
| **窗口内平均因子数** | 3.8 | 6.7 | ⬆️ +76% |
| **回测平均夏普** | +0.129 | -0.034 | ⬇️ -126% (崩溃) |
| **回测平均OOS IC** | 0.0207 | 0.0208 | ➡️ 持平 |
| **回测平均年化** | 14.56% | 18.14% | ⬆️ +24% (虚高) |
| **回测平均回撤** | -8.75% | -8.79% | ➡️ 持平 |

---

## 🔥 矛盾症状

✅ **IC正常**: 0.0207 → 0.0208 (因子预测力未退化)  
❌ **夏普崩溃**: +0.129 → -0.034 (策略执行质量坍塌)  
❌ **年化虚高**: 18.14%但夏普负值 → 高波动、低风险调整收益

**解读**: 因子本身有效,但过多因子导致信号混乱、换手率飙升、执行成本暴增。

---

## 🧬 新增的7个问题因子

```
+ AMIHUD_ILLIQUIDITY
+ BREAKOUT_20D
+ REALIZED_VOL_20D
+ SPREAD_PROXY
+ TSMOM_120D
+ TSMOM_60D
+ TURNOVER_ACCEL_5_20
```

这些因子在历史版本被Step2筛选**排除**，今日却进入因子池。

---

## 🎯 证据链

### 1. 窗口级性能恶化

表现最差的10个窗口:

```
窗口  夏普    年化     因子数
19   -5.35   -48.7%   8      ← 因子数=8
33   -4.88   -32.2%   4
12   -4.57   -52.4%   7
20   -3.82   -41.5%   8      ← 因子数=8
```

**规律**: 因子数≥7的窗口，夏普经常负值。

### 2. 因子数与性能负相关

- 因子数≤5: 夏普中位数 +0.36
- 因子数≥7: 夏普中位数 +0.11 (↓69%)
- 因子数=8: 极端负夏普高发

### 3. TopN实验验证

WFO层面回测:
- TopN=12 (多因子): 夏普0.09, 年化1.61%
- TopN=5  (少因子): 夏普0.03, 年化0.54%

**说明**: 即使在WFO优化后，因子过多仍导致性能下降。

---

## 🛠️ 立即修复方案

### P0: 回滚因子池到18个

```bash
# 1. 手动编辑 configs/FACTOR_SELECTION_CONSTRAINTS.yaml
#    或 scripts/step2_factor_selection.py
#    限制因子池为历史18个:
#    MOM_20D, SLOPE_20D, PRICE_POSITION_20D, PRICE_POSITION_120D,
#    RET_VOL_20D, MAX_DD_60D, VOL_RATIO_20D, VOL_RATIO_60D,
#    PV_CORR_20D, RSI_14, OBV_SLOPE_10D, CMF_20D,
#    SHARPE_RATIO_20D, CALMAR_RATIO_60D, ADX_14D, VORTEX_14D,
#    RELATIVE_STRENGTH_VS_MARKET_20D, CORRELATION_TO_MARKET_20D

# 2. 在 step3_run_wfo.py 中限制窗口内最大因子数
#    MAX_FACTORS_PER_WINDOW = 5

# 3. 重新运行流程
make clean
make step1 step2 step3 step4
python3 scripts/compute_wfo_backtest_metrics.py results/wfo/<最新>

# 4. 验证
# - 因子池: 18个
# - 窗口内平均因子数: ≤4.5
# - 回测夏普: ≥0.10
```

### P1: 深度排查配置变更

```bash
# 对比历史配置
git diff 20251027 20251028 -- configs/FACTOR_SELECTION_CONSTRAINTS.yaml

# 对比筛选日志
diff results/factor_selection/20251027/.../step2_factor_selection.log \
     results/factor_selection/20251028/.../step2_factor_selection.log
```

---

## ✅ 验收标准

修复后必须满足:

| 指标 | 目标 | 历史基准 |
|------|------|----------|
| 因子池总数 | 18±2 | 18 |
| 窗口内平均因子数 | ≤4.5 | 3.8 |
| 回测平均夏普 | ≥0.10 | 0.129 |
| WFO OOS IC | ≥0.015 | 0.0207 |
| Step4年化 | 10%-20% | 14.56% |
| 最大回撤 | ≤-10% | -8.75% |

---

## 📌 核心教训

1. **因子不是越多越好**: 18→25导致质量稀释
2. **窗口内因子数上限关键**: 3-5最优，7-8过拟合
3. **IC正常≠策略可行**: 执行成本、换手同样重要
4. **配置变更需严格审查**: 一行约束放松可毁掉系统

---

## 📁 详细报告

完整诊断见: `ROOT_CAUSE_FINAL_DIAGNOSIS.md`

包含:
- 完整数据对比表
- 逐窗口性能分析
- 因子质量评估
- 修复路线图
- 长期优化建议

---

**诊断时间**: 2025-10-28 17:40  
**置信度**: ⭐⭐⭐⭐⭐ (5/5)  
**状态**: ✅ 根因定位完成，待执行修复
