# 🎯 先验加权优化路线图

**决策**: 🟡 **CONDITIONAL GO** - 低成本快速测试，不大规模投入  
**日期**: 2025-10-29  
**状态**: 通过1/3标准（实用性✅，统计❌，稳健性❌）

---

## 📊 当前状态诊断

### 通过的标准 ✅
- **IC提升**: +13.2% (需≥10%)
- **负IC窗口改善率**: 77.8% (需≥70%)

### 未通过的标准 ❌
- **Wilcoxon p值**: 0.387 (需<0.10)
- **Block Bootstrap p值**: 0.316 (需<0.10)
- **Permutation p值**: 0.241 (需<0.10)
- **正向时期数**: 1/4 (需≥3/4)
- **胜率**: 52.8% (需≥60%)
- **损失不对称比**: 0.79 (需≤0.50)

### 核心问题
1. **方差过大**: 好窗口+0.0138，差窗口-0.0109，波动剧烈
2. **时期不稳定**: 仅第2时期显著提升(+17.3‰)，其他时期下降
3. **先验构造问题**: 当前先验 = 0.7×强度 + 0.3×稳定性，强度带来噪声

---

## 🧠 深度推理结论

### 为什么"有信号但不显著"？

**根本原因**: 先验加权是**防御性工具**，不是进攻性工具。

- 负IC窗口改善率77.8% → 在IS信号失效时，先验提供历史稳定性
- 整体p=0.387不显著 → 在IS信号有效时，先验反而干扰IC加权
- 时期1提升17.3‰ → 市场regime变化时先验更有用

### 最优策略不是"全用先验"

而是**自适应混合**：
```python
# IS质量检测
is_quality = calculate_is_quality(is_ic_series)  # IR, IC均值, IC方差

# 动态混合
if is_quality < threshold:  # IS信号不可靠
    weight = prior_weighted
else:  # IS信号可靠
    weight = ic_weighted
```

---

## 🚀 优化路线图（按收益/成本比排序）

### 阶段1：低成本快速验证（2-4小时）

#### 1.1 纯稳定性先验（最高优先级）
**假设**: 去掉"强度"，只用"稳定性"，降低噪声

**实现**:
```python
# 当前: prior = 0.7×强度 + 0.3×稳定性
# 改为: prior = 1.0×稳定性

# 稳定性 = 1 / (1 + CV)，其中CV = IC_std / |IC_mean|
# 或者: 稳定性 = IC胜率（正IC比例）
```

**预期**:
- 方差降低（去掉强度的极端值）
- p值可能降到0.10-0.20
- 负IC窗口改善率保持或提升

**Go/No-Go**:
- ✅ 如果p<0.10 → 进入阶段2
- ❌ 如果p>0.20 → 暂停，保留研究分支

---

#### 1.2 权重熵和换手率分析
**目的**: 检查先验是否导致权重过度集中和高换手

**实现**:
```python
# 计算每个窗口的权重熵
entropy = -sum(w * log(w))

# 计算窗口间权重变化
turnover = sum(abs(w_t - w_{t-1}))

# 对比IC加权 vs 先验加权
```

**判断**:
- ✅ 如果熵下降<10%，换手率增加<20% → 可接受
- ❌ 如果熵下降>20%，换手率增加>50% → 风险过高

---

### 阶段2：中等成本优化（1-2天，仅在阶段1通过后）

#### 2.1 家族收缩先验
**假设**: 单因子噪声大，家族均值更稳定

**实现**:
```python
# 1. 因子分类
families = {
    "momentum": ["MOM_*", "ROC_*", "MACD_*"],
    "reversal": ["RSI_*", "STOCH_*", "WILLR_*"],
    "volatility": ["ATR_*", "BBANDS_*", "STD_*"],
    "volume": ["OBV_*", "VWAP_*", "MFI_*"],
}

# 2. 家族先验 = 家族内因子稳定性均值
family_prior = {
    family: mean(stability[factors])
    for family, factors in families.items()
}

# 3. 收缩
factor_prior = 0.6 × family_prior[family] + 0.4 × factor_stability
```

**预期**:
- 降噪效果显著
- p值可能降到0.05-0.10

---

#### 2.2 自适应混合（基于IS质量）
**假设**: IS质量高时用IC加权，IS质量低时用先验加权

**实现**:
```python
# IS质量指标
is_ir = is_ic_mean / is_ic_std
is_quality = sigmoid(is_ir - threshold)  # 归一化到[0,1]

# 动态混合
lambda_t = 1 - is_quality  # IS质量高→λ=0，IS质量低→λ=1
weight_t = (1 - lambda_t) × ic_weight + lambda_t × prior_weight
```

**预期**:
- 在IS质量低的窗口（负IC）大幅提升
- 在IS质量高的窗口不干扰IC加权
- 整体p值可能<0.05

---

### 阶段3：实盘映射（2-3天，仅在阶段2通过后）

#### 3.1 成本后回测
**目的**: 验证IC提升能否转化为PnL提升

**实现**:
```python
# VectorBT回测，带真实成本
- 佣金: 0.36%
- 滑点: 0.05%
- T+1延迟

# 对比指标
- 年化收益
- 最大回撤
- 卡玛比率
- CVaR (5%最差分位)
```

**Go/No-Go**:
- ✅ 如果年化收益、卡玛比至少一项优于基线 → 生产就绪
- ❌ 否则 → 保留研究分支

---

#### 3.2 极端风险分析
**目的**: 检查尾部风险是否恶化

**实现**:
```python
# 极端日损益
worst_5pct = returns.quantile(0.05)

# CVaR改善
cvar_improvement = (prior_cvar - ic_cvar) / abs(ic_cvar)
```

**判断**:
- ✅ CVaR改善≥0 → 下行保护有效
- ❌ CVaR恶化>10% → 风险过高

---

## 📋 具体行动清单（立即执行）

### 今天（2小时）
- [x] 稳健统计检验（Wilcoxon + Bootstrap + Permutation）
- [x] Go/No-Go决策分析
- [ ] 生成纯稳定性先验
- [ ] 重跑WFO（用稳定性先验）
- [ ] 对比结果，决定是否进入阶段2

### 本周（如果阶段1通过）
- [ ] 实现家族收缩先验
- [ ] 实现自适应混合
- [ ] 权重熵和换手率分析
- [ ] 对比三种方案（原先验、稳定性、家族收缩、自适应）

### 下周（如果阶段2通过）
- [ ] VectorBT成本后回测
- [ ] 极端风险分析
- [ ] 生成生产就绪报告

---

## 🛡️ 风险控制

### 硬约束（不可违反）
1. **时间隔离**: 所有参数必须在先验训练期（2020-2022）内冻结
2. **无前视偏差**: 任何评估期（2023-2025）信息不得用于参数调整
3. **可复现性**: 所有随机过程必须固定seed
4. **日志完整**: 每次实验必须记录完整参数和结果

### 软约束（建议遵守）
1. **简洁性**: 优先简单方案，避免过度工程
2. **向量化**: 禁止循环，全部向量化
3. **模块化**: 核心逻辑在core/，脚本只orchestrate

---

## 📊 预期结果

### 乐观场景（30%概率）
- 纯稳定性先验p<0.05
- 家族收缩进一步降到p<0.01
- 自适应混合通过所有Go/No-Go标准
- 成本后年化收益提升5-10%
- **结论**: 生产就绪

### 基准场景（50%概率）
- 纯稳定性先验p=0.10-0.15
- 家族收缩降到p=0.05-0.10
- 自适应混合通过2/3标准
- 成本后年化收益提升0-5%
- **结论**: 研究分支保留，继续观察

### 悲观场景（20%概率）
- 纯稳定性先验p>0.20
- 所有优化方案均未显著
- **结论**: 暂停投入，等待更多窗口数据（至少60窗口）

---

## 🎓 学到的教训

### 1. 先验的本质是"防御性"
- 不要期望先验在所有窗口都优于IC加权
- 先验的价值在于"坏时更好"，不是"好时更好"
- 自适应混合是最优策略

### 2. 统计显著性需要大样本
- 36窗口对于d=0.12的效应量远远不够
- 需要1138窗口才能达到80%功效
- 或者提升效应量（通过降噪）

### 3. 实用价值 ≠ 统计显著性
- IC提升13.2%在量化中已不错
- 但统计上属于小效应，需要更多证据
- 生产部署必须两者兼顾

### 4. 简洁性是武器
- 当前方案已经很简洁（<100行代码）
- 继续保持，不要过度复杂化
- 优先降噪，而非增加参数

---

## 🚦 最终建议

### 立即行动
1. **测试纯稳定性先验**（今天，2小时）
2. **如果p<0.10** → 进入阶段2（家族收缩 + 自适应混合）
3. **如果p>0.20** → 暂停，保留研究分支

### 中期策略
- 并行观察IC加权 vs 先验加权
- 每月更新验证报告
- 等待更多窗口数据

### 长期方向
- 探索其他先验信息源（因子夏普、最大回撤）
- 机器学习先验（元学习）
- 多策略融合

---

**下一步**: 运行 `python scripts/generate_stability_prior.py` 生成纯稳定性先验，然后重跑WFO。

**预计耗时**: 2小时  
**决策点**: 如果p<0.10，继续；否则暂停。
