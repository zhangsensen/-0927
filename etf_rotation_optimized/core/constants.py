"""
核心常量配置 - 消除魔数

所有硬编码数值统一定义在此，遵循 Linus 原则：
- 明确语义
- 类型安全
- 除零保护统一
"""

import numpy as np

# ============================================================================
# 数值精度与边界
# ============================================================================
EPSILON = 1e-10  # 除零保护统一阈值
NAN_PLACEHOLDER = np.nan  # 缺失值占位符
INF_THRESHOLD = 1e15  # 无穷大判断阈值

# ============================================================================
# 数据质量阈值
# ============================================================================
DEFAULT_COVERAGE_THRESHOLD = 0.97  # 覆盖率阈值 97%
DEFAULT_WINDOW_DAYS = 20  # 满窗检查默认窗口
VOLUME_ANOMALY_ZSCORE = 3.0  # 成交量异常 Z-score 阈值

# ============================================================================
# 因子计算参数
# ============================================================================
# 动量周期
MOM_PERIODS = [5, 20, 60]

# 趋势周期
SLOPE_PERIODS = [20, 60]

# 价格位置周期
PRICE_POSITION_PERIODS = [20, 120]

# 波动率周期
VOL_PERIODS = [20, 60]

# RSI 周期
RSI_PERIOD = 14

# ============================================================================
# 标准化参数
# ============================================================================
WINSORIZE_LOWER_PCT = 2.5  # Winsorize 下界百分位
WINSORIZE_UPPER_PCT = 97.5  # Winsorize 上界百分位

# ============================================================================
# IC 计算参数
# ============================================================================
IC_MIN_OBSERVATIONS = 20  # IC 计算最小观察数
IC_SIGNIFICANCE_LEVEL = 0.05  # 显著性水平
TRADING_DAYS_PER_YEAR = 252  # 年化交易日数

# ============================================================================
# WFO 参数
# ============================================================================
DEFAULT_IS_WINDOW = 252  # 样本内窗口（1年）
DEFAULT_OOS_WINDOW = 60  # 样本外窗口（3个月）
DEFAULT_STEP = 20  # 步进（1个月）
DEFAULT_IC_THRESHOLD = 0.05  # IC 阈值

# ============================================================================
# 回测参数
# ============================================================================
INIT_CASH = 100000  # 初始资金
DEFAULT_TOP_N = 5  # 默认持仓数量
DEFAULT_REBALANCE_FREQ = 5  # 默认调仓频率（天）

# 成本参数
COMMISSION_RATE = 0.002  # 佣金率 0.2%
SLIPPAGE_RATE = 0.001  # 滑点率 0.1%
STAMP_TAX_RATE = 0.001  # 印花税率 0.1%（港股）

# 风控参数
MAX_POSITION = 0.3  # 单个 ETF 最大仓位
STOP_LOSS = -0.08  # 止损线
MAX_DRAWDOWN = 0.15  # 最大回撤
MAX_TURNOVER = 1.0  # 最大月换手率

# ============================================================================
# 有界因子定义
# ============================================================================
BOUNDED_FACTORS = {
    "PRICE_POSITION_20D",
    "PRICE_POSITION_120D",
    "PV_CORR_20D",
    "RSI_14",
}


# ============================================================================
# 辅助函数
# ============================================================================
def safe_div(numerator, denominator, default=0.0):
    """
    安全除法，统一除零保护

    Args:
        numerator: 分子
        denominator: 分母
        default: 除零时的默认值

    Returns:
        numerator / denominator 或 default
    """
    return numerator / denominator if abs(denominator) > EPSILON else default


def clip_inf(values, threshold=INF_THRESHOLD):
    """
    截断无穷值

    Args:
        values: 数组或序列
        threshold: 阈值

    Returns:
        截断后的值
    """
    return np.clip(values, -threshold, threshold)
