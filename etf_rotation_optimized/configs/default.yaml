# ============================================================================
# ETF轮动系统 - 默认配置
# ============================================================================
# 创建日期: 2025-10-28
# 用途: 统一配置文件，替代废弃的 config.yaml
# ============================================================================

run_id: "ETF_ROTATION_DEFAULT"

# ============================================================================
# 数据配置
# ============================================================================
data:
  # 数据目录（可选，默认为项目根目录/raw/ETF/daily）
  data_dir: null  # 设置为null使用默认路径，或指定绝对路径
  
  # 缓存目录（可选，默认为项目根目录/.cache）
  cache_dir: null
  
  # ETF代码列表（深圳19只 + 上海24只 = 43只）
  symbols:
    # 深圳ETF
    - "159801"
    - "159819"
    - "159859"
    - "159883"
    - "159915"
    - "159920"
    - "159928"
    - "159949"
    - "159992"
    - "159995"
    - "159998"
    # 上海ETF
    - "510050"
    - "510300"
    - "510500"
    - "511010"
    - "511260"
    - "511380"
    - "512010"
    - "512100"
    - "512400"
    - "512480"
    - "512660"
    - "512690"
    - "512720"
    - "512800"
    - "512880"
    - "512980"
    - "513050"
    - "513100"
    - "513130"
    - "513500"
    - "515030"
    - "515180"
    - "515210"
    - "515650"
    - "515790"
    - "516090"
    - "516160"
    - "516520"
    - "518850"
    - "518880"
    - "588000"
    - "588200"
  
  start_date: "2020-01-01"
  end_date: "2025-10-14"

# ============================================================================
# 横截面加工配置
# ============================================================================
cross_section:
  # Winsorize极值截断分位数
  winsorize_lower: 0.025  # 2.5%
  winsorize_upper: 0.975  # 97.5%
  
  # 有界因子（跳过极值截断）
  bounded_factors:
    - "PRICE_POSITION_20D"
    - "PRICE_POSITION_120D"
    - "PV_CORR_20D"
    - "RSI_14"

# ============================================================================
# 因子筛选配置
# ============================================================================
factor_selection:
  # 约束配置文件
  constraints_file: "configs/FACTOR_SELECTION_CONSTRAINTS.yaml"
  
  # 最小IC阈值
  min_ic: 0.02
  
  # 最大p-value阈值（统计显著性）
  max_pvalue: 0.10  # 10%显著性水平
  
  # 最小IR阈值
  min_ir: 0.05
  
  # 相关性去冗余阈值
  max_correlation: 0.8
  
  # 因子健康监控
  health_monitor:
    enabled: true
    lookback_recent: 252      # 最近1年
    lookback_historical: 504  # 历史2年
    health_threshold_dying: 0.7   # 衰减>30%为濒死
    health_threshold_dead: 0.5    # 衰减>50%为死亡
    min_healthy_factors: 3        # 最少健康因子数
    rebalance_frequency: "quarterly"  # 季度重新平衡

# ============================================================================
# WFO配置 - 直接因子级加权方案
# ============================================================================
wfo:
  # 窗口配置
  is_period: 252      # In-Sample窗口长度（交易日）
  oos_period: 60      # Out-of-Sample窗口长度（交易日）
  step_size: 20       # 滑动步长（交易日）
  
  # 直接因子级加权配置 (新版本 - 移除组合搜索)
  factor_weighting: "ic_weighted"  # 生产锁定: IC加权 (贡献加权存在前视偏差，禁用)
  min_factor_ic: 0.012  # 最小IC门槛 (Day 1优化: 0.015→0.012，期望入选更多因子)
  ic_floor: 0.0        # IC下界 (负IC置为此值)
  
  # Phase 2 多策略枚举（Top-5组合选择）
  phase2:
    min_factor_freq: 0.15    # 因子最低出现频率（放宽以纳入更多候选因子）
    min_factors: 6           # 子集最小因子数（后续测试聚焦6因子以上组合）
    max_factors: 9           # 子集最大因子数（控制组合复杂度）
    subset_mode: "enumerate" # 启用因子子集枚举以扩大策略数量
    # 方案2：窄网格 + 分层配额/随机顺序（用于快速评估7–9因子的边际价值）
    tau_grid: [1.0, 1.5, 1.8]          # 温度参数网格（聚焦较优区域）
    topn_grid: [8, 10]                 # Top-N 网格（集中在top-8/10）
    signal_z_threshold_grid: [0.0, 0.25, 0.5]  # Z分数阈值（z≤0.5 区间）
    max_strategies: 120000    # 目标规模：12万组合
    non_overlap_oos: true    # 非重叠OOS拼接（避免窗口覆盖）
    turnover_penalty: 0.1    # 换手惩罚系数（适中）
    coverage_penalty_coef: 1.0  # 覆盖率惩罚系数（1.0适中，2.0严格）
    coverage_min: 0.4        # 最小覆盖率（略放宽）
    avg_turnover_max: 0.7    # 最大平均换手率（略放宽）
    rank_by: "score"         # 排序依据：score/sharpe/annual_return
    # 分层/随机增强：确保6/7/8/9 因子层各有配额，并随机化子集顺序
    stratified_by_k: true
    k_quota: {6: 0.35, 7: 0.30, 8: 0.20, 9: 0.15}  # 比例（按spec计）
    subset_shuffle: true
    random_seed: 20251103
  
  # 贡献加权参数 (实验性，生产禁用)
  # contribution_weighting_temperature: 0.5  # 贡献加权温度参数
  # max_single_weight: 0.3    # 单因子最大权重
  # min_single_weight: 0.05   # 单因子最小权重

# ============================================================================
# 回测配置（事件驱动模式）
# ============================================================================
backtest:
  # 初始资金
  init_cash: 100000
  
  # 持仓配置
  top_n: 6            # 持仓标的数（2025-11-03: 更新为Top-6：基于粗暴开发实证最优配置）
  rebalance_freq: 20  # 调仓频率（交易日）（2025-11-03: 从5延长到20，显著降低成本）
  
  # 事件驱动参数（A股ETF专用）
  min_holding_days: 3      # 最小持有期（天）- 避免频繁交易
  max_daily_turnover: 0.5  # 每日最大换手率（50%）- 控制交易频率
  signal_strength_threshold: 0.0  # 信号强度阈值（Z-score）- 只在信号强时交易
  
  # 交易成本（真实模型）
  commission_rate: 0.0003  # 万3佣金
  stamp_tax_rate: 0.0      # ETF交易印花税为0（仅A股个股卖出征收），修正以避免高估成本
  slippage_bps: 5.0        # 5个基点滑点
  
  # 流动性约束
  min_daily_volume: 10000000   # 最小日均成交量1000万
  max_trade_ratio: 0.10        # 最大占日成交量10%
  
  # 信号延迟
  signal_delay_days: 1         # T+1执行
  
  # 风控参数
  max_position: 0.3   # 单标的最大仓位
  stop_loss: -0.08    # 止损线 -8%

# ============================================================================
# 输出配置
# ============================================================================
output_root: "results"

# ============================================================================
# 性能配置
# ============================================================================
performance:
  n_jobs: 8           # 并行核数（M4 Max留4核给系统）
  use_cache: true     # 启用缓存
  cache_dir: "cache"
