# ETFè½®åŠ¨é‡åŒ–äº¤æ˜“ç³»ç»Ÿ - é¡¹ç›®æ¶æ„æ–‡æ¡£

> **ä¸“ä¸šçº§ETFé‡åŒ–æŠ•èµ„å¹³å°ï¼Œé…ç½®é©±åŠ¨æ¶æ„v2.0**

---

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

ETFè½®åŠ¨ç³»ç»Ÿæ˜¯ä¸€ä¸ªå®Œæ•´çš„é‡åŒ–æŠ•èµ„è§£å†³æ–¹æ¡ˆï¼Œé‡‡ç”¨ç°ä»£è½¯ä»¶å·¥ç¨‹ç†å¿µå’Œé…ç½®é©±åŠ¨æ¶æ„ã€‚ç³»ç»Ÿå®ç°äº†ä»åŸå§‹ETFä»·æ ¼æ•°æ®åˆ°å¯æ‰§è¡ŒæŠ•èµ„ç­–ç•¥çš„å…¨æµç¨‹è‡ªåŠ¨åŒ–ï¼ŒåŒ…æ‹¬å› å­è®¡ç®—ã€å› å­ç­›é€‰ã€ç­–ç•¥å›æµ‹ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### æ ¸å¿ƒè®¾è®¡ç†å¿µ
- **é…ç½®é©±åŠ¨**: æ‰€æœ‰å‚æ•°é€šè¿‡YAMLé…ç½®ï¼Œæ— ç¡¬ç¼–ç 
- **æ¨¡å—åŒ–è®¾è®¡**: æ¸…æ™°çš„æ¨¡å—è¾¹ç•Œï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
- **ç§‘å­¦ç­›é€‰**: åŸºäºç»Ÿè®¡å­¦çš„å› å­ç­›é€‰æ¡†æ¶
- **é«˜æ€§èƒ½**: å‘é‡åŒ–è®¡ç®—ï¼Œä¼˜åŒ–çš„å†…å­˜ä½¿ç”¨
- **å¯å¤ç°**: ä¸¥æ ¼çš„æ—¶é—´å¯¹é½ï¼Œæ— æœªæ¥å‡½æ•°

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è¯¦è§£

### æ•´ä½“æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ETFè½®åŠ¨ç³»ç»Ÿæ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   æ•°æ®æºå±‚      â”‚    â”‚   è®¡ç®—å¼•æ“å±‚    â”‚    â”‚   ç»“æœè¾“å‡ºå±‚    â”‚  â”‚
â”‚  â”‚                â”‚    â”‚                â”‚    â”‚                â”‚  â”‚
â”‚  â”‚ ETFä»·æ ¼æ•°æ®     â”‚â”€â”€â”€â–¶â”‚ å› å­é¢æ¿ç”Ÿæˆ     â”‚â”€â”€â”€â–¶â”‚ ç­›é€‰ç»“æœæŠ¥å‘Š     â”‚  â”‚
â”‚  â”‚ 43ä¸ªETF        â”‚    â”‚ 36ä¸ªæŠ€æœ¯å› å­     â”‚    â”‚ ICåˆ†æç»Ÿè®¡      â”‚  â”‚
â”‚  â”‚ 5.5å¹´å†å²      â”‚    â”‚ å‘é‡åŒ–è®¡ç®—      â”‚    â”‚ åˆ†å±‚è¯„çº§ç»“æœ    â”‚  â”‚
â”‚  â”‚ Parquetæ ¼å¼    â”‚    â”‚ å¤šçº¿ç¨‹å¤„ç†      â”‚    â”‚ æ—¶é—´æˆ³å½’æ¡£      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    é…ç½®ç®¡ç†å±‚                                  â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚ YAMLé…ç½®æ–‡ä»¶    â”‚ â”‚ â”‚ é…ç½®éªŒè¯å™¨     â”‚ â”‚ â”‚ å‚æ•°æ§åˆ¶å™¨     â”‚ â”‚  â”‚
â”‚  â”‚ â”‚                 â”‚ â”‚ â”‚                 â”‚ â”‚ â”‚                 â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ æ•°æ®æºè·¯å¾„      â”‚ â”‚ â”‚ ç±»å‹æ£€æŸ¥        â”‚ â”‚ â”‚ åŠ¨æ€å‚æ•°è°ƒæ•´    â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ ç­›é€‰é˜ˆå€¼        â”‚ â”‚ â”‚ è·¯å¾„éªŒè¯        â”‚ â”‚ â”‚ ç¯å¢ƒå˜é‡è¦†ç›–    â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ åˆ†æå‚æ•°        â”‚ â”‚ â”‚ å‚æ•°èŒƒå›´æ£€æŸ¥    â”‚ â”‚ â”‚ å‘½ä»¤è¡Œå‚æ•°      â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ è¾“å‡ºæ ¼å¼        â”‚ â”‚ â”‚ å¼‚å¸¸å¤„ç†        â”‚ â”‚ â”‚ é»˜è®¤å€¼è®¾ç½®      â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    æ ¸å¿ƒä¸šåŠ¡å±‚                                    â”‚  â”‚
â”‚  â”‚                                                             â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚ ICåˆ†æå¼•æ“      â”‚ â”‚ â”‚ å› å­ç­›é€‰å™¨      â”‚ â”‚ â”‚ ç»Ÿå­¦æ ¡æ­£å™¨     â”‚ â”‚  â”‚
â”‚  â”‚ â”‚                 â”‚ â”‚ â”‚                 â”‚ â”‚ â”‚                 â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ å¤šå‘¨æœŸICè®¡ç®—    â”‚ â”‚ â”‚ åŸºç¡€ç­›é€‰        â”‚ â”‚ â”‚ FDRæ ¡æ­£        â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ å‘é‡åŒ–ç›¸å…³è®¡ç®—  â”‚ â”‚ â”‚ ç›¸å…³æ€§å»é‡      â”‚ â”‚ â”‚ tæ£€éªŒ          â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ ç¨³å®šæ€§åˆ†æ      â”‚ â”‚ â”‚ åˆ†å±‚è¯„çº§        â”‚ â”‚ â”‚ æ•ˆåº”é‡è®¡ç®—      â”‚ â”‚  â”‚
â”‚  â”‚ â”‚ è¦†ç›–ç‡ç»Ÿè®¡      â”‚ â”‚ â”‚ åŠ¨æ€é˜ˆå€¼è°ƒæ•´    â”‚ â”‚ â”‚ å¤šé‡æ£€éªŒæ§åˆ¶    â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—è¯¦ç»†è¯´æ˜

#### 1. æ¨ªæˆªé¢å»ºè®¾æ¨¡å— (01_æ¨ªæˆªé¢å»ºè®¾/)
**åŠŸèƒ½**: ETFå› å­é¢æ¿ç”Ÿæˆ
- **è¾“å…¥**: åŸå§‹ETFä»·æ ¼æ•°æ® (raw/ETF/daily/*.parquet)
- **è¾“å‡º**: å› å­é¢æ¿æ•°æ® (data/results/panels/)
- **æ ¸å¿ƒæ–‡ä»¶**: `generate_panel.py`
- **å› å­æ•°é‡**: 36ä¸ªæŠ€æœ¯æŒ‡æ ‡
- **å¤„ç†æ–¹å¼**: å‘é‡åŒ–è®¡ç®—ï¼Œå¤šçº¿ç¨‹å¤„ç†

**å› å­ç±»åˆ«**:
- **åŠ¨é‡å› å­**: MOMENTUM_20D, MOMENTUM_63D, MOMENTUM_126D, MOMENTUM_252D
- **æ³¢åŠ¨ç‡å› å­**: VOLATILITY_20D, VOLATILITY_60D, VOLATILITY_120D
- **ä»·æ ¼ä½ç½®å› å­**: PRICE_POSITION_20D, PRICE_POSITION_60D, PRICE_POSITION_120D
- **æŠ€æœ¯æŒ‡æ ‡å› å­**: RSI_6, RSI_14, RSI_24, ATR_14
- **æˆäº¤é‡å› å­**: VOLUME_RATIO_5D, VOLUME_RATIO_20D, VOLUME_RATIO_60D
- **å½¢æ€å› å­**: DOJI_PATTERN, BULLISH_ENGULFING, HAMMER_PATTERN
- **å¤åˆå› å­**: VOL_MA_RATIO_5, VOL_VOLATILITY_20, PRICE_VOLUME_DIV

#### 2. å› å­ç­›é€‰æ¨¡å— (02_å› å­ç­›é€‰/) â­ æ ¸å¿ƒæ¨¡å—
**åŠŸèƒ½**: ç§‘å­¦åŒ–å› å­ç­›é€‰å’Œåˆ†æ
- **è¾“å…¥**: å› å­é¢æ¿æ•°æ®
- **è¾“å‡º**: ç­›é€‰ç»“æœå’Œè¯¦ç»†æŠ¥å‘Š
- **æ¶æ„**: é…ç½®é©±åŠ¨è®¾è®¡
- **ç­›é€‰æ–¹æ³•**: 5ç»´åº¦ä¸“ä¸šç­›é€‰æ¡†æ¶

**æ ¸å¿ƒç»„ä»¶**:
```python
run_etf_cross_section_configurable.py    # ä¸»ç­›é€‰è„šæœ¬ (æ¨è)
etf_cross_section_config.py             # é…ç½®ç±»å®šä¹‰
sample_etf_config.yaml                  # ç¤ºä¾‹é…ç½®æ–‡ä»¶
```

**ç­›é€‰æµç¨‹**:
1. **ICåˆ†æ**: å¤šå‘¨æœŸä¿¡æ¯ç³»æ•°è®¡ç®— (1, 5, 10, 20æ—¥)
2. **åŸºç¡€ç­›é€‰**: ICé˜ˆå€¼ã€IRé˜ˆå€¼ã€på€¼ã€è¦†ç›–ç‡
3. **FDRæ ¡æ­£**: Benjamini-Hochbergå‡å‘ç°ç‡æ ¡æ­£
4. **ç›¸å…³æ€§å»é‡**: Spearmanç›¸å…³æ€§åˆ†æï¼Œè´ªå¿ƒå»é‡ç®—æ³•
5. **åˆ†å±‚è¯„çº§**: æ ¸å¿ƒ/è¡¥å……/ç ”ç©¶å› å­ä¸‰çº§åˆ†ç±»

#### 3. VBTå›æµ‹æ¨¡å— (03_vbtå›æµ‹/)
**åŠŸèƒ½**: å¤§è§„æ¨¡ç­–ç•¥å›æµ‹å’Œä¼˜åŒ–
- **å¼•æ“**: VectorBTä¸“ä¸šå›æµ‹æ¡†æ¶
- **è§„æ¨¡**: æ”¯æŒæ•°åƒç§ç­–ç•¥ç»„åˆæµ‹è¯•
- **æŒ‡æ ‡**: Sharpeæ¯”ç‡ã€æœ€å¤§å›æ’¤ã€å¹´åŒ–æ”¶ç›Šç­‰

---

## ğŸ›ï¸ é…ç½®ç³»ç»Ÿæ¶æ„

### é…ç½®å±‚æ¬¡ç»“æ„
```
ETFCrossSectionConfig (æ ¹é…ç½®)
â”œâ”€â”€ DataSourceConfig (æ•°æ®æºé…ç½®)
â”‚   â”œâ”€â”€ price_dir: Path              # ä»·æ ¼æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ panel_file: Path            # é¢æ¿æ–‡ä»¶è·¯å¾„
â”‚   â”œâ”€â”€ price_columns: List[str]     # è¯»å–åˆ—å
â”‚   â”œâ”€â”€ file_pattern: str           # æ–‡ä»¶åŒ¹é…æ¨¡å¼
â”‚   â””â”€â”€ symbol_extract_method: str   # Symbolæå–æ–¹æ³•
â”œâ”€â”€ AnalysisConfig (åˆ†æé…ç½®)
â”‚   â”œâ”€â”€ ic_periods: List[int]       # ICåˆ†æå‘¨æœŸ
â”‚   â”œâ”€â”€ min_observations: int       # æœ€å°è§‚æµ‹å€¼
â”‚   â”œâ”€â”€ correlation_method: str     # ç›¸å…³æ€§è®¡ç®—æ–¹æ³•
â”‚   â””â”€â”€ epsilon_small: float        # å°å€¼é˜²é™¤é›¶
â”œâ”€â”€ ScreeningConfig (ç­›é€‰é…ç½®)
â”‚   â”œâ”€â”€ min_ic: float               # æœ€å°ICé˜ˆå€¼
â”‚   â”œâ”€â”€ min_ir: float               # æœ€å°IRé˜ˆå€¼
â”‚   â”œâ”€â”€ max_pvalue: float           # æœ€å¤§på€¼
â”‚   â”œâ”€â”€ use_fdr: bool               # FDRæ ¡æ­£å¼€å…³
â”‚   â”œâ”€â”€ max_correlation: float      # æœ€å¤§ç›¸å…³æ€§
â”‚   â””â”€â”€ tier_thresholds: Dict        # åˆ†å±‚é˜ˆå€¼é…ç½®
â””â”€â”€ OutputConfig (è¾“å‡ºé…ç½®)
    â”œâ”€â”€ output_dir: Path            # è¾“å‡ºç›®å½•
    â”œâ”€â”€ use_timestamp_subdir: bool  # æ—¶é—´æˆ³å­ç›®å½•
    â”œâ”€â”€ files: Dict                 # æ–‡ä»¶å‘½åé…ç½®
    â””â”€â”€ include_factor_details: bool # è¯¦æƒ…åŒ…å«å¼€å…³
```

### é¢„è®¾é…ç½®æ¨¡æ¿
```python
# æ ‡å‡†é…ç½® (æ—¥å¸¸ä½¿ç”¨)
ETF_STANDARD_CONFIG = ETFCrossSectionConfig(
    screening=ScreeningConfig(
        min_ic=0.005,      # 0.5% ICé˜ˆå€¼
        min_ir=0.05,       # 0.05 IRé˜ˆå€¼
        use_fdr=True       # å¯ç”¨FDRæ ¡æ­£
    )
)

# ä¸¥æ ¼é…ç½® (ç”Ÿäº§ç¯å¢ƒ)
ETF_STRICT_CONFIG = ETFCrossSectionConfig(
    screening=ScreeningConfig(
        min_ic=0.008,      # 0.8% ICé˜ˆå€¼
        min_ir=0.08,       # 0.08 IRé˜ˆå€¼
        fdr_alpha=0.1      # æ›´ä¸¥æ ¼FDR
    )
)

# å®½æ¾é…ç½® (ç ”ç©¶æ¢ç´¢)
ETF_RELAXED_CONFIG = ETFCrossSectionConfig(
    screening=ScreeningConfig(
        min_ic=0.003,      # 0.3% ICé˜ˆå€¼
        min_ir=0.03,       # 0.03 IRé˜ˆå€¼
        use_fdr=False      # ç¦ç”¨FDR
    )
)
```

---

## ğŸ“Š æ•°æ®æµç¨‹è¯¦è§£

### æ•°æ®è¾“å…¥è§„èŒƒ
```python
# ä»·æ ¼æ•°æ®æ ¼å¼
price_data/
â”œâ”€â”€ 510300.SH_daily_20200102_20251014.parquet
â”œâ”€â”€ 159919.SZ_daily_20200102_20251014.parquet
â””â”€â”€ ... (43ä¸ªETFæ–‡ä»¶)

# æ•°æ®ç»“æ„
DataFrame(columns=['trade_date', 'close'])
- trade_date: äº¤æ˜“æ—¥æœŸ (datetime64[ns])
- close: æ”¶ç›˜ä»· (float64)
- ç´¢å¼•: æ—¥æœŸæ—¶é—´åºåˆ—
```

### å› å­é¢æ¿ç»“æ„
```python
# å› å­é¢æ¿æ ¼å¼
panel_data/
â””â”€â”€ panel_20251020_162504.parquet

# æ•°æ®ç»“æ„
DataFrame(index=['symbol', 'date'])
- symbol: ETFä»£ç  (str)
- date: äº¤æ˜“æ—¥æœŸ (datetime64[ns])
- columns: 36ä¸ªå› å­å€¼ (float64)
- shape: (56575, 36) - 56,575ä¸ªè§‚æµ‹å€¼
```

### ç­›é€‰ç»“æœè¾“å‡º
```python
screening_results/
â””â”€â”€ screening_20251020_184913/
    â”œâ”€â”€ ic_analysis.csv          # å®Œæ•´ICåˆ†æ (36è¡Œ Ã— å¤šåˆ—)
    â”œâ”€â”€ passed_factors.csv       # é€šè¿‡ç­›é€‰å› å­ (8è¡Œ Ã— 12åˆ—)
    â””â”€â”€ screening_report.txt     # è¯¦ç»†æ–‡å­—æŠ¥å‘Š
```

---

## ğŸ” å› å­ç­›é€‰ç§‘å­¦æ¡†æ¶

### IC (Information Coefficient) åˆ†æ
```python
# ICè®¡ç®—å…¬å¼
IC_t = rank_corr(factor_t, return_{t+1})

# å¤šå‘¨æœŸICåˆ†æ
periods = [1, 5, 10, 20]  # é¢„æµ‹å‘¨æœŸ
for period in periods:
    future_return = price.pct_change(period).shift(-period)
    ic = spearman_corr(factor, future_return)
```

### FDR (False Discovery Rate) æ ¡æ­£
```python
# Benjamini-Hochbergç®—æ³•
def fdr_correction(p_values, alpha=0.2):
    n = len(p_values)
    sorted_idx = np.argsort(p_values)
    sorted_p = p_values[sorted_idx]
    critical = np.arange(1, n + 1) * alpha / n

    rejected = sorted_p <= critical
    return sorted_idx[rejected.any()][:rejected[rejected].max() + 1]
```

### ç›¸å…³æ€§å»é‡ç®—æ³•
```python
# è´ªå¿ƒå»é‡ç­–ç•¥
def remove_correlated_factors(ic_df, panel, max_corr=0.7):
    factors = ic_df['factor'].tolist()
    corr_matrix = panel[factors].corr(method='spearman').abs()

    to_remove = set()
    for i, f1 in enumerate(factors):
        for f2 in factors[i+1:]:
            if corr_matrix.loc[f1, f2] > max_corr:
                # ä¿ç•™IC_IRæ›´é«˜çš„å› å­
                ir1 = ic_df[ic_df['factor'] == f1]['ic_ir'].values[0]
                ir2 = ic_df[ic_df['factor'] == f2]['ic_ir'].values[0]
                to_remove.add(f2 if abs(ir1) > abs(ir2) else f1)

    return ic_df[~ic_df['factor'].isin(to_remove)]
```

### åˆ†å±‚è¯„çº§ä½“ç³»
```python
# ä¸‰çº§åˆ†ç±»ä½“ç³»
def classify_factor(ic_mean, ic_ir):
    if abs(ic_mean) >= 0.02 and abs(ic_ir) >= 0.1:
        return "ğŸŸ¢ æ ¸å¿ƒ"    # é«˜é¢„æµ‹åŠ› + é«˜ç¨³å®šæ€§
    elif abs(ic_mean) >= 0.01 and abs(ic_ir) >= 0.07:
        return "ğŸŸ¡ è¡¥å……"    # ä¸­ç­‰é¢„æµ‹åŠ› + ä¸­ç­‰ç¨³å®šæ€§
    else:
        return "ğŸ”µ ç ”ç©¶"    # åŸºç¡€é¢„æµ‹åŠ›ï¼Œéœ€è¦è¿›ä¸€æ­¥éªŒè¯
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### è®¡ç®—æ€§èƒ½ä¼˜åŒ–
```python
# å‘é‡åŒ–è®¡ç®— (é¿å…å¾ªç¯)
def calculate_ic_vectorized(factor_matrix, return_matrix):
    """æ‰¹é‡è®¡ç®—ICï¼Œå®Œå…¨å‘é‡åŒ–"""
    factor_ranked = np.apply_along_axis(rank_row, 1, factor_matrix)
    return_ranked = np.apply_along_axis(rank_row, 1, return_matrix)

    # æ‰¹é‡ç›¸å…³ç³»æ•°è®¡ç®—
    ics = []
    for i in range(factor_matrix.shape[0]):
        ic = np.corrcoef(factor_ranked[i], return_ranked[i])[0, 1]
        ics.append(ic)
    return np.array(ics)
```

### å†…å­˜ç®¡ç†ä¼˜åŒ–
```python
# åˆ†å—å¤„ç†å¤§æ•°æ®é›†
def process_large_dataset(panel, chunk_size=1000):
    """åˆ†å—å¤„ç†ï¼Œæ§åˆ¶å†…å­˜ä½¿ç”¨"""
    results = []
    symbols = panel.index.get_level_values('symbol').unique()

    for i in range(0, len(symbols), chunk_size):
        chunk_symbols = symbols[i:i+chunk_size]
        chunk_data = panel.loc[chunk_symbols]
        chunk_result = analyze_chunk(chunk_data)
        results.append(chunk_result)

        # æ¸…ç†å†…å­˜
        del chunk_data
        gc.collect()

    return pd.concat(results, ignore_index=True)
```

### ç¼“å­˜ç­–ç•¥
```python
# ICè®¡ç®—ç»“æœç¼“å­˜
@lru_cache(maxsize=128)
def calculate_ic_cached(panel_hash, factor_name, period):
    """ç¼“å­˜ICè®¡ç®—ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—"""
    return calculate_ic_internal(panel_hash, factor_name, period)
```

---

## ğŸ“ˆ ç³»ç»Ÿç›‘æ§å’Œè´¨é‡ä¿è¯

### æ•°æ®è´¨é‡ç›‘æ§
```python
# æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
def validate_data_quality(panel):
    """æ£€æŸ¥æ•°æ®å®Œæ•´æ€§å’Œè´¨é‡"""
    checks = {
        'total_observations': len(panel),
        'unique_symbols': panel.index.get_level_values('symbol').nunique(),
        'date_range': (panel.index.get_level_values('date').min(),
                       panel.index.get_level_values('date').max()),
        'missing_rate': panel.isna().sum().sum() / panel.size,
        'factor_coverage': (1 - panel.isna().all(axis=1).mean())
    }
    return checks
```

### æ€§èƒ½ç›‘æ§
```python
# æ‰§è¡Œæ—¶é—´ç›‘æ§
import time
import psutil

def monitor_performance(func):
    """æ€§èƒ½ç›‘æ§è£…é¥°å™¨"""
    def wrapper(*args, **kwargs):
        process = psutil.Process()
        start_memory = process.memory_info().rss
        start_time = time.time()

        result = func(*args, **kwargs)

        end_time = time.time()
        end_memory = process.memory_info().rss

        metrics = {
            'execution_time': end_time - start_time,
            'memory_used': (end_memory - start_memory) / 1024 / 1024,  # MB
            'throughput': len(result) / (end_time - start_time)
        }
        return result, metrics
    return wrapper
```

### å¼‚å¸¸å¤„ç†æœºåˆ¶
```python
# å…¨é¢çš„å¼‚å¸¸å¤„ç†
class ETFSystemError(Exception):
    """ç³»ç»ŸåŸºç¡€å¼‚å¸¸ç±»"""
    pass

class ConfigurationError(ETFSystemError):
    """é…ç½®ç›¸å…³å¼‚å¸¸"""
    pass

class DataValidationError(ETFSystemError):
    """æ•°æ®éªŒè¯å¼‚å¸¸"""
    pass

class CalculationError(ETFSystemError):
    """è®¡ç®—è¿‡ç¨‹å¼‚å¸¸"""
    pass
```

---

## ğŸ”§ å¼€å‘å’Œéƒ¨ç½²æŒ‡å—

### å¼€å‘ç¯å¢ƒè®¾ç½®
```bash
# å…‹éš†é¡¹ç›®
git clone <repository_url>
cd etf_rotation_system

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate  # Linux/macOS
# venv\Scripts\activate   # Windows

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### ä»£ç è´¨é‡æ ‡å‡†
```python
# ä»£ç é£æ ¼ (Black, isort)
black etf_rotation_system/
isort etf_rotation_system/

# ç±»å‹æ£€æŸ¥ (mypy)
mypy etf_rotation_system/02_å› å­ç­›é€‰/

# ä»£ç è´¨é‡ (pylint)
pylint etf_rotation_system/02_å› å­ç­›é€‰/run_etf_cross_section_configurable.py
```

### æµ‹è¯•ç­–ç•¥
```python
# å•å…ƒæµ‹è¯•
pytest tests/unit/

# é›†æˆæµ‹è¯•
pytest tests/integration/

# æ€§èƒ½æµ‹è¯•
pytest tests/performance/

# è¦†ç›–ç‡æŠ¥å‘Š
pytest --cov=etf_rotation_system --cov-report=html
```

### éƒ¨ç½²é…ç½®
```yaml
# ç”Ÿäº§ç¯å¢ƒé…ç½®
data_source:
  price_dir: "/data/etf/production/daily"
  panel_file: "/data/etf/production/latest_panel.parquet"

screening:
  min_ic: 0.008          # æ›´ä¸¥æ ¼çš„æ ‡å‡†
  min_ir: 0.08
  use_fdr: true
  fdr_alpha: 0.1

output:
  output_dir: "/data/etf/results/production"
  use_timestamp_subdir: true
```

---

## ğŸ“š APIå‚è€ƒ

### æ ¸å¿ƒç±»å’Œå‡½æ•°
```python
# ä¸»è¦ç­›é€‰å™¨ç±»
class ETFCrossSectionScreener:
    def __init__(self, config: ETFCrossSectionConfig)
    def calculate_multi_period_ic(self, panel: pd.DataFrame, price_df: pd.DataFrame) -> pd.DataFrame
    def screen_factors(self, ic_df: pd.DataFrame, panel: pd.DataFrame) -> pd.DataFrame
    def run(self) -> Dict[str, Any]

# é…ç½®ç±»
class ETFCrossSectionConfig:
    @classmethod
    def from_yaml(cls, yaml_file: Path) -> 'ETFCrossSectionConfig'
    def to_yaml(self, yaml_file: Path) -> None
    def validate(self) -> List[str]
```

### ä½¿ç”¨ç¤ºä¾‹
```python
# åŸºç¡€ä½¿ç”¨
from etf_cross_section_config import ETFCrossSectionConfig
from run_etf_cross_section_configurable import ETFCrossSectionScreener

# åŠ è½½é…ç½®
config = ETFCrossSectionConfig.from_yaml('production_config.yaml')

# åˆ›å»ºç­›é€‰å™¨å¹¶è¿è¡Œ
screener = ETFCrossSectionScreener(config)
results = screener.run()

print(f"é€šè¿‡å› å­: {results['passed_factors']}/{results['total_factors']}")
print(f"ç»“æœç›®å½•: {results['output_dir']}")
```

---

## ğŸ¯ æœ€ä½³å®è·µå’Œå»ºè®®

### é…ç½®ç®¡ç†
1. **ç‰ˆæœ¬æ§åˆ¶**: æ‰€æœ‰é…ç½®æ–‡ä»¶çº³å…¥ç‰ˆæœ¬æ§åˆ¶
2. **ç¯å¢ƒåˆ†ç¦»**: å¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®
3. **å‚æ•°éªŒè¯**: ä½¿ç”¨å†…ç½®éªŒè¯åŠŸèƒ½æ£€æŸ¥é…ç½®åˆç†æ€§
4. **æ–‡æ¡£æ›´æ–°**: é…ç½®å˜æ›´æ—¶åŒæ­¥æ›´æ–°æ–‡æ¡£

### æ•°æ®ç®¡ç†
1. **æ•°æ®è´¨é‡**: å®šæœŸæ£€æŸ¥ä»·æ ¼æ•°æ®å®Œæ•´æ€§å’Œå‡†ç¡®æ€§
2. **å¤‡ä»½ç­–ç•¥**: é‡è¦æ•°æ®å®šæœŸå¤‡ä»½
3. **æ›´æ–°é¢‘ç‡**: æ ¹æ®å¸‚åœºæƒ…å†µç¡®å®šæ•°æ®æ›´æ–°é¢‘ç‡
4. **å­˜å‚¨ä¼˜åŒ–**: ä½¿ç”¨parquetæ ¼å¼ï¼Œè€ƒè™‘æ•°æ®å‹ç¼©

### æ€§èƒ½ä¼˜åŒ–
1. **åˆç†é…ç½®**: æ ¹æ®ç¡¬ä»¶èµ„æºè°ƒæ•´ICåˆ†æå‘¨æœŸ
2. **ç¼“å­˜åˆ©ç”¨**: å……åˆ†åˆ©ç”¨è®¡ç®—ç»“æœç¼“å­˜
3. **å¹¶è¡Œå¤„ç†**: åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ä½¿ç”¨å¤šè¿›ç¨‹è®¡ç®—
4. **å†…å­˜ç›‘æ§**: ç›‘æ§å†…å­˜ä½¿ç”¨ï¼Œé¿å…å†…å­˜æº¢å‡º

### ç»“æœéªŒè¯
1. **äº¤å‰éªŒè¯**: ä½¿ç”¨ä¸åŒæ—¶é—´æ®µéªŒè¯å› å­ç¨³å®šæ€§
2. **æ ·æœ¬å¤–æµ‹è¯•**: å®šæœŸè¿›è¡Œæ ·æœ¬å¤–æµ‹è¯•
3. **ç»“æœè®°å½•**: è¯¦ç»†è®°å½•æ¯æ¬¡è¿è¡Œé…ç½®å’Œç»“æœ
4. **å¼‚å¸¸åˆ†æ**: åˆ†æå¼‚å¸¸ç»“æœçš„åŸå› å’Œæ”¹è¿›æ–¹æ¡ˆ

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### é—®é¢˜è¯Šæ–­
```bash
# æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
python -c "
from etf_cross_section_config import ETFCrossSectionConfig
import pandas as pd
from pathlib import Path

# æ£€æŸ¥é…ç½®
config = ETFCrossSectionConfig.from_yaml('sample_etf_config.yaml')
print('é…ç½®åŠ è½½: âœ…')

# æ£€æŸ¥æ•°æ®
panel_file = Path('/Users/zhangshenshen/æ·±åº¦é‡åŒ–0927/etf_rotation_system/data/results/panels/panel_20251020_162504/panel.parquet')
if panel_file.exists():
    panel = pd.read_parquet(panel_file)
    print(f'æ•°æ®æ£€æŸ¥: âœ… (å½¢çŠ¶: {panel.shape})')
else:
    print('æ•°æ®æ£€æŸ¥: âŒ (æ–‡ä»¶ä¸å­˜åœ¨)')
"
```

### å¸¸è§é—®é¢˜è§£å†³
1. **å†…å­˜ä¸è¶³**: å‡å°‘ICåˆ†æå‘¨æœŸæˆ–ä½¿ç”¨åˆ†å—å¤„ç†
2. **é…ç½®é”™è¯¯**: ä½¿ç”¨é…ç½®éªŒè¯åŠŸèƒ½æ£€æŸ¥å‚æ•°
3. **è·¯å¾„é—®é¢˜**: ç¡®ä¿æ‰€æœ‰è·¯å¾„ä½¿ç”¨ç»å¯¹è·¯å¾„
4. **ä¾èµ–ç¼ºå¤±**: æ£€æŸ¥Pythonç¯å¢ƒå’ŒåŒ…å®‰è£…çŠ¶æ€

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**æœ€åæ›´æ–°**: 2025-10-20
**ç»´æŠ¤å›¢é˜Ÿ**: ETFè½®åŠ¨ç³»ç»Ÿå¼€å‘å›¢é˜Ÿ
**æŠ€æœ¯æ”¯æŒ**: é€šè¿‡GitHub Issuesæˆ–é‚®ä»¶è”ç³»