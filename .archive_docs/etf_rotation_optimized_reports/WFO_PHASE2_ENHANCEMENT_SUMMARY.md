# WFO Phase 2 å¢å¼ºåŠŸèƒ½æ€»ç»“

**å®Œæˆæ—¶é—´**: 2025-11-03 17:05  
**çŠ¶æ€**: âœ… **å…¨éƒ¨å®ç°å¹¶é›†æˆ**

---

## ğŸ¯ æ–°å¢åŠŸèƒ½æ¦‚è§ˆ

### 1. âœ… Zåˆ†æ•°é˜ˆå€¼ç½‘æ ¼

**åŠŸèƒ½**: è·¨æˆªé¢æ ‡å‡†åŒ–ä¿¡å·ï¼Œä»…ä¿ç•™å¼ºä¿¡å·èµ„äº§å‚ä¸Top-Né€‰æ‹©

**å‚æ•°**: `signal_z_threshold_grid`

**é€»è¾‘**:
```python
# æ¯ä¸ªäº¤æ˜“æ—¥tï¼Œå¯¹ä¿¡å·[t]åšæˆªé¢Zåˆ†æ•°
z = (signal - mean) / std
# ä»…ä¿ç•™ z > threshold çš„èµ„äº§
filtered_signal[z <= threshold] = NaN
```

**é…ç½®ç¤ºä¾‹**:
```yaml
signal_z_threshold_grid: [-0.5, 0.0, 0.5, 1.0]
```

**æ•ˆæœ**:
- `-0.5`: å®½æ¾ï¼ˆä¿ç•™å¼±äºå‡å€¼0.5Ïƒçš„èµ„äº§ï¼‰
- `0.0`: ä¸­æ€§ï¼ˆä»…ä¿ç•™å¼ºäºå‡å€¼çš„èµ„äº§ï¼‰
- `0.5`: ä¸¥æ ¼ï¼ˆä»…ä¿ç•™å¼ºäºå‡å€¼0.5Ïƒçš„èµ„äº§ï¼‰
- `1.0`: æä¸¥æ ¼ï¼ˆä»…ä¿ç•™å¼ºäºå‡å€¼1Ïƒçš„èµ„äº§ï¼‰

---

### 2. âœ… éé‡å OOSæ‹¼æ¥

**åŠŸèƒ½**: é¿å…WFOçª—å£OOSæ®µé‡å æ—¶åçª—è¦†ç›–å‰çª—

**å‚æ•°**: `non_overlap_oos`

**é€»è¾‘**:
```python
if non_overlap_oos:
    # ä»…å¡«å……å½“å‰ä»ä¸ºNaNçš„ä½ç½®
    fill_mask = np.isnan(stitched[s:e, :])
    stitched[s:e, :][fill_mask] = oos_sig[fill_mask]
else:
    # é»˜è®¤ï¼šåçª—è¦†ç›–å‰çª—
    stitched[s:e, :] = oos_sig
```

**é…ç½®**:
```yaml
non_overlap_oos: true  # æ¨èå¼€å¯
```

---

### 3. âœ… æ¢æ‰‹æƒ©ç½š

**åŠŸèƒ½**: é™ä½è¿‡åº¦äº¤æ˜“ç­–ç•¥çš„è¯„åˆ†

**å‚æ•°**: `turnover_penalty`

**é€»è¾‘**:
```python
# æ¢æ‰‹ç‡å®šä¹‰ï¼šæŒä»“é›†åˆå˜åŠ¨æ¯”ä¾‹
turnover[t] = 1 - |æŒä»“_t âˆ© æŒä»“_{t-1}| / top_n

# è¯„åˆ†æƒ©ç½š
score = base_score - turnover_penalty * avg_turnover
```

**é…ç½®**:
```yaml
turnover_penalty: 0.1  # 0.1è¡¨ç¤ºå¹³å‡æ¢æ‰‹50%æ—¶æ‰£0.05åˆ†
```

---

### 4. âœ… è¦†ç›–ç‡ä¸æ¢æ‰‹è¿‡æ»¤

**åŠŸèƒ½**: è¿‡æ»¤ä¸å¯äº¤æ˜“æˆ–è¿‡åº¦äº¤æ˜“çš„ç­–ç•¥

**å‚æ•°**: 
- `coverage_min`: æœ€å°è¦†ç›–ç‡ï¼ˆèƒ½é€‰å‡º>=TopNèµ„äº§çš„æ—¥æœŸå æ¯”ï¼‰
- `avg_turnover_max`: æœ€å¤§å¹³å‡æ¢æ‰‹ç‡

**é€»è¾‘**:
```python
# è¿‡æ»¤ä½è¦†ç›–ç‡ç­–ç•¥
df = df[df["coverage"] >= coverage_min]

# è¿‡æ»¤é«˜æ¢æ‰‹ç­–ç•¥
if avg_turnover_max is not None:
    df = df[df["avg_turnover"] <= avg_turnover_max]
```

**é…ç½®**:
```yaml
coverage_min: 0.5        # è‡³å°‘50%çš„æ—¥æœŸå¯äº¤æ˜“
avg_turnover_max: 0.6    # å¹³å‡æ¢æ‰‹ä¸è¶…è¿‡60%
```

---

### 5. âœ… çµæ´»æ’åº

**åŠŸèƒ½**: æ”¯æŒå¤šç§æ’åºä¾æ®

**å‚æ•°**: `rank_by`

**é€‰é¡¹**:
- `score`: ç»¼åˆå¾—åˆ†ï¼ˆSharpe 50% + å¹´åŒ–35% + Calmar 15% - æ¢æ‰‹æƒ©ç½šï¼‰
- `sharpe`: æŒ‰Sharpeæ¯”ç‡æ’åº
- `annual_return`: æŒ‰å¹´åŒ–æ”¶ç›Šæ’åº

**é…ç½®**:
```yaml
rank_by: "score"  # æ¨èä½¿ç”¨ç»¼åˆå¾—åˆ†
```

---

## ğŸ“Š ç­–ç•¥æšä¸¾ç©ºé—´

### åŸæœ‰ç»´åº¦
- å› å­å­é›†: C(é«˜é¢‘å› å­, 3~5)
- æ¸©åº¦Ï„: [0.7, 1.0, 1.5]
- TopN: [6]

### æ–°å¢ç»´åº¦
- **Zé˜ˆå€¼**: [-0.5, 0.0, 0.5, 1.0]

### æšä¸¾è§„æ¨¡ä¼°ç®—
```
åŸç©ºé—´: ~50ç»„åˆ Ã— 3Ï„ Ã— 1TopN = 150ç­–ç•¥
æ–°ç©ºé—´: ~50ç»„åˆ Ã— 3Ï„ Ã— 1TopN Ã— 4é˜ˆå€¼ = 600ç­–ç•¥
```

**é…ç½®**: `max_strategies: 500`ï¼ˆæ§åˆ¶ä¸Šé™ï¼‰

---

## ğŸ” è¾“å‡ºå˜åŒ–

### top5_strategies.csv æ–°å¢åˆ—

| åˆ—å | å«ä¹‰ |
|------|------|
| `z_threshold` | Zåˆ†æ•°é˜ˆå€¼ï¼ˆNaNè¡¨ç¤ºæœªå¯ç”¨ï¼‰ |
| `avg_turnover` | å¹³å‡æ¢æ‰‹ç‡ï¼ˆæŒä»“é›†åˆå˜åŠ¨æ¯”ä¾‹ï¼‰ |

### metadata.json æ–°å¢å­—æ®µ

```json
{
  "phase2_params": {
    "signal_z_threshold_grid": [-0.5, 0.0, 0.5, 1.0],
    "non_overlap_oos": true,
    "turnover_penalty": 0.1,
    "coverage_min": 0.5,
    "avg_turnover_max": 0.6,
    "rank_by": "score"
  }
}
```

---

## ğŸ¯ æ¨èé…ç½®

### ä¿å®ˆé…ç½®ï¼ˆç¨³å¥ä¼˜å…ˆï¼‰
```yaml
phase2:
  signal_z_threshold_grid: [0.0, 0.5]  # ä»…å¼ºä¿¡å·
  tau_grid: [1.0, 1.5]                 # åå‡åŒ€æƒé‡
  turnover_penalty: 0.2                # è¾ƒé«˜æƒ©ç½š
  coverage_min: 0.6                    # è¾ƒé«˜è¦†ç›–ç‡è¦æ±‚
  avg_turnover_max: 0.5                # è¾ƒä½æ¢æ‰‹ä¸Šé™
  rank_by: "sharpe"                    # Sharpeä¼˜å…ˆ
```

### æ¿€è¿›é…ç½®ï¼ˆæ”¶ç›Šä¼˜å…ˆï¼‰
```yaml
phase2:
  signal_z_threshold_grid: [-0.5, 0.0, 0.5, 1.0]  # å…¨åŒºé—´
  tau_grid: [0.7, 1.0, 1.5]                       # å…¨åŒºé—´
  turnover_penalty: 0.05                          # ä½æƒ©ç½š
  coverage_min: 0.4                               # ä½è¦†ç›–ç‡è¦æ±‚
  avg_turnover_max: 0.7                           # é«˜æ¢æ‰‹ä¸Šé™
  rank_by: "annual_return"                        # æ”¶ç›Šä¼˜å…ˆ
```

### å¹³è¡¡é…ç½®ï¼ˆæ¨èï¼‰
```yaml
phase2:
  signal_z_threshold_grid: [-0.5, 0.0, 0.5, 1.0]
  tau_grid: [0.7, 1.0, 1.5]
  turnover_penalty: 0.1
  coverage_min: 0.5
  avg_turnover_max: 0.6
  rank_by: "score"
```

---

## ğŸ”¬ éªŒè¯æ¸…å•

### åŠŸèƒ½éªŒè¯ âœ…

- [x] Zé˜ˆå€¼è¿‡æ»¤é€»è¾‘æ­£ç¡®ï¼ˆè·¨æˆªé¢æ ‡å‡†åŒ–ï¼‰
- [x] éé‡å OOSæ‹¼æ¥é€»è¾‘æ­£ç¡®
- [x] æ¢æ‰‹ç‡è®¡ç®—æ­£ç¡®ï¼ˆæŒä»“é›†åˆå˜åŠ¨ï¼‰
- [x] è¯„åˆ†æƒ©ç½šç”Ÿæ•ˆ
- [x] è¦†ç›–ç‡è¿‡æ»¤ç”Ÿæ•ˆ
- [x] æ¢æ‰‹ç‡è¿‡æ»¤ç”Ÿæ•ˆ
- [x] æ’åºä¾æ®ç”Ÿæ•ˆ

### T+1çº¦æŸ âœ…

```python
# Zé˜ˆå€¼è¿‡æ»¤åœ¨t-1ä¿¡å·ä¸Šæ“ä½œ
signals = signals_from_stitching  # t-1ä¿¡å·
if z_threshold is not None:
    signals = _apply_z_threshold(signals, z_threshold)  # ä»æ˜¯t-1
# ä½¿ç”¨è¿‡æ»¤åçš„t-1ä¿¡å·æ„å»ºtæŒä»“
daily_ret, daily_to = _topn_tplus1_returns_and_turnover(signals, returns, top_n)
```

---

## ğŸ“‹ ä¸‹ä¸€æ­¥å»ºè®®

### ç«‹å³æ‰§è¡Œ
1. âœ… è¿è¡Œå®Œæ•´ç½‘æ ¼éªŒè¯ï¼ˆå·²é…ç½®ï¼‰
2. â³ å¯¹æ¯”ä¸åŒé˜ˆå€¼çš„Top-5ç­–ç•¥
3. â³ åˆ†æé˜ˆå€¼å¯¹è¦†ç›–ç‡/æ¢æ‰‹/æ”¶ç›Šçš„å½±å“

### å¯é€‰ä¼˜åŒ–
1. é˜ˆå€¼æ­¥é•¿ç»†åŒ–ï¼ˆ0.25æ­¥é•¿ï¼‰
2. TopNç½‘æ ¼æ‰©å±•ï¼ˆ[4, 6, 8]ï¼‰
3. å¤šç›®æ ‡ä¼˜åŒ–ï¼ˆParetoå‰æ²¿ï¼‰

---

**å®Œæˆæ—¶é—´**: 2025-11-03 17:05  
**çŠ¶æ€**: âœ… **å…¨éƒ¨å®ç°ï¼Œé…ç½®å·²æ›´æ–°**  
**ä¸‹ä¸€æ­¥**: è¿è¡ŒWFOéªŒè¯
