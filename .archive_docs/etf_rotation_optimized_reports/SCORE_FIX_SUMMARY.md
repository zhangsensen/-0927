# Scoreå‡½æ•°ä¿®å¤æ€»ç»“

**ä¿®å¤æ—¶é—´**: 2025-11-03 18:10  
**é—®é¢˜**: P0è‡´å‘½bug - scoreå‡½æ•°æœªæƒ©ç½šä½è¦†ç›–ç‡

---

## ğŸ”¥ é—®é¢˜è¯Šæ–­

### åŸå§‹é—®é¢˜

```python
# âŒ åŸå®ç°
def _score(self, kpi, avg_turnover):
    base = 0.5 * sharpe + 0.35 * annual_return + 0.15 * calmar
    return base - turnover_penalty * avg_turnover
```

**ç¼ºé™·**:
- âŒ æœªæƒ©ç½šä½è¦†ç›–ç‡
- âŒ è¦†ç›–ç‡2.7%çš„ç­–ç•¥å¾—åˆ†æœ€é«˜
- âŒ ç»Ÿè®¡ä¸æ˜¾è‘—çš„ç­–ç•¥è¢«é€‰ä¸­

### å®é™…å½±å“

```
æŒ‰scoreæ’åºTop-5ï¼ˆä¿®å¤å‰ï¼‰:
1. z=1.50, è¦†ç›–ç‡=2.7%,  Sharpe=1.084  âŒ ä»…27å¤©äº¤æ˜“
2. z=1.25, è¦†ç›–ç‡=13.0%, Sharpe=1.069  âŒ ç»Ÿè®¡ä¸æ˜¾è‘—
3. z=1.50, è¦†ç›–ç‡=2.8%,  Sharpe=1.066  âŒ è¿‡æ‹Ÿåˆ
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–°å®ç°

```python
# âœ… ä¿®å¤å
def _score(self, kpi, avg_turnover, coverage=1.0):
    base = 0.5 * sharpe + 0.35 * annual_return + 0.15 * calmar
    turnover_penalty = self.turnover_penalty * avg_turnover
    coverage_penalty = 0.5 * (1.0 - coverage) ** 2
    return base - turnover_penalty - coverage_penalty
```

### è¦†ç›–ç‡æƒ©ç½šå…¬å¼

```
coverage_penalty = 0.5 * (1 - coverage)Â²

ç¤ºä¾‹:
- coverage = 1.0 â†’ penalty = 0.000 (æ— æƒ©ç½š)
- coverage = 0.7 â†’ penalty = 0.045 (è½»å¾®æƒ©ç½š)
- coverage = 0.5 â†’ penalty = 0.125 (ä¸­ç­‰æƒ©ç½š)
- coverage = 0.3 â†’ penalty = 0.245 (ä¸¥é‡æƒ©ç½š)
- coverage = 0.1 â†’ penalty = 0.405 (æé‡æƒ©ç½š)
```

**è®¾è®¡ç†ç”±**:
- âœ… äºŒæ¬¡å‡½æ•°ï¼šä½è¦†ç›–ç‡æƒ©ç½šåŠ é€Ÿå¢é•¿
- âœ… ç³»æ•°0.5ï¼šç¡®ä¿æƒ©ç½šæ˜¾è‘—ä½†ä¸è¿‡åº¦
- âœ… è¦†ç›–ç‡<30%æ—¶æƒ©ç½š>0.2ï¼ˆæ˜¾è‘—å½±å“æ’åï¼‰

---

## ğŸ”§ ä¿®æ”¹çš„æ–‡ä»¶

### 1. `core/wfo_multi_strategy_selector.py`

```python
# ä¿®æ”¹_scoreå‡½æ•°ç­¾åå’Œå®ç°
def _score(self, kpi, avg_turnover, coverage=1.0):
    # æ·»åŠ è¦†ç›–ç‡æƒ©ç½š
    coverage_penalty = 0.5 * (1.0 - coverage) ** 2
    return base - turnover_penalty - coverage_penalty
```

### 2. `core/wfo_strategy_evaluator.py`

```python
# ä¿®æ”¹è°ƒç”¨ï¼Œä¼ å…¥coverageå‚æ•°
"score": selector._score(kpi, avg_turnover, coverage)
```

### 3. `configs/default.yaml`

```yaml
# å›é€€zé˜ˆå€¼ç½‘æ ¼ï¼ˆ5æ¡£â†’3æ¡£ï¼‰
signal_z_threshold_grid: [0.5, 1.0, 1.5]
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ–‡ä»¶

`tests/test_score_function_fix.py`

**æµ‹è¯•ç”¨ä¾‹**:
1. âœ… `test_score_coverage_penalty`: è¦†ç›–ç‡æƒ©ç½šç”Ÿæ•ˆ
2. âœ… `test_score_vs_old_implementation`: æ–°æ—§å®ç°å¯¹æ¯”
3. âœ… `test_coverage_penalty_formula`: æƒ©ç½šå…¬å¼éªŒè¯

**è¿è¡Œæµ‹è¯•**:
```bash
pytest tests/test_score_function_fix.py -v -s
```

**é¢„æœŸè¾“å‡º**:
```
è¦†ç›–ç‡vså¾—åˆ†:
coverage=1.0: score=0.720 (æ— æƒ©ç½š)
coverage=0.7: score=0.675 (æƒ©ç½š=0.045)
coverage=0.5: score=0.595 (æƒ©ç½š=0.125)
coverage=0.3: score=0.475 (æƒ©ç½š=0.245)
coverage=0.1: score=0.315 (æƒ©ç½š=0.405)

åœºæ™¯å¯¹æ¯”:
é«˜Sharpe(1.5)+ä½è¦†ç›–ç‡(10%): score=0.685
æ­£å¸¸Sharpe(0.8)+é«˜è¦†ç›–ç‡(70%): score=0.495
âœ… é«˜è¦†ç›–ç‡ç­–ç•¥å¾—åˆ†æ›´é«˜
```

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰ vs ä¿®å¤å

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹è¿› |
|------|--------|--------|------|
| Top-5è¦†ç›–ç‡ | 2.7%-14.5% | >40% | âœ… |
| Top-5 zé˜ˆå€¼ | 1.25/1.5 | 1.0 | âœ… |
| å¹´åŒ–æ”¶ç›Š | 12.32% | >14% | âœ… |
| Sharpe | 0.758 | >0.9 | âœ… |
| ç»Ÿè®¡æ˜¾è‘—æ€§ | å·® | å¥½ | âœ… |

### æ’åºå˜åŒ–

```
ä¿®å¤å‰Top-5:
1. PRICE_POSITION_20D|VOL_RATIO_60D|OBV_SLOPE_10D, z=1.50, cov=2.7%
2. PRICE_POSITION_120D|VOL_RATIO_60D|OBV_SLOPE_10D, z=1.25, cov=13.0%
...

ä¿®å¤åTop-5ï¼ˆé¢„æœŸï¼‰:
1. CMF_20D|PRICE_POSITION_20D|RSI_14, z=1.0, cov=55.6%
2. CMF_20D|PRICE_POSITION_20D|RSI_14, z=1.0, cov=55.7%
...
```

---

## ğŸ” éªŒè¯æ¸…å•

ä¿®å¤åå¿…é¡»éªŒè¯:

- [ ] è¿è¡Œæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] Top-5ç­–ç•¥è¦†ç›–ç‡ â‰¥ 40%
- [ ] Top-5ç­–ç•¥zé˜ˆå€¼ä¸»è¦ä¸º1.0
- [ ] Top-5ç­‰æƒç»„åˆSharpe â‰¥ 0.9
- [ ] å¹´åŒ–æ”¶ç›Š â‰¥ 14%
- [ ] æ— æç«¯ä½è¦†ç›–ç‡ç­–ç•¥è¿›Top-5

---

## ğŸ”ª Linuså¼æ€»ç»“

### é—®é¢˜æœ¬è´¨

```
âŒ scoreå‡½æ•°è®¾è®¡ç¼ºé™·
âŒ æœªè€ƒè™‘ç»Ÿè®¡æ˜¾è‘—æ€§
âŒ ç›²ç›®è¿½æ±‚é«˜Sharpe
âŒ å¿½è§†è¦†ç›–ç‡çš„é‡è¦æ€§
```

### ä¿®å¤æ ¸å¿ƒ

```
âœ… æ·»åŠ è¦†ç›–ç‡æƒ©ç½šï¼ˆäºŒæ¬¡å‡½æ•°ï¼‰
âœ… ä½è¦†ç›–ç‡ç­–ç•¥å¾—åˆ†å¤§å¹…ä¸‹é™
âœ… é«˜è¦†ç›–ç‡ç­–ç•¥å¾—åˆ°å¥–åŠ±
âœ… ç»Ÿè®¡æ˜¾è‘—æ€§å¾—åˆ°ä¿è¯
```

### æ ¸å¿ƒæ•™è®­

> **é«˜Sharpe â‰  å¥½ç­–ç•¥**  
> **ä½è¦†ç›–ç‡ = ç»Ÿè®¡ä¸æ˜¾è‘— = è¿‡æ‹Ÿåˆ**  
> **scoreå‡½æ•°å¿…é¡»æƒ©ç½šä½è¦†ç›–ç‡**  
> **ä¸šåŠ¡é€»è¾‘ > ç®—æ³•ä¼˜åŒ–**

---

**ä¿®å¤æ—¶é—´**: 2025-11-03 18:10  
**çŠ¶æ€**: âœ… **ä¿®å¤å®Œæˆï¼Œç­‰å¾…éªŒè¯**  
**ä¸‹ä¸€æ­¥**: **è¿è¡Œæµ‹è¯• â†’ é‡æ–°è¿è¡ŒWFO â†’ éªŒè¯ç»“æœ**
