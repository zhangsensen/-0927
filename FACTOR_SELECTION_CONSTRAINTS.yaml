# WFO + IC筛选约束配置

**生效日期**：2025-10-25  
**适用范围**：43只ETF横截面因子筛选  

---

## 家族配额约束

```yaml
family_quotas:
  momentum_trend:
    max_count: 4
    candidates: [MOM_10D, MOM_20D, MOM_40D, MOM_63D, MOM_252D, ACCEL_10_40, SLOPE_20D, TREND_CONSISTENCY_20D, DIST_52W_HIGH]
    notes: "防止单类挤占；MOM与DIST互斥"

  price_position:
    max_count: 2
    candidates: [PRICE_POSITION_20D, PRICE_POSITION_60D, PRICE_POSITION_120D]
    notes: "有界因子，取2个即可覆盖"

  volatility_risk:
    max_count: 4
    candidates: [RET_VOL_10D, RET_VOL_20D, RET_VOL_60D, RET_VOL_120D, ATR_NORM_14, MAX_DD_60D, MAX_DD_120D, TAIL_VAR_60D, SEMIVAR_20D, VOL_OF_VOL_20D, VOL_REGIME_SHIFT]
    notes: "高相关性；最多4个；MAX_DD与TAIL_VAR互斥"

  volume_liquidity:
    max_count: 3
    candidates: [VOL_RATIO_5D, VOL_RATIO_20D, VOL_RATIO_60D, AMOUNT_RATIO_20D, VOLUME_TREND_SLOPE_20D, VOLUME_CONCENTRATION_20D, LIQUIDITY_SCORE_20D]
    notes: "取3个；VOL_RATIO与TREND_SLOPE互斥；CONCENTRATION可作补充"

  pv_coupling:
    max_count: 1
    candidates: [PV_CORR_20D, PV_DIVERGENCE_20D]
    notes: "二选一或都不选；可选维度"

  reversal_overbought:
    max_count: 2
    candidates: [RSI_6, RSI_14, WR_14, EXTREME_RETURN_FREQ_60D]
    notes: "RSI/WR互斥；EXTREME_FREQ低优先级"

  intraday_structure:
    max_count: 1
    candidates: [INTRADAY_POSITION, INTRADAY_RANGE_NORM]
    notes: "可选；需验证open数据完整性"

  statistical_robust:
    max_count: 2
    candidates: [SHARPE_60D, RET_SKEW_60D, RET_KURT_60D, DRAWDOWN_RECOVERY_SPEED]
    notes: "从中选2个；SKEW/KURT取一"
```

---

## 互斥对规则

```yaml
mutually_exclusive_pairs:

  - pair: [MOM_10D, MOM_20D]
    correlation: 0.85
    recommendation: "prefer_MOM_20D"
    reason: "相关性>0.8；MOM_20D更平衡"

  - pair: [MOM_63D, DIST_52W_HIGH]
    correlation: 0.70
    recommendation: "prefer_MOM_63D"
    reason: "信息方向对立；MOM正向更直观"

  - pair: [RET_VOL_20D, RET_VOL_60D]
    correlation: 0.90
    recommendation: "can_coexist_but_select_one"
    reason: "覆盖短/中周期；若纳入>1个需检验独立性"

  - pair: [MAX_DD_60D, TAIL_VAR_60D]
    correlation: 0.75
    recommendation: "prefer_MAX_DD_60D"
    reason: "都反映下行风险；MAX_DD更稳健"

  - pair: [RSI_14, WR_14]
    correlation: 0.85
    recommendation: "prefer_RSI_14"
    reason: "同为反转指标；RSI通用性更好"

  - pair: [PV_CORR_20D, PV_DIVERGENCE_20D]
    correlation: -1.0
    recommendation: "select_one_or_none"
    reason: "倒数关系；首选PV_CORR（直观）"

  - pair: [VOL_RATIO_20D, VOLUME_TREND_SLOPE_20D]
    correlation: 0.80
    recommendation: "prefer_VOL_RATIO_20D"
    reason: "都反映量能方向；RATIO形式更易解释"

  - pair: [RET_SKEW_60D, RET_KURT_60D]
    correlation: 0.40
    recommendation: "select_one"
    reason: "都属分布形态；虽相关性一般，最多选一个避免冗余"

  - pair: [ACCEL_10_40, SLOPE_20D]
    correlation: 0.75
    recommendation: "select_one_if_limited_slots"
    reason: "都反映趋势加强；若配额充足可共存"

global_correlation_threshold: 0.75
comment: "跨维度|ρ|>0.75需评估是否信息补充或冗余"
```

---

## IC筛选门槛

```yaml
ic_selection_criteria:

  minimal_ic_mean:
    value: 0.01
    description: "样本外IC均值的最低要求"
    unit: "absolute_ic"
    rationale: "0.01 IC ≈ 0.25% 日收益预测能力（保守标准）"

  ic_direction_stability:
    value: 0.60
    description: "IC同向（正IC）的天数比例"
    unit: "percentage"
    rationale: "至少60%的交易日IC>0，表示信号方向一致"
    rejection_rule: "若direction_stability<40%则剔除（反向信号）"

  ic_annual_consistency:
    value: 0.50
    description: "跨自然年份的IC一致性（避免年份特异性）"
    unit: "percentage"
    rationale: "不同年份的IC符号一致率≥50%，防止2024年有效2025年无效"
    check_method: "分年度计算IC，取均值和符号一致性"

  coverage_rate_threshold:
    value: 0.97
    description: "当日横截面有效覆盖率"
    unit: "percentage"
    rationale: "43只ETF中，至少40只（97.7%）该日因子和收益非NaN"
    rejection_rule: "若当日覆盖率<97%则剔除该日的IC计算"

  min_valid_days:
    value: 252
    description: "最少有效样本日数（1年交易日）"
    unit: "days"
    rationale: "IC需要足够样本支持；<252天样本太少"

ic_calculation_method: |
  对每个候选因子（在WFO训练折内）：
  1. 标准化：按日期×横截面做z-score → factor_z[T, i]
  2. 截断：按日期×横截面做2.5%/97.5%分位 → factor_capped[T, i]
  3. 未来收益：ret[T+1, i] = log(close[T+1, i] / close[T, i])
  4. 剔除NaN：当日若factor_capped或ret缺失 → 该ETF不参与当日IC
  5. 覆盖率检查：若当日有效ETF数<41只 → 当日IC=NaN
  6. IC计算：ic[T] = corr(factor_capped[T, :valid], ret[T+1, :valid])
  7. 汇总：ic_mean = mean(ic[valid_days]), ic_std = std(ic[valid_days])

ic_ranking_algorithm: |
  # WFO训练折内IC排序
  for each factor in candidate_universe:
    ic_mean = mean(ic_series)
    ic_std = std(ic_series)
    ic_stability = (sum(ic > 0) / len(ic))  # direction_stability
    ic_zscore = ic_mean / (ic_std + 1e-10)
    
    rank_score = (
      ic_mean * 0.5 +                    # IC绝对值权重
      ic_zscore * 0.3 +                  # IC稳定性（相对于噪音）
      (ic_stability - 0.5) * 0.2         # 方向一致性权重
    )
  
  # 按rank_score从高到低排序
  # 满足family_quotas和mutually_exclusive约束下，取top 15-20
```

---

## 覆盖率与缺失处理

```yaml
data_quality_rules:

  daily_completeness:
    rule: "原始OHLCV任一缺失 → 当日该标的所有指标=NaN"
    etf_count: 43
    acceptable_daily_coverage: 0.97  # 至少41只ETF有效
    nans_exceeding_threshold: "当日覆盖率<97% → 当日IC剔除"

  rolling_window_requirement:
    rule: "满窗原则"
    description: |
      对于窗口长度N的滚动指标：
      - 必须有N个连续有效值
      - 若中间有NaN，当日指标值=NaN
      - 示例：MOM_20D需20个有效close；若day-15缺失 → day-1的MOM_20D=NaN

  amount_field_fallback:
    real_amount: "若available则使用真实amount"
    fallback_estimation: "否则用 close × volume 估算"
    implementation: |
      if amount is not null:
        use amount
      else:
        amount = close * volume
      # 确保所有amount相关指标使用一致的amount定义

  nan_propagation_in_ratios:
    description: "比率类指标的除零处理"
    rule: "分母为0或接近0时，加1e-10平滑或返回NaN"
    example: |
      # VOL_RATIO
      if past_vol ≈ 0:
        vol_ratio = recent_vol / (1e-10)  # 结果→∞，WFO截断会处理
      
      # PRICE_POSITION
      if high_N == low_N:
        position = 0.5  # 无波动时置为中点
      
      # RET_VOL
      if std(returns) ≈ 0:
        ret_vol = 1e-10  # 置极小值；WFO截断时会处理
```

---

## WFO参数与流程

```yaml
wfo_configuration:

  train_test_split:
    training_set:
      start_date: "2023-01-01"  # or earliest available
      end_date: "2024-06-30"
      description: "用于拟合IC权重、因子选择"
    
    validation_set:
      start_date: "2024-07-01"
      end_date: "2025-10-24"  # or latest available
      description: "样本外评估IC稳定性"
    
    ratio: "~50% train, ~50% test"

  rebalance_frequency:
    value: "20d"  # 或月度
    reason: "对应中期调仓周期；太频繁则交易成本高，太少则滞后"

  factor_standardization_in_wfo:
    step1_calculation: "按指标定义生成因子matrix"
    step2_training_fold:
      - "对每个因子，每个日期，按当日横截面计算mean和std"
      - "zscore[T, i] = (factor[T, i] - mean(factor[T, :])) / std(factor[T, :] + 1e-10)"
      - "percentile_lower = percentile(zscore[T, :], 2.5)"
      - "percentile_upper = percentile(zscore[T, :], 97.5)"
      - "factor_capped[T, i] = clip(zscore[T, i], percentile_lower, percentile_upper)"
    step3_test_fold:
      - "同步应用训练折学得的截断阈值"
      - "或用验证折自身的当日横截面统计量（两者都不泄漏未来信息）"
      - "建议用验证折自身数据（更稳健）"

  ic_weight_fitting:
    method: "线性回归或OLS"
    formula: |
      future_return[T+1, :] = alpha_0 + sum(alpha_k * factor_capped[T, k]) + epsilon
      其中 factor_capped 是训练折内标准化后的因子
    constraints: |
      - 不做因子筛选，拟合所有候选因子（WFO内自动筛选）
      - 使用样本外验证折的IC稳定性作最终筛选依据
```

---

## 最终筛选步骤

```yaml
final_selection_pipeline:

  step_1_candidate_universe:
    count: "35-40个候选指标"
    source: "CANDIDATE_FACTORS_PRECISE_DEFINITION.md"

  step_2_wfo_training:
    action: "在训练折(2023-2024.6)内拟合IC权重和direction"
    output: "每个因子的ic_mean, ic_std, rank_score"

  step_3_wfo_validation:
    action: "在验证折(2024.7-2025.10)评估样本外IC稳定性"
    threshold_application: |
      ic_mean > 0.01 AND direction_stability > 0.6 AND annual_consistency > 0.5
    output: "通过验证的因子集合（预期20-25个）"

  step_4_family_quota_application:
    action: "按家族配额约束和互斥规则筛选"
    algorithm: |
      for each family:
        candidates_in_family = get_candidates(family)
        ranked_by_ic = sort(candidates_in_family, by=rank_score, descending=True)
        selected = ranked_by_ic[:family_quota]
      # 检查互斥对，若两个互斥的都被选中，保留IC高的
    output: "~20个因子"

  step_5_correlation_deduplication:
    action: "检验全局相关性，去掉ρ>0.75且不互补的对"
    method: |
      factor_corr_matrix = compute_correlation(selected_factors)
      for (i, j) in pairs where |corr[i,j]| > 0.75:
        if not is_complementary(i, j):
          remove_lower_ic_factor(i, j)
    output: "~15-18个因子"

  step_6_final_consolidation:
    action: "综合IC、稳定性、可解释性，确定最终因子集"
    criteria: |
      - IC均值>0.01且方向稳定性>60%
      - 跨年份一致性>50%
      - 覆盖8大维度（至少6个）
      - 相关性<0.75（除互补对）
    target_count: "12-15个核心因子"

  step_7_oos_validation:
    action: "用最终因子集在验证折回测"
    metrics: |
      - Sharpe ratio
      - Max drawdown
      - Win rate（正收益日占比）
      - 月度/季度稳定性
    acceptance_rule: "样本外Sharpe>0.5或日均超额收益>0.02%"
```

---

## 文件输出规范

```yaml
output_format:

  factor_matrix:
    filename: "factor_matrix_train.parquet"
    shape: "(dates, etfs, factors)"
    columns: [date, etf_code, factor_1, factor_2, ..., factor_35]
    notes: |
      - 存储标准化前的原始因子值
      - 在WFO内进行标准化和截断
      - 包含NaN标记（已处理缺失）

  ic_scores:
    filename: "ic_scores_train.csv"
    columns: [date, factor_name, ic, coverage_rate, num_valid_etfs]
    notes: |
      - 每个因子每天的IC值
      - 覆盖率和有效ETF数用于后续过滤

  wfo_results:
    filename: "wfo_selection_results.json"
    structure: |
      {
        "selected_factors": ["MOM_20D", "RET_VOL_20D", "PRICE_POSITION_20D", ...],
        "ic_stats": {
          "MOM_20D": {"ic_mean": 0.015, "ic_std": 0.03, "direction_stability": 0.62},
          ...
        },
        "rank_scores": {...},
        "family_quota_summary": {...},
        "validation_backtest_metrics": {...}
      }

  final_factor_list:
    filename: "FINAL_FACTORS_12_15.md"
    content: |
      - 因子名称、窗口、计算逻辑
      - IC均值/标准差/稳定性
      - 相关性提示
      - 在模型中的权重或排名
```

---

## 检验清单（Pre-WFO）

- [ ] 所有35-40个候选指标已按精确定义实现
- [ ] 缺失处理验证：对各指标、各ETF做" 满窗NaN检查" 
- [ ] 因子矩阵形状正确：(dates × etfs × factors)
- [ ] 缺失值比例<3%（97%覆盖率）
- [ ] 单元测试：极端case（全NaN、无波动、极端收益等）通过
- [ ] WFO训练/验证折数据无泄漏
- [ ] Z-score标准化逻辑验证：mean≈0, std≈1（按日期×横截面）
- [ ] 2.5%/97.5%分位截断逻辑正确
- [ ] IC计算函数验证（手动样本验证）
- [ ] WFO IC权重拟合结果合理（系数不爆炸）

---

## 备注

此配置遵循以下原则：
1. **信息不泄漏**：验证折使用当日横截面统计量或训练折参数，不使用未来数据
2. **稳健性**：97%覆盖率、2.5%/97.5%分位截断、满窗NaN原则
3. **可解释性**：IC选择基于统计显著性和方向一致性
4. **可复现性**：所有规则参数化，便于审计和调整

