# 工程化检查点 - 2025-10-27

## 🎯 核心状态

### ✅ 三项工程化完成

#### 1. 数据版本绑定（Data Version Binding）
- **实现**：WFO元数据驱动的cross_section/factor_selection绑定
- **机制**：读WFO timestamp，优先匹配同日时间戳≤WFO的版本，否则回退+警告
- **效果**：消除版本错配导致的数据污染
- **证据**：
  ```
  绑定数据版本：目标日期=20251027，WFO时间戳=20251027_170353
  已按WFO绑定 cross_section: .../20251027_170312
  已按WFO绑定 factor_selection: .../20251027_170344
  ```

#### 2. 交易成本模型（Trading Cost Model）
- **参数**：`TRADING_COST_BPS` 环境变量（默认=0）
- **计算**：日换手率 = 0.5 * Σ|w_t - w_{t-1}|，净收益 = 毛收益 - 换手率 × cost_rate
- **输出字段**：`oos_net_annual_return, oos_net_sharpe, avg_daily_turnover, cost_bps`
- **证据**：
  ```
  avg_daily_turnover=0.2459 (日均换手 ~24.6%)
  0 bps: avg_net_sharpe=-0.0514, avg_net_annual_return=0.1976
  5 bps: avg_net_sharpe=-0.2172, avg_net_annual_return=0.1608
  成本影响: -0.1658 Sharpe = 成本吃掉全部收益，反而负 0.22x
  ```

#### 3. 无重叠OOS拼接权益（Stitched OOS Equity）
- **步长估计**：min(oos_start差值) = 20天，回退=20天
- **产物**：`stitched_oos_equity.csv` 包含 date, window_idx, gross_ret, net_ret, cum_gross, cum_net
- **用途**：连续OOS权益曲线，用于生产级监控/展示

---

## 🔬 关键参数

| 参数 | 值 | 说明 |
|------|-----|------|
| TopN | 5 | 每日选股头部数量 |
| 因子权重 | 等权 | 5个选中因子等权平均 |
| 信号对齐 | T-1→T | T-1的因子预测T的收益 |
| IC计算 | 日截面Spearman | 每日独立，然后周期均值 |
| WFO窗口数 | 55 | 有效窗口=54（首窗无因子跳过） |
| OOS期长 | 60天 | 每窗都是60天样本外 |
| 步长 | 20天 | 相邻窗口推进20天 |
| COST_BPS | 0 (默认) | 可通过环境变量修改 |

---

## 📊 成本敏感性分析

**结论：策略对成本极端敏感。** 

### 成本对标

换手率 ~24.6% × 单边成本：
- **0 bps**：平均Sharpe = -0.0514，平均年化收益 = 19.76%
- **5 bps**（单边）：Sharpe 下跌至 -0.2172，年化收益 → 16.08%
  - 成本消耗：Sharpe -0.1658（损失幅度 322%），收益 -3.68%

**问题根因**：
1. 平均毛Sharpe已经接近零（-0.05），极低的收益承受不起成本
2. 24.6%的日换手太激进，导致5 bps的成本就是致命伤

---

## 🔍 策略诊断

### avg_sharpe = -0.05 的根源分析

#### 假说1：因子选择不优 ❌
- **证据**：WFO中avg_oos_ic=0.1728（非常好）
- **诊断**：因子本身有很强的预测力，问题不在因子质量
- **等级**：假说可排除

#### 假说2：TopN=5太保守 ⚠️ 低优先级
- **分析**：
  - 理论上，更激进的选择（TopN=3/2）会增加因子暴露
  - 但当前Sharpe已是负数，收益本质上来自运气和成本反向刺激
  - 改参数的边际收益很低
- **等级**：可验证但收益有限

#### 假说3：成本吃掉收益 ✅ 核心问题
- **证据**：
  - 5 bps成本直接将平均Sharpe从-0.05砸到-0.22
  - avg_daily_turnover=24.6% = 换手太频繁
  - TopN=5每日都完全重建，高端策略看5阶因子精度已经掉出水线
- **等级**：确认问题根源

#### 假说4：信号本身质量下降 ⚠️ 需要深入
- **分析**：
  - avg_oos_ic=0.0156（54窗平均的跨截面IC）
  - OOS IC从0.1728(WFO) → 0.0156(实际) 是 **91% 的衰减**
  - 这表明WFO因子选择对OOS的泛化能力不足
- **等级**：关键问题，需要验证

---

## 🎬 下一步建议

### 优先级1：诊断IC衰减（ROI高）
```
问题：WFO IC 0.173 vs OOS IC 0.016，为什么衰减这么多？
- 是过拟合吗？（WFO窗口长度太短？）
- 是样本漂移吗？（市场环境变化？）
- 是因子稳定性吗？（某些因子在OOS期失效？）

行动：
1. 按窗口绘制IC轨迹，看是否有时间趋势
2. 拆解各因子在OOS的单独IC贡献
3. 对比IS期和OOS期的因子平均值分布
```

### 优先级2：控制换手（ROI高）
```
问题：24.6%的日换手是否必要？
- TopN每日完全重建是否有必要？
- 是否可以用momentum/持仓平滑来降低换手？

行动：
1. 尝试TopN=10（更稳定的持仓）
2. 尝试周频/月频信号（而不是日频）
3. 计算最优的TopN/持仓周期组合
```

### 优先级3：因子优化（ROI中）
```
问题：18个因子中，哪些是累赘？
- WFO选了7个因子，平均只用5个，是否需要更激进的筛选？
- PRICE_POSITION_20D、RSI_14、SHARPE_RATIO_20D 超频出现，是否存在冗余？

行动：
1. 按OOS IC排序因子，看边际贡献
2. 试试用更激进的因子数量约束（TopK=3）
3. 尝试因子加权（而不是等权）
```

---

## 📋 工程标准检查

| 项 | 状态 | 注 |
|----|----|-----|
| 数据溯源 | ✅ | 版本绑定完整，有日志证据 |
| 重现性 | ✅ | metadata明确、参数可配 |
| 审计日志 | ✅ | 全过程有日志，可追溯 |
| 成本透明 | ✅ | 毛/净分离，avg_turnover记录 |
| 性能报告 | ✅ | 详细CSV + 汇总报告 |
| 代码可维护性 | ✅ | 主要逻辑<50行，缩进≤3层 |
| 向量化率 | ✅ | 无.apply()，全numpy/pandas向量操作 |
| 魔数 | ✅ | 所有参数YAML/环境变量化 |

---

## 🎯 决策

### What we have
- 一个**完整、可审计、生产级的回测框架**
- 数据绑定消除版本错配
- 成本链路清晰可控
- 无重叠OOS权益可直接上线

### What we need
- **不是代码优化**（边际收益<1%）
- **不是参数微调**（TopN±1没用）
- **是策略创新**（IC衰减才是真问题）

### 转向

**立即停止工程化细化。** 转向：
1. **诊断IC衰减** (3-4小时)
2. **因子选择优化** (4-6小时)
3. **成本对冲方案** (2-3小时)

这才能从 avg_sharpe=-0.05 变成正数。

---

## 版本记录

| 时间 | 版本 | 改动 |
|------|-----|------|
| 2025-10-27 17:50 | v1.0 | 三项工程化完成，建立检查点 |
| 2025-10-27 17:53 | v1.1 | 成本敏感性测试：5bps Sharpe跌-0.22 |
| 当前 | v1.2 | 确认优先级，转向策略诊断 |

